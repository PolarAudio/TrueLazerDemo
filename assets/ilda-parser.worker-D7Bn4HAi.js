(function(){"use strict";const w=[{r:255,g:0,b:0},{r:0,g:255,b:0},{r:0,g:0,b:255},{r:255,g:255,b:0},{r:0,g:255,b:255},{r:255,g:0,b:255},{r:255,g:128,b:0},{r:128,g:255,b:0},{r:0,g:255,b:128},{r:0,g:128,b:255},{r:128,g:0,b:255},{r:255,g:0,b:128},{r:255,g:255,b:255},{r:128,g:128,b:128},{r:255,g:128,b:128},{r:128,g:255,b:128},{r:128,g:128,b:255},{r:255,g:255,b:128},{r:128,g:255,b:255},{r:255,g:128,b:255}],S=new Map,D=n=>{if(!n||n.length===0)return{minX:0,maxX:0,minY:0,maxY:0};let e=n[0].x,l=n[0].x,f=n[0].y,s=n[0].y;for(let t=1;t<n.length;t++){const i=n[t];e=Math.min(e,i.x),l=Math.max(l,i.x),f=Math.min(f,i.y),s=Math.max(s,i.y)}return{minX:e,maxX:l,minY:f,maxY:s}};function C(n){const e=new DataView(n),l=[];let f=null,s=0;for(;s+32<=n.byteLength;){const t=s,i=String.fromCharCode(e.getUint8(t),e.getUint8(t+1),e.getUint8(t+2),e.getUint8(t+3));if(i!=="ILDA"){console.warn(`Parser: Invalid ILDA signature at offset ${t}, got: ${i}. Skipping 32 bytes.`),s+=32;continue}const r=e.getUint8(t+7);if(f===null&&(f=r),r>5){console.warn(`Parser: Unknown format code: ${r} at offset ${t}. Skipping 32 bytes.`),s+=32;continue}let m=e.getUint16(t+24,!1);const o=e.getUint16(t+26,!1),d=e.getUint16(t+28,!1),L=e.getUint8(t+30);let c;switch(r){case 0:c=8;break;case 1:c=6;break;case 2:c=8;break;case 4:c=10;break;case 5:c=8;break;default:console.warn(`Parser: Unsupported format ${r}, skipping 32 bytes.`),s+=32;continue}let I=m*c,b=32+I;const $=n.byteLength-s;if(b<$){const g=$-b;g>0&&g<=32&&(console.warn(`Parser: Malformed frame, ${g} leftover bytes. Adjusting size.`),b+=g,I+=g,m=Math.floor(I/c))}if(t+b>n.byteLength){console.warn(`Parser: Incomplete frame data for ${m} points at offset ${t}. Expected ${b} bytes, but only ${n.byteLength-t} bytes remaining. Breaking.`);break}if(m===0){console.log("Parser: Empty frame, skipping"),s+=b;continue}const u=[];let a=t+32;try{for(let g=0;g<m;g++){let U,x,F=0,p,y,h,k;r===0||r===4?(U=e.getInt16(a,!1)/32768,x=e.getInt16(a+2,!1)/32768,F=e.getInt16(a+4,!1)/32768,k=e.getUint8(a+6)):(U=e.getInt16(a,!1)/32768,x=e.getInt16(a+2,!1)/32768,k=e.getUint8(a+4));const v=(k&64)===64,P=(k&128)===128;if(r===0||r===1){const z=e.getUint8(a+(r===0?7:5)),M=w[z%w.length]||w[0];p=M.r,y=M.g,h=M.b}else if(r===4||r===5)p=e.getUint8(a+(r===4?7:5)),y=e.getUint8(a+(r===4?8:6)),h=e.getUint8(a+(r===4?9:7));else if(r===2){a+=c;continue}if(u.push({x:U,y:x,z:F,r:p===void 0?255:p,g:y===void 0?255:y,b:h===void 0?255:h,blanking:v,lastPoint:P}),a+=c,P)break}}catch(g){console.warn("Parser: Error reading points:",g);break}u.length>0&&l.push({frameNumber:o,totalFrames:d,projectorNumber:L,points:u,bounds:D(u)}),s+=b}return{frames:l,error:l.length===0?"No valid frames found":null,firstFormatCode:f}}self.onmessage=function(n){const{arrayBuffer:e,type:l,fileName:f,layerIndex:s,colIndex:t,workerId:i,frameIndex:r,isStillFrame:m}=n.data;if(l==="parse-ilda")try{const o=C(e),d=`ilda-${Date.now()}-${Math.random().toString(36).substring(2,9)}`;S.set(d,o.frames),self.postMessage({success:!0,workerId:d,totalFrames:o.frames.length,ildaFormat:o.firstFormatCode,fileName:f,layerIndex:s,colIndex:t,type:"parse-ilda"})}catch(o){console.error("[ilda-parser.worker] Error parsing file:",o),self.postMessage({success:!1,error:o.message,type:"parse-ilda"})}else if(l==="get-frame"){const o=S.get(i);o&&o[r]?self.postMessage({success:!0,frame:o[r],workerId:i,frameIndex:r,type:"get-frame",isStillFrame:m}):self.postMessage({success:!1,error:"Frame not found",workerId:i,frameIndex:r,type:"get-frame",isStillFrame:m})}}})();
