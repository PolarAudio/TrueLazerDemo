(function(){"use strict";const J=[{id:"rotate",name:"Rotate",type:"transform",description:"Rotates the shape around its center.",defaultParams:{angle:0,speed:0,direction:"CW"},paramControls:[{id:"angle",label:"Angle",type:"range",min:0,max:360,step:1},{id:"speed",label:"Speed",type:"range",min:0,max:10,step:.1},{id:"direction",label:"Direction",type:"select",options:["CW","CCW"]}]},{id:"scale",name:"Scale",type:"transform",description:"Scales the shape.",defaultParams:{scaleX:1,scaleY:1},paramControls:[{id:"scaleX",label:"Scale X",type:"range",min:.01,max:5,step:.01},{id:"scaleY",label:"Scale Y",type:"range",min:.01,max:5,step:.01}]},{id:"translate",name:"Translate",type:"transform",description:"Moves the shape.",defaultParams:{translateX:0,translateY:0},paramControls:[{id:"translateX",label:"Translate X",type:"range",min:-1,max:1,step:.01},{id:"translateY",label:"Translate Y",type:"range",min:-1,max:1,step:.01}]},{id:"color",name:"Color",type:"color",description:"Changes the color of the shape with solid, rainbow or custom palette modes.",defaultParams:{mode:"solid",color:"#ffffff",r:255,g:255,b:255,cycleSpeed:0,rainbowSpread:1,rainbowOffset:0,rainbowPalette:"rainbow",paletteColors:["#ff0000","#00ff00","#0000ff","#ffff00"],paletteSize:4,paletteSpread:1,hue:0,saturation:0,brightness:1,enabled:!0},paramControls:[{id:"mode",label:"Mode",type:"select",options:["solid","rainbow","palette"]},{id:"color",label:"Color",type:"color",showIf:{mode:"solid"}},{id:"hue",label:"Hue",type:"range",min:0,max:1,step:.001,showIf:{mode:"hsv_advanced"}},{id:"saturation",label:"Saturation",type:"range",min:0,max:1,step:.001,showIf:{mode:"hsv_advanced"}},{id:"brightness",label:"Brightness",type:"range",min:0,max:1,step:.001,showIf:{mode:"hsv_advanced"}},{id:"paletteSize",label:"Palette Size",type:"range",min:2,max:16,step:1,showIf:{mode:"palette"}},{id:"paletteSpread",label:"Spread",type:"range",min:.1,max:10,step:.1,showIf:{mode:"palette"}},{id:"cycleSpeed",label:"Cycle Speed",type:"range",min:0,max:10,step:.1,showIf:{mode:["rainbow","palette"]}},{id:"rainbowSpread",label:"Rainbow Spread",type:"range",min:.1,max:10,step:.1,showIf:{mode:"rainbow"}},{id:"rainbowOffset",label:"Offset",type:"range",min:0,max:360,step:1,showIf:{mode:["rainbow","palette"]}},{id:"rainbowPalette",label:"Preset",type:"select",options:["rainbow","fire","ice","cyber"],showIf:{mode:"rainbow"}}]},{id:"wave",name:"Wave",type:"animation",description:"Applies a wave distortion to the shape.",defaultParams:{amplitude:.1,frequency:10,speed:1,direction:"x"},paramControls:[{id:"amplitude",label:"Amplitude",type:"range",min:.01,max:1,step:.01},{id:"frequency",label:"Frequency",type:"range",min:1,max:50,step:1},{id:"speed",label:"Speed",type:"range",min:.1,max:10,step:.1},{id:"direction",label:"Direction",type:"select",options:["x","y"]}]},{id:"warp",name:"Warp",type:"animation",description:"Symmetrical chaotic wave distortion.",defaultParams:{amount:.1,chaos:.5,speed:1},paramControls:[{id:"amount",label:"Amount",type:"range",min:0,max:1,step:.01},{id:"chaos",label:"Chaos",type:"range",min:0,max:1,step:.01},{id:"speed",label:"Speed",type:"range",min:.1,max:10,step:.1}]},{id:"distortion",name:"Distortion",type:"transform",description:"Distorts the point data.",defaultParams:{amount:.1,scale:10,speed:.5},paramControls:[{id:"amount",label:"Amount",type:"range",min:0,max:1,step:.01},{id:"scale",label:"Scale",type:"range",min:1,max:50,step:1},{id:"speed",label:"Speed",type:"range",min:0,max:5,step:.1}]},{id:"move",name:"Move (Bounce)",type:"transform",description:"Moves points and bounces them off the borders.",defaultParams:{speedX:.1,speedY:.1},paramControls:[{id:"speedX",label:"Speed X",type:"range",min:0,max:2,step:.01},{id:"speedY",label:"Speed Y",type:"range",min:0,max:2,step:.01}]},{id:"delay",name:"Delay",type:"effect",description:"Frame or Channel based delay effect.",defaultParams:{mode:"frame",playstyle:"repeat",useCustomOrder:!1,delayDirection:"left_to_right",delayAmount:5,decay:.8,steps:10,customOrder:[],enabled:!0},paramControls:[{id:"mode",label:"Mode",type:"select",options:["frame","channel"]},{id:"playstyle",label:"Playstyle",type:"select",options:["once","repeat"]},{id:"useCustomOrder",label:"Custom Order",type:"checkbox",showIf:{mode:"channel"}},{id:"delayDirection",label:"Direction",type:"select",options:["center_to_out","out_to_center","left_to_right","right_to_left"],showIf:{useCustomOrder:!1}},{id:"steps",label:"Steps",type:"range",min:2,max:20,step:1,showIf:{mode:"frame"}},{id:"delayAmount",label:"Delay Time",type:"range",min:1,max:60,step:1},{id:"decay",label:"Decay",type:"range",min:0,max:1,step:.01}]},{id:"chase",name:"Chase",type:"effect",description:"Frame or Channel based chase effect.",defaultParams:{mode:"frame",playstyle:"repeat",steps:4,decay:.8,speed:1,overlap:1,direction:"left_to_right",useCustomOrder:!1,customOrder:[],enabled:!0},paramControls:[{id:"mode",label:"Mode",type:"select",options:["frame","channel"]},{id:"playstyle",label:"Playstyle",type:"select",options:["once","repeat","bounce"]},{id:"steps",label:"Steps",type:"range",min:2,max:16,step:1,showIf:{mode:"frame"}},{id:"decay",label:"Decay",type:"range",min:0,max:1,step:.01},{id:"speed",label:"Speed",type:"range",min:.1,max:5,step:.1},{id:"overlap",label:"Overlap",type:"range",min:1,max:4,step:1},{id:"useCustomOrder",label:"Custom Order",type:"checkbox",showIf:{mode:"channel"}},{id:"direction",label:"Direction",type:"select",options:["center_to_out","out_to_center","left_to_right","right_to_left"],showIf:{useCustomOrder:!1}}]},{id:"blanking",name:"Blanking",type:"animation",description:"Controls the blanking of the laser output.",defaultParams:{blankingInterval:0,spacing:0},paramControls:[{id:"blankingInterval",label:"Blanking Interval",type:"range",min:0,max:10,step:1},{id:"spacing",label:"Spacing",type:"range",min:0,max:20,step:1}]},{id:"strobe",name:"Strobe",type:"animation",description:"Applies a strobe effect to the laser output.",defaultParams:{strobeSpeed:100,strobeAmount:.5},paramControls:[{id:"strobeSpeed",label:"Strobe Speed (ms)",type:"range",min:10,max:1e3,step:10},{id:"strobeAmount",label:"Strobe Amount (0-1)",type:"range",min:0,max:1,step:.01}]},{id:"mirror",name:"Mirror",type:"transform",description:"Mirrors the shape from the center.",defaultParams:{mode:"none",additive:!0},paramControls:[{id:"mode",label:"Mirror Mode",type:"select",options:["none","x+","x-","y+","y-"]},{id:"additive",label:"Additive",type:"checkbox"}]}].reduce((o,e)=>(o[e.id]=e,o),{});function X(o,e,h,i){const n=e.style||"loop",a=e.direction||"forward";if(a==="pause")return h;let r=o;n==="bounce"&&(r*=2);let c=0;if(n==="once")c=Math.min(r,1),a==="backward"&&(c=1-c);else if(n==="bounce"){let u=r%1;Math.floor(r)%2===1?c=1-u:c=u,a==="backward"&&(c=1-c)}else c=r%1,a==="backward"&&(c=1-c);return i&&Array.isArray(i)&&i.length===2?i[0]+(i[1]-i[0])*c:h}function K(o,e,h,i,n,a){if(!h)return e;const r=typeof h=="string"?{syncMode:h}:h;if(!r.syncMode)return e;const{time:c,progress:u=0,bpm:f=120,clipDuration:p=0,fftLevels:m={low:0,mid:0,high:0},activationTime:d=0}=i;let l=r.range;!l||!Array.isArray(l)||l.length;let s=0;const b=r.speedMultiplier||1;if((r.style||"loop")==="once"&&d>0){const w=(c-d)*.001;let _=1;if(r.syncMode==="timeline")_=Math.max(.01,r.duration||1);else if(r.syncMode==="bpm"){const R=Math.max(.1,r.beats||4),x=f/60;_=R/(x||2)}else if(r.syncMode==="fps")return s=w*b,X(s,r,e,l);s=w/_*b}else if(r.syncMode==="fps")s=c*.001*b;else if(r.syncMode==="timeline"){const w=Math.max(.01,r.duration||1);p>0?s=u*p/w*b:s=0}else if(r.syncMode==="bpm"){const w=Math.max(.1,r.beats||4),_=f/60,R=w/(_||2);p>0?s=u*p/R*b:s=0}else if(r.syncMode==="fft"){const w=m[r.fftRange||"low"]||0;return l?l[0]+(l[1]-l[0])*w:e}return X(s,r,e,l)}let N=new Float32Array(1024*8);function $(o){N.length<o*8&&(N=new Float32Array(o*8*2))}function Q(o,e,h={}){const{progress:i=0,time:n=performance.now(),effectStates:a,syncSettings:r={},fftLevels:c}=h;if(!e||e.length===0)return o;const u=o.points,f=o.isTypedArray||u instanceof Float32Array,p=f?u.length/8:u.length;$(p);const m=N.subarray(0,p*8);if(f)m.set(u);else for(let s=0;s<p;s++){const b=u[s],M=s*8;m[M]=b.x,m[M+1]=b.y,m[M+2]=b.z||0,m[M+3]=b.r,m[M+4]=b.g,m[M+5]=b.b,m[M+6]=b.blanking?1:0,m[M+7]=b.lastPoint?1:0}let d=m;for(const s of e){const b=s.params;if(b.enabled===!1||!J[s.id])continue;const w=d.length/8;let _=b;const R=s.instanceId?`${s.instanceId}.`:`${s.id}.`;let x=!1;for(const g in b)if(r[R+g]){x=!0;break}if(x){_={...b};for(const g in _){const S=R+g;r[S]&&(_[g]=K(g,_[g],r[S],h))}}switch(s.id){case"rotate":Z(d,w,_,i,n);break;case"scale":j(d,w,_);break;case"translate":ee(d,w,_);break;case"color":ae(d,w,_,n);break;case"wave":oe(d,w,_,n);break;case"blanking":ne(d,w,_);break;case"strobe":se(d,w,_,n);break;case"mirror":d=ie(d,w,_);break;case"warp":le(d,w,_,n);break;case"distortion":fe(d,w,_,n);break;case"move":ce(d,w,_,n);break;case"delay":a&&s.instanceId&&(d=he(d,w,_,a,s.instanceId,h));break;case"chase":d=de(d,w,_,n,h);break}}const l=new Float32Array(d);return d._channelDistributions&&(l._channelDistributions=d._channelDistributions),{...o,points:l,isTypedArray:!0}}function Z(o,e,h,i,n){const{angle:a,speed:r,direction:c}=h,u=c==="CCW"?-1:1,f=n*.001*r*u,p=a*Math.PI/180+f,m=Math.sin(p),d=Math.cos(p);for(let l=0;l<e;l++){const s=l*8,b=o[s],M=o[s+1];o[s]=b*d-M*m,o[s+1]=b*m+M*d}}function j(o,e,h){const{scaleX:i,scaleY:n}=h;for(let a=0;a<e;a++){const r=a*8;o[r]*=i,o[r+1]*=n}}function ee(o,e,h){const{translateX:i,translateY:n}=h;for(let a=0;a<e;a++){const r=a*8;o[r]+=i,o[r+1]+=n}}function W(o){if(!o)return{r:255,g:255,b:255};const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(o);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:{r:255,g:255,b:255}}function te(o,e,h){let i,n,a;const r=Math.floor(o*6),c=o*6-r,u=h*(1-e),f=h*(1-c*e),p=h*(1-(1-c)*e);switch(r%6){case 0:i=h,n=p,a=u;break;case 1:i=f,n=h,a=u;break;case 2:i=u,n=h,a=p;break;case 3:i=u,n=f,a=h;break;case 4:i=p,n=u,a=h;break;case 5:i=h,n=u,a=f;break}return[Math.round(i*255),Math.round(n*255),Math.round(a*255)]}function ae(o,e,h,i){const{mode:n,r:a,g:r,b:c,color:u,hue:f,saturation:p,brightness:m,cycleSpeed:d,rainbowSpread:l,rainbowOffset:s,rainbowPalette:b,paletteColors:M=[],paletteSize:w=4,paletteSpread:_=1}=h,R=i*.001*d;if(n==="palette"){const x=Math.min(M.length,w),g=M.slice(0,x).map(W);g.length===0&&g.push({r:255,g:255,b:255});for(let S=0;S<e;S++){const y=S*8,C=(S/e*_+R*.5+s/360)%1*g.length,D=Math.floor(C)%g.length,v=(D+1)%g.length,F=C-Math.floor(C),P=g[D],A=g[v];o[y+3]=Math.round(P.r+(A.r-P.r)*F),o[y+4]=Math.round(P.g+(A.g-P.g)*F),o[y+5]=Math.round(P.b+(A.b-P.b)*F)}}else if(n==="rainbow"){const x=b||"rainbow";for(let g=0;g<e;g++){const S=g*8,y=(g/e*l+R*.5+s/360)%1;let B,C,D;x==="rainbow"?[B,C,D]=q(y,1,.5):[B,C,D]=re(x,y),o[S+3]=B,o[S+4]=C,o[S+5]=D}}else{let x=a,g=r,S=c;if(f!==void 0&&p!==void 0&&m!==void 0)[x,g,S]=te(f,p,m);else if(u){const y=W(u);x=y.r,g=y.g,S=y.b}if(d>0){const y=R*50%360,[B,C,D]=q(y/360,1,.5);for(let v=0;v<e;v++){const F=v*8;o[F+3]=B,o[F+4]=C,o[F+5]=D}}else for(let y=0;y<e;y++){const B=y*8;o[B+3]=x,o[B+4]=g,o[B+5]=S}}}function re(o,e){const h={fire:[{r:255,g:0,b:0},{r:255,g:128,b:0},{r:255,g:255,b:0},{r:255,g:0,b:0}],ice:[{r:0,g:0,b:255},{r:0,g:255,b:255},{r:255,g:255,b:255},{r:0,g:0,b:255}],cyber:[{r:255,g:0,b:255},{r:0,g:255,b:255},{r:0,g:0,b:255},{r:255,g:0,b:255}]},i=h[o]||h.fire,n=e*(i.length-1),a=Math.floor(n),r=n-a,c=i[a],u=i[a+1]||i[a];return[Math.round(c.r+(u.r-c.r)*r),Math.round(c.g+(u.g-c.g)*r),Math.round(c.b+(u.b-c.b)*r)]}function q(o,e,h){let i,n,a;{const r=(f,p,m)=>(m<0&&(m+=1),m>1&&(m-=1),m<.16666666666666666?f+(p-f)*6*m:m<.5?p:m<.6666666666666666?f+(p-f)*(.6666666666666666-m)*6:f),c=h+e-h*e,u=2*h-c;i=r(u,c,o+1/3),n=r(u,c,o),a=r(u,c,o-1/3)}return[Math.round(i*255),Math.round(n*255),Math.round(a*255)]}function oe(o,e,h,i){const{amplitude:n,frequency:a,speed:r,direction:c}=h,u=i*.001*r;for(let f=0;f<e;f++){const p=f*8;c==="x"?o[p+1]+=n*Math.sin(o[p]*a+u):c==="y"&&(o[p]+=n*Math.sin(o[p+1]*a+u))}}function ne(o,e,h){const{blankingInterval:i,spacing:n=0}=h;if(i<=0)return;const a=i+1+n;for(let r=0;r<e;r++)r%a>=i&&(o[r*8+6]=1)}function se(o,e,h,i){const{strobeSpeed:n,strobeAmount:a}=h;if(i%n/n<a)for(let c=0;c<e;c++)o[c*8+6]=1}function ie(o,e,h){const{mode:i,additive:n=!0}=h;if(i==="none"||e===0)return o;let a;const r=o._channelDistributions,c=(u,f,p)=>n?!0:p==="x+"?u>=0:p==="x-"?u<=0:p==="y+"?f>=0:p==="y-"?f<=0:!0;if(r){a=new Float32Array((e*2+r.size)*8);const u=new Map;let f=0;for(const[m,d]of r){const l=d.length/8,s=d.start,b=f;let M=0;for(let w=0;w<l;w++){const _=s+w*8;c(o[_],o[_+1],i)&&(a.set(o.subarray(_,_+8),f),f+=8,M++)}if(M>0){const w=f-8;a.set(a.subarray(w,w+8),f),a[f+6]=1,a[f+3]=0,a[f+4]=0,a[f+5]=0,f+=8;for(let _=0;_<l;_++){const R=s+_*8;c(o[R],o[R+1],i)&&(a.set(o.subarray(R,R+8),f),i==="x-"||i==="x+"?a[f]=-a[f]:(i==="y-"||i==="y+")&&(a[f+1]=-a[f+1]),f+=8)}u.set(m,{start:b,length:(M*2+1)*8})}}const p=new Float32Array(f);return p.set(a.subarray(0,f)),p._channelDistributions=u,p}else{a=new Float32Array((e*2+1)*8);let u=0,f=0;for(let p=0;p<e;p++){const m=p*8;c(o[m],o[m+1],i)&&(a.set(o.subarray(m,m+8),u),u+=8,f++)}if(f>0){const p=u-8;a.set(a.subarray(p,p+8),u),a[u+6]=1,a[u+3]=0,a[u+4]=0,a[u+5]=0,u+=8;for(let m=0;m<e;m++){const d=m*8;c(o[d],o[d+1],i)&&(a.set(o.subarray(d,d+8),u),i==="x-"||i==="x+"?a[u]=-a[u]:(i==="y-"||i==="y+")&&(a[u+1]=-a[u+1]),u+=8)}return a.slice(0,u)}}return o}function le(o,e,h,i){const{amount:n,chaos:a,speed:r}=h,c=i*.001*r;for(let u=0;u<e;u++){const f=u*8,p=o[f],m=o[f+1],d=Math.abs(m);o[f]+=Math.sin(d*10*(1+a)+c)*n*Math.cos(c*a),o[f+1]+=Math.cos(Math.abs(p)*10*(1+a)+c)*n*Math.sin(c*a)}}function fe(o,e,h,i){const{amount:n,scale:a,speed:r}=h,c=i*.001*r;for(let u=0;u<e;u++){const f=u*8,p=Math.sin(o[f]*a+c)*Math.cos(o[f+1]*a-c),m=Math.cos(o[f]*a-c)*Math.sin(o[f+1]*a+c);o[f]+=p*n,o[f+1]+=m*n}}function ce(o,e,h,i){const{speedX:n,speedY:a}=h,r=i*.001,c=r*n,u=r*a,f=4;for(let p=0;p<e;p++){const m=p*8;let d=o[m]+c,l=o[m+1]+u,s=(d+1)%f;s<0&&(s+=f),s>2&&(s=4-s),d=s-1;let b=(l+1)%f;b<0&&(b+=f),b>2&&(b=4-b),l=b-1,o[m]=d,o[m+1]=l}}function he(o,e,h,i,n,a){const{mode:r="frame",delayAmount:c,decay:u,delayDirection:f,useCustomOrder:p,customOrder:m,playstyle:d="repeat",steps:l=10}=h;i.has(n)||i.set(n,[]);const s=i.get(n);if(s.unshift(new Float32Array(o)),r==="frame"){const b=c*l+1;s.length>b&&(s.length=b);const M=new Float32Array(o.length);for(let w=0;w<e;w++){let _=0;const R=w/e;f==="left_to_right"?_=Math.floor(R*(l-1)):f==="right_to_left"?_=Math.floor((1-R)*(l-1)):f==="center_to_out"?_=Math.floor(Math.abs(R-.5)*2*(l-1)):f==="out_to_center"&&(_=Math.floor((1-Math.abs(R-.5)*2)*(l-1)));const x=_*c,g=x<s.length?s[x]:null,S=Math.pow(u,_),y=w*8;if(g&&g.length>0){let B;if(g.length===o.length)B=y;else{const C=g.length/8;let D=Math.floor(R*C);D>=C&&(D=C-1),B=D*8}if(M[y]=g[B],M[y+1]=g[B+1],M[y+2]=g[B+2],M[y+3]=g[B+3]*S,M[y+4]=g[B+4]*S,M[y+5]=g[B+5]*S,M[y+6]=g[B+6],M[y+7]=g[B+7],w<e-1){const C=(w+1)/e;let D=0;f==="left_to_right"?D=Math.floor(C*(l-1)):f==="right_to_left"?D=Math.floor((1-C)*(l-1)):f==="center_to_out"?D=Math.floor(Math.abs(C-.5)*2*(l-1)):f==="out_to_center"&&(D=Math.floor((1-Math.abs(C-.5)*2)*(l-1))),D!==_&&(M[y+6]=1)}}else M.set(o.subarray(y,y+8),y),M[y+3]=0,M[y+4]=0,M[y+5]=0,M[y+6]=1}return o._channelDistributions&&(M._channelDistributions=o._channelDistributions),M}else{const{assignedDacs:b}=a||{};let M=new Map,w=0;if(p||h.delayMode==="channel")(m&&m.length>0?m.map(F=>F.originalIndex):b?b.map((F,P)=>P):[0]).forEach((F,P)=>{M.set(F,P),w=Math.max(w,P)});else{const F=(b||[]).length||1;for(let P=0;P<F;P++){let A=P;f==="right_to_left"?A=F-1-P:f==="center_to_out"?A=Math.floor(Math.abs(P-(F-1)/2)):f==="out_to_center"&&(A=Math.min(P,F-1-P)),M.set(P,A),w=Math.max(w,A)}}const R=w+1,x=c*R+1;s.length>x&&(s.length=x);const g=[];for(let v=0;v<R;v++){const F=v*c;g.push({points:F<s.length?s[F]:null,factor:Math.pow(u,v),index:v})}const S=g.reduce((v,F)=>v+(F.points?F.points.length/8:o.length/8),0),y=new Float32Array(S*8);let B=0;const C=new Array(g.length);for(let v=0;v<g.length;v++){const F=g[v],P=F.points,A=P?P.length/8:o.length/8;C[v]=B;for(let I=0;I<A;I++){const E=I*8,L=B+I*8;P?(y[L]=P[E],y[L+1]=P[E+1],y[L+2]=P[E+2],y[L+3]=P[E+3]*F.factor,y[L+4]=P[E+4]*F.factor,y[L+5]=P[E+5]*F.factor,y[L+6]=P[E+6],y[L+7]=P[E+7]):y[L+6]=1}B+=A*8}const D=new Map;return M.forEach((v,F)=>{v<g.length&&D.set(F,{start:C[v],length:g[v].points?g[v].points.length:o.length})}),y._channelDistributions=D,y}}function de(o,e,h,i,n={}){const{mode:a="frame",steps:r,decay:c,speed:u,overlap:f,direction:p,useCustomOrder:m,customOrder:d,playstyle:l="loop"}=h,{progress:s=0,clipDuration:b=1,syncSettings:M={}}=n,w=h.instanceId?`${h.instanceId}.`:"chase.",_=!!M[w+"speed"],R=s!==void 0&&b>0||_;if(a==="frame"){const x=r;let g=(R?s*x:i*.001)*u;if(l==="bounce"){const y=x,B=g%(y*2);g=B>y?y*2-B:B}else l==="once"?g=Math.min(g,x):g=g%x;const S=new Float32Array(o.length);for(let y=0;y<e;y++){const B=y/e;let C=0;p==="left_to_right"?C=Math.min(x-1,Math.floor(B*x)):p==="right_to_left"?C=Math.min(x-1,Math.floor((1-B)*x)):p==="center_to_out"?C=Math.min(x-1,Math.floor(Math.abs(B-.5)*2*x)):p==="out_to_center"&&(C=Math.min(x-1,Math.floor((1-Math.abs(B-.5)*2)*x)));let D=Math.abs(g-C);D>x/2&&(D=x-D);let v=D<f?1-D/f:0;c>0&&(v=Math.pow(v,1-c));const F=y*8;if(S.set(o.subarray(F,F+8),F),S[F+3]*=v,S[F+4]*=v,S[F+5]*=v,v<.05&&(S[F+6]=1),y<e-1){const P=(y+1)/e;let A=0;p==="left_to_right"?A=Math.min(x-1,Math.floor(P*x)):p==="right_to_left"?A=Math.min(x-1,Math.floor((1-P)*x)):p==="center_to_out"?A=Math.min(x-1,Math.floor(Math.abs(P-.5)*2*x)):p==="out_to_center"&&(A=Math.min(x-1,Math.floor((1-Math.abs(P-.5)*2)*x))),A!==C&&(S[F+6]=1)}}return o._channelDistributions&&(S._channelDistributions=o._channelDistributions),S}else{const{assignedDacs:x}=n||{};let g=new Map,S=0;if(m)(d&&d.length>0?d.map(I=>I.originalIndex):x?x.map((I,E)=>E):[0]).forEach((I,E)=>{g.set(I,E),S++});else{S=(x?x.length:1)||1;for(let A=0;A<S;A++){let I=A;p==="right_to_left"?I=S-1-A:p==="center_to_out"?I=Math.floor(Math.abs(A-(S-1)/2)):p==="out_to_center"&&(I=Math.min(A,S-1-A)),g.set(A,I)}}const y=S;let B=(R?s*y:i*.001)*u;if(l==="bounce"){const A=y,I=B%(A*2);B=I>A?A*2-I:I}else l==="once"?B=Math.min(B,y):B=B%y;const C=e*S,D=new Float32Array(C*8),v=new Map;let F=0;const P=Array.from(g.keys());P.length===0&&P.push(0);for(const A of P){const I=g.get(A)||0;let E=Math.abs(B-I);E>y/2&&(E=y-E);let L=E<f?1-E/f:0;c>0&&(L=Math.pow(L,1-c));const k=F;for(let U=0;U<e;U++){const T=U*8,O=F+U*8;D.set(o.subarray(T,T+8),O),D[O+3]*=L,D[O+4]*=L,D[O+5]*=L,L<.05&&(D[O+6]=1)}v.set(A,{start:k,length:e*8}),F+=e*8}return D._channelDistributions=v,D}}function ue(o,e,h=!1){if(!e||!o||!o.points)return o;const{safetyZones:i,outputArea:n,transformationEnabled:a,transformationMode:r,flipX:c,flipY:u}=e;let f=o.points;const p=o.isTypedArray||f instanceof Float32Array,m=p?f.length/8:f.length;let d=h?f:p?new Float32Array(f):f.map(l=>({...l}));for(let l=0;l<m;l++){let s,b,M,w,_,R;if(p?(s=d[l*8],b=d[l*8+1],M=d[l*8+3],w=d[l*8+4],_=d[l*8+5],R=d[l*8+6]):(s=d[l].x,b=d[l].y,M=d[l].r,w=d[l].g,_=d[l].b,R=d[l].blanking?1:0),a&&n){let x=(s+1)/2,g=(1-b)/2;r==="crop"?(x<n.x||x>n.x+n.w||g<n.y||g>n.y+n.h)&&(M=0,w=0,_=0,R=1):r==="scale"&&(x=n.x+x*n.w,g=n.y+g*n.h,s=x*2-1,b=1-g*2)}if(i&&i.length>0){let x=(s+1)/2,g=(1-b)/2;for(const S of i)if(x>=S.x&&x<=S.x+S.w&&g>=S.y&&g<=S.y+S.h){M=0,w=0,_=0,R=1;break}}c&&(s=-s),u&&(b=-b),s=Math.max(-1,Math.min(1,s)),b=Math.max(-1,Math.min(1,b)),p?(d[l*8]=s,d[l*8+1]=b,d[l*8+3]=M,d[l*8+4]=w,d[l*8+5]=_,d[l*8+6]=R):(d[l].x=s,d[l].y=b,d[l].r=M,d[l].g=w,d[l].b=_,d[l].blanking=R>.5)}return{...o,points:d,isTypedArray:p}}const z=.08,H=4,V=.5;function pe(o){if(!o)return new Float32Array(0);const e=o instanceof Float32Array||o.isTypedArray,h=e?o.length/8:o.length;if(h>4e3){if(o instanceof Float32Array)return o;const l=new Float32Array(h*8);for(let s=0;s<h;s++){const b=o[s];l[s*8]=b.x,l[s*8+1]=b.y,l[s*8+2]=b.z||0,l[s*8+3]=b.r,l[s*8+4]=b.g,l[s*8+5]=b.b,l[s*8+6]=b.blanking?1:0,l[s*8+7]=b.lastPoint?1:0}return l}const i=[],n=(l,s,b,M,w,_,R)=>{i.push(l,s,b,M,w,_,R?1:0,0)},a=l=>{if(e){const s=l*8;return{x:o[s],y:o[s+1],z:o[s+2],r:o[s+3],g:o[s+4],b:o[s+5],blanking:o[s+6]>.5}}else{const s=o[l];return{x:s.x||0,y:s.y||0,z:s.z||0,r:s.r||0,g:s.g||0,b:s.b||0,blanking:!!s.blanking}}};if(h===0)return new Float32Array(0);let r=a(0);for(let l=0;l<h;l++){const s=a(l),b=s.x-r.x,M=s.y-r.y,w=Math.sqrt(b*b+M*M),_=s.blanking||r.blanking||w>V;if(_&&!r.blanking&&(n(r.x,r.y,r.z,0,0,0,!0),n(r.x,r.y,r.z,0,0,0,!0)),w>z){const R=Math.floor(w/z);for(let x=1;x<R;x++){const g=x/R,S=r.x+b*g,y=r.y+M*g,B=r.z+(s.z-r.z)*g,C=_?0:s.r,D=_?0:s.g,v=_?0:s.b,F=_||s.blanking;n(S,y,B,C,D,v,F)}}if(r.blanking!==s.blanking){const R=w<.01?1:H;for(let x=0;x<R;x++)n(s.x,s.y,s.z,0,0,0,!0)}n(s.x,s.y,s.z,s.r,s.g,s.b,s.blanking),r=s}const c=a(0),u=c.x-r.x,f=c.y-r.y,p=Math.sqrt(u*u+f*f);if(c.blanking||r.blanking||p>V){if(n(r.x,r.y,r.z,0,0,0,!0),n(r.x,r.y,r.z,0,0,0,!0),p>z){const l=Math.floor(p/z);for(let s=1;s<l;s++){const b=s/l;n(r.x+u*b,r.y+f*b,r.z+(c.z-r.z)*b,0,0,0,!0)}}for(let l=0;l<H;l++)n(c.x,c.y,c.z,0,0,0,!0)}const d=new Float32Array(i);return o._channelDistributions&&(d._channelDistributions=o._channelDistributions),d}class me{constructor(e,h){if(this.canvas=e,this.type=h,this.gl=e.getContext("webgl")||e.getContext("experimental-webgl"),this.animationFrameId=null,this.frameIndexes=Array(10).fill(0),this.pointIndexes=Array(10).fill(0),this.showBeamEffect=!1,this.beamAlpha=.5,this.fadeAlpha=.13,this.beamRenderMode="both",this.positionBuffer=null,this.colorBuffer=null,this.alphaBuffer=null,this.alphaBufferData=new Float32Array(131072),this.lastPointDrawTime=0,!this.gl){console.error("WebGL not supported");return}this.setup()}setup(){const e=this.gl,h=`
      attribute vec2 aPosition;
      attribute vec3 aColor;
      attribute float aAlpha;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
        gl_PointSize = 2.0;
        vColor = aColor;
        vAlpha = aAlpha;
      }
    `,i=`
      precision mediump float;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_FragColor = vec4(vColor, vAlpha);
      }
    `,n=this.createShader(e.VERTEX_SHADER,h),a=this.createShader(e.FRAGMENT_SHADER,i),r=this.createProgram(n,a);this.program=r,this.positionAttributeLocation=e.getAttribLocation(r,"aPosition"),this.colorAttributeLocation=e.getAttribLocation(r,"aColor"),this.alphaAttributeLocation=e.getAttribLocation(r,"aAlpha"),this.quadPositionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.quadPositionBuffer);const c=[-1,-1,1,-1,-1,1,-1,1,1,-1,1,1];e.bufferData(e.ARRAY_BUFFER,new Float32Array(c),e.STATIC_DRAW),this.quadColorUniformLocation=e.getUniformLocation(r,"uColor"),this.quadAlphaUniformLocation=e.getUniformLocation(r,"uAlpha");const u=`
      attribute vec2 aPosition;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
      }
    `,f=`
      precision mediump float;
      uniform vec4 uColor;
      void main() {
        gl_FragColor = uColor;
      }
    `,p=this.createShader(e.VERTEX_SHADER,u),m=this.createShader(e.FRAGMENT_SHADER,f);this.fadeProgram=this.createProgram(p,m),this.fadePositionAttributeLocation=e.getAttribLocation(this.fadeProgram,"aPosition"),this.fadeColorUniformLocation=e.getUniformLocation(this.fadeProgram,"uColor"),e.useProgram(r);const d=131072;this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferData(e.ARRAY_BUFFER,d*2*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),this.colorBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),e.bufferData(e.ARRAY_BUFFER,d*3*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),this.alphaBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.alphaBuffer),e.bufferData(e.ARRAY_BUFFER,d*1*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.clearColor(0,0,0,1)}reset(){this.frameIndexes.fill(0),this.pointIndexes.fill(0),this.clearCanvas()}createShader(e,h){const i=this.gl,n=i.createShader(e);if(i.shaderSource(n,h),i.compileShader(n),i.getShaderParameter(n,i.COMPILE_STATUS))return n;console.error(i.getShaderInfoLog(n)),i.deleteShader(n)}createProgram(e,h){const i=this.gl,n=i.createProgram();if(i.attachShader(n,e),i.attachShader(n,h),i.linkProgram(n),i.getProgramParameter(n,i.LINK_STATUS))return n;console.error(i.getProgramInfoLog(n)),i.deleteProgram(n)}render(e){e.showBeamEffect!==void 0&&this.setBeamEffect(e.showBeamEffect),e.beamAlpha!==void 0&&this.setBeamAlpha(e.beamAlpha),e.fadeAlpha!==void 0&&this.setFadeAlpha(e.fadeAlpha),e.beamRenderMode!==void 0&&(this.beamRenderMode=e.beamRenderMode),this.type==="world"?this.renderWorld(e.worldData,e.previewScanRate,e.layerIntensities,e.masterIntensity,e.dacSettings,e.previewTime,e.fftLevels,e.optimizationEnabled):this.renderSingle(e.ildaFrames,e.previewScanRate,e.intensity,e.effects,e.syncSettings,e.bpm,e.clipDuration,e.progress,e.previewTime,e.fftLevels,e.effectStates,e.optimizationEnabled)}renderSingle(e,h,i,n,a={},r=120,c=1,u=null,f=null,p={low:0,mid:0,high:0},m=null,d=!0){const l=this.gl;if(l.viewport(0,0,l.canvas.width,l.canvas.height),this.drawFadeQuad(),!e||e.length===0)return;const s=this.frameIndexes[0]%e.length,b=e[s],M=u!==null?u:s/e.length,w=f!==null?f:performance.now();this.draw(b,n,this.showBeamEffect,this.beamAlpha,h,this.beamRenderMode,i,0,M,w,a,r,c,p,m,d),this.frameIndexes[0]++,this.frameIndexes[0]>=e.length&&(this.frameIndexes[0]=0)}renderWorld(e,h,i,n,a,r=null,c={low:0,mid:0,high:0},u=!0){const f=this.gl;f.viewport(0,0,f.canvas.width,f.canvas.height),this.drawFadeQuad();const p=r!==null?r:performance.now();e.forEach(m=>{if(m&&m.frames&&m.frames.length>0){const d=m.frames[0];if(d){const l=m.layerIndex||0;if(m.syncSettings,m.bpm,l>=this.frameIndexes.length){const M=l+5;for(;this.frameIndexes.length<M;)this.frameIndexes.push(0),this.pointIndexes.push(0)}const b=(i[l]!==void 0?i[l]:1)*n;if(b>.001){const M=m.progress!==void 0?m.progress:this.frameIndexes[l]%m.frames.length/m.frames.length,{syncSettings:w={},bpm:_=120,clipDuration:R=1,effectStates:x=null}=m;let g=d;if(a){let S=d;if(a.dimmer!==void 0&&a.dimmer<1){const y=d.points,B=d.isTypedArray||y instanceof Float32Array,C=B?y.length/8:y.length,D=B?new Float32Array(y):y.map(v=>({...v}));for(let v=0;v<C;v++)B?(D[v*8+3]*=a.dimmer,D[v*8+4]*=a.dimmer,D[v*8+5]*=a.dimmer):(D[v].r*=a.dimmer,D[v].g*=a.dimmer,D[v].b*=a.dimmer);S={...d,points:D,isTypedArray:t}}g=ue(S,a)}this.draw(g,m.effects,this.showBeamEffect,this.beamAlpha,h,this.beamRenderMode,b,l,M,p,w,_,R,c,x,u)}}}}),e.forEach(m=>{if(m&&m.frames){const d=m.layerIndex||0;this.frameIndexes[d]++,this.frameIndexes[d]>=m.frames.length&&(this.frameIndexes[d]=0)}})}drawFadeQuad(){const e=this.gl;this.fadeProgram&&(e.useProgram(this.fadeProgram),e.bindBuffer(e.ARRAY_BUFFER,this.quadPositionBuffer),e.enableVertexAttribArray(this.fadePositionAttributeLocation),e.vertexAttribPointer(this.fadePositionAttributeLocation,2,e.FLOAT,!1,0,0),e.uniform4f(this.fadeColorUniformLocation,0,0,0,this.fadeAlpha),e.drawArrays(e.TRIANGLES,0,6))}setBeamEffect(e){this.showBeamEffect=e}setBeamAlpha(e){this.beamAlpha=e}setFadeAlpha(e){this.fadeAlpha=e}draw(e,h,i,n,a,r,c=1,u=0,f=0,p=performance.now(),m={},d=120,l=1,s={low:0,mid:0,high:0},b=null,M=!0){if(this.gl,!e||!e.points)return;let w=e;if(M){const F=pe(e.points);w={...e,points:F,isTypedArray:!0}}const _=Q(w,h,{progress:f,time:p,syncSettings:m,bpm:d,clipDuration:l,fftLevels:s,effectStates:b}),R=_.points,x=_.isTypedArray,g=x?R.length/8:R.length;if(g===0)return;const S=Math.max(1,Math.floor(g/a));let y=this.pointIndexes[u]||0;y>=g&&(y=0);const B=F=>{const P=(y+F)%g;if(x){const A=P*8;return{x:R[A],y:R[A+1],r:R[A+3],g:R[A+4],b:R[A+5],blanking:R[A+6]===1}}else{const A=R[P];return{x:A.x,y:A.y,r:A.r,g:A.g,b:A.b,blanking:A.blanking}}},C=()=>{const F=r==="points"||r==="both",P=r==="lines"||r==="both";let A=[],I=[];for(let E=0;E<S;E++){const L=B(E);if(L.blanking){A.length>0&&(P&&this._drawSegment(new Float32Array(A),new Float32Array(I),1,A.length/2,!1),F&&this._drawSegment(new Float32Array(A),new Float32Array(I),1,A.length/2,!0),A=[],I=[]);continue}A.push(L.x,L.y),I.push(L.r/255*c,L.g/255*c,L.b/255*c)}A.length>0&&(P&&this._drawSegment(new Float32Array(A),new Float32Array(I),1,A.length/2,!1),F&&this._drawSegment(new Float32Array(A),new Float32Array(I),1,A.length/2,!0))},D=()=>{const F=[],P=[];for(let A=0;A<S;A++){const I=B(A);if(!I.blanking){F.push(0,0,I.x,I.y);const E=[I.r/255*c,I.g/255*c,I.b/255*c];P.push(...E,...E)}}F.length>0&&this._drawLines(new Float32Array(F),new Float32Array(P),n,F.length/2)},v=()=>{const F=[],P=[];let A=B(0);for(let I=1;I<S;I++){const E=B(I);if(!A.blanking&&!E.blanking){F.push(0,0,A.x,A.y,E.x,E.y);const L=[A.r/255*c,A.g/255*c,A.b/255*c],k=[E.r/255*c,E.g/255*c,E.b/255*c],U=[(L[0]+k[0])/2,(L[1]+k[1])/2,(L[2]+k[2])/2],T=.3,O=[L[0]*T,L[1]*T,L[2]*T],be=[k[0]*T,k[1]*T,k[2]*T];P.push(...U,...O,...be)}A=E}F.length>0&&this._drawTriangles(new Float32Array(F),new Float32Array(P),n,F.length/2)};C(),i&&(r==="points"?D():r==="lines"?v():r==="both"&&(v(),D())),this.pointIndexes[u]=(y+S)%g}_drawSegment(e,h,i,n,a=!1){const r=this.gl;r.useProgram(this.program),r.bindBuffer(r.ARRAY_BUFFER,this.positionBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,e),r.enableVertexAttribArray(this.positionAttributeLocation),r.vertexAttribPointer(this.positionAttributeLocation,2,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,this.colorBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,h),r.enableVertexAttribArray(this.colorAttributeLocation),r.vertexAttribPointer(this.colorAttributeLocation,3,r.FLOAT,!1,0,0),this.alphaBufferData.length<n&&(this.alphaBufferData=new Float32Array(n*2)),this.alphaBufferData.fill(i,0,n);const c=this.alphaBufferData.subarray(0,n);r.bindBuffer(r.ARRAY_BUFFER,this.alphaBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,c),r.enableVertexAttribArray(this.alphaAttributeLocation),r.vertexAttribPointer(this.alphaAttributeLocation,1,r.FLOAT,!1,0,0),r.drawArrays(a?r.POINTS:r.LINE_STRIP,0,n)}_drawLines(e,h,i,n){const a=this.gl;a.useProgram(this.program),a.bindBuffer(a.ARRAY_BUFFER,this.positionBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,e),a.enableVertexAttribArray(this.positionAttributeLocation),a.vertexAttribPointer(this.positionAttributeLocation,2,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.colorBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,h),a.enableVertexAttribArray(this.colorAttributeLocation),a.vertexAttribPointer(this.colorAttributeLocation,3,a.FLOAT,!1,0,0),this.alphaBufferData.length<n&&(this.alphaBufferData=new Float32Array(n*2)),this.alphaBufferData.fill(i,0,n);const r=this.alphaBufferData.subarray(0,n);a.bindBuffer(a.ARRAY_BUFFER,this.alphaBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,r),a.enableVertexAttribArray(this.alphaAttributeLocation),a.vertexAttribPointer(this.alphaAttributeLocation,1,a.FLOAT,!1,0,0),a.drawArrays(a.LINES,0,n)}_drawTriangles(e,h,i,n){const a=this.gl;a.useProgram(this.program),a.bindBuffer(a.ARRAY_BUFFER,this.positionBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,e),a.enableVertexAttribArray(this.positionAttributeLocation),a.vertexAttribPointer(this.positionAttributeLocation,2,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.colorBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,h),a.enableVertexAttribArray(this.colorAttributeLocation),a.vertexAttribPointer(this.colorAttributeLocation,3,a.FLOAT,!1,0,0),this.alphaBufferData.length<n&&(this.alphaBufferData=new Float32Array(n*2)),this.alphaBufferData.fill(i,0,n);const r=this.alphaBufferData.subarray(0,n);a.bindBuffer(a.ARRAY_BUFFER,this.alphaBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,r),a.enableVertexAttribArray(this.alphaAttributeLocation),a.vertexAttribPointer(this.alphaAttributeLocation,1,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,n)}clearCanvas(){const e=this.gl;e.viewport(0,0,e.canvas.width,e.canvas.height),e.clear(e.COLOR_BUFFER_BIT)}destroy(){if(cancelAnimationFrame(this.animationFrameId),this.gl){const e=this.gl.getExtension("WEBGL_losing_context");e&&e.loseContext()}}}const Y=new Map;function G(o,e=0){const h=Y.get(o);if(!h)return;const i=performance.now();h.renderer.render(h.data),e=i,h.animationFrameId=requestAnimationFrame(()=>G(o,e))}self.onmessage=o=>{const{action:e,payload:h}=o.data;if(e==="register"){const{id:i,canvas:n,type:a,data:r}=h,c=new me(n,a),u=requestAnimationFrame(()=>G(i));Y.set(i,{renderer:c,type:a,data:r,animationFrameId:u})}else if(e==="deregister"){const{id:i}=h,n=Y.get(i);n&&(cancelAnimationFrame(n.animationFrameId),Y.delete(i))}else if(e==="update"){const{id:i,data:n}=h,a=Y.get(i);if(a){if(a.data&&a.data.effectStates&&n.effectStates)n.effectStates=a.data.effectStates;else if(a.data&&a.data.worldData&&a.data.worldData.length>0){const r=a.data.worldData[0];if(r&&r.effectStates&&n.worldData){const c=r.effectStates;for(const u of n.worldData)u.effectStates=c}}a.data=n}}else if(e==="clear"){const{id:i}=h,n=Y.get(i);n&&n.renderer.clearCanvas()}}})();
