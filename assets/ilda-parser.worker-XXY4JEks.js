(function(){"use strict";const S=[{r:255,g:0,b:0},{r:255,g:17,b:0},{r:255,g:34,b:0},{r:255,g:51,b:0},{r:255,g:68,b:0},{r:255,g:85,b:0},{r:255,g:102,b:0},{r:255,g:119,b:0},{r:255,g:136,b:0},{r:255,g:153,b:0},{r:255,g:170,b:0},{r:255,g:187,b:0},{r:255,g:204,b:0},{r:255,g:221,b:0},{r:255,g:238,b:0},{r:255,g:255,b:0},{r:255,g:255,b:0},{r:238,g:255,b:0},{r:204,g:255,b:0},{r:170,g:255,b:0},{r:136,g:255,b:0},{r:102,g:255,b:0},{r:68,g:255,b:0},{r:34,g:255,b:0},{r:0,g:255,b:0},{r:0,g:255,b:34},{r:0,g:255,b:68},{r:0,g:255,b:102},{r:0,g:255,b:136},{r:0,g:255,b:170},{r:0,g:255,b:204},{r:0,g:255,b:238},{r:0,g:136,b:255},{r:0,g:119,b:255},{r:0,g:102,b:255},{r:0,g:102,b:255},{r:0,g:85,b:255},{r:0,g:68,b:255},{r:0,g:68,b:255},{r:0,g:34,b:255},{r:0,g:0,b:255},{r:34,g:0,b:255},{r:68,g:0,b:255},{r:102,g:0,b:255},{r:136,g:0,b:255},{r:170,g:0,b:255},{r:204,g:0,b:255},{r:238,g:0,b:255},{r:255,g:0,b:255},{r:255,g:34,b:255},{r:255,g:68,b:255},{r:255,g:102,b:255},{r:255,g:136,b:255},{r:255,g:170,b:255},{r:255,g:204,b:255},{r:255,g:238,b:255},{r:255,g:255,b:255},{r:255,g:238,b:238},{r:255,g:204,b:204},{r:255,g:170,b:170},{r:255,g:136,b:136},{r:255,g:102,b:102},{r:255,g:68,b:68},{r:0,g:34,b:34}],U=new Map;function P(l,i,r,y,f=S){const g=[],t=new DataView(l);let o=0;try{for(let n=0;n<y;n++){if(i===2){o+=r;continue}let m,c,h=0,e,s,p,I;i===0||i===4?(m=t.getInt16(o,!1)/32768,c=t.getInt16(o+2,!1)/32768,h=t.getInt16(o+4,!1)/32768,I=t.getUint8(o+6)):(m=t.getInt16(o,!1)/32768,c=t.getInt16(o+2,!1)/32768,I=t.getUint8(o+4));const u=(I&64)!==0,a=(I&128)!==0;if(u)e=0,s=0,p=0;else if(i===0||i===1){const d=t.getUint8(o+(i===0?7:5)),b=f||S,F=b[d%b.length]||S[0];e=F.r,s=F.g,p=F.b}else(i===4||i===5)&&(p=t.getUint8(o+(i===4?7:5)),s=t.getUint8(o+(i===4?8:6)),e=t.getUint8(o+(i===4?9:7)));if(g.push({x:m,y:c,z:h,r:e===void 0?255:e,g:s===void 0?255:s,b:p===void 0?255:p,blanking:u,lastPoint:a}),o+=r,a)break}}catch(n){console.warn("Parser: Error reading points:",n)}return g}function v(l,i=!1){console.log(`[ilda-parser.worker.js] parseIldaFile - Starting parsing. stopAtFirstFrame=${i}`);const r=new DataView(l);if(l.byteLength<32)return{frames:[],error:"File too small to be a valid ILDA file"};const y=String.fromCharCode(r.getUint8(0),r.getUint8(1),r.getUint8(2),r.getUint8(3));if(y!=="ILDA")return console.warn(`[ilda-parser.worker.js] Parser: Invalid ILDA header signature: ${y}`),{frames:[],error:"Invalid ILDA file header"};const f=[];let g=null,t=0,o=null;for(;t+32<=l.byteLength;){const n=t,m=String.fromCharCode(r.getUint8(n),r.getUint8(n+1),r.getUint8(n+2),r.getUint8(n+3));if(m!=="ILDA"){console.warn(`[ilda-parser.worker.js] Parser: Invalid ILDA signature at offset ${n}, got: ${m}. Skipping 32 bytes.`),t+=32;continue}const c=r.getUint8(n+7);if(g===null&&(g=c),c>5){console.warn(`[ilda-parser.worker.js] Parser: Unknown format code: ${c} at offset ${n}. Skipping 32 bytes.`),t+=32;continue}const h=String.fromCharCode(...new Uint8Array(l,n+8,8)).trim(),e=String.fromCharCode(...new Uint8Array(l,n+16,8)).trim();let s=r.getUint16(n+24,!1);const p=r.getUint16(n+26,!1),I=r.getUint16(n+28,!1),u=r.getUint8(n+30);let a;switch(c){case 0:a=8;break;case 1:a=6;break;case 2:a=4;break;case 4:a=10;break;case 5:a=8;break;default:console.warn(`Parser: Unsupported format ${c}, skipping 32 bytes.`),t+=32;continue}if(c===2){o=[];const x=t+32;for(let k=0;k<s;k++){const w=r.getUint8(x+k*4),D=r.getUint8(x+k*4+1),M=r.getUint8(x+k*4+2);o.push({r:w,g:D,b:M})}}let d=s*a,b=32+d;const F=l.byteLength-t;if(b<F){const x=F-b;x>0&&x<=32&&(console.warn(`Parser: Malformed frame, ${x} leftover bytes. Adjusting size.`),b+=x,d+=x,s=Math.floor(d/a))}if(n+b>l.byteLength){console.warn(`Parser: Incomplete frame data for ${s} points at offset ${n}. Expected ${b} bytes, but only ${l.byteLength-n} bytes remaining. Breaking.`);break}if(s===0){console.log("[ilda-parser.worker.js] Parser: Empty frame, skipping"),t+=b;continue}if(f.push({frameName:h,companyName:e,frameNumber:p,totalFrames:I,scannerHead:u,formatCode:c,recordSize:a,pointCount:s,pointDataOffset:n+32,pointDataSize:d,frameEndOffset:n+b,palette:o,bounds:{minX:0,maxX:0,minY:0,maxY:0}}),t+=b,i&&f.length>0){console.log("[ilda-parser.worker.js] parseIldaFile - stopAtFirstFrame requested, breaking early.");break}}return console.log(`[ilda-parser.worker.js] parseIldaFile - Finished parsing. Found ${f.length} frames.`),{frames:f,error:f.length===0?"No valid frames found":null,firstFormatCode:g,ildaFileBuffer:l}}async function A(l,i=128,r=128){if(!l||l.length===0)return null;const y=new OffscreenCanvas(i,r),f=y.getContext("2d");f.fillStyle="#000000",f.fillRect(0,0,i,r),f.lineWidth=1.5,f.lineCap="round";let g=null,t=null,o=!0;for(let n=0;n<l.length;n++){const m=l[n],c=(m.x+1)*.5*i,h=(1-(m.y+1)*.5)*r;!m.blanking&&!o&&g!==null&&(f.beginPath(),f.moveTo(g,t),f.lineTo(c,h),f.strokeStyle=`rgb(${m.r},${m.g},${m.b})`,f.stroke()),g=c,t=h,o=m.blanking}return y.transferToImageBitmap()}const $=new Map;self.onmessage=async function(l){const{arrayBuffer:i,type:r,fileName:y,filePath:f,layerIndex:g,colIndex:t,workerId:o,frameIndex:n,isStillFrame:m,requestId:c,stopAtFirstFrame:h}=l.data;if(r==="parse-ilda"){if(!i){self.postMessage({success:!1,error:"ArrayBuffer missing for parse-ilda command",type:"parse-ilda"});return}try{console.log("[ilda-parser.worker.js] Calling parseIldaFile for:",y);const e=v(i,h);if(e.error){self.postMessage({success:!1,error:e.error,type:"parse-ilda",fileName:y,filePath:f,layerIndex:g,colIndex:t}),self.postMessage({type:"parsing-status",status:!1,layerIndex:g,colIndex:t});return}const s=`ilda-${Date.now()}-${Math.random().toString(36).substring(2,9)}`;U.set(s,{ildaFileBuffer:e.ildaFileBuffer,framesMetadata:e.frames}),console.log("[ilda-parser.worker.js] Posting success message for parse-ilda."),self.postMessage({success:!0,workerId:s,totalFrames:e.frames.length,ildaFormat:e.firstFormatCode,fileName:y,filePath:f,layerIndex:g,colIndex:t,type:"parse-ilda"}),self.postMessage({type:"parsing-status",status:!1,layerIndex:g,colIndex:t})}catch(e){console.error("[ilda-parser.worker.js] Error parsing file in onmessage handler:",e),self.postMessage({success:!1,error:e.message,type:"parse-ilda"}),self.postMessage({type:"parsing-status",status:!1,layerIndex:g,colIndex:t})}}else if(r==="load-and-parse-ilda"){const e=Math.random().toString(36).substring(2,15);$.set(e,{fileName:y,filePath:f,layerIndex:g,colIndex:t,browserFile:l.data.browserFile,stopAtFirstFrame:h}),g!==void 0&&t!==void 0&&self.postMessage({type:"parsing-status",status:!0,layerIndex:g,colIndex:t});const s=h?65536:null;self.postMessage({type:"request-file-content",filePath:f,requestId:e,maxBytes:s})}else if(r==="file-content-response"){const e=$.get(c);if(!e){console.error(`Worker: No context found for requestId: ${c}`);return}if($.delete(c),l.data.error){console.error(`Worker: Error receiving file content: ${l.data.error}`),self.postMessage({success:!1,error:l.data.error,type:"parse-ilda",...e}),e.layerIndex!==void 0&&e.colIndex!==void 0&&self.postMessage({type:"parsing-status",status:!1,layerIndex:e.layerIndex,colIndex:e.colIndex});return}try{console.log(`[ilda-parser.worker.js] Calling parseIldaFile for: ${e.fileName} (from file-content-response)`);const s=v(i,e.stopAtFirstFrame);if(s.error){self.postMessage({success:!1,error:s.error,type:"parse-ilda",...e}),e.layerIndex!==void 0&&e.colIndex!==void 0&&self.postMessage({type:"parsing-status",status:!1,layerIndex:e.layerIndex,colIndex:e.colIndex});return}const p=`ilda-${Date.now()}-${Math.random().toString(36).substring(2,9)}`;U.set(p,{ildaFileBuffer:s.ildaFileBuffer,framesMetadata:s.frames}),self.postMessage({success:!0,workerId:p,totalFrames:s.frames.length,ildaFormat:s.firstFormatCode,type:"parse-ilda",...e}),e.layerIndex!==void 0&&e.colIndex!==void 0&&self.postMessage({type:"parsing-status",status:!1,layerIndex:e.layerIndex,colIndex:e.colIndex})}catch(s){console.error("[ilda-parser.worker.js] Error parsing file from content response:",s),self.postMessage({success:!1,error:s.message,type:"parse-ilda",...e}),e.layerIndex!==void 0&&e.colIndex!==void 0&&self.postMessage({type:"parsing-status",status:!1,layerIndex:e.layerIndex,colIndex:e.colIndex})}}else if(r==="get-frame"){const{workerId:e,frameIndex:s,isStillFrame:p,layerIndex:I,colIndex:u,browserFile:a,filePath:d}=l.data,b=U.get(e);if(!b){self.postMessage({success:!1,error:"ILDA data not found",type:"get-frame",workerId:e,browserFile:a,filePath:d,layerIndex:I,colIndex:u});return}const{ildaFileBuffer:F,framesMetadata:x}=b,k=Math.floor(s);if(!Number.isFinite(k)||k>=x.length||k<0){self.postMessage({success:!1,error:`Frame index ${s} out of bounds or invalid`,type:"get-frame",workerId:e,browserFile:a,filePath:d,layerIndex:I,colIndex:u});return}const w=x[k];if(!w){self.postMessage({success:!1,error:`Frame metadata not found for index ${k}`,type:"get-frame",workerId:e,browserFile:a,filePath:d,layerIndex:I,colIndex:u});return}let D=w.cachedPoints;if(!D){const M=F.slice(w.pointDataOffset,w.pointDataOffset+w.pointDataSize);D=P(M,w.formatCode,w.recordSize,w.pointCount,w.palette),w.cachedPoints=D}if(a){const M=await A(D);self.postMessage({success:!0,bitmap:M,type:"get-frame",workerId:e,frameIndex:s,isStillFrame:p,layerIndex:I,colIndex:u,browserFile:a,filePath:d},[M])}else{const M={points:D};self.postMessage({success:!0,frame:M,type:"get-frame",workerId:e,frameIndex:s,isStillFrame:p,layerIndex:I,colIndex:u,browserFile:a,filePath:d})}}else if(r==="get-all-frames"){const e=U.get(o);if(!e){self.postMessage({success:!1,error:"ILDA data not found",type:"get-all-frames",workerId:o});return}const{ildaFileBuffer:s,framesMetadata:p}=e,I=[];try{for(let u=0;u<p.length;u++){const a=p[u];let d=a.cachedPoints;if(!d){const b=s.slice(a.pointDataOffset,a.pointDataOffset+a.pointDataSize);d=P(b,a.formatCode,a.recordSize,a.pointCount,a.palette),a.cachedPoints=d}I.push({...a,points:d})}self.postMessage({success:!0,frames:I,type:"get-all-frames",workerId:o,layerIndex:g,colIndex:t})}catch(u){self.postMessage({success:!1,error:u.message,type:"get-all-frames",workerId:o})}}}})();
