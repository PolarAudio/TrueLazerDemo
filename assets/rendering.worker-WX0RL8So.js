(function(){"use strict";const C=[{id:"rotate",name:"Rotate",type:"transform",description:"Rotates the shape around its center.",defaultParams:{angle:0,speed:0,direction:"CW"},paramControls:[{id:"angle",label:"Angle",type:"range",min:0,max:360,step:1},{id:"speed",label:"Speed",type:"range",min:0,max:10,step:.1},{id:"direction",label:"Direction",type:"select",options:["CW","CCW"]}]},{id:"scale",name:"Scale",type:"transform",description:"Scales the shape.",defaultParams:{scaleX:1,scaleY:1},paramControls:[{id:"scaleX",label:"Scale X",type:"range",min:.01,max:5,step:.01},{id:"scaleY",label:"Scale Y",type:"range",min:.01,max:5,step:.01}]},{id:"translate",name:"Translate",type:"transform",description:"Moves the shape.",defaultParams:{translateX:0,translateY:0},paramControls:[{id:"translateX",label:"Translate X",type:"range",min:-1,max:1,step:.01},{id:"translateY",label:"Translate Y",type:"range",min:-1,max:1,step:.01}]},{id:"color",name:"Color",type:"color",description:"Changes the color of the shape with solid or rainbow modes.",defaultParams:{mode:"solid",r:255,g:255,b:255,cycleSpeed:0,rainbowSpread:1,rainbowOffset:0,rainbowPalette:"rainbow"},paramControls:[{id:"mode",label:"Mode",type:"select",options:["solid","rainbow"]},{id:"r",label:"Red",type:"range",min:0,max:255,step:1,showIf:{mode:"solid"}},{id:"g",label:"Green",type:"range",min:0,max:255,step:1,showIf:{mode:"solid"}},{id:"b",label:"Blue",type:"range",min:0,max:255,step:1,showIf:{mode:"solid"}},{id:"cycleSpeed",label:"Cycle Speed",type:"range",min:0,max:10,step:.1},{id:"rainbowSpread",label:"Rainbow Spread",type:"range",min:.1,max:10,step:.1,showIf:{mode:"rainbow"}},{id:"rainbowOffset",label:"Rainbow Offset",type:"range",min:0,max:360,step:1,showIf:{mode:"rainbow"}},{id:"rainbowPalette",label:"Palette",type:"select",options:["rainbow","fire","ice","cyber"],showIf:{mode:"rainbow"}}]},{id:"wave",name:"Wave",type:"animation",description:"Applies a wave distortion to the shape.",defaultParams:{amplitude:.1,frequency:10,speed:1,direction:"x"},paramControls:[{id:"amplitude",label:"Amplitude",type:"range",min:.01,max:1,step:.01},{id:"frequency",label:"Frequency",type:"range",min:1,max:50,step:1},{id:"speed",label:"Speed",type:"range",min:.1,max:10,step:.1},{id:"direction",label:"Direction",type:"select",options:["x","y"]}]},{id:"warp",name:"Warp",type:"animation",description:"Symmetrical chaotic wave distortion.",defaultParams:{amount:.1,chaos:.5,speed:1},paramControls:[{id:"amount",label:"Amount",type:"range",min:0,max:1,step:.01},{id:"chaos",label:"Chaos",type:"range",min:0,max:1,step:.01},{id:"speed",label:"Speed",type:"range",min:.1,max:10,step:.1}]},{id:"distortion",name:"Distortion",type:"transform",description:"Distorts the point data.",defaultParams:{amount:.1,scale:10,speed:.5},paramControls:[{id:"amount",label:"Amount",type:"range",min:0,max:1,step:.01},{id:"scale",label:"Scale",type:"range",min:1,max:50,step:1},{id:"speed",label:"Speed",type:"range",min:0,max:5,step:.1}]},{id:"move",name:"Move (Bounce)",type:"transform",description:"Moves points and bounces them off the borders.",defaultParams:{speedX:.1,speedY:.1},paramControls:[{id:"speedX",label:"Speed X",type:"range",min:0,max:2,step:.01},{id:"speedY",label:"Speed Y",type:"range",min:0,max:2,step:.01}]},{id:"delay",name:"Delay",type:"effect",description:"Frame or Channel based delay effect.",defaultParams:{mode:"frame",playstyle:"repeat",useCustomOrder:!1,delayDirection:"left_to_right",delayAmount:5,decay:.8,customOrder:[],enabled:!0},paramControls:[{id:"mode",label:"Mode",type:"select",options:["frame","channel"]},{id:"playstyle",label:"Playstyle",type:"select",options:["once","repeat","bounce"]},{id:"useCustomOrder",label:"Custom Order",type:"checkbox",showIf:{mode:"channel"}},{id:"delayDirection",label:"Direction",type:"select",options:["center_to_out","out_to_center","left_to_right","right_to_left"],showIf:{useCustomOrder:!1}},{id:"delayAmount",label:"Delay Time",type:"range",min:1,max:60,step:1},{id:"decay",label:"Decay",type:"range",min:0,max:1,step:.01}]},{id:"chase",name:"Chase",type:"effect",description:"Frame or Channel based chase effect.",defaultParams:{mode:"frame",playstyle:"repeat",steps:4,decay:.8,speed:1,overlap:1,direction:"left_to_right",useCustomOrder:!1,customOrder:[],enabled:!0},paramControls:[{id:"mode",label:"Mode",type:"select",options:["frame","channel"]},{id:"playstyle",label:"Playstyle",type:"select",options:["once","repeat","bounce"]},{id:"steps",label:"Steps",type:"range",min:2,max:16,step:1},{id:"decay",label:"Decay",type:"range",min:0,max:1,step:.01},{id:"speed",label:"Speed",type:"range",min:.1,max:5,step:.1},{id:"overlap",label:"Overlap",type:"range",min:1,max:4,step:1},{id:"useCustomOrder",label:"Custom Order",type:"checkbox",showIf:{mode:"channel"}},{id:"direction",label:"Direction",type:"select",options:["center_to_out","out_to_center","left_to_right","right_to_left"],showIf:{useCustomOrder:!1}}]},{id:"blanking",name:"Blanking",type:"animation",description:"Controls the blanking of the laser output.",defaultParams:{blankingInterval:0,spacing:0},paramControls:[{id:"blankingInterval",label:"Blanking Interval",type:"range",min:0,max:10,step:1},{id:"spacing",label:"Spacing",type:"range",min:0,max:20,step:1}]},{id:"strobe",name:"Strobe",type:"animation",description:"Applies a strobe effect to the laser output.",defaultParams:{strobeSpeed:100,strobeAmount:.5},paramControls:[{id:"strobeSpeed",label:"Strobe Speed (ms)",type:"range",min:10,max:1e3,step:10},{id:"strobeAmount",label:"Strobe Amount (0-1)",type:"range",min:0,max:1,step:.01}]},{id:"mirror",name:"Mirror",type:"transform",description:"Mirrors the shape from the center.",defaultParams:{mode:"none"},paramControls:[{id:"mode",label:"Mirror Mode",type:"select",options:["none","x+","x-","y+","y-"]}]}],I=(s,e)=>({...e,...s});function O(s,e,p,a){if(!p)return e;const n=typeof p=="string"?{syncMode:p}:p;if(!n.syncMode)return e;const{time:t,progress:r=0,bpm:l=120,clipDuration:i=0,fftLevels:o={low:0,mid:0,high:0}}=a;let h=0;const f=n.speedMultiplier||1;if(n.syncMode==="fps")h=t*.001*f;else if(n.syncMode==="timeline"){const y=Math.max(.01,n.duration||1);i>0?h=r*i/y*f:h=0}else if(n.syncMode==="bpm"){const y=Math.max(.1,n.beats||4),g=l/60,A=y/(g||2);i>0?h=r*i/A*f:h=0}else if(n.syncMode==="fft"){const y=n.fftRange||"low",g=o[y]||0;return U(g,e,n)}const c=n.direction||"forward";if(c==="pause")return e;const d=n.style||"loop";let m=0;if(d==="once")m=Math.min(h,1),c==="backward"&&(m=1-m);else if(d==="bounce"){let y=h%1;Math.floor(h)%2===1?m=1-y:m=y,c==="backward"&&(m=1-m)}else m=h%1,c==="backward"&&(m=1-m);const u=n.range;let R=0,x=1;if(u&&Array.isArray(u)&&u.length===2)R=u[0],x=u[1];else return e;return R+(x-R)*m}function U(s,e,p){const a=p.range;return a&&Array.isArray(a)&&a.length===2?a[0]+(a[1]-a[0])*s:e}function N(s,e,p={}){const{progress:a=0,time:n=performance.now(),effectStates:t,syncSettings:r={},fftLevels:l}=p;if(!e||e.length===0)return s;let i;if(Array.isArray(s.points)){i=new Float32Array(s.points.length*8);for(let f=0;f<s.points.length;f++){const c=s.points[f],d=f*8;i[d]=c.x,i[d+1]=c.y,i[d+2]=c.z||0,i[d+3]=c.r,i[d+4]=c.g,i[d+5]=c.b,i[d+6]=c.blanking?1:0,i[d+7]=c.lastPoint?1:0}}else i=new Float32Array(s.points);let o=i;const h=()=>o.length/8;for(const f of e){if(f.params.enabled===!1||!C.find(m=>m.id===f.id))continue;const d={...f.params};for(const m of Object.keys(d)){const u=`${f.id}.${m}`;r[u]&&(d[m]=O(m,d[m],r[u],p))}switch(f.id){case"rotate":X(o,h(),d,a,n);break;case"scale":W(o,h(),d);break;case"translate":V(o,h(),d);break;case"color":q(o,h(),d,n);break;case"wave":G(o,h(),d,n);break;case"blanking":H(o,h(),d);break;case"strobe":Q(o,h(),d,n);break;case"mirror":o=K(o,h(),d);break;case"warp":$(o,h(),d,n);break;case"distortion":j(o,h(),d,n);break;case"move":Z(o,h(),d,n);break;case"delay":t&&f.instanceId&&(o=J(o,h(),d,t,f.instanceId,p));break;case"chase":o=ee(o,h(),d,n,p);break}}return{...s,points:o,isTypedArray:!0}}function X(s,e,p,a,n){const{angle:t,speed:r,direction:l}=I(p,C.find(d=>d.id==="rotate").defaultParams),i=l==="CCW"?-1:1,o=n*.001*r*i,h=t*Math.PI/180+o,f=Math.sin(h),c=Math.cos(h);for(let d=0;d<e;d++){const m=d*8,u=s[m],R=s[m+1];s[m]=u*c-R*f,s[m+1]=u*f+R*c}}function W(s,e,p){const{scaleX:a,scaleY:n}=I(p,C.find(t=>t.id==="scale").defaultParams);for(let t=0;t<e;t++){const r=t*8;s[r]*=a,s[r+1]*=n}}function V(s,e,p){const{translateX:a,translateY:n}=I(p,C.find(t=>t.id==="translate").defaultParams);for(let t=0;t<e;t++){const r=t*8;s[r]+=a,s[r+1]+=n}}function q(s,e,p,a){const{mode:n,r:t,g:r,b:l,cycleSpeed:i,rainbowSpread:o,rainbowOffset:h,rainbowPalette:f}=I(p,C.find(d=>d.id==="color").defaultParams),c=a*.001*i;if(n==="rainbow"){const d=f||"rainbow";for(let m=0;m<e;m++){const u=m*8,R=(m/e*o+c*.5+h/360)%1;let x,y,g;d==="rainbow"?[x,y,g]=k(R,1,.5):[x,y,g]=z(d,R),s[u+3]=x,s[u+4]=y,s[u+5]=g}}else if(i>0){const d=c*50%360,[m,u,R]=k(d/360,1,.5);for(let x=0;x<e;x++){const y=x*8;s[y+3]=m,s[y+4]=u,s[y+5]=R}}else for(let d=0;d<e;d++){const m=d*8;s[m+3]=t,s[m+4]=r,s[m+5]=l}}function z(s,e){const p={fire:[{r:255,g:0,b:0},{r:255,g:128,b:0},{r:255,g:255,b:0},{r:255,g:0,b:0}],ice:[{r:0,g:0,b:255},{r:0,g:255,b:255},{r:255,g:255,b:255},{r:0,g:0,b:255}],cyber:[{r:255,g:0,b:255},{r:0,g:255,b:255},{r:0,g:0,b:255},{r:255,g:0,b:255}]},a=p[s]||p.fire,n=e*(a.length-1),t=Math.floor(n),r=n-t,l=a[t],i=a[t+1]||a[t];return[Math.round(l.r+(i.r-l.r)*r),Math.round(l.g+(i.g-l.g)*r),Math.round(l.b+(i.b-l.b)*r)]}function k(s,e,p){let a,n,t;{const r=(o,h,f)=>(f<0&&(f+=1),f>1&&(f-=1),f<.16666666666666666?o+(h-o)*6*f:f<.5?h:f<.6666666666666666?o+(h-o)*(.6666666666666666-f)*6:o),l=p+e-p*e,i=2*p-l;a=r(i,l,s+1/3),n=r(i,l,s),t=r(i,l,s-1/3)}return[Math.round(a*255),Math.round(n*255),Math.round(t*255)]}function G(s,e,p,a){const{amplitude:n,frequency:t,speed:r,direction:l}=I(p,C.find(o=>o.id==="wave").defaultParams),i=a*.001*r;for(let o=0;o<e;o++){const h=o*8;l==="x"?s[h+1]+=n*Math.sin(s[h]*t+i):l==="y"&&(s[h]+=n*Math.sin(s[h+1]*t+i))}}function H(s,e,p){const{blankingInterval:a,spacing:n=0}=I(p,C.find(r=>r.id==="blanking").defaultParams);if(a<=0)return;const t=a+1+n;for(let r=0;r<e;r++)r%t>=a&&(s[r*8+6]=1)}function Q(s,e,p,a){const{strobeSpeed:n,strobeAmount:t}=I(p,C.find(l=>l.id==="strobe").defaultParams);if(a%n/n<t)for(let l=0;l<e;l++)s[l*8+6]=1}function K(s,e,p){const{mode:a}=I(p,C.find(i=>i.id==="mirror").defaultParams);if(a==="none")return s;let n=[];for(let i=0;i<e;i++){const o=i*8,h=s[o],f=s[o+1];let c=!1;a==="x-"&&(h<=0||a==="x+"&&(h>=0||a==="y-"&&(f<=0||a==="y+"&&f>=0)))&&(c=!0),c&&n.push({x:s[o],y:s[o+1],z:s[o+2],r:s[o+3],g:s[o+4],b:s[o+5],blk:s[o+6],last:s[o+7]})}const t=n.length*2,r=new Float32Array(t*8);let l=0;for(const i of n)r[l++]=i.x,r[l++]=i.y,r[l++]=i.z,r[l++]=i.r,r[l++]=i.g,r[l++]=i.b,r[l++]=i.blk,r[l++]=i.last;for(const i of n)a==="x-"||a==="x+"?r[l++]=-i.x:r[l++]=i.x,a==="y-"||a==="y+"?r[l++]=-i.y:r[l++]=i.y,r[l++]=i.z,r[l++]=i.r,r[l++]=i.g,r[l++]=i.b,r[l++]=i.blk,r[l++]=i.last;return r}function $(s,e,p,a){const{amount:n,chaos:t,speed:r}=I(p,C.find(i=>i.id==="warp").defaultParams),l=a*.001*r;for(let i=0;i<e;i++){const o=i*8,h=s[o],f=s[o+1],c=Math.abs(f);s[o]+=Math.sin(c*10*(1+t)+l)*n*Math.cos(l*t),s[o+1]+=Math.cos(Math.abs(h)*10*(1+t)+l)*n*Math.sin(l*t)}}function j(s,e,p,a){const{amount:n,scale:t,speed:r}=I(p,C.find(i=>i.id==="distortion").defaultParams),l=a*.001*r;for(let i=0;i<e;i++){const o=i*8,h=Math.sin(s[o]*t+l)*Math.cos(s[o+1]*t-l),f=Math.cos(s[o]*t-l)*Math.sin(s[o+1]*t+l);s[o]+=h*n,s[o+1]+=f*n}}function Z(s,e,p,a){const{speedX:n,speedY:t}=I(p,C.find(h=>h.id==="move").defaultParams),r=a*.001,l=r*n,i=r*t,o=4;for(let h=0;h<e;h++){const f=h*8;let c=s[f]+l,d=s[f+1]+i,m=(c+1)%o;m<0&&(m+=o),m>2&&(m=4-m),c=m-1;let u=(d+1)%o;u<0&&(u+=o),u>2&&(u=4-u),d=u-1,s[f]=c,s[f+1]=d}}function J(s,e,p,a,n,t){const{mode:r="frame",delayAmount:l,decay:i,delayDirection:o,useCustomOrder:h,customOrder:f}=I(p,C.find(d=>d.id==="delay").defaultParams);a.has(n)||a.set(n,[]);const c=a.get(n);if(c.unshift(new Float32Array(s)),r==="frame"){const m=l*10+1;c.length>m&&(c.length=m);const u=new Float32Array(s.length);for(let R=0;R<e;R++){let x=0;const y=R/e;o==="left_to_right"?x=Math.floor(y*9):o==="right_to_left"?x=Math.floor((1-y)*9):o==="center_to_out"?x=Math.floor(Math.abs(y-.5)*2*9):o==="out_to_center"&&(x=Math.floor((1-Math.abs(y-.5)*2)*9));const g=x*l,A=g<c.length?c[g]:null,S=Math.pow(i,x),P=R*8;A&&A.length===s.length?(u[P]=A[P],u[P+1]=A[P+1],u[P+2]=A[P+2],u[P+3]=A[P+3]*S,u[P+4]=A[P+4]*S,u[P+5]=A[P+5]*S,u[P+6]=A[P+6],u[P+7]=A[P+7]):(u.set(s.subarray(P,P+8),P),u[P+3]=0,u[P+4]=0,u[P+5]=0,u[P+6]=1)}return u}else{const{assignedDacs:d}=t||{};let m=new Map,u=0;if(h||p.delayMode==="channel")(f&&f.length>0?f.map(b=>b.originalIndex):d?d.map((b,w)=>w):[0]).forEach((b,w)=>{m.set(b,w),u=Math.max(u,w)});else{const b=(d||[]).length||1;for(let w=0;w<b;w++){let M=w;o==="right_to_left"?M=b-1-w:o==="center_to_out"?M=Math.floor(Math.abs(w-(b-1)/2)):o==="out_to_center"&&(M=Math.min(w,b-1-w)),m.set(w,M),u=Math.max(u,M)}}const x=u+1,y=l*x+1;c.length>y&&(c.length=y);const g=[];for(let F=0;F<x;F++){const b=F*l;g.push({points:b<c.length?c[b]:null,factor:Math.pow(i,F),index:F})}const A=g.reduce((F,b)=>F+(b.points?b.points.length/8:s.length/8),0),S=new Float32Array(A*8);let P=0;const B=new Array(g.length);for(let F=0;F<g.length;F++){const b=g[F],w=b.points,M=w?w.length/8:s.length/8;B[F]=P;for(let v=0;v<M;v++){const E=v*8,L=P+v*8;w?(S[L]=w[E],S[L+1]=w[E+1],S[L+2]=w[E+2],S[L+3]=w[E+3]*b.factor,S[L+4]=w[E+4]*b.factor,S[L+5]=w[E+5]*b.factor,S[L+6]=w[E+6],S[L+7]=w[E+7]):S[L+6]=1}P+=M*8}const _=new Map;return m.forEach((F,b)=>{F<g.length&&_.set(b,{start:B[F],length:g[F].points?g[F].points.length:s.length})}),S._channelDistributions=_,S}}function ee(s,e,p,a,n={}){const{mode:t="frame",steps:r,decay:l,speed:i,overlap:o,direction:h,useCustomOrder:f,customOrder:c}=I(p,C.find(d=>d.id==="chase").defaultParams);if(t==="frame"){const d=a*.001*i%r,m=new Float32Array(s.length);for(let u=0;u<e;u++){const R=u/e;let x=0;h==="left_to_right"?x=Math.floor(R*(r-1)):h==="right_to_left"?x=Math.floor((1-R)*(r-1)):h==="center_to_out"?x=Math.floor(Math.abs(R-.5)*2*(r-1)):h==="out_to_center"&&(x=Math.floor((1-Math.abs(R-.5)*2)*(r-1)));let y=Math.abs(d-x);y>r/2&&(y=r-y);let g=y<o?1-y/o:0;l>0&&(g=Math.pow(g,1-l));const A=u*8;m.set(s.subarray(A,A+8),A),m[A+3]*=g,m[A+4]*=g,m[A+5]*=g,g<.05&&(m[A+6]=1)}return m}else{const{assignedDacs:d}=n||{};let m=new Map,u=0;if(f)(c&&c.length>0?c.map(_=>_.originalIndex):d?d.map((_,F)=>F):[0]).forEach((_,F)=>{m.set(_,F),u++});else{u=(d?d.length:1)||1;for(let B=0;B<u;B++){let _=B;h==="right_to_left"?_=u-1-B:h==="center_to_out"?_=Math.floor(Math.abs(B-(u-1)/2)):h==="out_to_center"&&(_=Math.min(B,u-1-B)),m.set(B,_)}}const R=u,x=a*.001*i%R,y=e*u,g=new Float32Array(y*8),A=new Map;let S=0;const P=Array.from(m.keys());P.length===0&&P.push(0);for(const B of P){const _=m.get(B)||0;let F=Math.abs(x-_);F>R/2&&(F=R-F);let b=F<o?1-F/o:0;l>0&&(b=Math.pow(b,1-l));const w=S;for(let M=0;M<e;M++){const v=M*8,E=S+M*8;g.set(s.subarray(v,v+8),E),g[E+3]*=b,g[E+4]*=b,g[E+5]*=b,b<.05&&(g[E+6]=1)}A.set(B,{start:w,length:e}),S+=e*8}return g._channelDistributions=A,g}}function te(s,e){if(!e||!s||!s.points)return s;const{safetyZones:p,outputArea:a,transformationEnabled:n,transformationMode:t,flipX:r,flipY:l}=e;let i=s.points;const o=s.isTypedArray||i instanceof Float32Array,h=o?i.length/8:i.length;let f=o?new Float32Array(i):i.map(c=>({...c}));for(let c=0;c<h;c++){let d,m,u,R,x,y;if(o?(d=f[c*8],m=f[c*8+1],u=f[c*8+3],R=f[c*8+4],x=f[c*8+5],y=f[c*8+6]):(d=f[c].x,m=f[c].y,u=f[c].r,R=f[c].g,x=f[c].b,y=f[c].blanking?1:0),r&&(d=-d),l&&(m=-m),n&&a){let g=(d+1)/2,A=(1-m)/2;t==="crop"?(g<a.x||g>a.x+a.w||A<a.y||A>a.y+a.h)&&(u=0,R=0,x=0,y=1):t==="scale"&&(g=a.x+g*a.w,A=a.y+A*a.h,d=g*2-1,m=1-A*2)}if(p&&p.length>0){let g=(d+1)/2,A=(1-m)/2;for(const S of p)if(g>=S.x&&g<=S.x+S.w&&A>=S.y&&A<=S.y+S.h){u=0,R=0,x=0,y=1;break}}o?(f[c*8]=d,f[c*8+1]=m,f[c*8+3]=u,f[c*8+4]=R,f[c*8+5]=x,f[c*8+6]=y):(f[c].x=d,f[c].y=m,f[c].r=u,f[c].g=R,f[c].b=x,f[c].blanking=y>.5)}return{...s,points:f,isTypedArray:o}}class re{constructor(e,p){if(this.canvas=e,this.type=p,this.gl=e.getContext("webgl")||e.getContext("experimental-webgl"),this.animationFrameId=null,this.frameIndexes=Array(10).fill(0),this.pointIndexes=Array(10).fill(0),this.showBeamEffect=!1,this.beamAlpha=.5,this.fadeAlpha=.13,this.beamRenderMode="both",this.positionBuffer=null,this.colorBuffer=null,this.alphaBuffer=null,this.lastPointDrawTime=0,!this.gl){console.error("WebGL not supported");return}this.setup()}setup(){const e=this.gl,p=`
      attribute vec2 aPosition;
      attribute vec3 aColor;
      attribute float aAlpha;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
        gl_PointSize = 2.0;
        vColor = aColor;
        vAlpha = aAlpha;
      }
    `,a=`
      precision mediump float;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_FragColor = vec4(vColor, vAlpha);
      }
    `,n=this.createShader(e.VERTEX_SHADER,p),t=this.createShader(e.FRAGMENT_SHADER,a),r=this.createProgram(n,t);this.program=r,this.positionAttributeLocation=e.getAttribLocation(r,"aPosition"),this.colorAttributeLocation=e.getAttribLocation(r,"aColor"),this.alphaAttributeLocation=e.getAttribLocation(r,"aAlpha"),this.quadPositionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.quadPositionBuffer);const l=[-1,-1,1,-1,-1,1,-1,1,1,-1,1,1];e.bufferData(e.ARRAY_BUFFER,new Float32Array(l),e.STATIC_DRAW),this.quadColorUniformLocation=e.getUniformLocation(r,"uColor"),this.quadAlphaUniformLocation=e.getUniformLocation(r,"uAlpha");const i=`
      attribute vec2 aPosition;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
      }
    `,o=`
      precision mediump float;
      uniform vec4 uColor;
      void main() {
        gl_FragColor = uColor;
      }
    `,h=this.createShader(e.VERTEX_SHADER,i),f=this.createShader(e.FRAGMENT_SHADER,o);this.fadeProgram=this.createProgram(h,f),this.fadePositionAttributeLocation=e.getAttribLocation(this.fadeProgram,"aPosition"),this.fadeColorUniformLocation=e.getUniformLocation(this.fadeProgram,"uColor"),e.useProgram(r);const c=131072;this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferData(e.ARRAY_BUFFER,c*2*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),this.colorBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),e.bufferData(e.ARRAY_BUFFER,c*3*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),this.alphaBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.alphaBuffer),e.bufferData(e.ARRAY_BUFFER,c*1*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.clearColor(0,0,0,1)}reset(){this.frameIndexes.fill(0),this.pointIndexes.fill(0),this.clearCanvas()}createShader(e,p){const a=this.gl,n=a.createShader(e);if(a.shaderSource(n,p),a.compileShader(n),a.getShaderParameter(n,a.COMPILE_STATUS))return n;console.error(a.getShaderInfoLog(n)),a.deleteShader(n)}createProgram(e,p){const a=this.gl,n=a.createProgram();if(a.attachShader(n,e),a.attachShader(n,p),a.linkProgram(n),a.getProgramParameter(n,a.LINK_STATUS))return n;console.error(a.getProgramInfoLog(n)),a.deleteProgram(n)}render(e){e.showBeamEffect!==void 0&&this.setBeamEffect(e.showBeamEffect),e.beamAlpha!==void 0&&this.setBeamAlpha(e.beamAlpha),e.fadeAlpha!==void 0&&this.setFadeAlpha(e.fadeAlpha),e.beamRenderMode!==void 0&&(this.beamRenderMode=e.beamRenderMode),this.type==="world"?this.renderWorld(e.worldData,e.previewScanRate,e.layerIntensities,e.masterIntensity,e.dacSettings,e.previewTime):this.renderSingle(e.ildaFrames,e.previewScanRate,e.intensity,e.effects,e.syncSettings,e.bpm,e.clipDuration,e.progress,e.previewTime)}renderSingle(e,p,a,n,t={},r=120,l=1,i=null,o=null){const h=this.gl;if(h.viewport(0,0,h.canvas.width,h.canvas.height),this.drawFadeQuad(),!e||e.length===0)return;const f=this.frameIndexes[0]%e.length,c=e[f],d=i!==null?i:f/e.length,m=o!==null?o:performance.now();this.draw(c,n,this.showBeamEffect,this.beamAlpha,p,this.beamRenderMode,a,0,d,m,t,r,l),this.frameIndexes[0]++,this.frameIndexes[0]>=e.length&&(this.frameIndexes[0]=0)}renderWorld(e,p,a,n,t,r=null){const l=this.gl;l.viewport(0,0,l.canvas.width,l.canvas.height),this.drawFadeQuad();const i=r!==null?r:performance.now();e.forEach(o=>{if(o&&o.frames&&o.frames.length>0){const h=o.frames[0];if(h){const f=o.layerIndex||0;if(o.syncSettings,o.bpm,f>=this.frameIndexes.length){const m=f+5;for(;this.frameIndexes.length<m;)this.frameIndexes.push(0),this.pointIndexes.push(0)}const d=(a[f]!==void 0?a[f]:1)*n;if(d>.001){const m=o.progress!==void 0?o.progress:this.frameIndexes[f]%o.frames.length/o.frames.length,{syncSettings:u={},bpm:R=120,clipDuration:x=1}=o;let y=h;if(t){let g=h;if(t.dimmer!==void 0&&t.dimmer<1){const A=h.points,S=h.isTypedArray||A instanceof Float32Array,P=S?A.length/8:A.length,B=S?new Float32Array(A):A.map(_=>({..._}));for(let _=0;_<P;_++)S?(B[_*8+3]*=t.dimmer,B[_*8+4]*=t.dimmer,B[_*8+5]*=t.dimmer):(B[_].r*=t.dimmer,B[_].g*=t.dimmer,B[_].b*=t.dimmer);g={...h,points:B,isTypedArray:S}}y=te(g,t)}this.draw(y,o.effects,this.showBeamEffect,this.beamAlpha,p,this.beamRenderMode,d,f,m,i,u,R,x)}}}}),e.forEach(o=>{if(o&&o.frames){const h=o.layerIndex||0;this.frameIndexes[h]++,this.frameIndexes[h]>=o.frames.length&&(this.frameIndexes[h]=0)}})}drawFadeQuad(){const e=this.gl;this.fadeProgram&&(e.useProgram(this.fadeProgram),e.bindBuffer(e.ARRAY_BUFFER,this.quadPositionBuffer),e.enableVertexAttribArray(this.fadePositionAttributeLocation),e.vertexAttribPointer(this.fadePositionAttributeLocation,2,e.FLOAT,!1,0,0),e.uniform4f(this.fadeColorUniformLocation,0,0,0,this.fadeAlpha),e.drawArrays(e.TRIANGLES,0,6))}setBeamEffect(e){this.showBeamEffect=e}setBeamAlpha(e){this.beamAlpha=e}setFadeAlpha(e){this.fadeAlpha=e}draw(e,p,a,n,t,r,l=1,i=0,o=0,h=performance.now(),f={},c=120,d=1){if(this.gl,!e||!e.points)return;const m=N(e,p,{progress:o,time:h,syncSettings:f,bpm:c,clipDuration:d}),u=m.points,R=m.isTypedArray,x=R?u.length/8:u.length;if(x===0)return;const y=Math.max(1,Math.floor(x/t));let g=this.pointIndexes[i]||0;g>=x&&(g=0);const A=_=>{const F=(g+_)%x;if(R){const b=F*8;return{x:u[b],y:u[b+1],r:u[b+3],g:u[b+4],b:u[b+5],blanking:u[b+6]===1}}else{const b=u[F];return{x:b.x,y:b.y,r:b.r,g:b.g,b:b.b,blanking:b.blanking}}},S=()=>{const _=r==="points"||r==="both",F=r==="lines"||r==="both";let b=[],w=[];for(let M=0;M<y;M++){const v=A(M);if(v.blanking){b.length>0&&(F&&this._drawSegment(new Float32Array(b),new Float32Array(w),1,b.length/2,!1),_&&this._drawSegment(new Float32Array(b),new Float32Array(w),1,b.length/2,!0),b=[],w=[]);continue}b.push(v.x,v.y),w.push(v.r/255*l,v.g/255*l,v.b/255*l)}b.length>0&&(F&&this._drawSegment(new Float32Array(b),new Float32Array(w),1,b.length/2,!1),_&&this._drawSegment(new Float32Array(b),new Float32Array(w),1,b.length/2,!0))},P=()=>{const _=[],F=[];for(let b=0;b<y;b++){const w=A(b);if(!w.blanking){_.push(0,0,w.x,w.y);const M=[w.r/255*l,w.g/255*l,w.b/255*l];F.push(...M,...M)}}_.length>0&&this._drawLines(new Float32Array(_),new Float32Array(F),n,_.length/2)},B=()=>{const _=[],F=[];let b=A(0);for(let w=1;w<y;w++){const M=A(w);if(!b.blanking&&!M.blanking){_.push(0,0,b.x,b.y,M.x,M.y);const v=[b.r/255*l,b.g/255*l,b.b/255*l],E=[M.r/255*l,M.g/255*l,M.b/255*l],L=[(v[0]+E[0])/2,(v[1]+E[1])/2,(v[2]+E[2])/2],D=.3,ae=[v[0]*D,v[1]*D,v[2]*D],oe=[E[0]*D,E[1]*D,E[2]*D];F.push(...L,...ae,...oe)}b=M}_.length>0&&this._drawTriangles(new Float32Array(_),new Float32Array(F),n,_.length/2)};S(),a&&(r==="points"?P():r==="lines"?B():r==="both"&&(B(),P())),this.pointIndexes[i]=(g+y)%x}_drawSegment(e,p,a,n,t=!1){const r=this.gl;r.useProgram(this.program),r.bindBuffer(r.ARRAY_BUFFER,this.positionBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,e),r.enableVertexAttribArray(this.positionAttributeLocation),r.vertexAttribPointer(this.positionAttributeLocation,2,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,this.colorBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,p),r.enableVertexAttribArray(this.colorAttributeLocation),r.vertexAttribPointer(this.colorAttributeLocation,3,r.FLOAT,!1,0,0);const l=new Float32Array(Array(n).fill(a));r.bindBuffer(r.ARRAY_BUFFER,this.alphaBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,l),r.enableVertexAttribArray(this.alphaAttributeLocation),r.vertexAttribPointer(this.alphaAttributeLocation,1,r.FLOAT,!1,0,0),r.drawArrays(t?r.POINTS:r.LINE_STRIP,0,n)}_drawLines(e,p,a,n){const t=this.gl;t.useProgram(this.program),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,e),t.enableVertexAttribArray(this.positionAttributeLocation),t.vertexAttribPointer(this.positionAttributeLocation,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,p),t.enableVertexAttribArray(this.colorAttributeLocation),t.vertexAttribPointer(this.colorAttributeLocation,3,t.FLOAT,!1,0,0);const r=new Float32Array(Array(n).fill(a));t.bindBuffer(t.ARRAY_BUFFER,this.alphaBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,r),t.enableVertexAttribArray(this.alphaAttributeLocation),t.vertexAttribPointer(this.alphaAttributeLocation,1,t.FLOAT,!1,0,0),t.drawArrays(t.LINES,0,n)}_drawTriangles(e,p,a,n){const t=this.gl;t.useProgram(this.program),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,e),t.enableVertexAttribArray(this.positionAttributeLocation),t.vertexAttribPointer(this.positionAttributeLocation,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,p),t.enableVertexAttribArray(this.colorAttributeLocation),t.vertexAttribPointer(this.colorAttributeLocation,3,t.FLOAT,!1,0,0);const r=new Float32Array(Array(n).fill(a));t.bindBuffer(t.ARRAY_BUFFER,this.alphaBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,r),t.enableVertexAttribArray(this.alphaAttributeLocation),t.vertexAttribPointer(this.alphaAttributeLocation,1,t.FLOAT,!1,0,0),t.drawArrays(t.TRIANGLES,0,n)}clearCanvas(){const e=this.gl;e.viewport(0,0,e.canvas.width,e.canvas.height),e.clear(e.COLOR_BUFFER_BIT)}destroy(){cancelAnimationFrame(this.animationFrameId)}}const T=new Map;function Y(s,e=0){const p=T.get(s);if(!p)return;const a=performance.now();p.renderer.render(p.data),e=a,p.animationFrameId=requestAnimationFrame(()=>Y(s,e))}self.onmessage=s=>{const{action:e,payload:p}=s.data;if(e==="register"){const{id:a,canvas:n,type:t,data:r}=p,l=new re(n,t),i=requestAnimationFrame(()=>Y(a));T.set(a,{renderer:l,type:t,data:r,animationFrameId:i})}else if(e==="deregister"){const{id:a}=p,n=T.get(a);n&&(cancelAnimationFrame(n.animationFrameId),T.delete(a))}else if(e==="update"){const{id:a,data:n}=p,t=T.get(a);t&&(t.data=n)}else if(e==="clear"){const{id:a}=p,n=T.get(a);n&&n.renderer.clearCanvas()}}})();
