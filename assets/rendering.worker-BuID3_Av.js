(function(){"use strict";class p{constructor(t,i){if(this.canvas=t,this.type=i,this.gl=t.getContext("webgl")||t.getContext("experimental-webgl"),this.animationFrameId=null,this.frameIndexes=Array(5).fill(0),this.showBeamEffect=!1,this.beamAlpha=.5,this.fadeAlpha=.13,this.beamRenderMode="lines",this.positionBuffer=null,this.colorBuffer=null,this.alphaBuffer=null,this.currentPointIndex=0,this.lastPointDrawTime=0,!this.gl){console.error("WebGL not supported");return}this.setup()}setup(){const t=this.gl,i=`
      attribute vec2 aPosition;
      attribute vec3 aColor;
      attribute float aAlpha;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
        gl_PointSize = 2.0;
        vColor = aColor;
        vAlpha = aAlpha;
      }
    `,r=`
      precision mediump float;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_FragColor = vec4(vColor, vAlpha);
      }
    `,a=this.createShader(t.VERTEX_SHADER,i),e=this.createShader(t.FRAGMENT_SHADER,r),n=this.createProgram(a,e);this.program=n,this.positionAttributeLocation=t.getAttribLocation(n,"aPosition"),this.colorAttributeLocation=t.getAttribLocation(n,"aColor"),this.alphaAttributeLocation=t.getAttribLocation(n,"aAlpha"),this.quadPositionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.quadPositionBuffer);const c=[-1,-1,1,-1,-1,1,-1,1,1,-1,1,1];t.bufferData(t.ARRAY_BUFFER,new Float32Array(c),t.STATIC_DRAW),this.quadColorUniformLocation=t.getUniformLocation(n,"uColor"),this.quadAlphaUniformLocation=t.getUniformLocation(n,"uAlpha");const A=`
      attribute vec2 aPosition;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
      }
    `,F=`
      precision mediump float;
      uniform vec4 uColor;
      void main() {
        gl_FragColor = uColor;
      }
    `,g=this.createShader(t.VERTEX_SHADER,A),b=this.createShader(t.FRAGMENT_SHADER,F);this.fadeProgram=this.createProgram(g,b),this.fadePositionAttributeLocation=t.getAttribLocation(this.fadeProgram,"aPosition"),this.fadeColorUniformLocation=t.getUniformLocation(this.fadeProgram,"uColor"),t.useProgram(n);const o=131072;this.positionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferData(t.ARRAY_BUFFER,o*2*Float32Array.BYTES_PER_ELEMENT,t.DYNAMIC_DRAW),this.colorBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),t.bufferData(t.ARRAY_BUFFER,o*3*Float32Array.BYTES_PER_ELEMENT,t.DYNAMIC_DRAW),this.alphaBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.alphaBuffer),t.bufferData(t.ARRAY_BUFFER,o*1*Float32Array.BYTES_PER_ELEMENT,t.DYNAMIC_DRAW),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA)}reset(){this.currentPointIndex=0,this.frameIndexes.fill(0),this.clearCanvas()}createShader(t,i){const r=this.gl,a=r.createShader(t);if(r.shaderSource(a,i),r.compileShader(a),r.getShaderParameter(a,r.COMPILE_STATUS))return a;console.error(r.getShaderInfoLog(a)),r.deleteShader(a)}createProgram(t,i){const r=this.gl,a=r.createProgram();if(r.attachShader(a,t),r.attachShader(a,i),r.linkProgram(a),r.getProgramParameter(a,r.LINK_STATUS))return a;console.error(r.getProgramInfoLog(a)),r.deleteProgram(a)}render(t){t.showBeamEffect!==void 0&&this.setBeamEffect(t.showBeamEffect),t.beamAlpha!==void 0&&this.setBeamAlpha(t.beamAlpha),t.fadeAlpha!==void 0&&this.setFadeAlpha(t.fadeAlpha),t.beamRenderMode!==void 0&&(this.beamRenderMode=t.beamRenderMode),this.type==="world"?this.renderWorld(t.worldData,t.previewScanRate):this.renderSingle(t.ildaFrames,t.previewScanRate)}renderSingle(t,i){const r=this.gl;if(r.viewport(0,0,r.canvas.width,r.canvas.height),r.clear(r.COLOR_BUFFER_BIT),!t||t.length===0)return;const a=t[this.frameIndexes[0]%t.length];this.draw(a.points,this.showBeamEffect,this.beamAlpha,i,this.beamRenderMode),this.frameIndexes[0]++,this.frameIndexes[0]>=t.length&&(this.frameIndexes[0]=0)}renderWorld(t,i){const r=this.gl;r.viewport(0,0,r.canvas.width,r.canvas.height),r.clear(r.COLOR_BUFFER_BIT),t.forEach((a,e)=>{if(a&&a.frames&&a.frames.length>0){const n=a.frames[this.frameIndexes[e]%a.frames.length];n&&this.draw(n.points,this.showBeamEffect,this.beamAlpha,i,this.beamRenderMode)}}),t.forEach((a,e)=>{a&&a.frames&&(this.frameIndexes[e]++,this.frameIndexes[e]>=a.frames.length&&(this.frameIndexes[e]=0))})}setBeamEffect(t){this.showBeamEffect=t}setBeamAlpha(t){this.beamAlpha=t}setFadeAlpha(t){this.fadeAlpha=t}draw(t,i,r,a,e){if(this.gl,!t||t.length===0)return;const n=Math.max(1,Math.floor(t.length/a)),c=this.currentPointIndex,A=Math.min(c+n,t.length),F=()=>{let o=[],h=[];for(let f=c;f<A;f++){const s=t[f];if(s.blanking){o.length>0&&(this._drawSegment(new Float32Array(o),new Float32Array(h),1,o.length/2),o=[],h=[]);continue}o.push(s.x,s.y),h.push(s.r/255,s.g/255,s.b/255)}o.length>0&&this._drawSegment(new Float32Array(o),new Float32Array(h),1,o.length/2)},g=()=>{const o=[],h=[];for(let f=c;f<A;f++){const s=t[f];if(!s.blanking){o.push(0,0,s.x,s.y);const l=[s.r/255,s.g/255,s.b/255];h.push(...l,...l)}}o.length>0&&this._drawLines(new Float32Array(o),new Float32Array(h),r,o.length/2)},b=()=>{const o=[],h=[];for(let f=c+1;f<A;f++){const s=t[f-1],l=t[f];if(!s.blanking&&!l.blanking){o.push(0,0,s.x,s.y,l.x,l.y);const R=[s.r/255,s.g/255,s.b/255],m=[l.r/255,l.g/255,l.b/255],E=[(R[0]+m[0])/2,(R[1]+m[1])/2,(R[2]+m[2])/2];h.push(...E,...R,...m)}}o.length>0&&this._drawTriangles(new Float32Array(o),new Float32Array(h),r,o.length/2)};F(),i&&(e==="points"?g():e==="lines"?b():e==="both"&&(b(),g())),this.currentPointIndex=(this.currentPointIndex+n)%t.length}_drawSegment(t,i,r,a){const e=this.gl;e.useProgram(this.program),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,t),e.enableVertexAttribArray(this.positionAttributeLocation),e.vertexAttribPointer(this.positionAttributeLocation,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,i),e.enableVertexAttribArray(this.colorAttributeLocation),e.vertexAttribPointer(this.colorAttributeLocation,3,e.FLOAT,!1,0,0);const n=new Float32Array(Array(a).fill(r));e.bindBuffer(e.ARRAY_BUFFER,this.alphaBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,n),e.enableVertexAttribArray(this.alphaAttributeLocation),e.vertexAttribPointer(this.alphaAttributeLocation,1,e.FLOAT,!1,0,0),e.drawArrays(e.LINE_STRIP,0,a)}_drawLines(t,i,r,a){const e=this.gl;e.useProgram(this.program),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,t),e.enableVertexAttribArray(this.positionAttributeLocation),e.vertexAttribPointer(this.positionAttributeLocation,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,i),e.enableVertexAttribArray(this.colorAttributeLocation),e.vertexAttribPointer(this.colorAttributeLocation,3,e.FLOAT,!1,0,0);const n=new Float32Array(Array(a).fill(r));e.bindBuffer(e.ARRAY_BUFFER,this.alphaBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,n),e.enableVertexAttribArray(this.alphaAttributeLocation),e.vertexAttribPointer(this.alphaAttributeLocation,1,e.FLOAT,!1,0,0),e.drawArrays(e.LINES,0,a)}_drawTriangles(t,i,r,a){const e=this.gl;e.useProgram(this.program),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,t),e.enableVertexAttribArray(this.positionAttributeLocation),e.vertexAttribPointer(this.positionAttributeLocation,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,i),e.enableVertexAttribArray(this.colorAttributeLocation),e.vertexAttribPointer(this.colorAttributeLocation,3,e.FLOAT,!1,0,0);const n=new Float32Array(Array(a).fill(r));e.bindBuffer(e.ARRAY_BUFFER,this.alphaBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,n),e.enableVertexAttribArray(this.alphaAttributeLocation),e.vertexAttribPointer(this.alphaAttributeLocation,1,e.FLOAT,!1,0,0),e.drawArrays(e.TRIANGLES,0,a)}clearCanvas(){const t=this.gl;t.viewport(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT)}destroy(){cancelAnimationFrame(this.animationFrameId)}}const u=new Map;function B(d,t=0){const i=u.get(d);if(!i)return;const r=performance.now();i.renderer.render(i.data),self.postMessage({action:"frame-data-ready",payload:i.data}),t=r,i.animationFrameId=requestAnimationFrame(()=>B(d,t))}self.onmessage=d=>{const{action:t,payload:i}=d.data;if(t==="register"){const{id:r,canvas:a,type:e,data:n}=i,c=new p(a,e),A=requestAnimationFrame(()=>B(r));u.set(r,{renderer:c,type:e,data:n,animationFrameId:A})}else if(t==="deregister"){const{id:r}=i,a=u.get(r);a&&(cancelAnimationFrame(a.animationFrameId),u.delete(r))}else if(t==="update"){const{id:r,data:a}=i,e=u.get(r);e&&(e.renderer.reset(),e.data=a)}else if(t==="clear"){const{id:r}=i,a=u.get(r);a&&a.renderer.clearCanvas()}}})();
