(function(){"use strict";const S=[{r:255,g:0,b:0},{r:255,g:17,b:0},{r:255,g:34,b:0},{r:255,g:51,b:0},{r:255,g:68,b:0},{r:255,g:85,b:0},{r:255,g:102,b:0},{r:255,g:119,b:0},{r:255,g:136,b:0},{r:255,g:153,b:0},{r:255,g:170,b:0},{r:255,g:187,b:0},{r:255,g:204,b:0},{r:255,g:221,b:0},{r:255,g:238,b:0},{r:255,g:255,b:0},{r:255,g:255,b:0},{r:238,g:255,b:0},{r:204,g:255,b:0},{r:170,g:255,b:0},{r:136,g:255,b:0},{r:102,g:255,b:0},{r:68,g:255,b:0},{r:34,g:255,b:0},{r:0,g:255,b:0},{r:0,g:255,b:34},{r:0,g:255,b:68},{r:0,g:255,b:102},{r:0,g:255,b:136},{r:0,g:255,b:170},{r:0,g:255,b:204},{r:0,g:255,b:238},{r:0,g:136,b:255},{r:0,g:119,b:255},{r:0,g:102,b:255},{r:0,g:102,b:255},{r:0,g:85,b:255},{r:0,g:68,b:255},{r:0,g:68,b:255},{r:0,g:34,b:255},{r:0,g:0,b:255},{r:34,g:0,b:255},{r:68,g:0,b:255},{r:102,g:0,b:255},{r:136,g:0,b:255},{r:170,g:0,b:255},{r:204,g:0,b:255},{r:238,g:0,b:255},{r:255,g:0,b:255},{r:255,g:34,b:255},{r:255,g:68,b:255},{r:255,g:102,b:255},{r:255,g:136,b:255},{r:255,g:170,b:255},{r:255,g:204,b:255},{r:255,g:238,b:255},{r:255,g:255,b:255},{r:255,g:238,b:238},{r:255,g:204,b:204},{r:255,g:170,b:170},{r:255,g:136,b:136},{r:255,g:102,b:102},{r:255,g:68,b:68},{r:0,g:34,b:34}],$=new Map;function P(l,f,a,I,i=S){const g=[],t=new DataView(l);let n=0;try{for(let s=0;s<I;s++){if(f===2){n+=a;continue}let y,c,M=0,e,r,u,b;f===0||f===4?(y=t.getInt16(n,!1)/32768,c=t.getInt16(n+2,!1)/32768,M=t.getInt16(n+4,!1)/32768,b=t.getUint8(n+6)):(y=t.getInt16(n,!1)/32768,c=t.getInt16(n+2,!1)/32768,b=t.getUint8(n+4));const m=(b&64)!==0,o=(b&128)!==0;if(f===0||f===1){const d=t.getUint8(n+(f===0?7:5)),p=i||S,k=p[d%p.length]||S[0];e=k.r,r=k.g,u=k.b}else(f===4||f===5)&&(u=t.getUint8(n+(f===4?7:5)),r=t.getUint8(n+(f===4?8:6)),e=t.getUint8(n+(f===4?9:7)));if(g.push({x:y,y:c,z:M,r:e===void 0?255:e,g:r===void 0?255:r,b:u===void 0?255:u,blanking:m,lastPoint:o}),n+=a,o)break}}catch(s){console.warn("Parser: Error reading points:",s)}return g}function v(l,f=!1){console.log(`[ilda-parser.worker.js] parseIldaFile - Starting parsing. stopAtFirstFrame=${f}`);const a=new DataView(l);if(l.byteLength<32)return{frames:[],error:"File too small to be a valid ILDA file"};const I=String.fromCharCode(a.getUint8(0),a.getUint8(1),a.getUint8(2),a.getUint8(3));if(I!=="ILDA")return console.warn(`[ilda-parser.worker.js] Parser: Invalid ILDA header signature: ${I}`),{frames:[],error:"Invalid ILDA file header"};const i=[];let g=null,t=0,n=null;for(;t+32<=l.byteLength;){const s=t,y=String.fromCharCode(a.getUint8(s),a.getUint8(s+1),a.getUint8(s+2),a.getUint8(s+3));if(y!=="ILDA"){console.warn(`[ilda-parser.worker.js] Parser: Invalid ILDA signature at offset ${s}, got: ${y}. Skipping 32 bytes.`),t+=32;continue}const c=a.getUint8(s+7);if(g===null&&(g=c),c>5){console.warn(`[ilda-parser.worker.js] Parser: Unknown format code: ${c} at offset ${s}. Skipping 32 bytes.`),t+=32;continue}const M=String.fromCharCode(...new Uint8Array(l,s+8,8)).trim(),e=String.fromCharCode(...new Uint8Array(l,s+16,8)).trim();let r=a.getUint16(s+24,!1);const u=a.getUint16(s+26,!1),b=a.getUint16(s+28,!1),m=a.getUint8(s+30);let o;switch(c){case 0:o=8;break;case 1:o=6;break;case 2:o=3;break;case 4:o=10;break;case 5:o=8;break;default:console.warn(`Parser: Unsupported format ${c}, skipping 32 bytes.`),t+=32;continue}if(c===2){n=[];const x=t+32;for(let w=0;w<r;w++){const h=a.getUint8(x+w*3),D=a.getUint8(x+w*3+1),F=a.getUint8(x+w*3+2);n.push({r:h,g:D,b:F})}}let d=r*o,p=32+d;const k=l.byteLength-t;if(p<k){const x=k-p;x>0&&x<=32&&(console.warn(`Parser: Malformed frame, ${x} leftover bytes. Adjusting size.`),p+=x,d+=x,r=Math.floor(d/o))}if(s+p>l.byteLength){console.warn(`Parser: Incomplete frame data for ${r} points at offset ${s}. Expected ${p} bytes, but only ${l.byteLength-s} bytes remaining. Breaking.`);break}if(r===0){console.log("[ilda-parser.worker.js] Parser: Empty frame, skipping"),t+=p;continue}if(i.push({frameName:M,companyName:e,frameNumber:u,totalFrames:b,scannerHead:m,formatCode:c,recordSize:o,pointCount:r,pointDataOffset:s+32,pointDataSize:d,frameEndOffset:s+p,palette:n,bounds:{minX:0,maxX:0,minY:0,maxY:0}}),t+=p,f&&i.length>0){console.log("[ilda-parser.worker.js] parseIldaFile - stopAtFirstFrame requested, breaking early.");break}}return console.log(`[ilda-parser.worker.js] parseIldaFile - Finished parsing. Found ${i.length} frames.`),{frames:i,error:i.length===0?"No valid frames found":null,firstFormatCode:g,ildaFileBuffer:l}}async function A(l,f=128,a=128){if(!l||l.length===0)return null;const I=new OffscreenCanvas(f,a),i=I.getContext("2d");i.fillStyle="#000000",i.fillRect(0,0,f,a),i.lineWidth=1.5,i.lineCap="round";let g=null,t=null;for(let n=0;n<l.length;n++){const s=l[n],y=(s.x+1)*.5*f,c=(1-(s.y+1)*.5)*a;!s.blanking&&g!==null&&(i.beginPath(),i.moveTo(g,t),i.lineTo(y,c),i.strokeStyle=`rgb(${s.r},${s.g},${s.b})`,i.stroke()),g=y,t=c}if(l.length>2){const n=l[0],s=l[l.length-1];if(!s.blanking){const y=(n.x+1)*.5*f,c=(1-(n.y+1)*.5)*a;Math.sqrt(Math.pow(y-g,2)+Math.pow(c-t,2))<f*.02&&(i.beginPath(),i.moveTo(g,t),i.lineTo(y,c),i.strokeStyle=`rgb(${s.r},${s.g},${s.b})`,i.stroke())}}return I.transferToImageBitmap()}const U=new Map;self.onmessage=async function(l){const{arrayBuffer:f,type:a,fileName:I,filePath:i,layerIndex:g,colIndex:t,workerId:n,frameIndex:s,isStillFrame:y,requestId:c,stopAtFirstFrame:M}=l.data;if(a==="parse-ilda"){if(!f){self.postMessage({success:!1,error:"ArrayBuffer missing for parse-ilda command",type:"parse-ilda"});return}try{console.log("[ilda-parser.worker.js] Calling parseIldaFile for:",I);const e=v(f,M);if(e.error){self.postMessage({success:!1,error:e.error,type:"parse-ilda",fileName:I,filePath:i,layerIndex:g,colIndex:t}),self.postMessage({type:"parsing-status",status:!1,layerIndex:g,colIndex:t});return}const r=`ilda-${Date.now()}-${Math.random().toString(36).substring(2,9)}`;$.set(r,{ildaFileBuffer:e.ildaFileBuffer,framesMetadata:e.frames}),console.log("[ilda-parser.worker.js] Posting success message for parse-ilda."),self.postMessage({success:!0,workerId:r,totalFrames:e.frames.length,ildaFormat:e.firstFormatCode,fileName:I,filePath:i,layerIndex:g,colIndex:t,type:"parse-ilda"}),self.postMessage({type:"parsing-status",status:!1,layerIndex:g,colIndex:t})}catch(e){console.error("[ilda-parser.worker.js] Error parsing file in onmessage handler:",e),self.postMessage({success:!1,error:e.message,type:"parse-ilda"}),self.postMessage({type:"parsing-status",status:!1,layerIndex:g,colIndex:t})}}else if(a==="load-and-parse-ilda"){const e=Math.random().toString(36).substring(2,15);U.set(e,{fileName:I,filePath:i,layerIndex:g,colIndex:t,browserFile:l.data.browserFile,stopAtFirstFrame:M}),g!==void 0&&t!==void 0&&self.postMessage({type:"parsing-status",status:!0,layerIndex:g,colIndex:t});const r=M?65536:null;self.postMessage({type:"request-file-content",filePath:i,requestId:e,maxBytes:r})}else if(a==="file-content-response"){const e=U.get(c);if(!e){console.error(`Worker: No context found for requestId: ${c}`);return}if(U.delete(c),l.data.error){console.error(`Worker: Error receiving file content: ${l.data.error}`),self.postMessage({success:!1,error:l.data.error,type:"parse-ilda",...e}),e.layerIndex!==void 0&&e.colIndex!==void 0&&self.postMessage({type:"parsing-status",status:!1,layerIndex:e.layerIndex,colIndex:e.colIndex});return}try{console.log(`[ilda-parser.worker.js] Calling parseIldaFile for: ${e.fileName} (from file-content-response)`);const r=v(f,e.stopAtFirstFrame);if(r.error){self.postMessage({success:!1,error:r.error,type:"parse-ilda",...e}),e.layerIndex!==void 0&&e.colIndex!==void 0&&self.postMessage({type:"parsing-status",status:!1,layerIndex:e.layerIndex,colIndex:e.colIndex});return}const u=`ilda-${Date.now()}-${Math.random().toString(36).substring(2,9)}`;$.set(u,{ildaFileBuffer:r.ildaFileBuffer,framesMetadata:r.frames}),self.postMessage({success:!0,workerId:u,totalFrames:r.frames.length,ildaFormat:r.firstFormatCode,type:"parse-ilda",...e}),e.layerIndex!==void 0&&e.colIndex!==void 0&&self.postMessage({type:"parsing-status",status:!1,layerIndex:e.layerIndex,colIndex:e.colIndex})}catch(r){console.error("[ilda-parser.worker.js] Error parsing file from content response:",r),self.postMessage({success:!1,error:r.message,type:"parse-ilda",...e}),e.layerIndex!==void 0&&e.colIndex!==void 0&&self.postMessage({type:"parsing-status",status:!1,layerIndex:e.layerIndex,colIndex:e.colIndex})}}else if(a==="get-frame"){const{workerId:e,frameIndex:r,isStillFrame:u,layerIndex:b,colIndex:m,browserFile:o,filePath:d}=l.data,p=$.get(e);if(!p){self.postMessage({success:!1,error:"ILDA data not found",type:"get-frame",workerId:e,browserFile:o,filePath:d,layerIndex:b,colIndex:m});return}const{ildaFileBuffer:k,framesMetadata:x}=p,w=Math.floor(r);if(!Number.isFinite(w)||w>=x.length||w<0){self.postMessage({success:!1,error:`Frame index ${r} out of bounds or invalid`,type:"get-frame",workerId:e,browserFile:o,filePath:d,layerIndex:b,colIndex:m});return}const h=x[w];if(!h){self.postMessage({success:!1,error:`Frame metadata not found for index ${w}`,type:"get-frame",workerId:e,browserFile:o,filePath:d,layerIndex:b,colIndex:m});return}let D=h.cachedPoints;if(!D){const F=k.slice(h.pointDataOffset,h.pointDataOffset+h.pointDataSize);D=P(F,h.formatCode,h.recordSize,h.pointCount,h.palette),h.cachedPoints=D}if(o){const F=await A(D);self.postMessage({success:!0,bitmap:F,type:"get-frame",workerId:e,frameIndex:r,isStillFrame:u,layerIndex:b,colIndex:m,browserFile:o,filePath:d},[F])}else{const F={points:D};self.postMessage({success:!0,frame:F,type:"get-frame",workerId:e,frameIndex:r,isStillFrame:u,layerIndex:b,colIndex:m,browserFile:o,filePath:d})}}else if(a==="get-all-frames"){const e=$.get(n);if(!e){self.postMessage({success:!1,error:"ILDA data not found",type:"get-all-frames",workerId:n});return}const{ildaFileBuffer:r,framesMetadata:u}=e,b=[];try{for(let m=0;m<u.length;m++){const o=u[m];let d=o.cachedPoints;if(!d){const p=r.slice(o.pointDataOffset,o.pointDataOffset+o.pointDataSize);d=P(p,o.formatCode,o.recordSize,o.pointCount,o.palette),o.cachedPoints=d}b.push({...o,points:d})}self.postMessage({success:!0,frames:b,type:"get-all-frames",workerId:n,layerIndex:g,colIndex:t})}catch(m){self.postMessage({success:!1,error:m.message,type:"get-all-frames",workerId:n})}}}})();
