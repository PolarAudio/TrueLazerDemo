(function(){"use strict";const V=[{id:"rotate",name:"Rotate",type:"transform",description:"Rotates the shape around its center.",defaultParams:{angle:0,speed:0,direction:"CW"},paramControls:[{id:"angle",label:"Angle",type:"range",min:0,max:360,step:1},{id:"speed",label:"Speed",type:"range",min:0,max:10,step:.1},{id:"direction",label:"Direction",type:"select",options:["CW","CCW"]}]},{id:"scale",name:"Scale",type:"transform",description:"Scales the shape.",defaultParams:{scaleX:1,scaleY:1},paramControls:[{id:"scaleX",label:"Scale X",type:"range",min:.01,max:5,step:.01},{id:"scaleY",label:"Scale Y",type:"range",min:.01,max:5,step:.01}]},{id:"translate",name:"Translate",type:"transform",description:"Moves the shape.",defaultParams:{translateX:0,translateY:0},paramControls:[{id:"translateX",label:"Translate X",type:"range",min:-1,max:1,step:.01},{id:"translateY",label:"Translate Y",type:"range",min:-1,max:1,step:.01}]},{id:"color",name:"Color",type:"color",description:"Changes the color of the shape with solid, rainbow or custom palette modes.",defaultParams:{mode:"solid",color:"#ffffff",r:255,g:255,b:255,cycleSpeed:0,rainbowSpread:1,rainbowOffset:0,rainbowPalette:"rainbow",paletteColors:["#ff0000","#00ff00","#0000ff","#ffff00"],paletteSize:4,paletteSpread:1,hue:0,saturation:0,brightness:1,enabled:!0},paramControls:[{id:"mode",label:"Mode",type:"select",options:["solid","rainbow","palette"]},{id:"color",label:"Color",type:"color",showIf:{mode:"solid"}},{id:"hue",label:"Hue",type:"range",min:0,max:1,step:.001,showIf:{mode:"hsv_advanced"}},{id:"saturation",label:"Saturation",type:"range",min:0,max:1,step:.001,showIf:{mode:"hsv_advanced"}},{id:"brightness",label:"Brightness",type:"range",min:0,max:1,step:.001,showIf:{mode:"hsv_advanced"}},{id:"paletteSize",label:"Palette Size",type:"range",min:2,max:16,step:1,showIf:{mode:"palette"}},{id:"paletteSpread",label:"Spread",type:"range",min:.1,max:10,step:.1,showIf:{mode:"palette"}},{id:"cycleSpeed",label:"Cycle Speed",type:"range",min:0,max:10,step:.1,showIf:{mode:["rainbow","palette"]}},{id:"rainbowSpread",label:"Rainbow Spread",type:"range",min:.1,max:10,step:.1,showIf:{mode:"rainbow"}},{id:"rainbowOffset",label:"Offset",type:"range",min:0,max:360,step:1,showIf:{mode:["rainbow","palette"]}},{id:"rainbowPalette",label:"Preset",type:"select",options:["rainbow","fire","ice","cyber"],showIf:{mode:"rainbow"}}]},{id:"wave",name:"Wave",type:"animation",description:"Applies a wave distortion to the shape.",defaultParams:{amplitude:.1,frequency:10,speed:1,direction:"x"},paramControls:[{id:"amplitude",label:"Amplitude",type:"range",min:.01,max:1,step:.01},{id:"frequency",label:"Frequency",type:"range",min:1,max:50,step:1},{id:"speed",label:"Speed",type:"range",min:.1,max:10,step:.1},{id:"direction",label:"Direction",type:"select",options:["x","y"]}]},{id:"warp",name:"Warp",type:"animation",description:"Symmetrical chaotic wave distortion.",defaultParams:{amount:.1,chaos:.5,speed:1},paramControls:[{id:"amount",label:"Amount",type:"range",min:0,max:1,step:.01},{id:"chaos",label:"Chaos",type:"range",min:0,max:1,step:.01},{id:"speed",label:"Speed",type:"range",min:.1,max:10,step:.1}]},{id:"distortion",name:"Distortion",type:"transform",description:"Distorts the point data.",defaultParams:{amount:.1,scale:10,speed:.5},paramControls:[{id:"amount",label:"Amount",type:"range",min:0,max:1,step:.01},{id:"scale",label:"Scale",type:"range",min:1,max:50,step:1},{id:"speed",label:"Speed",type:"range",min:0,max:5,step:.1}]},{id:"move",name:"Move (Bounce)",type:"transform",description:"Moves points and bounces them off the borders.",defaultParams:{speedX:.1,speedY:.1},paramControls:[{id:"speedX",label:"Speed X",type:"range",min:0,max:2,step:.01},{id:"speedY",label:"Speed Y",type:"range",min:0,max:2,step:.01}]},{id:"delay",name:"Delay",type:"effect",description:"Frame or Channel based delay effect.",defaultParams:{mode:"segment",playstyle:"repeat",useCustomOrder:!1,delayDirection:"left_to_right",delayAmount:5,decay:.8,steps:10,customOrder:[],enabled:!0},paramControls:[{id:"mode",label:"Mode",type:"select",options:["segment","frame","channel"]},{id:"playstyle",label:"Playstyle",type:"select",options:["once","repeat"]},{id:"useCustomOrder",label:"Custom Order",type:"checkbox",showIf:{mode:"channel"}},{id:"delayDirection",label:"Direction",type:"select",options:["center_to_out","out_to_center","left_to_right","right_to_left"],showIf:{useCustomOrder:!1}},{id:"steps",label:"Steps",type:"range",min:2,max:20,step:1,showIf:{mode:["segment","frame"]}},{id:"delayAmount",label:"Delay Time",type:"range",min:1,max:60,step:1},{id:"decay",label:"Decay",type:"range",min:0,max:1,step:.01}]},{id:"chase",name:"Chase",type:"effect",description:"Frame or Channel based chase effect.",defaultParams:{mode:"segment",playstyle:"repeat",steps:4,decay:.8,speed:1,overlap:1,direction:"left_to_right",useCustomOrder:!1,customOrder:[],enabled:!0},paramControls:[{id:"mode",label:"Mode",type:"select",options:["segment","channel"]},{id:"playstyle",label:"Playstyle",type:"select",options:["once","repeat","bounce"]},{id:"steps",label:"Steps",type:"range",min:2,max:16,step:1,showIf:{mode:"segment"}},{id:"decay",label:"Decay",type:"range",min:0,max:1,step:.01},{id:"speed",label:"Speed",type:"range",min:.1,max:5,step:.1},{id:"overlap",label:"Overlap",type:"range",min:1,max:4,step:1},{id:"useCustomOrder",label:"Custom Order",type:"checkbox",showIf:{mode:"channel"}},{id:"direction",label:"Direction",type:"select",options:["center_to_out","out_to_center","left_to_right","right_to_left"],showIf:{useCustomOrder:!1}}]},{id:"blanking",name:"Blanking",type:"animation",description:"Controls the blanking of the laser output.",defaultParams:{blankingInterval:0,spacing:0},paramControls:[{id:"blankingInterval",label:"Blanking Interval",type:"range",min:0,max:10,step:1},{id:"spacing",label:"Spacing",type:"range",min:0,max:20,step:1}]},{id:"strobe",name:"Strobe",type:"animation",description:"Applies a strobe effect to the laser output.",defaultParams:{strobeSpeed:100,strobeAmount:.5},paramControls:[{id:"strobeSpeed",label:"Strobe Speed (ms)",type:"range",min:10,max:1e3,step:10},{id:"strobeAmount",label:"Strobe Amount (0-1)",type:"range",min:0,max:1,step:.01}]},{id:"mirror",name:"Mirror",type:"transform",description:"Mirrors the shape from the center.",defaultParams:{mode:"none",additive:!0,axisOffset:0,planeRotation:0},paramControls:[{id:"mode",label:"Mirror Mode",type:"select",options:["none","x+","x-","y+","y-"]},{id:"additive",label:"Additive",type:"checkbox"},{id:"axisOffset",label:"Axis Offset",type:"range",min:-1,max:1,step:.01},{id:"planeRotation",label:"Plane Rotation",type:"range",min:0,max:360,step:1}]}].reduce((r,e)=>(r[e.id]=e,r),{});function N(r,e,p,l){const s=e.style||"loop",a=e.direction||"forward";if(a==="pause")return p;let o=r;s==="bounce"&&(o*=2);let h=0;if(s==="once")h=Math.min(o,1),a==="backward"&&(h=1-h);else if(s==="bounce"){let m=o%1;Math.floor(o)%2===1?h=1-m:h=m,a==="backward"&&(h=1-h)}else h=o%1,a==="backward"&&(h=1-h);return l&&Array.isArray(l)&&l.length===2?l[0]+(l[1]-l[0])*h:p}function G(r,e,p,l,s,a){if(!p)return e;const o=typeof p=="string"?{syncMode:p}:p;if(!o.syncMode)return e;const{time:h,progress:m=0,bpm:n=120,clipDuration:b=0,fftLevels:_={low:0,mid:0,high:0},activationTime:u=0}=l;let t=o.range;!t||!Array.isArray(t)||t.length;let g=0;const c=o.speedMultiplier||1;if((o.style||"loop")==="once"&&u>0){const w=(h-u)*.001;let R=1;if(o.syncMode==="timeline")R=Math.max(.01,o.duration||1);else if(o.syncMode==="bpm"){const F=Math.max(.1,o.beats||4),M=n/60;R=F/(M||2)}else if(o.syncMode==="fps")return g=w*c,N(g,o,e,t);g=w/R*c}else if(o.syncMode==="fps")g=h*.001*c;else if(o.syncMode==="timeline"){const w=Math.max(.01,o.duration||1);b>0?g=m*b/w*c:g=0}else if(o.syncMode==="bpm"){const w=Math.max(.1,o.beats||4),R=n/60,F=w/(R||2);b>0?g=m*b/F*c:g=0}else if(o.syncMode==="fft"){const w=_[o.fftRange||"low"]||0;return t?t[0]+(t[1]-t[0])*w:e}return N(g,o,e,t)}let U=new Float32Array(1024*8);function K(r){U.length<r*8&&(U=new Float32Array(r*8*2))}function $(r,e,p={}){const{progress:l=0,time:s=performance.now(),effectStates:a,syncSettings:o={},fftLevels:h}=p;if(!e||e.length===0)return r;const m=r.points,n=r.isTypedArray||m instanceof Float32Array,b=n?m.length/8:m.length;K(b);const _=U.subarray(0,b*8);if(n)_.set(m);else for(let g=0;g<b;g++){const c=m[g],i=g*8;_[i]=c.x,_[i+1]=c.y,_[i+2]=c.z||0,_[i+3]=c.r,_[i+4]=c.g,_[i+5]=c.b,_[i+6]=c.blanking?1:0,_[i+7]=c.lastPoint?1:0}let u=_;for(const g of e){const c=g.params;if(c.enabled===!1||!V[g.id])continue;const w=u.length/8;let R=c;const F=g.instanceId?`${g.instanceId}.`:`${g.id}.`;let M=!1;for(const d in c)if(o[F+d]){M=!0;break}if(M){R={...c};for(const d in R){const x=F+d;o[x]&&(R[d]=G(d,R[d],o[x],p))}}switch(g.id){case"rotate":Q(u,w,R,l,s);break;case"scale":Z(u,w,R);break;case"translate":j(u,w,R);break;case"color":ee(u,w,R,s);break;case"wave":ae(u,w,R,s);break;case"blanking":re(u,w,R);break;case"strobe":oe(u,w,R,s);break;case"mirror":u=ne(u,w,R);break;case"warp":se(u,w,R,s);break;case"distortion":ie(u,w,R,s);break;case"move":le(u,w,R,s);break;case"delay":a&&g.instanceId&&(u=fe(u,w,R,a,g.instanceId,p));break;case"chase":u=ce(u,w,R,s,p);break}}const t=new Float32Array(u);return u._channelDistributions&&(t._channelDistributions=u._channelDistributions),{...r,points:t,isTypedArray:!0}}function Q(r,e,p,l,s){const{angle:a,speed:o,direction:h}=p,m=h==="CCW"?-1:1,n=s*.001*o*m,b=a*Math.PI/180+n,_=Math.sin(b),u=Math.cos(b);for(let t=0;t<e;t++){const g=t*8,c=r[g],i=r[g+1];r[g]=c*u-i*_,r[g+1]=c*_+i*u}}function Z(r,e,p){const{scaleX:l,scaleY:s}=p;for(let a=0;a<e;a++){const o=a*8;r[o]*=l,r[o+1]*=s}}function j(r,e,p){const{translateX:l,translateY:s}=p;for(let a=0;a<e;a++){const o=a*8;r[o]+=l,r[o+1]+=s}}function z(r){if(!r)return{r:255,g:255,b:255};const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(r);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:{r:255,g:255,b:255}}function J(r,e,p){let l,s,a;const o=Math.floor(r*6),h=r*6-o,m=p*(1-e),n=p*(1-h*e),b=p*(1-(1-h)*e);switch(o%6){case 0:l=p,s=b,a=m;break;case 1:l=n,s=p,a=m;break;case 2:l=m,s=p,a=b;break;case 3:l=m,s=n,a=p;break;case 4:l=b,s=m,a=p;break;case 5:l=p,s=m,a=n;break}return[Math.round(l*255),Math.round(s*255),Math.round(a*255)]}function ee(r,e,p,l){const{mode:s,r:a,g:o,b:h,color:m,hue:n,saturation:b,brightness:_,cycleSpeed:u,rainbowSpread:t,rainbowOffset:g,rainbowPalette:c,paletteColors:i=[],paletteSize:w=4,paletteSpread:R=1}=p,F=l*.001*u;if(s==="palette"){const M=Math.min(i.length,w),d=i.slice(0,M).map(z);d.length===0&&d.push({r:255,g:255,b:255});for(let x=0;x<e;x++){const f=x*8,C=(x/e*R+F*.5+g/360)%1*d.length,P=Math.floor(C)%d.length,y=(P+1)%d.length,A=C-Math.floor(C),v=d[P],S=d[y];r[f+3]=Math.round(v.r+(S.r-v.r)*A),r[f+4]=Math.round(v.g+(S.g-v.g)*A),r[f+5]=Math.round(v.b+(S.b-v.b)*A)}}else if(s==="rainbow"){const M=c||"rainbow";for(let d=0;d<e;d++){const x=d*8,f=(d/e*t+F*.5+g/360)%1;let B,C,P;M==="rainbow"?[B,C,P]=W(f,1,.5):[B,C,P]=te(M,f),r[x+3]=B,r[x+4]=C,r[x+5]=P}}else{let M=a,d=o,x=h;if(n!==void 0&&b!==void 0&&_!==void 0)[M,d,x]=J(n,b,_);else if(m){const f=z(m);M=f.r,d=f.g,x=f.b}if(u>0){const f=F*50%360,[B,C,P]=W(f/360,1,.5);for(let y=0;y<e;y++){const A=y*8;r[A+3]=B,r[A+4]=C,r[A+5]=P}}else for(let f=0;f<e;f++){const B=f*8;r[B+3]=M,r[B+4]=d,r[B+5]=x}}}function te(r,e){const p={fire:[{r:255,g:0,b:0},{r:255,g:128,b:0},{r:255,g:255,b:0},{r:255,g:0,b:0}],ice:[{r:0,g:0,b:255},{r:0,g:255,b:255},{r:255,g:255,b:255},{r:0,g:0,b:255}],cyber:[{r:255,g:0,b:255},{r:0,g:255,b:255},{r:0,g:0,b:255},{r:255,g:0,b:255}]},l=p[r]||p.fire,s=e*(l.length-1),a=Math.floor(s),o=s-a,h=l[a],m=l[a+1]||l[a];return[Math.round(h.r+(m.r-h.r)*o),Math.round(h.g+(m.g-h.g)*o),Math.round(h.b+(m.b-h.b)*o)]}function W(r,e,p){let l,s,a;{const o=(n,b,_)=>(_<0&&(_+=1),_>1&&(_-=1),_<.16666666666666666?n+(b-n)*6*_:_<.5?b:_<.6666666666666666?n+(b-n)*(.6666666666666666-_)*6:n),h=p+e-p*e,m=2*p-h;l=o(m,h,r+1/3),s=o(m,h,r),a=o(m,h,r-1/3)}return[Math.round(l*255),Math.round(s*255),Math.round(a*255)]}function ae(r,e,p,l){const{amplitude:s,frequency:a,speed:o,direction:h}=p,m=l*.001*o;for(let n=0;n<e;n++){const b=n*8;h==="x"?r[b+1]+=s*Math.sin(r[b]*a+m):h==="y"&&(r[b]+=s*Math.sin(r[b+1]*a+m))}}function re(r,e,p){const{blankingInterval:l,spacing:s=0}=p;if(l<=0)return;const a=l+1+s;for(let o=0;o<e;o++)o%a>=l&&(r[o*8+6]=1)}function oe(r,e,p,l){const{strobeSpeed:s,strobeAmount:a}=p;if(l%s/s<a)for(let h=0;h<e;h++)r[h*8+6]=1}function ne(r,e,p){const{mode:l,additive:s=!0,axisOffset:a=0,planeRotation:o=0}=p;if(l==="none"||e===0)return r;const h=o*Math.PI/180,m=Math.cos(h),n=Math.sin(h),b={x:0,y:0},_=(c,i)=>{let w=c,R=i;if(h!==0){const F=c*m+i*n,M=-c*n+i*m;w=F,R=M}if(l==="x-"||l==="x+"?w=2*a-w:(l==="y-"||l==="y+")&&(R=2*a-R),h!==0){const F=w*m-R*n,M=w*n+R*m;w=F,R=M}b.x=w,b.y=R},u=(c,i)=>{if(s)return!0;let w=c,R=i;return h!==0&&(w=c*m+i*n,R=-c*n+i*m),l==="x+"?w>=a:l==="x-"?w<=a:l==="y+"?R>=a:l==="y-"?R<=a:!0};let t;const g=r._channelDistributions;if(g){t=new Float32Array((e*2+g.size*2+50)*8);const c=new Map;let i=0;for(const[R,F]of g){const M=F.length/8,d=F.start,x=i;let f=0,B=!0;for(let C=0;C<M;C++){const P=d+C*8,y=u(r[P],r[P+1]);y&&(!B&&f>0&&(t.set(r.subarray(P,P+8),i),t[i+6]=1,t[i+3]=0,t[i+4]=0,t[i+5]=0,i+=8,f++),t.set(r.subarray(P,P+8),i),i+=8,f++),B=y}if(f>0){const C=i-8;t.set(t.subarray(C,C+8),i),t[i+6]=1,t[i+3]=0,t[i+4]=0,t[i+5]=0,i+=8;let P=!0,y=0;for(let A=M-1;A>=0;A--){const v=d+A*8,S=u(r[v],r[v+1]);if(S){!P&&y>0&&(t.set(r.subarray(v,v+8),i),_(t[i],t[i+1]),t[i]=b.x,t[i+1]=b.y,t[i+6]=1,t[i+3]=0,t[i+4]=0,t[i+5]=0,i+=8),t.set(r.subarray(v,v+8),i);const I=i;_(t[I],t[I+1]),t[I]=b.x,t[I+1]=b.y,A===M-1?(t[I+6]=1,t[I+3]=0,t[I+4]=0,t[I+5]=0):t[I+6]=r[v+8+6],i+=8,y++}P=S}c.set(R,{start:x,length:i-x})}}const w=new Float32Array(i);return w.set(t.subarray(0,i)),w._channelDistributions=c,w}else{t=new Float32Array((e*2+50)*8);let c=0,i=0,w=!0;for(let R=0;R<e;R++){const F=R*8,M=u(r[F],r[F+1]);M&&(!w&&i>0&&(t.set(r.subarray(F,F+8),c),t[c+6]=1,t[c+3]=0,t[c+4]=0,t[c+5]=0,c+=8,i++),t.set(r.subarray(F,F+8),c),c+=8,i++),w=M}if(i>0){const R=c-8;t.set(t.subarray(R,R+8),c),t[c+6]=1,t[c+3]=0,t[c+4]=0,t[c+5]=0,c+=8;let F=!0,M=0;for(let d=e-1;d>=0;d--){const x=d*8,f=u(r[x],r[x+1]);if(f){!F&&M>0&&(t.set(r.subarray(x,x+8),c),_(t[c],t[c+1]),t[c]=b.x,t[c+1]=b.y,t[c+6]=1,t[c+3]=0,t[c+4]=0,t[c+5]=0,c+=8),t.set(r.subarray(x,x+8),c);const B=c;_(t[B],t[B+1]),t[B]=b.x,t[B+1]=b.y,d===e-1?(t[B+6]=1,t[B+3]=0,t[B+4]=0,t[B+5]=0):t[B+6]=r[x+8+6],c+=8,M++}F=f}}return t.slice(0,c)}}function se(r,e,p,l){const{amount:s,chaos:a,speed:o}=p,h=l*.001*o;for(let m=0;m<e;m++){const n=m*8,b=r[n],_=r[n+1],u=Math.abs(_);r[n]+=Math.sin(u*10*(1+a)+h)*s*Math.cos(h*a),r[n+1]+=Math.cos(Math.abs(b)*10*(1+a)+h)*s*Math.sin(h*a)}}function ie(r,e,p,l){const{amount:s,scale:a,speed:o}=p,h=l*.001*o;for(let m=0;m<e;m++){const n=m*8,b=Math.sin(r[n]*a+h)*Math.cos(r[n+1]*a-h),_=Math.cos(r[n]*a-h)*Math.sin(r[n+1]*a+h);r[n]+=b*s,r[n+1]+=_*s}}function le(r,e,p,l){const{speedX:s,speedY:a}=p,o=l*.001,h=o*s,m=o*a,n=4;for(let b=0;b<e;b++){const _=b*8;let u=r[_]+h,t=r[_+1]+m,g=(u+1)%n;g<0&&(g+=n),g>2&&(g=4-g),u=g-1;let c=(t+1)%n;c<0&&(c+=n),c>2&&(c=4-c),t=c-1,r[_]=u,r[_+1]=t}}function fe(r,e,p,l,s,a){const{mode:o="segment",delayAmount:h,decay:m,delayDirection:n,useCustomOrder:b,customOrder:_,playstyle:u="repeat",steps:t=10}=p;l.has(s)||l.set(s,[]);const g=l.get(s);if(g.unshift(new Float32Array(r)),o==="segment"){const c=h*t+1;g.length>c&&(g.length=c);const i=new Float32Array(r.length);for(let w=0;w<e;w++){let R=0;const F=w/e;n==="left_to_right"?R=Math.floor(F*t):n==="right_to_left"?R=Math.floor((1-F)*t):n==="center_to_out"?R=Math.floor(Math.abs(F-.5)*2*t):n==="out_to_center"&&(R=Math.floor((1-Math.abs(F-.5)*2)*t)),R=Math.min(t-1,Math.max(0,R));const M=R*h,d=M<g.length?g[M]:null,x=Math.pow(m,R),f=w*8;if(d&&d.length>0){let B;if(d.length===r.length)B=f;else{const P=d.length/8;let y=Math.floor(F*P);y>=P&&(y=P-1),B=y*8}i[f]=d[B],i[f+1]=d[B+1],i[f+2]=d[B+2],i[f+3]=d[B+3]*x,i[f+4]=d[B+4]*x,i[f+5]=d[B+5]*x;const C=r[f+6]>.5;if(i[f+6]=C?1:d[B+6],i[f+6]>.5&&(i[f+3]=0,i[f+4]=0,i[f+5]=0),i[f+7]=d[B+7],w>0){const P=(w-1)/e;let y=0;if(n==="left_to_right"?y=Math.floor(P*t):n==="right_to_left"?y=Math.floor((1-P)*t):n==="center_to_out"?y=Math.floor(Math.abs(P-.5)*2*t):n==="out_to_center"&&(y=Math.floor((1-Math.abs(P-.5)*2)*t)),y=Math.min(t-1,Math.max(0,y)),y!==R){i[f+6]=1,i[f+3]=0,i[f+4]=0,i[f+5]=0;const A=(w-1)*8;i[A+6]=1,i[A+3]=0,i[A+4]=0,i[A+5]=0}}}else i.set(r.subarray(f,f+8),f),i[f+3]=0,i[f+4]=0,i[f+5]=0,i[f+6]=1}return r._channelDistributions&&(i._channelDistributions=r._channelDistributions),i}else if(o==="frame"){const c=t,i=h*c+1;g.length>i&&(g.length=i);const w=[];for(let d=0;d<c;d++){const x=d*h,f=x<g.length?g[x]:null;w.push({points:f,factor:Math.pow(m,d)})}let R=0;for(let d=0;d<w.length;d++){const x=w[d].points||r;R+=x.length/8,d<w.length-1&&(R+=1)}const F=new Float32Array(R*8);let M=0;for(let d=0;d<w.length;d++){const x=w[d],f=x.points||r,B=x.factor,C=f.length/8;for(let P=0;P<C;P++){const y=P*8,A=M+P*8;F[A]=f[y],F[A+1]=f[y+1],F[A+2]=f[y+2],F[A+3]=f[y+3]*B,F[A+4]=f[y+4]*B,F[A+5]=f[y+5]*B,F[A+6]=f[y+6],F[A+7]=f[y+7]}if(M+=C*8,d<w.length-1){const P=(C-1)*8,y=M;F[y]=f[P],F[y+1]=f[P+1],F[y+2]=f[P+2],F[y+3]=0,F[y+4]=0,F[y+5]=0,F[y+6]=1,F[y+7]=0,M+=8}}return r._channelDistributions&&(F._channelDistributions=r._channelDistributions),F}else{const{assignedDacs:c}=a||{};let i=new Map,w=0;if(b||p.delayMode==="channel")(_&&_.length>0?_.map(A=>A.originalIndex):c?c.map((A,v)=>v):[0]).forEach((A,v)=>{i.set(A,v),w=Math.max(w,v)});else{const A=(c||[]).length||1;for(let v=0;v<A;v++){let S=v;n==="right_to_left"?S=A-1-v:n==="center_to_out"?S=Math.floor(Math.abs(v-(A-1)/2)):n==="out_to_center"&&(S=Math.min(v,A-1-v)),i.set(v,S),w=Math.max(w,S)}}const F=w+1,M=h*F+1;g.length>M&&(g.length=M);const d=[];for(let y=0;y<F;y++){const A=y*h;d.push({points:A<g.length?g[A]:null,factor:Math.pow(m,y),index:y})}const x=d.reduce((y,A)=>y+(A.points?A.points.length/8:r.length/8),0),f=new Float32Array(x*8);let B=0;const C=new Array(d.length);for(let y=0;y<d.length;y++){const A=d[y],v=A.points,S=v?v.length/8:r.length/8;C[y]=B;for(let I=0;I<S;I++){const D=I*8,E=B+I*8;v?(f[E]=v[D],f[E+1]=v[D+1],f[E+2]=v[D+2],f[E+3]=v[D+3]*A.factor,f[E+4]=v[D+4]*A.factor,f[E+5]=v[D+5]*A.factor,f[E+6]=v[D+6],f[E+7]=v[D+7]):f[E+6]=1}B+=S*8}const P=new Map;return i.forEach((y,A)=>{y<d.length&&P.set(A,{start:C[y],length:d[y].points?d[y].points.length:r.length})}),f._channelDistributions=P,f}}function ce(r,e,p,l,s={}){const{mode:a="segment",steps:o,decay:h,speed:m,overlap:n,direction:b,useCustomOrder:_,customOrder:u,playstyle:t="loop"}=p,{progress:g=0,clipDuration:c=1,syncSettings:i={}}=s,w=p.instanceId?`${p.instanceId}.`:"chase.",R=!!i[w+"speed"],F=g!==void 0&&c>0||R;if(a==="segment"){const M=o;let d=(F?g*M:l*.001)*m;if(t==="bounce"){const f=M,B=d%(f*2);d=B>f?f*2-B:B}else t==="once"?d=Math.min(d,M):d=d%M;const x=new Float32Array(r.length);for(let f=0;f<e;f++){const B=f/e;let C=0;b==="left_to_right"?C=Math.min(M-1,Math.floor(B*M)):b==="right_to_left"?C=Math.min(M-1,Math.floor((1-B)*M)):b==="center_to_out"?C=Math.min(M-1,Math.floor(Math.abs(B-.5)*2*M)):b==="out_to_center"&&(C=Math.min(M-1,Math.floor((1-Math.abs(B-.5)*2)*M)));let P=Math.abs(d-C);P>M/2&&(P=M-P);let y=P<n?1-P/n:0;h>0&&(y=Math.pow(y,1-h));const A=f*8;if(x.set(r.subarray(A,A+8),A),x[A+3]*=y,x[A+4]*=y,x[A+5]*=y,(y<.05||r[A+6]>.5)&&(x[A+6]=1,x[A+3]=0,x[A+4]=0,x[A+5]=0),f>0){const v=(f-1)/e;let S=0;if(b==="left_to_right"?S=Math.min(M-1,Math.floor(v*M)):b==="right_to_left"?S=Math.min(M-1,Math.floor((1-v)*M)):b==="center_to_out"?S=Math.min(M-1,Math.floor(Math.abs(v-.5)*2*M)):b==="out_to_center"&&(S=Math.min(M-1,Math.floor((1-Math.abs(v-.5)*2)*M))),S!==C){x[A+6]=1,x[A+3]=0,x[A+4]=0,x[A+5]=0;const I=(f-1)*8;x[I+6]=1,x[I+3]=0,x[I+4]=0,x[I+5]=0}}}return r._channelDistributions&&(x._channelDistributions=r._channelDistributions),x}else{const{assignedDacs:M}=s||{};let d=new Map,x=0;if(_)(u&&u.length>0?u.map(I=>I.originalIndex):M?M.map((I,D)=>D):[0]).forEach((I,D)=>{d.set(I,D),x++});else{x=(M?M.length:1)||1;for(let S=0;S<x;S++){let I=S;b==="right_to_left"?I=x-1-S:b==="center_to_out"?I=Math.floor(Math.abs(S-(x-1)/2)):b==="out_to_center"&&(I=Math.min(S,x-1-S)),d.set(S,I)}}const f=x;let B=(F?g*f:l*.001)*m;if(t==="bounce"){const S=f,I=B%(S*2);B=I>S?S*2-I:I}else t==="once"?B=Math.min(B,f):B=B%f;const C=e*x,P=new Float32Array(C*8),y=new Map;let A=0;const v=Array.from(d.keys());v.length===0&&v.push(0);for(const S of v){const I=d.get(S)||0;let D=Math.abs(B-I);D>f/2&&(D=f-D);let E=D<n?1-D/n:0;h>0&&(E=Math.pow(E,1-h));const L=A;for(let k=0;k<e;k++){const Y=k*8,T=A+k*8;P.set(r.subarray(Y,Y+8),T),P[T+3]*=E,P[T+4]*=E,P[T+5]*=E,E<.05&&(P[T+6]=1)}y.set(S,{start:L,length:e*8}),A+=e*8}return P._channelDistributions=y,P}}function he(r,e,p=!1){if(!e||!r||!r.points)return r;const{safetyZones:l,outputArea:s,transformationEnabled:a,transformationMode:o,flipX:h,flipY:m}=e;let n=r.points;const b=r.isTypedArray||n instanceof Float32Array,_=b?n.length/8:n.length;let u=p?n:b?new Float32Array(n):n.map(t=>({...t}));for(let t=0;t<_;t++){let g,c,i,w,R,F;if(b?(g=u[t*8],c=u[t*8+1],i=u[t*8+3],w=u[t*8+4],R=u[t*8+5],F=u[t*8+6]):(g=u[t].x,c=u[t].y,i=u[t].r,w=u[t].g,R=u[t].b,F=u[t].blanking?1:0),a&&s){let M=(g+1)/2,d=(1-c)/2;o==="crop"?(M<s.x||M>s.x+s.w||d<s.y||d>s.y+s.h)&&(i=0,w=0,R=0,F=1):o==="scale"&&(M=s.x+M*s.w,d=s.y+d*s.h,g=M*2-1,c=1-d*2)}if(l&&l.length>0){let M=(g+1)/2,d=(1-c)/2;for(const x of l)if(M>=x.x&&M<=x.x+x.w&&d>=x.y&&d<=x.y+x.h){i=0,w=0,R=0,F=1;break}}h&&(g=-g),m&&(c=-c),g=Math.max(-1,Math.min(1,g)),c=Math.max(-1,Math.min(1,c)),b?(u[t*8]=g,u[t*8+1]=c,u[t*8+3]=i,u[t*8+4]=w,u[t*8+5]=R,u[t*8+6]=F):(u[t].x=g,u[t].y=c,u[t].r=i,u[t].g=w,u[t].b=R,u[t].blanking=F>.5)}return{...r,points:u,isTypedArray:b}}const X=.08,q=4;function de(r){if(!r)return new Float32Array(0);const e=r instanceof Float32Array||r.isTypedArray,p=e?r.length/8:r.length;if(p>4e3){if(r instanceof Float32Array)return r;const m=new Float32Array(p*8);for(let n=0;n<p;n++){const b=r[n];m[n*8]=b.x,m[n*8+1]=b.y,m[n*8+2]=b.z||0,m[n*8+3]=b.r,m[n*8+4]=b.g,m[n*8+5]=b.b,m[n*8+6]=b.blanking?1:0,m[n*8+7]=b.lastPoint?1:0}return m}const l=[],s=(m,n,b,_,u,t,g)=>{const c=g?0:_,i=g?0:u,w=g?0:t;l.push(m,n,b,c,i,w,g?1:0,0)},a=m=>{if(e){const n=m*8;return{x:r[n],y:r[n+1],z:r[n+2],r:r[n+3],g:r[n+4],b:r[n+5],blanking:r[n+6]>.5}}else{const n=r[m];return{x:n.x||0,y:n.y||0,z:n.z||0,r:n.r||0,g:n.g||0,b:n.b||0,blanking:!!n.blanking}}};if(p===0)return new Float32Array(0);let o=a(0);for(let m=0;m<p;m++){const n=a(m);if(o.blanking!==n.blanking)if(n.blanking)for(let t=0;t<q;t++)s(o.x,o.y,o.z,0,0,0,!0);else{s(n.x,n.y,n.z,0,0,0,!0);for(let t=0;t<q;t++)s(n.x,n.y,n.z,0,0,0,!0)}const b=n.x-o.x,_=n.y-o.y,u=Math.sqrt(b*b+_*_);if(u>X){const t=Math.floor(u/X);for(let g=1;g<t;g++){const c=g/t;s(o.x+b*c,o.y+_*c,o.z+(n.z-o.z)*c,n.blanking?0:n.r,n.blanking?0:n.g,n.blanking?0:n.b,n.blanking)}}s(n.x,n.y,n.z,n.r,n.g,n.b,n.blanking),o=n}const h=new Float32Array(l);return r._channelDistributions&&(h._channelDistributions=r._channelDistributions),h}class pe{constructor(e,p){if(this.canvas=e,this.type=p,this.gl=e.getContext("webgl")||e.getContext("experimental-webgl"),this.animationFrameId=null,this.frameIndexes=Array(10).fill(0),this.pointIndexes=Array(10).fill(0),this.showBeamEffect=!1,this.beamAlpha=.5,this.fadeAlpha=.13,this.beamRenderMode="both",this.positionBuffer=null,this.colorBuffer=null,this.alphaBuffer=null,this.alphaBufferData=new Float32Array(131072),this.lastPointDrawTime=0,!this.gl){console.error("WebGL not supported");return}this.setup()}setup(){const e=this.gl,p=`
      attribute vec2 aPosition;
      attribute vec3 aColor;
      attribute float aAlpha;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
        gl_PointSize = 2.0;
        vColor = aColor;
        vAlpha = aAlpha;
      }
    `,l=`
      precision mediump float;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_FragColor = vec4(vColor, vAlpha);
      }
    `,s=this.createShader(e.VERTEX_SHADER,p),a=this.createShader(e.FRAGMENT_SHADER,l),o=this.createProgram(s,a);this.program=o,this.positionAttributeLocation=e.getAttribLocation(o,"aPosition"),this.colorAttributeLocation=e.getAttribLocation(o,"aColor"),this.alphaAttributeLocation=e.getAttribLocation(o,"aAlpha"),this.quadPositionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.quadPositionBuffer);const h=[-1,-1,1,-1,-1,1,-1,1,1,-1,1,1];e.bufferData(e.ARRAY_BUFFER,new Float32Array(h),e.STATIC_DRAW),this.quadColorUniformLocation=e.getUniformLocation(o,"uColor"),this.quadAlphaUniformLocation=e.getUniformLocation(o,"uAlpha");const m=`
      attribute vec2 aPosition;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
      }
    `,n=`
      precision mediump float;
      uniform vec4 uColor;
      void main() {
        gl_FragColor = uColor;
      }
    `,b=this.createShader(e.VERTEX_SHADER,m),_=this.createShader(e.FRAGMENT_SHADER,n);this.fadeProgram=this.createProgram(b,_),this.fadePositionAttributeLocation=e.getAttribLocation(this.fadeProgram,"aPosition"),this.fadeColorUniformLocation=e.getUniformLocation(this.fadeProgram,"uColor"),e.useProgram(o);const u=131072;this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferData(e.ARRAY_BUFFER,u*2*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),this.colorBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),e.bufferData(e.ARRAY_BUFFER,u*3*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),this.alphaBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.alphaBuffer),e.bufferData(e.ARRAY_BUFFER,u*1*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.clearColor(0,0,0,1)}reset(){this.frameIndexes.fill(0),this.pointIndexes.fill(0),this.clearCanvas()}createShader(e,p){const l=this.gl,s=l.createShader(e);if(l.shaderSource(s,p),l.compileShader(s),l.getShaderParameter(s,l.COMPILE_STATUS))return s;console.error(l.getShaderInfoLog(s)),l.deleteShader(s)}createProgram(e,p){const l=this.gl,s=l.createProgram();if(l.attachShader(s,e),l.attachShader(s,p),l.linkProgram(s),l.getProgramParameter(s,l.LINK_STATUS))return s;console.error(l.getProgramInfoLog(s)),l.deleteProgram(s)}render(e){e.showBeamEffect!==void 0&&this.setBeamEffect(e.showBeamEffect),e.beamAlpha!==void 0&&this.setBeamAlpha(e.beamAlpha),e.fadeAlpha!==void 0&&this.setFadeAlpha(e.fadeAlpha),e.beamRenderMode!==void 0&&(this.beamRenderMode=e.beamRenderMode),this.type==="world"?this.renderWorld(e.worldData,e.previewScanRate,e.layerIntensities,e.masterIntensity,e.dacSettings,e.previewTime,e.fftLevels,e.optimizationEnabled):this.renderSingle(e.ildaFrames,e.previewScanRate,e.intensity,e.effects,e.syncSettings,e.bpm,e.clipDuration,e.progress,e.previewTime,e.fftLevels,e.effectStates,e.optimizationEnabled)}renderSingle(e,p,l,s,a={},o=120,h=1,m=null,n=null,b={low:0,mid:0,high:0},_=null,u=!0){const t=this.gl;if(t.viewport(0,0,t.canvas.width,t.canvas.height),this.drawFadeQuad(),!e||e.length===0)return;const g=this.frameIndexes[0]%e.length,c=e[g],i=m!==null?m:g/e.length,w=n!==null?n:performance.now();this.draw(c,s,this.showBeamEffect,this.beamAlpha,p,this.beamRenderMode,l,0,i,w,a,o,h,b,_,u),this.frameIndexes[0]++,this.frameIndexes[0]>=e.length&&(this.frameIndexes[0]=0)}renderWorld(e,p,l,s,a,o=null,h={low:0,mid:0,high:0},m=!0){const n=this.gl;n.viewport(0,0,n.canvas.width,n.canvas.height),this.drawFadeQuad();const b=o!==null?o:performance.now();e.forEach(_=>{if(_&&_.frames&&_.frames.length>0){const u=_.frames[0];if(u){const t=_.layerIndex||0;if(_.syncSettings,_.bpm,t>=this.frameIndexes.length){const i=t+5;for(;this.frameIndexes.length<i;)this.frameIndexes.push(0),this.pointIndexes.push(0)}const c=(l[t]!==void 0?l[t]:1)*s;if(c>.001){const i=_.progress!==void 0?_.progress:this.frameIndexes[t]%_.frames.length/_.frames.length,{syncSettings:w={},bpm:R=120,clipDuration:F=1,effectStates:M=null}=_;let d=u;if(a){let x=u;if(a.dimmer!==void 0&&a.dimmer<1){const f=u.points,B=u.isTypedArray||f instanceof Float32Array,C=B?f.length/8:f.length,P=B?new Float32Array(f):f.map(y=>({...y}));for(let y=0;y<C;y++)B?(P[y*8+3]*=a.dimmer,P[y*8+4]*=a.dimmer,P[y*8+5]*=a.dimmer):(P[y].r*=a.dimmer,P[y].g*=a.dimmer,P[y].b*=a.dimmer);x={...u,points:P,isTypedArray:B}}d=he(x,a)}this.draw(d,_.effects,this.showBeamEffect,this.beamAlpha,p,this.beamRenderMode,c,t,i,b,w,R,F,h,M,m)}}}}),e.forEach(_=>{if(_&&_.frames){const u=_.layerIndex||0;this.frameIndexes[u]++,this.frameIndexes[u]>=_.frames.length&&(this.frameIndexes[u]=0)}})}drawFadeQuad(){const e=this.gl;this.fadeProgram&&(e.useProgram(this.fadeProgram),e.bindBuffer(e.ARRAY_BUFFER,this.quadPositionBuffer),e.enableVertexAttribArray(this.fadePositionAttributeLocation),e.vertexAttribPointer(this.fadePositionAttributeLocation,2,e.FLOAT,!1,0,0),e.uniform4f(this.fadeColorUniformLocation,0,0,0,this.fadeAlpha),e.drawArrays(e.TRIANGLES,0,6))}setBeamEffect(e){this.showBeamEffect=e}setBeamAlpha(e){this.beamAlpha=e}setFadeAlpha(e){this.fadeAlpha=e}draw(e,p,l,s,a,o,h=1,m=0,n=0,b=performance.now(),_={},u=120,t=1,g={low:0,mid:0,high:0},c=null,i=!0){if(this.gl,!e||!e.points)return;let w=e;if(i){const A=de(e.points);w={...e,points:A,isTypedArray:!0}}const R=$(w,p,{progress:n,time:b,syncSettings:_,bpm:u,clipDuration:t,fftLevels:g,effectStates:c}),F=R.points,M=R.isTypedArray,d=M?F.length/8:F.length;if(d===0)return;const x=Math.max(1,Math.floor(d/a));let f=this.pointIndexes[m]||0;f>=d&&(f=0);const B=A=>{const v=(f+A)%d;if(M){const S=v*8;return{x:F[S],y:F[S+1],r:F[S+3],g:F[S+4],b:F[S+5],blanking:F[S+6]===1}}else{const S=F[v];return{x:S.x,y:S.y,r:S.r,g:S.g,b:S.b,blanking:S.blanking}}},C=()=>{const A=o==="points"||o==="both";if(o==="lines"||o==="both"){let S=[],I=[],D=B(0);for(let E=1;E<x;E++){const L=B(E),k=(f+E)%d,Y=(f+E-1)%d,T=k<Y;L.blanking||T?S.length>0&&(this._drawSegment(new Float32Array(S),new Float32Array(I),1,S.length/2,!1),S=[],I=[]):(S.length===0&&(S.push(D.x,D.y),I.push(L.r/255*h,L.g/255*h,L.b/255*h)),S.push(L.x,L.y),I.push(L.r/255*h,L.g/255*h,L.b/255*h)),D=L}S.length>0&&this._drawSegment(new Float32Array(S),new Float32Array(I),1,S.length/2,!1)}if(A){const S=[],I=[];for(let D=0;D<x;D++){const E=B(D);E.blanking||(S.push(E.x,E.y),I.push(E.r/255*h,E.g/255*h,E.b/255*h))}S.length>0&&this._drawSegment(new Float32Array(S),new Float32Array(I),1,S.length/2,!0)}},P=()=>{const A=[],v=[];for(let S=0;S<x;S++){const I=B(S);if(!I.blanking){A.push(0,0,I.x,I.y);const D=[I.r/255*h,I.g/255*h,I.b/255*h];v.push(...D,...D)}}A.length>0&&this._drawLines(new Float32Array(A),new Float32Array(v),s,A.length/2)},y=()=>{const A=[],v=[];let S=B(0);for(let I=1;I<x;I++){const D=B(I);if((f+I)%d<(f+I-1)%d){S=D;continue}if(!D.blanking){A.push(0,0,S.x,S.y,D.x,D.y);const L=[D.r/255*h,D.g/255*h,D.b/255*h],k=[D.r/255*h,D.g/255*h,D.b/255*h],Y=[L[0],L[1],L[2]],T=.3,ue=[L[0]*T,L[1]*T,L[2]*T],me=[k[0]*T,k[1]*T,k[2]*T];v.push(...Y,...ue,...me)}S=D}A.length>0&&this._drawTriangles(new Float32Array(A),new Float32Array(v),s,A.length/2)};C(),l&&(o==="points"?P():o==="lines"?y():o==="both"&&(y(),P())),this.pointIndexes[m]=(f+x)%d}_drawSegment(e,p,l,s,a=!1){const o=this.gl;o.useProgram(this.program),o.bindBuffer(o.ARRAY_BUFFER,this.positionBuffer),o.bufferSubData(o.ARRAY_BUFFER,0,e),o.enableVertexAttribArray(this.positionAttributeLocation),o.vertexAttribPointer(this.positionAttributeLocation,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this.colorBuffer),o.bufferSubData(o.ARRAY_BUFFER,0,p),o.enableVertexAttribArray(this.colorAttributeLocation),o.vertexAttribPointer(this.colorAttributeLocation,3,o.FLOAT,!1,0,0),this.alphaBufferData.length<s&&(this.alphaBufferData=new Float32Array(s*2)),this.alphaBufferData.fill(l,0,s);const h=this.alphaBufferData.subarray(0,s);o.bindBuffer(o.ARRAY_BUFFER,this.alphaBuffer),o.bufferSubData(o.ARRAY_BUFFER,0,h),o.enableVertexAttribArray(this.alphaAttributeLocation),o.vertexAttribPointer(this.alphaAttributeLocation,1,o.FLOAT,!1,0,0),o.drawArrays(a?o.POINTS:o.LINE_STRIP,0,s)}_drawLines(e,p,l,s){const a=this.gl;a.useProgram(this.program),a.bindBuffer(a.ARRAY_BUFFER,this.positionBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,e),a.enableVertexAttribArray(this.positionAttributeLocation),a.vertexAttribPointer(this.positionAttributeLocation,2,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.colorBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,p),a.enableVertexAttribArray(this.colorAttributeLocation),a.vertexAttribPointer(this.colorAttributeLocation,3,a.FLOAT,!1,0,0),this.alphaBufferData.length<s&&(this.alphaBufferData=new Float32Array(s*2)),this.alphaBufferData.fill(l,0,s);const o=this.alphaBufferData.subarray(0,s);a.bindBuffer(a.ARRAY_BUFFER,this.alphaBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,o),a.enableVertexAttribArray(this.alphaAttributeLocation),a.vertexAttribPointer(this.alphaAttributeLocation,1,a.FLOAT,!1,0,0),a.drawArrays(a.LINES,0,s)}_drawTriangles(e,p,l,s){const a=this.gl;a.useProgram(this.program),a.bindBuffer(a.ARRAY_BUFFER,this.positionBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,e),a.enableVertexAttribArray(this.positionAttributeLocation),a.vertexAttribPointer(this.positionAttributeLocation,2,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.colorBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,p),a.enableVertexAttribArray(this.colorAttributeLocation),a.vertexAttribPointer(this.colorAttributeLocation,3,a.FLOAT,!1,0,0),this.alphaBufferData.length<s&&(this.alphaBufferData=new Float32Array(s*2)),this.alphaBufferData.fill(l,0,s);const o=this.alphaBufferData.subarray(0,s);a.bindBuffer(a.ARRAY_BUFFER,this.alphaBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,o),a.enableVertexAttribArray(this.alphaAttributeLocation),a.vertexAttribPointer(this.alphaAttributeLocation,1,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,s)}clearCanvas(){const e=this.gl;e.viewport(0,0,e.canvas.width,e.canvas.height),e.clear(e.COLOR_BUFFER_BIT)}destroy(){if(cancelAnimationFrame(this.animationFrameId),this.gl){const e=this.gl.getExtension("WEBGL_losing_context");e&&e.loseContext()}}}const O=new Map;function H(r,e=0){const p=O.get(r);if(!p)return;const l=performance.now();p.renderer.render(p.data),e=l,p.animationFrameId=requestAnimationFrame(()=>H(r,e))}self.onmessage=r=>{const{action:e,payload:p}=r.data;if(e==="register"){const{id:l,canvas:s,type:a,data:o}=p,h=new pe(s,a),m=requestAnimationFrame(()=>H(l));O.set(l,{renderer:h,type:a,data:o,animationFrameId:m})}else if(e==="deregister"){const{id:l}=p,s=O.get(l);s&&(cancelAnimationFrame(s.animationFrameId),O.delete(l))}else if(e==="update"){const{id:l,data:s}=p,a=O.get(l);if(a){if(a.data&&a.data.effectStates&&s.effectStates)s.effectStates=a.data.effectStates;else if(a.data&&a.data.worldData&&a.data.worldData.length>0){const o=a.data.worldData[0];if(o&&o.effectStates&&s.worldData){const h=o.effectStates;for(const m of s.worldData)m.effectStates=h}}a.data=s}}else if(e==="clear"){const{id:l}=p,s=O.get(l);s&&s.renderer.clearCanvas()}}})();
