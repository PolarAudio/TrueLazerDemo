(function(){"use strict";const I=new Map;function y(o){console.log("[ilda-parser.worker.js] parseIldaFile - Starting parsing.");const t=new DataView(o),n=[];let f=null,a=0;for(;a+32<=o.byteLength;){const s=a,l=String.fromCharCode(t.getUint8(s),t.getUint8(s+1),t.getUint8(s+2),t.getUint8(s+3));if(l!=="ILDA"){console.warn(`[ilda-parser.worker.js] Parser: Invalid ILDA signature at offset ${s}, got: ${l}. Skipping 32 bytes.`),a+=32;continue}const d=t.getUint8(s+7);if(f===null&&(f=d),d>5){console.warn(`[ilda-parser.worker.js] Parser: Unknown format code: ${d} at offset ${s}. Skipping 32 bytes.`),a+=32;continue}let c=t.getUint16(s+24,!1);const w=t.getUint16(s+26,!1),g=t.getUint16(s+28,!1),e=t.getUint8(s+30);let r;switch(d){case 0:r=8;break;case 1:r=6;break;case 2:r=3;break;case 4:r=10;break;case 5:r=8;break;default:console.warn(`Parser: Unsupported format ${d}, skipping 32 bytes.`),a+=32;continue}let p=c*r,i=32+p;const k=o.byteLength-a;if(i<k){const u=k-i;u>0&&u<=32&&(console.warn(`Parser: Malformed frame, ${u} leftover bytes. Adjusting size.`),i+=u,p+=u,c=Math.floor(p/r))}if(s+i>o.byteLength){console.warn(`Parser: Incomplete frame data for ${c} points at offset ${s}. Expected ${i} bytes, but only ${o.byteLength-s} bytes remaining. Breaking.`);break}if(c===0){console.log("[ilda-parser.worker.js] Parser: Empty frame, skipping"),a+=i;continue}n.push({frameNumber:w,totalFrames:g,projectorNumber:e,formatCode:d,recordSize:r,pointCount:c,pointDataOffset:s+32,pointDataSize:p,frameEndOffset:s+i,bounds:{minX:0,maxX:0,minY:0,maxY:0}}),a+=i}return console.log(`[ilda-parser.worker.js] parseIldaFile - Finished parsing. Found ${n.length} frames.`),{frames:n,error:n.length===0?"No valid frames found":null,firstFormatCode:f,ildaFileBuffer:o}}const m=new Map;self.onmessage=function(o){const{arrayBuffer:t,type:n,fileName:f,filePath:a,layerIndex:s,colIndex:l,workerId:d,frameIndex:c,isStillFrame:w,requestId:g}=o.data;if(n==="parse-ilda"){if(!t){self.postMessage({success:!1,error:"ArrayBuffer missing for parse-ilda command",type:"parse-ilda"});return}try{console.log("[ilda-parser.worker.js] Calling parseIldaFile for:",f);const e=y(t);console.log("[ilda-parser.worker.js] parseIldaFile returned:",e);const r=`ilda-${Date.now()}-${Math.random().toString(36).substring(2,9)}`;I.set(r,{ildaFileBuffer:e.ildaFileBuffer,framesMetadata:e.frames}),console.log("[ilda-parser.worker.js] Posting success message for parse-ilda."),self.postMessage({success:!0,workerId:r,totalFrames:e.frames.length,ildaFormat:e.firstFormatCode,fileName:f,filePath:a,layerIndex:s,colIndex:l,type:"parse-ilda"}),self.postMessage({type:"parsing-status",status:!1,layerIndex:s,colIndex:l})}catch(e){console.error("[ilda-parser.worker.js] Error parsing file in onmessage handler:",e),self.postMessage({success:!1,error:e.message,type:"parse-ilda"}),self.postMessage({type:"parsing-status",status:!1,layerIndex:s,colIndex:l})}}else if(n==="load-and-parse-ilda"){const e=Math.random().toString(36).substring(2,15);m.set(e,{fileName:f,filePath:a,layerIndex:s,colIndex:l}),self.postMessage({type:"parsing-status",status:!0,layerIndex:s,colIndex:l}),self.postMessage({type:"request-file-content",filePath:a,requestId:e})}else if(n==="file-content-response"){const e=m.get(g);if(!e){console.error(`Worker: No context found for requestId: ${g}`);return}if(m.delete(g),o.data.error){console.error(`Worker: Error receiving file content: ${o.data.error}`),self.postMessage({success:!1,error:o.data.error,type:"parse-ilda",...e}),self.postMessage({type:"parsing-status",status:!1,layerIndex:e.layerIndex,colIndex:e.colIndex});return}try{console.log(`[ilda-parser.worker.js] Calling parseIldaFile for: ${e.fileName} (from file-content-response)`);const r=y(t),p=`ilda-${Date.now()}-${Math.random().toString(36).substring(2,9)}`;I.set(p,{ildaFileBuffer:r.ildaFileBuffer,framesMetadata:r.frames}),self.postMessage({success:!0,workerId:p,totalFrames:r.frames.length,ildaFormat:r.firstFormatCode,type:"parse-ilda",...e}),self.postMessage({type:"parsing-status",status:!1,layerIndex:e.layerIndex,colIndex:e.colIndex})}catch(r){console.error("[ilda-parser.worker.js] Error parsing file from content response:",r),self.postMessage({success:!1,error:r.message,type:"parse-ilda",...e}),self.postMessage({type:"parsing-status",status:!1,layerIndex:e.layerIndex,colIndex:e.colIndex})}}}})();
