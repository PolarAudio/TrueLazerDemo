(function(){"use strict";const V=[{id:"rotate",name:"Rotate",type:"transform",description:"Rotates the shape around its center.",defaultParams:{angle:0,speed:0,direction:"CW"},paramControls:[{id:"angle",label:"Angle",type:"range",min:0,max:360,step:1},{id:"speed",label:"Speed",type:"range",min:0,max:10,step:.1},{id:"direction",label:"Direction",type:"select",options:["CW","CCW"]}]},{id:"scale",name:"Scale",type:"transform",description:"Scales the shape.",defaultParams:{scaleX:1,scaleY:1},paramControls:[{id:"scaleX",label:"Scale X",type:"range",min:.01,max:5,step:.01},{id:"scaleY",label:"Scale Y",type:"range",min:.01,max:5,step:.01}]},{id:"translate",name:"Translate",type:"transform",description:"Moves the shape.",defaultParams:{translateX:0,translateY:0},paramControls:[{id:"translateX",label:"Translate X",type:"range",min:-1,max:1,step:.01},{id:"translateY",label:"Translate Y",type:"range",min:-1,max:1,step:.01}]},{id:"color",name:"Color",type:"color",description:"Changes the color of the shape with solid, rainbow or custom palette modes.",defaultParams:{mode:"solid",color:"#ffffff",r:255,g:255,b:255,cycleSpeed:0,rainbowSpread:1,rainbowOffset:0,rainbowPalette:"rainbow",paletteColors:["#ff0000","#00ff00","#0000ff","#ffff00"],paletteSize:4,paletteSpread:1,hue:0,saturation:0,brightness:1,enabled:!0},paramControls:[{id:"mode",label:"Mode",type:"select",options:["solid","rainbow","palette"]},{id:"color",label:"Color",type:"color",showIf:{mode:"solid"}},{id:"hue",label:"Hue",type:"range",min:0,max:1,step:.001,showIf:{mode:"hsv_advanced"}},{id:"saturation",label:"Saturation",type:"range",min:0,max:1,step:.001,showIf:{mode:"hsv_advanced"}},{id:"brightness",label:"Brightness",type:"range",min:0,max:1,step:.001,showIf:{mode:"hsv_advanced"}},{id:"paletteSize",label:"Palette Size",type:"range",min:2,max:16,step:1,showIf:{mode:"palette"}},{id:"paletteSpread",label:"Spread",type:"range",min:.1,max:10,step:.1,showIf:{mode:"palette"}},{id:"cycleSpeed",label:"Cycle Speed",type:"range",min:0,max:10,step:.1,showIf:{mode:["rainbow","palette"]}},{id:"rainbowSpread",label:"Rainbow Spread",type:"range",min:.1,max:10,step:.1,showIf:{mode:"rainbow"}},{id:"rainbowOffset",label:"Offset",type:"range",min:0,max:360,step:1,showIf:{mode:["rainbow","palette"]}},{id:"rainbowPalette",label:"Preset",type:"select",options:["rainbow","fire","ice","cyber"],showIf:{mode:"rainbow"}}]},{id:"wave",name:"Wave",type:"animation",description:"Applies a wave distortion to the shape.",defaultParams:{amplitude:.1,frequency:10,speed:1,direction:"x"},paramControls:[{id:"amplitude",label:"Amplitude",type:"range",min:.01,max:1,step:.01},{id:"frequency",label:"Frequency",type:"range",min:1,max:50,step:1},{id:"speed",label:"Speed",type:"range",min:.1,max:10,step:.1},{id:"direction",label:"Direction",type:"select",options:["x","y"]}]},{id:"warp",name:"Warp",type:"animation",description:"Symmetrical chaotic wave distortion.",defaultParams:{amount:.1,chaos:.5,speed:1},paramControls:[{id:"amount",label:"Amount",type:"range",min:0,max:1,step:.01},{id:"chaos",label:"Chaos",type:"range",min:0,max:1,step:.01},{id:"speed",label:"Speed",type:"range",min:.1,max:10,step:.1}]},{id:"distortion",name:"Distortion",type:"transform",description:"Distorts the point data.",defaultParams:{amount:.1,scale:10,speed:.5},paramControls:[{id:"amount",label:"Amount",type:"range",min:0,max:1,step:.01},{id:"scale",label:"Scale",type:"range",min:1,max:50,step:1},{id:"speed",label:"Speed",type:"range",min:0,max:5,step:.1}]},{id:"move",name:"Move (Bounce)",type:"transform",description:"Moves points and bounces them off the borders.",defaultParams:{speedX:.1,speedY:.1},paramControls:[{id:"speedX",label:"Speed X",type:"range",min:0,max:2,step:.01},{id:"speedY",label:"Speed Y",type:"range",min:0,max:2,step:.01}]},{id:"delay",name:"Delay",type:"effect",description:"Frame or Channel based delay effect.",defaultParams:{mode:"frame",playstyle:"repeat",useCustomOrder:!1,delayDirection:"left_to_right",delayAmount:5,decay:.8,steps:10,customOrder:[],enabled:!0},paramControls:[{id:"mode",label:"Mode",type:"select",options:["frame","channel"]},{id:"playstyle",label:"Playstyle",type:"select",options:["once","repeat"]},{id:"useCustomOrder",label:"Custom Order",type:"checkbox",showIf:{mode:"channel"}},{id:"delayDirection",label:"Direction",type:"select",options:["center_to_out","out_to_center","left_to_right","right_to_left"],showIf:{useCustomOrder:!1}},{id:"steps",label:"Steps",type:"range",min:2,max:20,step:1,showIf:{mode:"frame"}},{id:"delayAmount",label:"Delay Time",type:"range",min:1,max:60,step:1},{id:"decay",label:"Decay",type:"range",min:0,max:1,step:.01}]},{id:"chase",name:"Chase",type:"effect",description:"Frame or Channel based chase effect.",defaultParams:{mode:"frame",playstyle:"repeat",steps:4,decay:.8,speed:1,overlap:1,direction:"left_to_right",useCustomOrder:!1,customOrder:[],enabled:!0},paramControls:[{id:"mode",label:"Mode",type:"select",options:["frame","channel"]},{id:"playstyle",label:"Playstyle",type:"select",options:["once","repeat","bounce"]},{id:"steps",label:"Steps",type:"range",min:2,max:16,step:1,showIf:{mode:"frame"}},{id:"decay",label:"Decay",type:"range",min:0,max:1,step:.01},{id:"speed",label:"Speed",type:"range",min:.1,max:5,step:.1},{id:"overlap",label:"Overlap",type:"range",min:1,max:4,step:1},{id:"useCustomOrder",label:"Custom Order",type:"checkbox",showIf:{mode:"channel"}},{id:"direction",label:"Direction",type:"select",options:["center_to_out","out_to_center","left_to_right","right_to_left"],showIf:{useCustomOrder:!1}}]},{id:"blanking",name:"Blanking",type:"animation",description:"Controls the blanking of the laser output.",defaultParams:{blankingInterval:0,spacing:0},paramControls:[{id:"blankingInterval",label:"Blanking Interval",type:"range",min:0,max:10,step:1},{id:"spacing",label:"Spacing",type:"range",min:0,max:20,step:1}]},{id:"strobe",name:"Strobe",type:"animation",description:"Applies a strobe effect to the laser output.",defaultParams:{strobeSpeed:100,strobeAmount:.5},paramControls:[{id:"strobeSpeed",label:"Strobe Speed (ms)",type:"range",min:10,max:1e3,step:10},{id:"strobeAmount",label:"Strobe Amount (0-1)",type:"range",min:0,max:1,step:.01}]},{id:"mirror",name:"Mirror",type:"transform",description:"Mirrors the shape from the center.",defaultParams:{mode:"none",additive:!0},paramControls:[{id:"mode",label:"Mirror Mode",type:"select",options:["none","x+","x-","y+","y-"]},{id:"additive",label:"Additive",type:"checkbox"}]}].reduce((r,e)=>(r[e.id]=e,r),{});function W(r,e,d,l){const o=e.style||"loop",a=e.direction||"forward";if(a==="pause")return d;let n=r;o==="bounce"&&(n*=2);let i=0;if(o==="once")i=Math.min(n,1),a==="backward"&&(i=1-i);else if(o==="bounce"){let c=n%1;Math.floor(n)%2===1?i=1-c:i=c,a==="backward"&&(i=1-i)}else i=n%1,a==="backward"&&(i=1-i);return l&&Array.isArray(l)&&l.length===2?l[0]+(l[1]-l[0])*i:d}function G(r,e,d,l,o,a){if(!d)return e;const n=typeof d=="string"?{syncMode:d}:d;if(!n.syncMode)return e;const{time:i,progress:c=0,bpm:s=120,clipDuration:y=0,fftLevels:b={low:0,mid:0,high:0},activationTime:h=0}=l;let p=n.range;!p||!Array.isArray(p)||p.length;let A=0;const M=n.speedMultiplier||1;if((n.style||"loop")==="once"&&h>0){const f=(i-h)*.001;let x=1;if(n.syncMode==="timeline")x=Math.max(.01,n.duration||1);else if(n.syncMode==="bpm"){const R=Math.max(.1,n.beats||4),w=s/60;x=R/(w||2)}else if(n.syncMode==="fps")return A=f*M,W(A,n,e,p);A=f/x*M}else if(n.syncMode==="fps")A=i*.001*M;else if(n.syncMode==="timeline"){const f=Math.max(.01,n.duration||1);y>0?A=c*y/f*M:A=0}else if(n.syncMode==="bpm"){const f=Math.max(.1,n.beats||4),x=s/60,R=f/(x||2);y>0?A=c*y/R*M:A=0}else if(n.syncMode==="fft"){const f=b[n.fftRange||"low"]||0;return p?p[0]+(p[1]-p[0])*f:e}return W(A,n,e,p)}let N=new Float32Array(1024*8);function K(r){N.length<r*8&&(N=new Float32Array(r*8*2))}function $(r,e,d={}){const{progress:l=0,time:o=performance.now(),effectStates:a,syncSettings:n={},fftLevels:i}=d;if(!e||e.length===0)return r;const c=r.points,s=r.isTypedArray||c instanceof Float32Array,y=s?c.length/8:c.length;K(y);const b=N.subarray(0,y*8);if(s)b.set(c);else for(let A=0;A<y;A++){const M=c[A],u=A*8;b[u]=M.x,b[u+1]=M.y,b[u+2]=M.z||0,b[u+3]=M.r,b[u+4]=M.g,b[u+5]=M.b,b[u+6]=M.blanking?1:0,b[u+7]=M.lastPoint?1:0}let h=b;for(const A of e){const M=A.params;if(M.enabled===!1||!V[A.id])continue;const f=h.length/8;let x=M;const R=A.instanceId?`${A.instanceId}.`:`${A.id}.`;let w=!1;for(const m in M)if(n[R+m]){w=!0;break}if(w){x={...M};for(const m in x){const S=R+m;n[S]&&(x[m]=G(m,x[m],n[S],d))}}switch(A.id){case"rotate":Q(h,f,x,l,o);break;case"scale":J(h,f,x);break;case"translate":Z(h,f,x);break;case"color":ee(h,f,x,o);break;case"wave":ae(h,f,x,o);break;case"blanking":re(h,f,x);break;case"strobe":oe(h,f,x,o);break;case"mirror":h=ne(h,f,x);break;case"warp":se(h,f,x,o);break;case"distortion":ie(h,f,x,o);break;case"move":le(h,f,x,o);break;case"delay":a&&A.instanceId&&(h=fe(h,f,x,a,A.instanceId,d));break;case"chase":h=ce(h,f,x,o,d);break}}const p=new Float32Array(h);return h._channelDistributions&&(p._channelDistributions=h._channelDistributions),{...r,points:p,isTypedArray:!0}}function Q(r,e,d,l,o){const{angle:a,speed:n,direction:i}=d,c=i==="CCW"?-1:1,s=o*.001*n*c,y=a*Math.PI/180+s,b=Math.sin(y),h=Math.cos(y);for(let p=0;p<e;p++){const A=p*8,M=r[A],u=r[A+1];r[A]=M*h-u*b,r[A+1]=M*b+u*h}}function J(r,e,d){const{scaleX:l,scaleY:o}=d;for(let a=0;a<e;a++){const n=a*8;r[n]*=l,r[n+1]*=o}}function Z(r,e,d){const{translateX:l,translateY:o}=d;for(let a=0;a<e;a++){const n=a*8;r[n]+=l,r[n+1]+=o}}function X(r){if(!r)return{r:255,g:255,b:255};const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(r);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:{r:255,g:255,b:255}}function j(r,e,d){let l,o,a;const n=Math.floor(r*6),i=r*6-n,c=d*(1-e),s=d*(1-i*e),y=d*(1-(1-i)*e);switch(n%6){case 0:l=d,o=y,a=c;break;case 1:l=s,o=d,a=c;break;case 2:l=c,o=d,a=y;break;case 3:l=c,o=s,a=d;break;case 4:l=y,o=c,a=d;break;case 5:l=d,o=c,a=s;break}return[Math.round(l*255),Math.round(o*255),Math.round(a*255)]}function ee(r,e,d,l){const{mode:o,r:a,g:n,b:i,color:c,hue:s,saturation:y,brightness:b,cycleSpeed:h,rainbowSpread:p,rainbowOffset:A,rainbowPalette:M,paletteColors:u=[],paletteSize:f=4,paletteSpread:x=1}=d,R=l*.001*h;if(o==="palette"){const w=Math.min(u.length,f),m=u.slice(0,w).map(X);m.length===0&&m.push({r:255,g:255,b:255});for(let S=0;S<e;S++){const g=S*8,E=(S/e*x+R*.5+A/360)%1*m.length,v=Math.floor(E)%m.length,I=(v+1)%m.length,B=E-Math.floor(E),P=m[v],_=m[I];r[g+3]=Math.round(P.r+(_.r-P.r)*B),r[g+4]=Math.round(P.g+(_.g-P.g)*B),r[g+5]=Math.round(P.b+(_.b-P.b)*B)}}else if(o==="rainbow"){const w=M||"rainbow";for(let m=0;m<e;m++){const S=m*8,g=(m/e*p+R*.5+A/360)%1;let F,E,v;w==="rainbow"?[F,E,v]=q(g,1,.5):[F,E,v]=te(w,g),r[S+3]=F,r[S+4]=E,r[S+5]=v}}else{let w=a,m=n,S=i;if(s!==void 0&&y!==void 0&&b!==void 0)[w,m,S]=j(s,y,b);else if(c){const g=X(c);w=g.r,m=g.g,S=g.b}if(h>0){const g=R*50%360,[F,E,v]=q(g/360,1,.5);for(let I=0;I<e;I++){const B=I*8;r[B+3]=F,r[B+4]=E,r[B+5]=v}}else for(let g=0;g<e;g++){const F=g*8;r[F+3]=w,r[F+4]=m,r[F+5]=S}}}function te(r,e){const d={fire:[{r:255,g:0,b:0},{r:255,g:128,b:0},{r:255,g:255,b:0},{r:255,g:0,b:0}],ice:[{r:0,g:0,b:255},{r:0,g:255,b:255},{r:255,g:255,b:255},{r:0,g:0,b:255}],cyber:[{r:255,g:0,b:255},{r:0,g:255,b:255},{r:0,g:0,b:255},{r:255,g:0,b:255}]},l=d[r]||d.fire,o=e*(l.length-1),a=Math.floor(o),n=o-a,i=l[a],c=l[a+1]||l[a];return[Math.round(i.r+(c.r-i.r)*n),Math.round(i.g+(c.g-i.g)*n),Math.round(i.b+(c.b-i.b)*n)]}function q(r,e,d){let l,o,a;{const n=(s,y,b)=>(b<0&&(b+=1),b>1&&(b-=1),b<.16666666666666666?s+(y-s)*6*b:b<.5?y:b<.6666666666666666?s+(y-s)*(.6666666666666666-b)*6:s),i=d+e-d*e,c=2*d-i;l=n(c,i,r+1/3),o=n(c,i,r),a=n(c,i,r-1/3)}return[Math.round(l*255),Math.round(o*255),Math.round(a*255)]}function ae(r,e,d,l){const{amplitude:o,frequency:a,speed:n,direction:i}=d,c=l*.001*n;for(let s=0;s<e;s++){const y=s*8;i==="x"?r[y+1]+=o*Math.sin(r[y]*a+c):i==="y"&&(r[y]+=o*Math.sin(r[y+1]*a+c))}}function re(r,e,d){const{blankingInterval:l,spacing:o=0}=d;if(l<=0)return;const a=l+1+o;for(let n=0;n<e;n++)n%a>=l&&(r[n*8+6]=1)}function oe(r,e,d,l){const{strobeSpeed:o,strobeAmount:a}=d;if(l%o/o<a)for(let i=0;i<e;i++)r[i*8+6]=1}function ne(r,e,d){const{mode:l,additive:o=!0}=d;if(l==="none"||e===0)return r;let a;const n=r._channelDistributions,i=(c,s,y)=>o?!0:y==="x+"?c>=0:y==="x-"?c<=0:y==="y+"?s>=0:y==="y-"?s<=0:!0;if(n){a=new Float32Array((e*2+n.size*2+50)*8);const c=new Map;let s=0;for(const[b,h]of n){const p=h.length/8,A=h.start,M=s;let u=0,f=!0;for(let x=0;x<p;x++){const R=A+x*8,w=i(r[R],r[R+1],l);w&&(!f&&u>0&&(a.set(r.subarray(R,R+8),s),a[s+6]=1,a[s+3]=0,a[s+4]=0,a[s+5]=0,s+=8,u++),a.set(r.subarray(R,R+8),s),s+=8,u++),f=w}if(u>0){const x=s-8;a.set(a.subarray(x,x+8),s),a[s+6]=1,a[s+3]=0,a[s+4]=0,a[s+5]=0,s+=8;let R=!0,w=0;for(let m=p-1;m>=0;m--){const S=A+m*8,g=i(r[S],r[S+1],l);if(g){!R&&w>0&&(a.set(r.subarray(S,S+8),s),l==="x-"||l==="x+"?a[s]=-a[s]:(l==="y-"||l==="y+")&&(a[s+1]=-a[s+1]),a[s+6]=1,a[s+3]=0,a[s+4]=0,a[s+5]=0,s+=8),a.set(r.subarray(S,S+8),s);const F=s;l==="x-"||l==="x+"?a[F]=-a[F]:(l==="y-"||l==="y+")&&(a[F+1]=-a[F+1]),s+=8,w++}R=g}c.set(b,{start:M,length:s-M})}}const y=new Float32Array(s);return y.set(a.subarray(0,s)),y._channelDistributions=c,y}else{a=new Float32Array((e*2+50)*8);let c=0,s=0,y=!0;for(let b=0;b<e;b++){const h=b*8,p=i(r[h],r[h+1],l);p&&(!y&&s>0&&(a.set(r.subarray(h,h+8),c),a[c+6]=1,a[c+3]=0,a[c+4]=0,a[c+5]=0,c+=8,s++),a.set(r.subarray(h,h+8),c),c+=8,s++),y=p}if(s>0){const b=c-8;a.set(a.subarray(b,b+8),c),a[c+6]=1,a[c+3]=0,a[c+4]=0,a[c+5]=0,c+=8;let h=!0,p=0;for(let A=e-1;A>=0;A--){const M=A*8,u=i(r[M],r[M+1],l);if(u){!h&&p>0&&(a.set(r.subarray(M,M+8),c),l==="x-"||l==="x+"?a[c]=-a[c]:(l==="y-"||l==="y+")&&(a[c+1]=-a[c+1]),a[c+6]=1,a[c+3]=0,a[c+4]=0,a[c+5]=0,c+=8),a.set(r.subarray(M,M+8),c);const f=c;l==="x-"||l==="x+"?a[f]=-a[f]:(l==="y-"||l==="y+")&&(a[f+1]=-a[f+1]),c+=8,p++}h=u}}return a.slice(0,c)}}function se(r,e,d,l){const{amount:o,chaos:a,speed:n}=d,i=l*.001*n;for(let c=0;c<e;c++){const s=c*8,y=r[s],b=r[s+1],h=Math.abs(b);r[s]+=Math.sin(h*10*(1+a)+i)*o*Math.cos(i*a),r[s+1]+=Math.cos(Math.abs(y)*10*(1+a)+i)*o*Math.sin(i*a)}}function ie(r,e,d,l){const{amount:o,scale:a,speed:n}=d,i=l*.001*n;for(let c=0;c<e;c++){const s=c*8,y=Math.sin(r[s]*a+i)*Math.cos(r[s+1]*a-i),b=Math.cos(r[s]*a-i)*Math.sin(r[s+1]*a+i);r[s]+=y*o,r[s+1]+=b*o}}function le(r,e,d,l){const{speedX:o,speedY:a}=d,n=l*.001,i=n*o,c=n*a,s=4;for(let y=0;y<e;y++){const b=y*8;let h=r[b]+i,p=r[b+1]+c,A=(h+1)%s;A<0&&(A+=s),A>2&&(A=4-A),h=A-1;let M=(p+1)%s;M<0&&(M+=s),M>2&&(M=4-M),p=M-1,r[b]=h,r[b+1]=p}}function fe(r,e,d,l,o,a){const{mode:n="frame",delayAmount:i,decay:c,delayDirection:s,useCustomOrder:y,customOrder:b,playstyle:h="repeat",steps:p=10}=d;l.has(o)||l.set(o,[]);const A=l.get(o);if(A.unshift(new Float32Array(r)),n==="frame"){const M=i*p+1;A.length>M&&(A.length=M);const u=new Float32Array(r.length);for(let f=0;f<e;f++){let x=0;const R=f/e;s==="left_to_right"?x=Math.floor(R*(p-1)):s==="right_to_left"?x=Math.floor((1-R)*(p-1)):s==="center_to_out"?x=Math.floor(Math.abs(R-.5)*2*(p-1)):s==="out_to_center"&&(x=Math.floor((1-Math.abs(R-.5)*2)*(p-1)));const w=x*i,m=w<A.length?A[w]:null,S=Math.pow(c,x),g=f*8;if(m&&m.length>0){let F;if(m.length===r.length)F=g;else{const E=m.length/8;let v=Math.floor(R*E);v>=E&&(v=E-1),F=v*8}if(u[g]=m[F],u[g+1]=m[F+1],u[g+2]=m[F+2],u[g+3]=m[F+3]*S,u[g+4]=m[F+4]*S,u[g+5]=m[F+5]*S,u[g+6]=m[F+6],u[g+7]=m[F+7],f<e-1){const E=(f+1)/e;let v=0;s==="left_to_right"?v=Math.floor(E*(p-1)):s==="right_to_left"?v=Math.floor((1-E)*(p-1)):s==="center_to_out"?v=Math.floor(Math.abs(E-.5)*2*(p-1)):s==="out_to_center"&&(v=Math.floor((1-Math.abs(E-.5)*2)*(p-1))),v!==x&&(u[g+6]=1)}}else u.set(r.subarray(g,g+8),g),u[g+3]=0,u[g+4]=0,u[g+5]=0,u[g+6]=1}return r._channelDistributions&&(u._channelDistributions=r._channelDistributions),u}else{const{assignedDacs:M}=a||{};let u=new Map,f=0;if(y||d.delayMode==="channel")(b&&b.length>0?b.map(B=>B.originalIndex):M?M.map((B,P)=>P):[0]).forEach((B,P)=>{u.set(B,P),f=Math.max(f,P)});else{const B=(M||[]).length||1;for(let P=0;P<B;P++){let _=P;s==="right_to_left"?_=B-1-P:s==="center_to_out"?_=Math.floor(Math.abs(P-(B-1)/2)):s==="out_to_center"&&(_=Math.min(P,B-1-P)),u.set(P,_),f=Math.max(f,_)}}const R=f+1,w=i*R+1;A.length>w&&(A.length=w);const m=[];for(let I=0;I<R;I++){const B=I*i;m.push({points:B<A.length?A[B]:null,factor:Math.pow(c,I),index:I})}const S=m.reduce((I,B)=>I+(B.points?B.points.length/8:r.length/8),0),g=new Float32Array(S*8);let F=0;const E=new Array(m.length);for(let I=0;I<m.length;I++){const B=m[I],P=B.points,_=P?P.length/8:r.length/8;E[I]=F;for(let D=0;D<_;D++){const C=D*8,L=F+D*8;P?(g[L]=P[C],g[L+1]=P[C+1],g[L+2]=P[C+2],g[L+3]=P[C+3]*B.factor,g[L+4]=P[C+4]*B.factor,g[L+5]=P[C+5]*B.factor,g[L+6]=P[C+6],g[L+7]=P[C+7]):g[L+6]=1}F+=_*8}const v=new Map;return u.forEach((I,B)=>{I<m.length&&v.set(B,{start:E[I],length:m[I].points?m[I].points.length:r.length})}),g._channelDistributions=v,g}}function ce(r,e,d,l,o={}){const{mode:a="frame",steps:n,decay:i,speed:c,overlap:s,direction:y,useCustomOrder:b,customOrder:h,playstyle:p="loop"}=d,{progress:A=0,clipDuration:M=1,syncSettings:u={}}=o,f=d.instanceId?`${d.instanceId}.`:"chase.",x=!!u[f+"speed"],R=A!==void 0&&M>0||x;if(a==="frame"){const w=n;let m=(R?A*w:l*.001)*c;if(p==="bounce"){const g=w,F=m%(g*2);m=F>g?g*2-F:F}else p==="once"?m=Math.min(m,w):m=m%w;const S=new Float32Array(r.length);for(let g=0;g<e;g++){const F=g/e;let E=0;y==="left_to_right"?E=Math.min(w-1,Math.floor(F*w)):y==="right_to_left"?E=Math.min(w-1,Math.floor((1-F)*w)):y==="center_to_out"?E=Math.min(w-1,Math.floor(Math.abs(F-.5)*2*w)):y==="out_to_center"&&(E=Math.min(w-1,Math.floor((1-Math.abs(F-.5)*2)*w)));let v=Math.abs(m-E);v>w/2&&(v=w-v);let I=v<s?1-v/s:0;i>0&&(I=Math.pow(I,1-i));const B=g*8;if(S.set(r.subarray(B,B+8),B),S[B+3]*=I,S[B+4]*=I,S[B+5]*=I,I<.05&&(S[B+6]=1),g<e-1){const P=(g+1)/e;let _=0;y==="left_to_right"?_=Math.min(w-1,Math.floor(P*w)):y==="right_to_left"?_=Math.min(w-1,Math.floor((1-P)*w)):y==="center_to_out"?_=Math.min(w-1,Math.floor(Math.abs(P-.5)*2*w)):y==="out_to_center"&&(_=Math.min(w-1,Math.floor((1-Math.abs(P-.5)*2)*w))),_!==E&&(S[B+6]=1)}}return r._channelDistributions&&(S._channelDistributions=r._channelDistributions),S}else{const{assignedDacs:w}=o||{};let m=new Map,S=0;if(b)(h&&h.length>0?h.map(D=>D.originalIndex):w?w.map((D,C)=>C):[0]).forEach((D,C)=>{m.set(D,C),S++});else{S=(w?w.length:1)||1;for(let _=0;_<S;_++){let D=_;y==="right_to_left"?D=S-1-_:y==="center_to_out"?D=Math.floor(Math.abs(_-(S-1)/2)):y==="out_to_center"&&(D=Math.min(_,S-1-_)),m.set(_,D)}}const g=S;let F=(R?A*g:l*.001)*c;if(p==="bounce"){const _=g,D=F%(_*2);F=D>_?_*2-D:D}else p==="once"?F=Math.min(F,g):F=F%g;const E=e*S,v=new Float32Array(E*8),I=new Map;let B=0;const P=Array.from(m.keys());P.length===0&&P.push(0);for(const _ of P){const D=m.get(_)||0;let C=Math.abs(F-D);C>g/2&&(C=g-C);let L=C<s?1-C/s:0;i>0&&(L=Math.pow(L,1-i));const T=B;for(let U=0;U<e;U++){const k=U*8,O=B+U*8;v.set(r.subarray(k,k+8),O),v[O+3]*=L,v[O+4]*=L,v[O+5]*=L,L<.05&&(v[O+6]=1)}I.set(_,{start:T,length:e*8}),B+=e*8}return v._channelDistributions=I,v}}function he(r,e,d=!1){if(!e||!r||!r.points)return r;const{safetyZones:l,outputArea:o,transformationEnabled:a,transformationMode:n,flipX:i,flipY:c}=e;let s=r.points;const y=r.isTypedArray||s instanceof Float32Array,b=y?s.length/8:s.length;let h=d?s:y?new Float32Array(s):s.map(p=>({...p}));for(let p=0;p<b;p++){let A,M,u,f,x,R;if(y?(A=h[p*8],M=h[p*8+1],u=h[p*8+3],f=h[p*8+4],x=h[p*8+5],R=h[p*8+6]):(A=h[p].x,M=h[p].y,u=h[p].r,f=h[p].g,x=h[p].b,R=h[p].blanking?1:0),a&&o){let w=(A+1)/2,m=(1-M)/2;n==="crop"?(w<o.x||w>o.x+o.w||m<o.y||m>o.y+o.h)&&(u=0,f=0,x=0,R=1):n==="scale"&&(w=o.x+w*o.w,m=o.y+m*o.h,A=w*2-1,M=1-m*2)}if(l&&l.length>0){let w=(A+1)/2,m=(1-M)/2;for(const S of l)if(w>=S.x&&w<=S.x+S.w&&m>=S.y&&m<=S.y+S.h){u=0,f=0,x=0,R=1;break}}i&&(A=-A),c&&(M=-M),A=Math.max(-1,Math.min(1,A)),M=Math.max(-1,Math.min(1,M)),y?(h[p*8]=A,h[p*8+1]=M,h[p*8+3]=u,h[p*8+4]=f,h[p*8+5]=x,h[p*8+6]=R):(h[p].x=A,h[p].y=M,h[p].r=u,h[p].g=f,h[p].b=x,h[p].blanking=R>.5)}return{...r,points:h,isTypedArray:y}}const z=.08,de=4,ue=1.5;function pe(r){if(!r)return new Float32Array(0);const e=r instanceof Float32Array||r.isTypedArray,d=e?r.length/8:r.length;if(d>4e3){if(r instanceof Float32Array)return r;const u=new Float32Array(d*8);for(let f=0;f<d;f++){const x=r[f];u[f*8]=x.x,u[f*8+1]=x.y,u[f*8+2]=x.z||0,u[f*8+3]=x.r,u[f*8+4]=x.g,u[f*8+5]=x.b,u[f*8+6]=x.blanking?1:0,u[f*8+7]=x.lastPoint?1:0}return u}const l=[],o=(u,f,x,R,w,m,S)=>{const g=S?0:R,F=S?0:w,E=S?0:m;l.push(u,f,x,g,F,E,S?1:0,0)},a=u=>{if(e){const f=u*8;return{x:r[f],y:r[f+1],z:r[f+2],r:r[f+3],g:r[f+4],b:r[f+5],blanking:r[f+6]>.5}}else{const f=r[u];return{x:f.x||0,y:f.y||0,z:f.z||0,r:f.r||0,g:f.g||0,b:f.b||0,blanking:!!f.blanking}}};if(d===0)return new Float32Array(0);let n=null;for(let u=0;u<d;u++){const f=a(u);if(!f.blanking){n=f;break}}let i=a(0);for(let u=0;u<d;u++){const f=a(u);f.x-i.x,f.y-i.y,o(f.x,f.y,f.z,f.r,f.g,f.b,f.blanking),i=f}const c=a(0),s=n||c,y=s.x-i.x,b=s.y-i.y,h=Math.sqrt(y*y+b*b),p=h<.1&&!s.blanking&&!i.blanking,A=!p&&(c.blanking||i.blanking||h>ue);if(p){if(h>z){const u=Math.floor(h/z);for(let f=1;f<u;f++){const x=f/u;o(i.x+y*x,i.y+b*x,i.z+(s.z-i.z)*x,i.r+(s.r-i.r)*x,i.g+(s.g-i.g)*x,i.b+(s.b-i.b)*x,!1)}}o(s.x,s.y,s.z,s.r,s.g,s.b,!1)}else if(A&&h>.01){o(i.x,i.y,i.z,0,0,0,!0),o(i.x,i.y,i.z,0,0,0,!0);const u=c.x-i.x,f=c.y-i.y,x=Math.sqrt(u*u+f*f);if(x>z){const R=Math.floor(x/z);for(let w=1;w<R;w++){const m=w/R;o(i.x+u*m,i.y+f*m,i.z+(c.z-i.z)*m,0,0,0,!0)}}for(let R=0;R<de;R++)o(c.x,c.y,c.z,0,0,0,!0)}const M=new Float32Array(l);return r._channelDistributions&&(M._channelDistributions=r._channelDistributions),M}class me{constructor(e,d){if(this.canvas=e,this.type=d,this.gl=e.getContext("webgl")||e.getContext("experimental-webgl"),this.animationFrameId=null,this.frameIndexes=Array(10).fill(0),this.pointIndexes=Array(10).fill(0),this.showBeamEffect=!1,this.beamAlpha=.5,this.fadeAlpha=.13,this.beamRenderMode="both",this.positionBuffer=null,this.colorBuffer=null,this.alphaBuffer=null,this.alphaBufferData=new Float32Array(131072),this.lastPointDrawTime=0,!this.gl){console.error("WebGL not supported");return}this.setup()}setup(){const e=this.gl,d=`
      attribute vec2 aPosition;
      attribute vec3 aColor;
      attribute float aAlpha;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
        gl_PointSize = 2.0;
        vColor = aColor;
        vAlpha = aAlpha;
      }
    `,l=`
      precision mediump float;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_FragColor = vec4(vColor, vAlpha);
      }
    `,o=this.createShader(e.VERTEX_SHADER,d),a=this.createShader(e.FRAGMENT_SHADER,l),n=this.createProgram(o,a);this.program=n,this.positionAttributeLocation=e.getAttribLocation(n,"aPosition"),this.colorAttributeLocation=e.getAttribLocation(n,"aColor"),this.alphaAttributeLocation=e.getAttribLocation(n,"aAlpha"),this.quadPositionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.quadPositionBuffer);const i=[-1,-1,1,-1,-1,1,-1,1,1,-1,1,1];e.bufferData(e.ARRAY_BUFFER,new Float32Array(i),e.STATIC_DRAW),this.quadColorUniformLocation=e.getUniformLocation(n,"uColor"),this.quadAlphaUniformLocation=e.getUniformLocation(n,"uAlpha");const c=`
      attribute vec2 aPosition;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
      }
    `,s=`
      precision mediump float;
      uniform vec4 uColor;
      void main() {
        gl_FragColor = uColor;
      }
    `,y=this.createShader(e.VERTEX_SHADER,c),b=this.createShader(e.FRAGMENT_SHADER,s);this.fadeProgram=this.createProgram(y,b),this.fadePositionAttributeLocation=e.getAttribLocation(this.fadeProgram,"aPosition"),this.fadeColorUniformLocation=e.getUniformLocation(this.fadeProgram,"uColor"),e.useProgram(n);const h=131072;this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferData(e.ARRAY_BUFFER,h*2*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),this.colorBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),e.bufferData(e.ARRAY_BUFFER,h*3*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),this.alphaBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.alphaBuffer),e.bufferData(e.ARRAY_BUFFER,h*1*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.clearColor(0,0,0,1)}reset(){this.frameIndexes.fill(0),this.pointIndexes.fill(0),this.clearCanvas()}createShader(e,d){const l=this.gl,o=l.createShader(e);if(l.shaderSource(o,d),l.compileShader(o),l.getShaderParameter(o,l.COMPILE_STATUS))return o;console.error(l.getShaderInfoLog(o)),l.deleteShader(o)}createProgram(e,d){const l=this.gl,o=l.createProgram();if(l.attachShader(o,e),l.attachShader(o,d),l.linkProgram(o),l.getProgramParameter(o,l.LINK_STATUS))return o;console.error(l.getProgramInfoLog(o)),l.deleteProgram(o)}render(e){e.showBeamEffect!==void 0&&this.setBeamEffect(e.showBeamEffect),e.beamAlpha!==void 0&&this.setBeamAlpha(e.beamAlpha),e.fadeAlpha!==void 0&&this.setFadeAlpha(e.fadeAlpha),e.beamRenderMode!==void 0&&(this.beamRenderMode=e.beamRenderMode),this.type==="world"?this.renderWorld(e.worldData,e.previewScanRate,e.layerIntensities,e.masterIntensity,e.dacSettings,e.previewTime,e.fftLevels,e.optimizationEnabled):this.renderSingle(e.ildaFrames,e.previewScanRate,e.intensity,e.effects,e.syncSettings,e.bpm,e.clipDuration,e.progress,e.previewTime,e.fftLevels,e.effectStates,e.optimizationEnabled)}renderSingle(e,d,l,o,a={},n=120,i=1,c=null,s=null,y={low:0,mid:0,high:0},b=null,h=!0){const p=this.gl;if(p.viewport(0,0,p.canvas.width,p.canvas.height),this.drawFadeQuad(),!e||e.length===0)return;const A=this.frameIndexes[0]%e.length,M=e[A],u=c!==null?c:A/e.length,f=s!==null?s:performance.now();this.draw(M,o,this.showBeamEffect,this.beamAlpha,d,this.beamRenderMode,l,0,u,f,a,n,i,y,b,h),this.frameIndexes[0]++,this.frameIndexes[0]>=e.length&&(this.frameIndexes[0]=0)}renderWorld(e,d,l,o,a,n=null,i={low:0,mid:0,high:0},c=!0){const s=this.gl;s.viewport(0,0,s.canvas.width,s.canvas.height),this.drawFadeQuad();const y=n!==null?n:performance.now();e.forEach(b=>{if(b&&b.frames&&b.frames.length>0){const h=b.frames[0];if(h){const p=b.layerIndex||0;if(b.syncSettings,b.bpm,p>=this.frameIndexes.length){const u=p+5;for(;this.frameIndexes.length<u;)this.frameIndexes.push(0),this.pointIndexes.push(0)}const M=(l[p]!==void 0?l[p]:1)*o;if(M>.001){const u=b.progress!==void 0?b.progress:this.frameIndexes[p]%b.frames.length/b.frames.length,{syncSettings:f={},bpm:x=120,clipDuration:R=1,effectStates:w=null}=b;let m=h;if(a){let S=h;if(a.dimmer!==void 0&&a.dimmer<1){const g=h.points,F=h.isTypedArray||g instanceof Float32Array,E=F?g.length/8:g.length,v=F?new Float32Array(g):g.map(I=>({...I}));for(let I=0;I<E;I++)F?(v[I*8+3]*=a.dimmer,v[I*8+4]*=a.dimmer,v[I*8+5]*=a.dimmer):(v[I].r*=a.dimmer,v[I].g*=a.dimmer,v[I].b*=a.dimmer);S={...h,points:v,isTypedArray:t}}m=he(S,a)}this.draw(m,b.effects,this.showBeamEffect,this.beamAlpha,d,this.beamRenderMode,M,p,u,y,f,x,R,i,w,c)}}}}),e.forEach(b=>{if(b&&b.frames){const h=b.layerIndex||0;this.frameIndexes[h]++,this.frameIndexes[h]>=b.frames.length&&(this.frameIndexes[h]=0)}})}drawFadeQuad(){const e=this.gl;this.fadeProgram&&(e.useProgram(this.fadeProgram),e.bindBuffer(e.ARRAY_BUFFER,this.quadPositionBuffer),e.enableVertexAttribArray(this.fadePositionAttributeLocation),e.vertexAttribPointer(this.fadePositionAttributeLocation,2,e.FLOAT,!1,0,0),e.uniform4f(this.fadeColorUniformLocation,0,0,0,this.fadeAlpha),e.drawArrays(e.TRIANGLES,0,6))}setBeamEffect(e){this.showBeamEffect=e}setBeamAlpha(e){this.beamAlpha=e}setFadeAlpha(e){this.fadeAlpha=e}draw(e,d,l,o,a,n,i=1,c=0,s=0,y=performance.now(),b={},h=120,p=1,A={low:0,mid:0,high:0},M=null,u=!0){if(this.gl,!e||!e.points)return;let f=e;if(u){const B=pe(e.points);f={...e,points:B,isTypedArray:!0}}const x=$(f,d,{progress:s,time:y,syncSettings:b,bpm:h,clipDuration:p,fftLevels:A,effectStates:M}),R=x.points,w=x.isTypedArray,m=w?R.length/8:R.length;if(m===0)return;const S=Math.max(1,Math.floor(m/a));let g=this.pointIndexes[c]||0;g>=m&&(g=0);const F=B=>{const P=(g+B)%m;if(w){const _=P*8;return{x:R[_],y:R[_+1],r:R[_+3],g:R[_+4],b:R[_+5],blanking:R[_+6]===1}}else{const _=R[P];return{x:_.x,y:_.y,r:_.r,g:_.g,b:_.b,blanking:_.blanking}}},E=()=>{const B=n==="points"||n==="both";if(n==="lines"||n==="both"){let _=[],D=[],C=F(0);for(let L=1;L<S;L++){const T=F(L);T.blanking?_.length>0&&(this._drawSegment(new Float32Array(_),new Float32Array(D),1,_.length/2,!1),_=[],D=[]):(_.length===0&&(_.push(C.x,C.y),D.push(T.r/255*i,T.g/255*i,T.b/255*i)),_.push(T.x,T.y),D.push(T.r/255*i,T.g/255*i,T.b/255*i)),C=T}_.length>0&&this._drawSegment(new Float32Array(_),new Float32Array(D),1,_.length/2,!1)}if(B){const _=[],D=[];for(let C=0;C<S;C++){const L=F(C);L.blanking||(_.push(L.x,L.y),D.push(L.r/255*i,L.g/255*i,L.b/255*i))}_.length>0&&this._drawSegment(new Float32Array(_),new Float32Array(D),1,_.length/2,!0)}},v=()=>{const B=[],P=[];for(let _=0;_<S;_++){const D=F(_);if(!D.blanking){B.push(0,0,D.x,D.y);const C=[D.r/255*i,D.g/255*i,D.b/255*i];P.push(...C,...C)}}B.length>0&&this._drawLines(new Float32Array(B),new Float32Array(P),o,B.length/2)},I=()=>{const B=[],P=[];let _=F(0);for(let D=1;D<S;D++){const C=F(D);if(!C.blanking){B.push(0,0,_.x,_.y,C.x,C.y);const L=[C.r/255*i,C.g/255*i,C.b/255*i],T=[C.r/255*i,C.g/255*i,C.b/255*i],U=[L[0],L[1],L[2]],k=.3,O=[L[0]*k,L[1]*k,L[2]*k],be=[T[0]*k,T[1]*k,T[2]*k];P.push(...U,...O,...be)}_=C}B.length>0&&this._drawTriangles(new Float32Array(B),new Float32Array(P),o,B.length/2)};E(),l&&(n==="points"?v():n==="lines"?I():n==="both"&&(I(),v())),this.pointIndexes[c]=(g+S)%m}_drawSegment(e,d,l,o,a=!1){const n=this.gl;n.useProgram(this.program),n.bindBuffer(n.ARRAY_BUFFER,this.positionBuffer),n.bufferSubData(n.ARRAY_BUFFER,0,e),n.enableVertexAttribArray(this.positionAttributeLocation),n.vertexAttribPointer(this.positionAttributeLocation,2,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this.colorBuffer),n.bufferSubData(n.ARRAY_BUFFER,0,d),n.enableVertexAttribArray(this.colorAttributeLocation),n.vertexAttribPointer(this.colorAttributeLocation,3,n.FLOAT,!1,0,0),this.alphaBufferData.length<o&&(this.alphaBufferData=new Float32Array(o*2)),this.alphaBufferData.fill(l,0,o);const i=this.alphaBufferData.subarray(0,o);n.bindBuffer(n.ARRAY_BUFFER,this.alphaBuffer),n.bufferSubData(n.ARRAY_BUFFER,0,i),n.enableVertexAttribArray(this.alphaAttributeLocation),n.vertexAttribPointer(this.alphaAttributeLocation,1,n.FLOAT,!1,0,0),n.drawArrays(a?n.POINTS:n.LINE_STRIP,0,o)}_drawLines(e,d,l,o){const a=this.gl;a.useProgram(this.program),a.bindBuffer(a.ARRAY_BUFFER,this.positionBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,e),a.enableVertexAttribArray(this.positionAttributeLocation),a.vertexAttribPointer(this.positionAttributeLocation,2,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.colorBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,d),a.enableVertexAttribArray(this.colorAttributeLocation),a.vertexAttribPointer(this.colorAttributeLocation,3,a.FLOAT,!1,0,0),this.alphaBufferData.length<o&&(this.alphaBufferData=new Float32Array(o*2)),this.alphaBufferData.fill(l,0,o);const n=this.alphaBufferData.subarray(0,o);a.bindBuffer(a.ARRAY_BUFFER,this.alphaBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,n),a.enableVertexAttribArray(this.alphaAttributeLocation),a.vertexAttribPointer(this.alphaAttributeLocation,1,a.FLOAT,!1,0,0),a.drawArrays(a.LINES,0,o)}_drawTriangles(e,d,l,o){const a=this.gl;a.useProgram(this.program),a.bindBuffer(a.ARRAY_BUFFER,this.positionBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,e),a.enableVertexAttribArray(this.positionAttributeLocation),a.vertexAttribPointer(this.positionAttributeLocation,2,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.colorBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,d),a.enableVertexAttribArray(this.colorAttributeLocation),a.vertexAttribPointer(this.colorAttributeLocation,3,a.FLOAT,!1,0,0),this.alphaBufferData.length<o&&(this.alphaBufferData=new Float32Array(o*2)),this.alphaBufferData.fill(l,0,o);const n=this.alphaBufferData.subarray(0,o);a.bindBuffer(a.ARRAY_BUFFER,this.alphaBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,n),a.enableVertexAttribArray(this.alphaAttributeLocation),a.vertexAttribPointer(this.alphaAttributeLocation,1,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,o)}clearCanvas(){const e=this.gl;e.viewport(0,0,e.canvas.width,e.canvas.height),e.clear(e.COLOR_BUFFER_BIT)}destroy(){if(cancelAnimationFrame(this.animationFrameId),this.gl){const e=this.gl.getExtension("WEBGL_losing_context");e&&e.loseContext()}}}const Y=new Map;function H(r,e=0){const d=Y.get(r);if(!d)return;const l=performance.now();d.renderer.render(d.data),e=l,d.animationFrameId=requestAnimationFrame(()=>H(r,e))}self.onmessage=r=>{const{action:e,payload:d}=r.data;if(e==="register"){const{id:l,canvas:o,type:a,data:n}=d,i=new me(o,a),c=requestAnimationFrame(()=>H(l));Y.set(l,{renderer:i,type:a,data:n,animationFrameId:c})}else if(e==="deregister"){const{id:l}=d,o=Y.get(l);o&&(cancelAnimationFrame(o.animationFrameId),Y.delete(l))}else if(e==="update"){const{id:l,data:o}=d,a=Y.get(l);if(a){if(a.data&&a.data.effectStates&&o.effectStates)o.effectStates=a.data.effectStates;else if(a.data&&a.data.worldData&&a.data.worldData.length>0){const n=a.data.worldData[0];if(n&&n.effectStates&&o.worldData){const i=n.effectStates;for(const c of o.worldData)c.effectStates=i}}a.data=o}}else if(e==="clear"){const{id:l}=d,o=Y.get(l);o&&o.renderer.clearCanvas()}}})();
