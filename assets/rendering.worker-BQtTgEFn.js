(function(){"use strict";const V=[{id:"rotate",name:"Rotate",type:"transform",description:"Rotates the shape around its center.",defaultParams:{angle:0,speed:0,direction:"CW"},paramControls:[{id:"angle",label:"Angle",type:"range",min:0,max:360,step:1},{id:"speed",label:"Speed",type:"range",min:0,max:10,step:.1},{id:"direction",label:"Direction",type:"select",options:["CW","CCW"]}]},{id:"scale",name:"Scale",type:"transform",description:"Scales the shape.",defaultParams:{scaleX:1,scaleY:1},paramControls:[{id:"scaleX",label:"Scale X",type:"range",min:.01,max:5,step:.01},{id:"scaleY",label:"Scale Y",type:"range",min:.01,max:5,step:.01}]},{id:"translate",name:"Translate",type:"transform",description:"Moves the shape.",defaultParams:{translateX:0,translateY:0},paramControls:[{id:"translateX",label:"Translate X",type:"range",min:-1,max:1,step:.01},{id:"translateY",label:"Translate Y",type:"range",min:-1,max:1,step:.01}]},{id:"color",name:"Color",type:"color",description:"Changes the color of the shape with solid, rainbow or custom palette modes.",defaultParams:{mode:"solid",color:"#ffffff",r:255,g:255,b:255,cycleSpeed:0,rainbowSpread:1,rainbowOffset:0,rainbowPalette:"rainbow",paletteColors:["#ff0000","#00ff00","#0000ff","#ffff00"],paletteSize:4,paletteSpread:1,hue:0,saturation:0,brightness:1,enabled:!0},paramControls:[{id:"mode",label:"Mode",type:"select",options:["solid","rainbow","palette"]},{id:"color",label:"Color",type:"color",showIf:{mode:"solid"}},{id:"hue",label:"Hue",type:"range",min:0,max:1,step:.001,showIf:{mode:"hsv_advanced"}},{id:"saturation",label:"Saturation",type:"range",min:0,max:1,step:.001,showIf:{mode:"hsv_advanced"}},{id:"brightness",label:"Brightness",type:"range",min:0,max:1,step:.001,showIf:{mode:"hsv_advanced"}},{id:"paletteSize",label:"Palette Size",type:"range",min:2,max:16,step:1,showIf:{mode:"palette"}},{id:"paletteSpread",label:"Spread",type:"range",min:.1,max:10,step:.1,showIf:{mode:"palette"}},{id:"cycleSpeed",label:"Cycle Speed",type:"range",min:0,max:10,step:.1,showIf:{mode:["rainbow","palette"]}},{id:"rainbowSpread",label:"Rainbow Spread",type:"range",min:.1,max:10,step:.1,showIf:{mode:"rainbow"}},{id:"rainbowOffset",label:"Offset",type:"range",min:0,max:360,step:1,showIf:{mode:["rainbow","palette"]}},{id:"rainbowPalette",label:"Preset",type:"select",options:["rainbow","fire","ice","cyber"],showIf:{mode:"rainbow"}}]},{id:"wave",name:"Wave",type:"animation",description:"Applies a wave distortion to the shape.",defaultParams:{amplitude:.1,frequency:10,speed:1,direction:"x"},paramControls:[{id:"amplitude",label:"Amplitude",type:"range",min:.01,max:1,step:.01},{id:"frequency",label:"Frequency",type:"range",min:1,max:50,step:1},{id:"speed",label:"Speed",type:"range",min:.1,max:10,step:.1},{id:"direction",label:"Direction",type:"select",options:["x","y"]}]},{id:"warp",name:"Warp",type:"animation",description:"Symmetrical chaotic wave distortion.",defaultParams:{amount:.1,chaos:.5,speed:1},paramControls:[{id:"amount",label:"Amount",type:"range",min:0,max:1,step:.01},{id:"chaos",label:"Chaos",type:"range",min:0,max:1,step:.01},{id:"speed",label:"Speed",type:"range",min:.1,max:10,step:.1}]},{id:"distortion",name:"Distortion",type:"transform",description:"Distorts the point data.",defaultParams:{amount:.1,scale:10,speed:.5},paramControls:[{id:"amount",label:"Amount",type:"range",min:0,max:1,step:.01},{id:"scale",label:"Scale",type:"range",min:1,max:50,step:1},{id:"speed",label:"Speed",type:"range",min:0,max:5,step:.1}]},{id:"move",name:"Move (Bounce)",type:"transform",description:"Moves points and bounces them off the borders.",defaultParams:{speedX:.1,speedY:.1},paramControls:[{id:"speedX",label:"Speed X",type:"range",min:0,max:2,step:.01},{id:"speedY",label:"Speed Y",type:"range",min:0,max:2,step:.01}]},{id:"delay",name:"Delay",type:"effect",description:"Frame or Channel based delay effect.",defaultParams:{mode:"segment",playstyle:"repeat",useCustomOrder:!1,delayDirection:"left_to_right",delayAmount:5,decay:.8,steps:10,customOrder:[],enabled:!0},paramControls:[{id:"mode",label:"Mode",type:"select",options:["segment","frame","channel"]},{id:"playstyle",label:"Playstyle",type:"select",options:["once","repeat"]},{id:"useCustomOrder",label:"Custom Order",type:"checkbox",showIf:{mode:"channel"}},{id:"delayDirection",label:"Direction",type:"select",options:["center_to_out","out_to_center","left_to_right","right_to_left"],showIf:{useCustomOrder:!1}},{id:"steps",label:"Steps",type:"range",min:2,max:20,step:1,showIf:{mode:["segment","frame"]}},{id:"delayAmount",label:"Delay Time",type:"range",min:1,max:60,step:1},{id:"decay",label:"Decay",type:"range",min:0,max:1,step:.01}]},{id:"chase",name:"Chase",type:"effect",description:"Frame or Channel based chase effect.",defaultParams:{mode:"segment",playstyle:"repeat",steps:4,decay:.8,speed:1,overlap:1,direction:"left_to_right",useCustomOrder:!1,customOrder:[],enabled:!0},paramControls:[{id:"mode",label:"Mode",type:"select",options:["segment","channel"]},{id:"playstyle",label:"Playstyle",type:"select",options:["once","repeat","bounce"]},{id:"steps",label:"Steps",type:"range",min:2,max:16,step:1,showIf:{mode:"segment"}},{id:"decay",label:"Decay",type:"range",min:0,max:1,step:.01},{id:"speed",label:"Speed",type:"range",min:.1,max:5,step:.1},{id:"overlap",label:"Overlap",type:"range",min:1,max:4,step:1},{id:"useCustomOrder",label:"Custom Order",type:"checkbox",showIf:{mode:"channel"}},{id:"direction",label:"Direction",type:"select",options:["center_to_out","out_to_center","left_to_right","right_to_left"],showIf:{useCustomOrder:!1}}]},{id:"blanking",name:"Blanking",type:"animation",description:"Controls the blanking of the laser output.",defaultParams:{blankingInterval:0,spacing:0},paramControls:[{id:"blankingInterval",label:"Blanking Interval",type:"range",min:0,max:10,step:1},{id:"spacing",label:"Spacing",type:"range",min:0,max:20,step:1}]},{id:"strobe",name:"Strobe",type:"animation",description:"Applies a strobe effect to the laser output.",defaultParams:{strobeSpeed:100,strobeAmount:.5},paramControls:[{id:"strobeSpeed",label:"Strobe Speed (ms)",type:"range",min:10,max:1e3,step:10},{id:"strobeAmount",label:"Strobe Amount (0-1)",type:"range",min:0,max:1,step:.01}]},{id:"mirror",name:"Mirror",type:"transform",description:"Mirrors the shape from the center.",defaultParams:{mode:"none",additive:!0,axisOffset:0,planeRotation:0},paramControls:[{id:"mode",label:"Mirror Mode",type:"select",options:["none","x+","x-","y+","y-"]},{id:"additive",label:"Additive",type:"checkbox"},{id:"axisOffset",label:"Axis Offset",type:"range",min:-1,max:1,step:.01},{id:"planeRotation",label:"Plane Rotation",type:"range",min:0,max:360,step:1}]}].reduce((a,e)=>(a[e.id]=e,a),{});function N(a,e,u,l){const s=e.style||"loop",r=e.direction||"forward";if(r==="pause")return u;let o=a;s==="bounce"&&(o*=2);let h=0;if(s==="once")h=Math.min(o,1),r==="backward"&&(h=1-h);else if(s==="bounce"){let m=o%1;Math.floor(o)%2===1?h=1-m:h=m,r==="backward"&&(h=1-h)}else h=o%1,r==="backward"&&(h=1-h);return l&&Array.isArray(l)&&l.length===2?l[0]+(l[1]-l[0])*h:u}function G(a,e,u,l,s,r){if(!u)return e;const o=typeof u=="string"?{syncMode:u}:u;if(!o.syncMode)return e;const{time:h,progress:m=0,bpm:n=120,clipDuration:b=0,fftLevels:_={low:0,mid:0,high:0},activationTime:p=0}=l;let t=o.range;!t||!Array.isArray(t)||t.length;let y=0;const c=o.speedMultiplier||1;if((o.style||"loop")==="once"&&p>0){const w=(h-p)*.001;let R=1;if(o.syncMode==="timeline")R=Math.max(.01,o.duration||1);else if(o.syncMode==="bpm"){const F=Math.max(.1,o.beats||4),M=n/60;R=F/(M||2)}else if(o.syncMode==="fps")return y=w*c,N(y,o,e,t);y=w/R*c}else if(o.syncMode==="fps")y=h*.001*c;else if(o.syncMode==="timeline"){const w=Math.max(.01,o.duration||1);b>0?y=m*b/w*c:y=0}else if(o.syncMode==="bpm"){const w=Math.max(.1,o.beats||4),R=n/60,F=w/(R||2);b>0?y=m*b/F*c:y=0}else if(o.syncMode==="fft"){const w=_[o.fftRange||"low"]||0;return t?t[0]+(t[1]-t[0])*w:e}return N(y,o,e,t)}let U=new Float32Array(1024*8);function K(a){U.length<a*8&&(U=new Float32Array(a*8*2))}function $(a,e,u={}){const{progress:l=0,time:s=performance.now(),effectStates:r,syncSettings:o={},fftLevels:h}=u;if(!e||e.length===0)return a;const m=a.points,n=a.isTypedArray||m instanceof Float32Array,b=n?m.length/8:m.length;K(b);const _=U.subarray(0,b*8);if(n)_.set(m);else for(let y=0;y<b;y++){const c=m[y],i=y*8;_[i]=c.x,_[i+1]=c.y,_[i+2]=c.z||0,_[i+3]=c.r,_[i+4]=c.g,_[i+5]=c.b,_[i+6]=c.blanking?1:0,_[i+7]=c.lastPoint?1:0}let p=_;for(const y of e){const c=y.params;if(c.enabled===!1||!V[y.id])continue;const w=p.length/8;let R=c;const F=y.instanceId?`${y.instanceId}.`:`${y.id}.`;let M=!1;for(const d in c)if(o[F+d]){M=!0;break}if(M){R={...c};for(const d in R){const g=F+d;o[g]&&(R[d]=G(d,R[d],o[g],u))}}switch(y.id){case"rotate":Q(p,w,R,l,s);break;case"scale":Z(p,w,R);break;case"translate":j(p,w,R);break;case"color":ee(p,w,R,s);break;case"wave":ae(p,w,R,s);break;case"blanking":re(p,w,R);break;case"strobe":oe(p,w,R,s);break;case"mirror":p=ne(p,w,R);break;case"warp":se(p,w,R,s);break;case"distortion":ie(p,w,R,s);break;case"move":le(p,w,R,s);break;case"delay":r&&y.instanceId&&(p=fe(p,w,R,r,y.instanceId,u));break;case"chase":p=ce(p,w,R,s,u);break}}const t=new Float32Array(p);return p._channelDistributions&&(t._channelDistributions=p._channelDistributions),{...a,points:t,isTypedArray:!0}}function Q(a,e,u,l,s){const{angle:r,speed:o,direction:h}=u,m=h==="CCW"?-1:1,n=s*.001*o*m,b=r*Math.PI/180+n,_=Math.sin(b),p=Math.cos(b);for(let t=0;t<e;t++){const y=t*8,c=a[y],i=a[y+1];a[y]=c*p-i*_,a[y+1]=c*_+i*p}}function Z(a,e,u){const{scaleX:l,scaleY:s}=u;for(let r=0;r<e;r++){const o=r*8;a[o]*=l,a[o+1]*=s}}function j(a,e,u){const{translateX:l,translateY:s}=u;for(let r=0;r<e;r++){const o=r*8;a[o]+=l,a[o+1]+=s}}function z(a){if(!a)return{r:255,g:255,b:255};const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:{r:255,g:255,b:255}}function J(a,e,u){let l,s,r;const o=Math.floor(a*6),h=a*6-o,m=u*(1-e),n=u*(1-h*e),b=u*(1-(1-h)*e);switch(o%6){case 0:l=u,s=b,r=m;break;case 1:l=n,s=u,r=m;break;case 2:l=m,s=u,r=b;break;case 3:l=m,s=n,r=u;break;case 4:l=b,s=m,r=u;break;case 5:l=u,s=m,r=n;break}return[Math.round(l*255),Math.round(s*255),Math.round(r*255)]}function ee(a,e,u,l){const{mode:s,r,g:o,b:h,color:m,hue:n,saturation:b,brightness:_,cycleSpeed:p,rainbowSpread:t,rainbowOffset:y,rainbowPalette:c,paletteColors:i=[],paletteSize:w=4,paletteSpread:R=1}=u,F=l*.001*p;if(s==="palette"){const M=Math.min(i.length,w),d=i.slice(0,M).map(z);d.length===0&&d.push({r:255,g:255,b:255});for(let g=0;g<e;g++){const f=g*8,C=(g/e*R+F*.5+y/360)%1*d.length,P=Math.floor(C)%d.length,A=(P+1)%d.length,x=C-Math.floor(C),v=d[P],S=d[A];a[f+3]=Math.round(v.r+(S.r-v.r)*x),a[f+4]=Math.round(v.g+(S.g-v.g)*x),a[f+5]=Math.round(v.b+(S.b-v.b)*x)}}else if(s==="rainbow"){const M=c||"rainbow";for(let d=0;d<e;d++){const g=d*8,f=(d/e*t+F*.5+y/360)%1;let B,C,P;M==="rainbow"?[B,C,P]=W(f,1,.5):[B,C,P]=te(M,f),a[g+3]=B,a[g+4]=C,a[g+5]=P}}else{let M=r,d=o,g=h;if(n!==void 0&&b!==void 0&&_!==void 0)[M,d,g]=J(n,b,_);else if(m){const f=z(m);M=f.r,d=f.g,g=f.b}if(p>0){const f=F*50%360,[B,C,P]=W(f/360,1,.5);for(let A=0;A<e;A++){const x=A*8;a[x+3]=B,a[x+4]=C,a[x+5]=P}}else for(let f=0;f<e;f++){const B=f*8;a[B+3]=M,a[B+4]=d,a[B+5]=g}}}function te(a,e){const u={fire:[{r:255,g:0,b:0},{r:255,g:128,b:0},{r:255,g:255,b:0},{r:255,g:0,b:0}],ice:[{r:0,g:0,b:255},{r:0,g:255,b:255},{r:255,g:255,b:255},{r:0,g:0,b:255}],cyber:[{r:255,g:0,b:255},{r:0,g:255,b:255},{r:0,g:0,b:255},{r:255,g:0,b:255}]},l=u[a]||u.fire,s=e*(l.length-1),r=Math.floor(s),o=s-r,h=l[r],m=l[r+1]||l[r];return[Math.round(h.r+(m.r-h.r)*o),Math.round(h.g+(m.g-h.g)*o),Math.round(h.b+(m.b-h.b)*o)]}function W(a,e,u){let l,s,r;{const o=(n,b,_)=>(_<0&&(_+=1),_>1&&(_-=1),_<.16666666666666666?n+(b-n)*6*_:_<.5?b:_<.6666666666666666?n+(b-n)*(.6666666666666666-_)*6:n),h=u+e-u*e,m=2*u-h;l=o(m,h,a+1/3),s=o(m,h,a),r=o(m,h,a-1/3)}return[Math.round(l*255),Math.round(s*255),Math.round(r*255)]}function ae(a,e,u,l){const{amplitude:s,frequency:r,speed:o,direction:h}=u,m=l*.001*o;for(let n=0;n<e;n++){const b=n*8;h==="x"?a[b+1]+=s*Math.sin(a[b]*r+m):h==="y"&&(a[b]+=s*Math.sin(a[b+1]*r+m))}}function re(a,e,u){const{blankingInterval:l,spacing:s=0}=u;if(l<=0)return;const r=l+1+s;for(let o=0;o<e;o++)o%r>=l&&(a[o*8+6]=1)}function oe(a,e,u,l){const{strobeSpeed:s,strobeAmount:r}=u;if(l%s/s<r)for(let h=0;h<e;h++)a[h*8+6]=1}function ne(a,e,u){const{mode:l,additive:s=!0,axisOffset:r=0,planeRotation:o=0}=u;if(l==="none"||e===0)return a;const h=o*Math.PI/180,m=Math.cos(h),n=Math.sin(h),b={x:0,y:0},_=(c,i)=>{let w=c,R=i;if(h!==0){const F=c*m+i*n,M=-c*n+i*m;w=F,R=M}if(l==="x-"||l==="x+"?w=2*r-w:(l==="y-"||l==="y+")&&(R=2*r-R),h!==0){const F=w*m-R*n,M=w*n+R*m;w=F,R=M}b.x=w,b.y=R},p=(c,i)=>{if(s)return!0;let w=c,R=i;return h!==0&&(w=c*m+i*n,R=-c*n+i*m),l==="x+"?w>=r:l==="x-"?w<=r:l==="y+"?R>=r:l==="y-"?R<=r:!0};let t;const y=a._channelDistributions;if(y){t=new Float32Array((e*2+y.size*2+50)*8);const c=new Map;let i=0;for(const[R,F]of y){const M=F.length/8,d=F.start,g=i;let f=0,B=!0;for(let C=0;C<M;C++){const P=d+C*8,A=p(a[P],a[P+1]);A&&(!B&&f>0&&(t.set(a.subarray(P,P+8),i),t[i+6]=1,t[i+3]=0,t[i+4]=0,t[i+5]=0,i+=8,f++),t.set(a.subarray(P,P+8),i),i+=8,f++),B=A}if(f>0){const C=i-8;t.set(t.subarray(C,C+8),i),t[i+6]=1,t[i+3]=0,t[i+4]=0,t[i+5]=0,i+=8;let P=!0,A=0;for(let x=M-1;x>=0;x--){const v=d+x*8,S=p(a[v],a[v+1]);if(S){!P&&A>0&&(t.set(a.subarray(v,v+8),i),_(t[i],t[i+1]),t[i]=b.x,t[i+1]=b.y,t[i+6]=1,t[i+3]=0,t[i+4]=0,t[i+5]=0,i+=8),t.set(a.subarray(v,v+8),i);const I=i;_(t[I],t[I+1]),t[I]=b.x,t[I+1]=b.y,x===M-1?(t[I+6]=1,t[I+3]=0,t[I+4]=0,t[I+5]=0,t[I+7]=0):(t[I+3]=a[v+8+3],t[I+4]=a[v+8+4],t[I+5]=a[v+8+5],t[I+6]=a[v+8+6],t[I+7]=a[v+8+7]),i+=8,A++}P=S}c.set(R,{start:g,length:i-g})}}const w=new Float32Array(i);return w.set(t.subarray(0,i)),w._channelDistributions=c,w}else{t=new Float32Array((e*2+50)*8);let c=0,i=0,w=!0;for(let R=0;R<e;R++){const F=R*8,M=p(a[F],a[F+1]);M&&(!w&&i>0&&(t.set(a.subarray(F,F+8),c),t[c+6]=1,t[c+3]=0,t[c+4]=0,t[c+5]=0,c+=8,i++),t.set(a.subarray(F,F+8),c),c+=8,i++),w=M}if(i>0){const R=c-8;t.set(t.subarray(R,R+8),c),t[c+6]=1,t[c+3]=0,t[c+4]=0,t[c+5]=0,c+=8;let F=!0,M=0;for(let d=e-1;d>=0;d--){const g=d*8,f=p(a[g],a[g+1]);if(f){!F&&M>0&&(t.set(a.subarray(g,g+8),c),_(t[c],t[c+1]),t[c]=b.x,t[c+1]=b.y,t[c+6]=1,t[c+3]=0,t[c+4]=0,t[c+5]=0,c+=8),t.set(a.subarray(g,g+8),c);const B=c;_(t[B],t[B+1]),t[B]=b.x,t[B+1]=b.y,d===e-1?(t[B+6]=1,t[B+3]=0,t[B+4]=0,t[B+5]=0,t[B+7]=0):(t[B+3]=a[g+8+3],t[B+4]=a[g+8+4],t[B+5]=a[g+8+5],t[B+6]=a[g+8+6],t[B+7]=a[g+8+7]),c+=8,M++}F=f}}return t.slice(0,c)}}function se(a,e,u,l){const{amount:s,chaos:r,speed:o}=u,h=l*.001*o;for(let m=0;m<e;m++){const n=m*8,b=a[n],_=a[n+1],p=Math.abs(_);a[n]+=Math.sin(p*10*(1+r)+h)*s*Math.cos(h*r),a[n+1]+=Math.cos(Math.abs(b)*10*(1+r)+h)*s*Math.sin(h*r)}}function ie(a,e,u,l){const{amount:s,scale:r,speed:o}=u,h=l*.001*o;for(let m=0;m<e;m++){const n=m*8,b=Math.sin(a[n]*r+h)*Math.cos(a[n+1]*r-h),_=Math.cos(a[n]*r-h)*Math.sin(a[n+1]*r+h);a[n]+=b*s,a[n+1]+=_*s}}function le(a,e,u,l){const{speedX:s,speedY:r}=u,o=l*.001,h=o*s,m=o*r,n=4;for(let b=0;b<e;b++){const _=b*8;let p=a[_]+h,t=a[_+1]+m,y=(p+1)%n;y<0&&(y+=n),y>2&&(y=4-y),p=y-1;let c=(t+1)%n;c<0&&(c+=n),c>2&&(c=4-c),t=c-1,a[_]=p,a[_+1]=t}}function fe(a,e,u,l,s,r){const{mode:o="segment",delayAmount:h,decay:m,delayDirection:n,useCustomOrder:b,customOrder:_,playstyle:p="repeat",steps:t=10}=u;l.has(s)||l.set(s,[]);const y=l.get(s);if(y.unshift(new Float32Array(a)),o==="segment"){const c=h*t+1;y.length>c&&(y.length=c);const i=new Float32Array(a.length);for(let w=0;w<e;w++){let R=0;const F=w/e;n==="left_to_right"?R=Math.floor(F*t):n==="right_to_left"?R=Math.floor((1-F)*t):n==="center_to_out"?R=Math.floor(Math.abs(F-.5)*2*t):n==="out_to_center"&&(R=Math.floor((1-Math.abs(F-.5)*2)*t)),R=Math.min(t-1,Math.max(0,R));const M=R*h,d=M<y.length?y[M]:null,g=Math.pow(m,R),f=w*8;if(d&&d.length>0){let B;if(d.length===a.length)B=f;else{const P=d.length/8;let A=Math.floor(F*P);A>=P&&(A=P-1),B=A*8}i[f]=d[B],i[f+1]=d[B+1],i[f+2]=d[B+2],i[f+3]=d[B+3]*g,i[f+4]=d[B+4]*g,i[f+5]=d[B+5]*g;const C=a[f+6]>.5;if(i[f+6]=C?1:d[B+6],i[f+6]>.5&&(i[f+3]=0,i[f+4]=0,i[f+5]=0),i[f+7]=d[B+7],w>0){const P=(w-1)/e;let A=0;if(n==="left_to_right"?A=Math.floor(P*t):n==="right_to_left"?A=Math.floor((1-P)*t):n==="center_to_out"?A=Math.floor(Math.abs(P-.5)*2*t):n==="out_to_center"&&(A=Math.floor((1-Math.abs(P-.5)*2)*t)),A=Math.min(t-1,Math.max(0,A)),A!==R){i[f+6]=1,i[f+3]=0,i[f+4]=0,i[f+5]=0;const x=(w-1)*8;i[x+6]=1,i[x+3]=0,i[x+4]=0,i[x+5]=0}}}else i.set(a.subarray(f,f+8),f),i[f+3]=0,i[f+4]=0,i[f+5]=0,i[f+6]=1}return a._channelDistributions&&(i._channelDistributions=a._channelDistributions),i}else if(o==="frame"){const c=t,i=h*c+1;y.length>i&&(y.length=i);const w=[];for(let d=0;d<c;d++){const g=d*h,f=g<y.length?y[g]:null;w.push({points:f,factor:Math.pow(m,d)})}let R=0;for(let d=0;d<w.length;d++){const g=w[d].points||a;R+=g.length/8,d<w.length-1&&(R+=1)}const F=new Float32Array(R*8);let M=0;for(let d=0;d<w.length;d++){const g=w[d],f=g.points||a,B=g.factor,C=f.length/8;for(let P=0;P<C;P++){const A=P*8,x=M+P*8;F[x]=f[A],F[x+1]=f[A+1],F[x+2]=f[A+2],F[x+3]=f[A+3]*B,F[x+4]=f[A+4]*B,F[x+5]=f[A+5]*B,F[x+6]=f[A+6],F[x+7]=f[A+7]}if(M+=C*8,d<w.length-1){const P=(C-1)*8,A=M;F[A]=f[P],F[A+1]=f[P+1],F[A+2]=f[P+2],F[A+3]=0,F[A+4]=0,F[A+5]=0,F[A+6]=1,F[A+7]=0,M+=8}}return a._channelDistributions&&(F._channelDistributions=a._channelDistributions),F}else{const{assignedDacs:c}=r||{};let i=new Map,w=0;if(b||u.delayMode==="channel")(_&&_.length>0?_.map(x=>x.originalIndex):c?c.map((x,v)=>v):[0]).forEach((x,v)=>{i.set(x,v),w=Math.max(w,v)});else{const x=(c||[]).length||1;for(let v=0;v<x;v++){let S=v;n==="right_to_left"?S=x-1-v:n==="center_to_out"?S=Math.floor(Math.abs(v-(x-1)/2)):n==="out_to_center"&&(S=Math.min(v,x-1-v)),i.set(v,S),w=Math.max(w,S)}}const F=w+1,M=h*F+1;y.length>M&&(y.length=M);const d=[];for(let A=0;A<F;A++){const x=A*h;d.push({points:x<y.length?y[x]:null,factor:Math.pow(m,A),index:A})}const g=d.reduce((A,x)=>A+(x.points?x.points.length/8:a.length/8),0),f=new Float32Array(g*8);let B=0;const C=new Array(d.length);for(let A=0;A<d.length;A++){const x=d[A],v=x.points,S=v?v.length/8:a.length/8;C[A]=B;for(let I=0;I<S;I++){const D=I*8,E=B+I*8;v?(f[E]=v[D],f[E+1]=v[D+1],f[E+2]=v[D+2],f[E+3]=v[D+3]*x.factor,f[E+4]=v[D+4]*x.factor,f[E+5]=v[D+5]*x.factor,f[E+6]=v[D+6],f[E+7]=v[D+7]):f[E+6]=1}B+=S*8}const P=new Map;return i.forEach((A,x)=>{A<d.length&&P.set(x,{start:C[A],length:d[A].points?d[A].points.length:a.length})}),f._channelDistributions=P,f}}function ce(a,e,u,l,s={}){const{mode:r="segment",steps:o,decay:h,speed:m,overlap:n,direction:b,useCustomOrder:_,customOrder:p,playstyle:t="loop"}=u,{progress:y=0,clipDuration:c=1,syncSettings:i={}}=s,w=u.instanceId?`${u.instanceId}.`:"chase.",R=!!i[w+"speed"],F=y!==void 0&&c>0||R;if(r==="segment"){const M=o;let d=(F?y*M:l*.001)*m;if(t==="bounce"){const f=M,B=d%(f*2);d=B>f?f*2-B:B}else t==="once"?d=Math.min(d,M):d=d%M;const g=new Float32Array(a.length);for(let f=0;f<e;f++){const B=f/e;let C=0;b==="left_to_right"?C=Math.min(M-1,Math.floor(B*M)):b==="right_to_left"?C=Math.min(M-1,Math.floor((1-B)*M)):b==="center_to_out"?C=Math.min(M-1,Math.floor(Math.abs(B-.5)*2*M)):b==="out_to_center"&&(C=Math.min(M-1,Math.floor((1-Math.abs(B-.5)*2)*M)));let P=Math.abs(d-C);P>M/2&&(P=M-P);let A=P<n?1-P/n:0;h>0&&(A=Math.pow(A,1-h));const x=f*8;if(g.set(a.subarray(x,x+8),x),g[x+3]*=A,g[x+4]*=A,g[x+5]*=A,(A<.05||a[x+6]>.5)&&(g[x+6]=1,g[x+3]=0,g[x+4]=0,g[x+5]=0),f>0){const v=(f-1)/e;let S=0;if(b==="left_to_right"?S=Math.min(M-1,Math.floor(v*M)):b==="right_to_left"?S=Math.min(M-1,Math.floor((1-v)*M)):b==="center_to_out"?S=Math.min(M-1,Math.floor(Math.abs(v-.5)*2*M)):b==="out_to_center"&&(S=Math.min(M-1,Math.floor((1-Math.abs(v-.5)*2)*M))),S!==C){g[x+6]=1,g[x+3]=0,g[x+4]=0,g[x+5]=0;const I=(f-1)*8;g[I+6]=1,g[I+3]=0,g[I+4]=0,g[I+5]=0}}}return a._channelDistributions&&(g._channelDistributions=a._channelDistributions),g}else{const{assignedDacs:M}=s||{};let d=new Map,g=0;if(_)(p&&p.length>0?p.map(I=>I.originalIndex):M?M.map((I,D)=>D):[0]).forEach((I,D)=>{d.set(I,D),g++});else{g=(M?M.length:1)||1;for(let S=0;S<g;S++){let I=S;b==="right_to_left"?I=g-1-S:b==="center_to_out"?I=Math.floor(Math.abs(S-(g-1)/2)):b==="out_to_center"&&(I=Math.min(S,g-1-S)),d.set(S,I)}}const f=g;let B=(F?y*f:l*.001)*m;if(t==="bounce"){const S=f,I=B%(S*2);B=I>S?S*2-I:I}else t==="once"?B=Math.min(B,f):B=B%f;const C=e*g,P=new Float32Array(C*8),A=new Map;let x=0;const v=Array.from(d.keys());v.length===0&&v.push(0);for(const S of v){const I=d.get(S)||0;let D=Math.abs(B-I);D>f/2&&(D=f-D);let E=D<n?1-D/n:0;h>0&&(E=Math.pow(E,1-h));const L=x;for(let k=0;k<e;k++){const Y=k*8,T=x+k*8;P.set(a.subarray(Y,Y+8),T),P[T+3]*=E,P[T+4]*=E,P[T+5]*=E,E<.05&&(P[T+6]=1)}A.set(S,{start:L,length:e*8}),x+=e*8}return P._channelDistributions=A,P}}function he(a,e,u=!1){if(!e||!a||!a.points)return a;const{safetyZones:l,outputArea:s,transformationEnabled:r,transformationMode:o,flipX:h,flipY:m}=e;let n=a.points;const b=a.isTypedArray||n instanceof Float32Array,_=b?n.length/8:n.length;let p=u?n:b?new Float32Array(n):n.map(t=>({...t}));for(let t=0;t<_;t++){let y,c,i,w,R,F;if(b?(y=p[t*8],c=p[t*8+1],i=p[t*8+3],w=p[t*8+4],R=p[t*8+5],F=p[t*8+6]):(y=p[t].x,c=p[t].y,i=p[t].r,w=p[t].g,R=p[t].b,F=p[t].blanking?1:0),r&&s){let M=(y+1)/2,d=(1-c)/2;o==="crop"?(M<s.x||M>s.x+s.w||d<s.y||d>s.y+s.h)&&(i=0,w=0,R=0,F=1):o==="scale"&&(M=s.x+M*s.w,d=s.y+d*s.h,y=M*2-1,c=1-d*2)}if(l&&l.length>0){let M=(y+1)/2,d=(1-c)/2;for(const g of l)if(M>=g.x&&M<=g.x+g.w&&d>=g.y&&d<=g.y+g.h){i=0,w=0,R=0,F=1;break}}h&&(y=-y),m&&(c=-c),y=Math.max(-1,Math.min(1,y)),c=Math.max(-1,Math.min(1,c)),b?(p[t*8]=y,p[t*8+1]=c,p[t*8+3]=i,p[t*8+4]=w,p[t*8+5]=R,p[t*8+6]=F):(p[t].x=y,p[t].y=c,p[t].r=i,p[t].g=w,p[t].b=R,p[t].blanking=F>.5)}return{...a,points:p,isTypedArray:b}}const X=.08,q=4;function de(a){if(!a)return new Float32Array(0);const e=a instanceof Float32Array||a.isTypedArray,u=e?a.length/8:a.length;if(u>4e3){if(a instanceof Float32Array)return a;const m=new Float32Array(u*8);for(let n=0;n<u;n++){const b=a[n];m[n*8]=b.x,m[n*8+1]=b.y,m[n*8+2]=b.z||0,m[n*8+3]=b.r,m[n*8+4]=b.g,m[n*8+5]=b.b,m[n*8+6]=b.blanking?1:0,m[n*8+7]=b.lastPoint?1:0}return m}const l=[],s=(m,n,b,_,p,t,y)=>{const c=y?0:_,i=y?0:p,w=y?0:t;l.push(m,n,b,c,i,w,y?1:0,0)},r=m=>{if(e){const n=m*8;return{x:a[n],y:a[n+1],z:a[n+2],r:a[n+3],g:a[n+4],b:a[n+5],blanking:a[n+6]>.5}}else{const n=a[m];return{x:n.x||0,y:n.y||0,z:n.z||0,r:n.r||0,g:n.g||0,b:n.b||0,blanking:!!n.blanking}}};if(u===0)return new Float32Array(0);let o=r(0);for(let m=0;m<u;m++){const n=r(m);if(o.blanking!==n.blanking)if(n.blanking)for(let t=0;t<q;t++)s(o.x,o.y,o.z,0,0,0,!0);else{s(n.x,n.y,n.z,0,0,0,!0);for(let t=0;t<q;t++)s(n.x,n.y,n.z,0,0,0,!0)}const b=n.x-o.x,_=n.y-o.y,p=Math.sqrt(b*b+_*_);if(p>X){const t=Math.floor(p/X);for(let y=1;y<t;y++){const c=y/t;s(o.x+b*c,o.y+_*c,o.z+(n.z-o.z)*c,n.blanking?0:n.r,n.blanking?0:n.g,n.blanking?0:n.b,n.blanking)}}s(n.x,n.y,n.z,n.r,n.g,n.b,n.blanking),o=n}const h=new Float32Array(l);return a._channelDistributions&&(h._channelDistributions=a._channelDistributions),h}class ue{constructor(e,u){if(this.canvas=e,this.type=u,this.gl=e.getContext("webgl")||e.getContext("experimental-webgl"),this.animationFrameId=null,this.frameIndexes=Array(10).fill(0),this.pointIndexes=Array(10).fill(0),this.showBeamEffect=!1,this.beamAlpha=.5,this.fadeAlpha=.13,this.beamRenderMode="both",this.positionBuffer=null,this.colorBuffer=null,this.alphaBuffer=null,this.alphaBufferData=new Float32Array(131072),this.lastPointDrawTime=0,!this.gl){console.error("WebGL not supported");return}this.setup()}setup(){const e=this.gl,u=`
      attribute vec2 aPosition;
      attribute vec3 aColor;
      attribute float aAlpha;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
        gl_PointSize = 2.0;
        vColor = aColor;
        vAlpha = aAlpha;
      }
    `,l=`
      precision mediump float;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_FragColor = vec4(vColor, vAlpha);
      }
    `,s=this.createShader(e.VERTEX_SHADER,u),r=this.createShader(e.FRAGMENT_SHADER,l),o=this.createProgram(s,r);this.program=o,this.positionAttributeLocation=e.getAttribLocation(o,"aPosition"),this.colorAttributeLocation=e.getAttribLocation(o,"aColor"),this.alphaAttributeLocation=e.getAttribLocation(o,"aAlpha"),this.quadPositionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.quadPositionBuffer);const h=[-1,-1,1,-1,-1,1,-1,1,1,-1,1,1];e.bufferData(e.ARRAY_BUFFER,new Float32Array(h),e.STATIC_DRAW),this.quadColorUniformLocation=e.getUniformLocation(o,"uColor"),this.quadAlphaUniformLocation=e.getUniformLocation(o,"uAlpha");const m=`
      attribute vec2 aPosition;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
      }
    `,n=`
      precision mediump float;
      uniform vec4 uColor;
      void main() {
        gl_FragColor = uColor;
      }
    `,b=this.createShader(e.VERTEX_SHADER,m),_=this.createShader(e.FRAGMENT_SHADER,n);this.fadeProgram=this.createProgram(b,_),this.fadePositionAttributeLocation=e.getAttribLocation(this.fadeProgram,"aPosition"),this.fadeColorUniformLocation=e.getUniformLocation(this.fadeProgram,"uColor"),e.useProgram(o);const p=131072;this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferData(e.ARRAY_BUFFER,p*2*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),this.colorBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),e.bufferData(e.ARRAY_BUFFER,p*3*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),this.alphaBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.alphaBuffer),e.bufferData(e.ARRAY_BUFFER,p*1*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.clearColor(0,0,0,1)}reset(){this.frameIndexes.fill(0),this.pointIndexes.fill(0),this.clearCanvas()}createShader(e,u){const l=this.gl,s=l.createShader(e);if(l.shaderSource(s,u),l.compileShader(s),l.getShaderParameter(s,l.COMPILE_STATUS))return s;console.error(l.getShaderInfoLog(s)),l.deleteShader(s)}createProgram(e,u){const l=this.gl,s=l.createProgram();if(l.attachShader(s,e),l.attachShader(s,u),l.linkProgram(s),l.getProgramParameter(s,l.LINK_STATUS))return s;console.error(l.getProgramInfoLog(s)),l.deleteProgram(s)}render(e){e.showBeamEffect!==void 0&&this.setBeamEffect(e.showBeamEffect),e.beamAlpha!==void 0&&this.setBeamAlpha(e.beamAlpha),e.fadeAlpha!==void 0&&this.setFadeAlpha(e.fadeAlpha),e.beamRenderMode!==void 0&&(this.beamRenderMode=e.beamRenderMode),this.type==="world"?this.renderWorld(e.worldData,e.previewScanRate,e.layerIntensities,e.masterIntensity,e.dacSettings,e.previewTime,e.fftLevels,e.optimizationEnabled):this.renderSingle(e.ildaFrames,e.previewScanRate,e.intensity,e.effects,e.syncSettings,e.bpm,e.clipDuration,e.progress,e.previewTime,e.fftLevels,e.effectStates,e.optimizationEnabled)}renderSingle(e,u,l,s,r={},o=120,h=1,m=null,n=null,b={low:0,mid:0,high:0},_=null,p=!0){const t=this.gl;if(t.viewport(0,0,t.canvas.width,t.canvas.height),this.drawFadeQuad(),!e||e.length===0)return;const y=this.frameIndexes[0]%e.length,c=e[y],i=m!==null?m:y/e.length,w=n!==null?n:performance.now();this.draw(c,s,this.showBeamEffect,this.beamAlpha,u,this.beamRenderMode,l,0,i,w,r,o,h,b,_,p),this.frameIndexes[0]++,this.frameIndexes[0]>=e.length&&(this.frameIndexes[0]=0)}renderWorld(e,u,l,s,r,o=null,h={low:0,mid:0,high:0},m=!0){const n=this.gl;n.viewport(0,0,n.canvas.width,n.canvas.height),this.drawFadeQuad();const b=o!==null?o:performance.now();e.forEach(_=>{if(_&&_.frames&&_.frames.length>0){const p=_.frames[0];if(p){const t=_.layerIndex||0;if(_.syncSettings,_.bpm,t>=this.frameIndexes.length){const i=t+5;for(;this.frameIndexes.length<i;)this.frameIndexes.push(0),this.pointIndexes.push(0)}const c=(l[t]!==void 0?l[t]:1)*s;if(c>.001){const i=_.progress!==void 0?_.progress:this.frameIndexes[t]%_.frames.length/_.frames.length,{syncSettings:w={},bpm:R=120,clipDuration:F=1,effectStates:M=null}=_;let d=p;if(r){let g=p;if(r.dimmer!==void 0&&r.dimmer<1){const f=p.points,B=p.isTypedArray||f instanceof Float32Array,C=B?f.length/8:f.length,P=B?new Float32Array(f):f.map(A=>({...A}));for(let A=0;A<C;A++)B?(P[A*8+3]*=r.dimmer,P[A*8+4]*=r.dimmer,P[A*8+5]*=r.dimmer):(P[A].r*=r.dimmer,P[A].g*=r.dimmer,P[A].b*=r.dimmer);g={...p,points:P,isTypedArray:B}}d=he(g,r)}this.draw(d,_.effects,this.showBeamEffect,this.beamAlpha,u,this.beamRenderMode,c,t,i,b,w,R,F,h,M,m)}}}}),e.forEach(_=>{if(_&&_.frames){const p=_.layerIndex||0;this.frameIndexes[p]++,this.frameIndexes[p]>=_.frames.length&&(this.frameIndexes[p]=0)}})}drawFadeQuad(){const e=this.gl;this.fadeProgram&&(e.useProgram(this.fadeProgram),e.bindBuffer(e.ARRAY_BUFFER,this.quadPositionBuffer),e.enableVertexAttribArray(this.fadePositionAttributeLocation),e.vertexAttribPointer(this.fadePositionAttributeLocation,2,e.FLOAT,!1,0,0),e.uniform4f(this.fadeColorUniformLocation,0,0,0,this.fadeAlpha),e.drawArrays(e.TRIANGLES,0,6))}setBeamEffect(e){this.showBeamEffect=e}setBeamAlpha(e){this.beamAlpha=e}setFadeAlpha(e){this.fadeAlpha=e}draw(e,u,l,s,r,o,h=1,m=0,n=0,b=performance.now(),_={},p=120,t=1,y={low:0,mid:0,high:0},c=null,i=!0){if(this.gl,!e||!e.points)return;let w=e;if(i){const x=de(e.points);w={...e,points:x,isTypedArray:!0}}const R=$(w,u,{progress:n,time:b,syncSettings:_,bpm:p,clipDuration:t,fftLevels:y,effectStates:c}),F=R.points,M=R.isTypedArray,d=M?F.length/8:F.length;if(d===0)return;const g=Math.max(1,Math.floor(d/r));let f=this.pointIndexes[m]||0;f>=d&&(f=0);const B=x=>{const v=(f+x)%d;if(M){const S=v*8;return{x:F[S],y:F[S+1],r:F[S+3],g:F[S+4],b:F[S+5],blanking:F[S+6]===1}}else{const S=F[v];return{x:S.x,y:S.y,r:S.r,g:S.g,b:S.b,blanking:S.blanking}}},C=()=>{const x=o==="points"||o==="both";if(o==="lines"||o==="both"){let S=[],I=[],D=B(0);for(let E=1;E<g;E++){const L=B(E),k=(f+E)%d,Y=(f+E-1)%d,T=k<Y;L.blanking||T?S.length>0&&(this._drawSegment(new Float32Array(S),new Float32Array(I),1,S.length/2,!1),S=[],I=[]):(S.length===0&&(S.push(D.x,D.y),I.push(L.r/255*h,L.g/255*h,L.b/255*h)),S.push(L.x,L.y),I.push(L.r/255*h,L.g/255*h,L.b/255*h)),D=L}S.length>0&&this._drawSegment(new Float32Array(S),new Float32Array(I),1,S.length/2,!1)}if(x){const S=[],I=[];for(let D=0;D<g;D++){const E=B(D);E.blanking||(S.push(E.x,E.y),I.push(E.r/255*h,E.g/255*h,E.b/255*h))}S.length>0&&this._drawSegment(new Float32Array(S),new Float32Array(I),1,S.length/2,!0)}},P=()=>{const x=[],v=[];for(let S=0;S<g;S++){const I=B(S);if(!I.blanking){x.push(0,0,I.x,I.y);const D=[I.r/255*h,I.g/255*h,I.b/255*h];v.push(...D,...D)}}x.length>0&&this._drawLines(new Float32Array(x),new Float32Array(v),s,x.length/2)},A=()=>{const x=[],v=[];let S=B(0);for(let I=1;I<g;I++){const D=B(I);if((f+I)%d<(f+I-1)%d){S=D;continue}if(!D.blanking){x.push(0,0,S.x,S.y,D.x,D.y);const L=[D.r/255*h,D.g/255*h,D.b/255*h],k=[D.r/255*h,D.g/255*h,D.b/255*h],Y=[L[0],L[1],L[2]],T=.3,pe=[L[0]*T,L[1]*T,L[2]*T],me=[k[0]*T,k[1]*T,k[2]*T];v.push(...Y,...pe,...me)}S=D}x.length>0&&this._drawTriangles(new Float32Array(x),new Float32Array(v),s,x.length/2)};C(),l&&(o==="points"?P():o==="lines"?A():o==="both"&&(A(),P())),this.pointIndexes[m]=(f+g)%d}_drawSegment(e,u,l,s,r=!1){const o=this.gl;o.useProgram(this.program),o.bindBuffer(o.ARRAY_BUFFER,this.positionBuffer),o.bufferSubData(o.ARRAY_BUFFER,0,e),o.enableVertexAttribArray(this.positionAttributeLocation),o.vertexAttribPointer(this.positionAttributeLocation,2,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this.colorBuffer),o.bufferSubData(o.ARRAY_BUFFER,0,u),o.enableVertexAttribArray(this.colorAttributeLocation),o.vertexAttribPointer(this.colorAttributeLocation,3,o.FLOAT,!1,0,0),this.alphaBufferData.length<s&&(this.alphaBufferData=new Float32Array(s*2)),this.alphaBufferData.fill(l,0,s);const h=this.alphaBufferData.subarray(0,s);o.bindBuffer(o.ARRAY_BUFFER,this.alphaBuffer),o.bufferSubData(o.ARRAY_BUFFER,0,h),o.enableVertexAttribArray(this.alphaAttributeLocation),o.vertexAttribPointer(this.alphaAttributeLocation,1,o.FLOAT,!1,0,0),o.drawArrays(r?o.POINTS:o.LINE_STRIP,0,s)}_drawLines(e,u,l,s){const r=this.gl;r.useProgram(this.program),r.bindBuffer(r.ARRAY_BUFFER,this.positionBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,e),r.enableVertexAttribArray(this.positionAttributeLocation),r.vertexAttribPointer(this.positionAttributeLocation,2,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,this.colorBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,u),r.enableVertexAttribArray(this.colorAttributeLocation),r.vertexAttribPointer(this.colorAttributeLocation,3,r.FLOAT,!1,0,0),this.alphaBufferData.length<s&&(this.alphaBufferData=new Float32Array(s*2)),this.alphaBufferData.fill(l,0,s);const o=this.alphaBufferData.subarray(0,s);r.bindBuffer(r.ARRAY_BUFFER,this.alphaBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,o),r.enableVertexAttribArray(this.alphaAttributeLocation),r.vertexAttribPointer(this.alphaAttributeLocation,1,r.FLOAT,!1,0,0),r.drawArrays(r.LINES,0,s)}_drawTriangles(e,u,l,s){const r=this.gl;r.useProgram(this.program),r.bindBuffer(r.ARRAY_BUFFER,this.positionBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,e),r.enableVertexAttribArray(this.positionAttributeLocation),r.vertexAttribPointer(this.positionAttributeLocation,2,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,this.colorBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,u),r.enableVertexAttribArray(this.colorAttributeLocation),r.vertexAttribPointer(this.colorAttributeLocation,3,r.FLOAT,!1,0,0),this.alphaBufferData.length<s&&(this.alphaBufferData=new Float32Array(s*2)),this.alphaBufferData.fill(l,0,s);const o=this.alphaBufferData.subarray(0,s);r.bindBuffer(r.ARRAY_BUFFER,this.alphaBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,o),r.enableVertexAttribArray(this.alphaAttributeLocation),r.vertexAttribPointer(this.alphaAttributeLocation,1,r.FLOAT,!1,0,0),r.drawArrays(r.TRIANGLES,0,s)}clearCanvas(){const e=this.gl;e.viewport(0,0,e.canvas.width,e.canvas.height),e.clear(e.COLOR_BUFFER_BIT)}destroy(){if(cancelAnimationFrame(this.animationFrameId),this.gl){const e=this.gl.getExtension("WEBGL_losing_context");e&&e.loseContext()}}}const O=new Map;function H(a,e=0){const u=O.get(a);if(!u)return;const l=performance.now();u.renderer.render(u.data),e=l,u.animationFrameId=requestAnimationFrame(()=>H(a,e))}self.onmessage=a=>{const{action:e,payload:u}=a.data;if(e==="register"){const{id:l,canvas:s,type:r,data:o}=u,h=new ue(s,r),m=requestAnimationFrame(()=>H(l));O.set(l,{renderer:h,type:r,data:o,animationFrameId:m})}else if(e==="deregister"){const{id:l}=u,s=O.get(l);s&&(cancelAnimationFrame(s.animationFrameId),O.delete(l))}else if(e==="update"){const{id:l,data:s}=u,r=O.get(l);if(r){if(r.data&&r.data.effectStates&&s.effectStates)s.effectStates=r.data.effectStates;else if(r.data&&r.data.worldData&&r.data.worldData.length>0){const o=r.data.worldData[0];if(o&&o.effectStates&&s.worldData){const h=o.effectStates;for(const m of s.worldData)m.effectStates=h}}r.data=s}}else if(e==="clear"){const{id:l}=u,s=O.get(l);s&&s.renderer.clearCanvas()}}})();
