(function(){"use strict";const y=new Map;function X(e,t){const{ctx:n,data:x,lastUpdateTime:m,currentFrameIndex:a,pointIndex:f,lastX:h,lastY:p,wasPenUp:v}=e,{ildaFrames:r,showBeamEffect:l,beamAlpha:U,drawSpeed:$}=x,{width:s,height:i}=e.canvas;if(n.fillStyle="black",n.fillRect(0,0,s,i),!r||r.length===0)return;e.lastUpdateTime||(e.lastUpdateTime=t),t-e.lastUpdateTime>=100&&(e.currentFrameIndex=(e.currentFrameIndex+1)%r.length,e.lastUpdateTime=t,self.postMessage({type:"frameChange",id:e.id,frameIndex:e.currentFrameIndex}),e.pointIndex=0,e.lastX=32768/65535*s,e.lastY=i-32768/65535*i,e.wasPenUp=!0);const g=r[e.currentFrameIndex];if(!(!g||!g.points))for(let u=0;u<$;u++){e.pointIndex>=g.points.length&&(e.pointIndex=0,e.lastX=32768/65535*s,e.lastY=i-32768/65535*i,e.wasPenUp=!0);const o=g.points[e.pointIndex],c=(o.x+32768)/65535*s,w=i-(o.y+32768)/65535*i;if(o.blanking)e.wasPenUp=!0;else{const d=`rgb(${o.r}, ${o.g}, ${o.b})`;if(e.wasPenUp)n.fillStyle=d,n.beginPath(),n.arc(c,w,1,0,Math.PI*2),n.fill();else{if(l){const P=s/2,b=i/2;n.beginPath(),n.moveTo(P,b),n.lineTo(e.lastX,e.lastY),n.lineTo(c,w),n.closePath(),n.fillStyle=`rgba(${o.r}, ${o.g}, ${o.b}, ${U})`,n.fill()}n.beginPath(),n.moveTo(e.lastX,e.lastY),n.lineTo(c,w),n.strokeStyle=d,n.lineWidth=.3,n.stroke()}e.wasPenUp=!1}e.lastX=c,e.lastY=w,e.pointIndex++}}function Y(e,t){const{ctx:n,data:x,frameIndexes:m,pointIndexes:a}=e,{worldData:f,showBeamEffect:h,beamAlpha:p,drawSpeed:v}=x,{width:r,height:l}=e.canvas;if(n.fillStyle="black",n.fillRect(0,0,r,l),!f||f.length===0)return;e.lastUpdateTime||(e.lastUpdateTime=t),t-e.lastUpdateTime>=100&&(e.frameIndexes=e.frameIndexes.map((s,i)=>{const I=f[i];return I&&I.frames&&I.frames.length>0?(s+1)%I.frames.length:0}),e.lastUpdateTime=t),f.forEach((s,i)=>{if(s&&s.frames&&s.frames.length>0){const I=e.frameIndexes[i]||0,T=s.frames[I];if(T&&T.points){let g=.5000076295109483*r,u=l-32768/65535*l,o=!0,c=e.pointIndexes[i]||0;for(let w=0;w<v;w++){c>=T.points.length&&(c=0,g=32768/65535*r,u=l-32768/65535*l,o=!0);const d=T.points[c],P=(d.x+32768)/65535*r,b=l-(d.y+32768)/65535*l;if(d.blanking)o=!0;else{const S=`rgb(${d.r}, ${d.g}, ${d.b})`;if(o)n.fillStyle=S,n.beginPath(),n.arc(P,b,1,0,Math.PI*2),n.fill();else{if(h){const k=r/2,D=l/2;n.beginPath(),n.moveTo(k,D),n.lineTo(g,u),n.lineTo(P,b),n.closePath(),n.fillStyle=`rgba(${d.r}, ${d.g}, ${d.b}, ${p})`,n.fill()}n.beginPath(),n.moveTo(g,u),n.lineTo(P,b),n.strokeStyle=S,n.lineWidth=.5,n.stroke()}o=!1}g=P,u=b,c++}e.pointIndexes[i]=c}}})}function F(e){for(const t of y.values())t.type==="single"?X(t,e):t.type==="world"&&Y(t,e);requestAnimationFrame(F)}self.onmessage=e=>{const{action:t,payload:n}=e.data;if(t==="register"){const{id:x,canvas:m,type:a,data:f}=n,{width:h,height:p}=m;y.set(x,{id:x,canvas:m,ctx:m.getContext("2d"),type:a,data:f,lastUpdateTime:0,currentFrameIndex:0,pointIndex:0,lastX:32768/65535*h,lastY:p-32768/65535*p,wasPenUp:!0,frameIndexes:(f.worldData||[]).map(()=>0),pointIndexes:(f.worldData||[]).map(()=>0)})}else if(t==="deregister")y.delete(n.id);else if(t==="update"){const{id:x,data:m}=n,a=y.get(x);if(a){if(a.type==="single")a.data.ildaFrames!==m.ildaFrames&&(a.currentFrameIndex=0,a.lastUpdateTime=0);else if(a.type==="world"){const f=a.data.worldData,h=[],p=[];(m.worldData||[]).forEach((r,l)=>{const U=(f||[]).findIndex($=>$===r);U!==-1?(h[l]=a.frameIndexes[U]||0,p[l]=a.pointIndexes[U]||0):(h[l]=0,p[l]=0)}),a.frameIndexes=h,a.pointIndexes=p}a.data=m}}},requestAnimationFrame(F)})();
