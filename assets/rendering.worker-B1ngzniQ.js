(function(){"use strict";const S=[{id:"rotate",name:"Rotate",type:"transform",description:"Rotates the shape around its center.",defaultParams:{angle:0,rotationSpeed:0},paramControls:[{id:"angle",label:"Angle",type:"range",min:0,max:360,step:1},{id:"rotationSpeed",label:"Rotation Speed",type:"range",min:-10,max:10,step:.1}]},{id:"scale",name:"Scale",type:"transform",description:"Scales the shape.",defaultParams:{scaleX:1,scaleY:1},paramControls:[{id:"scaleX",label:"Scale X",type:"range",min:.01,max:5,step:.01},{id:"scaleY",label:"Scale Y",type:"range",min:.01,max:5,step:.01}]},{id:"translate",name:"Translate",type:"transform",description:"Moves the shape.",defaultParams:{translateX:0,translateY:0},paramControls:[{id:"translateX",label:"Translate X",type:"range",min:-1,max:1,step:.01},{id:"translateY",label:"Translate Y",type:"range",min:-1,max:1,step:.01}]},{id:"color",name:"Color",type:"color",description:"Changes the color of the shape with solid or rainbow modes.",defaultParams:{mode:"solid",r:255,g:255,b:255,cycleSpeed:0,rainbowSpread:1,rainbowOffset:0},paramControls:[{id:"mode",label:"Mode",type:"select",options:["solid","rainbow"]},{id:"r",label:"Red",type:"range",min:0,max:255,step:1,showIf:{mode:"solid"}},{id:"g",label:"Green",type:"range",min:0,max:255,step:1,showIf:{mode:"solid"}},{id:"b",label:"Blue",type:"range",min:0,max:255,step:1,showIf:{mode:"solid"}},{id:"cycleSpeed",label:"Cycle Speed",type:"range",min:0,max:10,step:.1},{id:"rainbowSpread",label:"Rainbow Spread",type:"range",min:.1,max:10,step:.1,showIf:{mode:"rainbow"}},{id:"rainbowOffset",label:"Rainbow Offset",type:"range",min:0,max:360,step:1,showIf:{mode:"rainbow"}},{id:"rainbowPalette",label:"Palette",type:"select",options:["rainbow","fire","ice","cyber"],showIf:{mode:"rainbow"}}]},{id:"wave",name:"Wave",type:"animation",description:"Applies a wave distortion to the shape.",defaultParams:{amplitude:.1,frequency:10,speed:1,direction:"x"},paramControls:[{id:"amplitude",label:"Amplitude",type:"range",min:.01,max:1,step:.01},{id:"frequency",label:"Frequency",type:"range",min:1,max:50,step:1},{id:"speed",label:"Speed",type:"range",min:.1,max:10,step:.1},{id:"direction",label:"Direction",type:"select",options:["x","y"]}]},{id:"blanking",name:"Blanking",type:"animation",description:"Controls the blanking of the laser output.",defaultParams:{blankingInterval:0},paramControls:[{id:"blankingInterval",label:"Blanking Interval",type:"range",min:0,max:10,step:1}]},{id:"strobe",name:"Strobe",type:"animation",description:"Applies a strobe effect to the laser output.",defaultParams:{strobeSpeed:100,strobeAmount:.5},paramControls:[{id:"strobeSpeed",label:"Strobe Speed (ms)",type:"range",min:10,max:1e3,step:10},{id:"strobeAmount",label:"Strobe Amount (0-1)",type:"range",min:0,max:1,step:.01}]},{id:"mirror",name:"Mirror",type:"transform",description:"Mirrors the shape along the X or Y axis.",defaultParams:{mirrorX:!1,mirrorY:!1},paramControls:[{id:"mirrorX",label:"Mirror X",type:"checkbox"},{id:"mirrorY",label:"Mirror Y",type:"checkbox"}]}],B=(n,t)=>({...t,...n});function T(n,t,s={}){const{progress:o=0,time:a=performance.now()}=s;if(!t||t.length===0)return n;let e;if(Array.isArray(n.points)){e=new Float32Array(n.points.length*8);for(let r=0;r<n.points.length;r++){const f=n.points[r],l=r*8;e[l]=f.x,e[l+1]=f.y,e[l+2]=f.z||0,e[l+3]=f.r,e[l+4]=f.g,e[l+5]=f.b,e[l+6]=f.blanking?1:0,e[l+7]=f.lastPoint?1:0}}else e=new Float32Array(n.points);const i=e.length/8;for(const r of t)if(S.find(l=>l.id===r.id))switch(r.id){case"rotate":M(e,i,r.params,o);break;case"scale":U(e,i,r.params);break;case"translate":D(e,i,r.params);break;case"color":k(e,i,r.params,a);break;case"wave":O(e,i,r.params,a);break;case"blanking":X(e,i,r.params);break;case"strobe":V(e,i,r.params,a);break;case"mirror":q(e,i,r.params);break}return{...n,points:e,isTypedArray:!0}}function M(n,t,s,o){const{angle:a,rotationSpeed:e}=B(s,S.find(l=>l.id==="rotate").defaultParams),i=a*Math.PI/180+o*2*Math.PI*e,r=Math.sin(i),f=Math.cos(i);for(let l=0;l<t;l++){const m=l*8,p=n[m],g=n[m+1];n[m]=p*f-g*r,n[m+1]=p*r+g*f}}function U(n,t,s){const{scaleX:o,scaleY:a}=B(s,S.find(e=>e.id==="scale").defaultParams);for(let e=0;e<t;e++){const i=e*8;n[i]*=o,n[i+1]*=a}}function D(n,t,s){const{translateX:o,translateY:a}=B(s,S.find(e=>e.id==="translate").defaultParams);for(let e=0;e<t;e++){const i=e*8;n[i]+=o,n[i+1]+=a}}function k(n,t,s,o){const{mode:a,r:e,g:i,b:r,cycleSpeed:f,rainbowSpread:l,rainbowOffset:m,rainbowPalette:p}=B(s,S.find(u=>u.id==="color").defaultParams),g=o*.001*f;if(a==="rainbow"){const u=p||"rainbow";for(let b=0;b<t;b++){const P=b*8,w=(b/t*l+g*.5+m/360)%1;let y,R,E;u==="rainbow"?[y,R,E]=_(w,1,.5):[y,R,E]=N(u,w),n[P+3]=y,n[P+4]=R,n[P+5]=E}}else if(f>0){const u=g*50%360,[b,P,w]=_(u/360,1,.5);for(let y=0;y<t;y++){const R=y*8;n[R+3]=b,n[R+4]=P,n[R+5]=w}}else for(let u=0;u<t;u++){const b=u*8;n[b+3]=e,n[b+4]=i,n[b+5]=r}}function N(n,t){const s={fire:[{r:255,g:0,b:0},{r:255,g:128,b:0},{r:255,g:255,b:0},{r:255,g:0,b:0}],ice:[{r:0,g:0,b:255},{r:0,g:255,b:255},{r:255,g:255,b:255},{r:0,g:0,b:255}],cyber:[{r:255,g:0,b:255},{r:0,g:255,b:255},{r:0,g:0,b:255},{r:255,g:0,b:255}]},o=s[n]||s.fire,a=t*(o.length-1),e=Math.floor(a),i=a-e,r=o[e],f=o[e+1]||o[e];return[Math.round(r.r+(f.r-r.r)*i),Math.round(r.g+(f.g-r.g)*i),Math.round(r.b+(f.b-r.b)*i)]}function _(n,t,s){let o,a,e;{const i=(l,m,p)=>(p<0&&(p+=1),p>1&&(p-=1),p<.16666666666666666?l+(m-l)*6*p:p<.5?m:p<.6666666666666666?l+(m-l)*(.6666666666666666-p)*6:l),r=s+t-s*t,f=2*s-r;o=i(f,r,n+1/3),a=i(f,r,n),e=i(f,r,n-1/3)}return[Math.round(o*255),Math.round(a*255),Math.round(e*255)]}function O(n,t,s,o){const{amplitude:a,frequency:e,speed:i,direction:r}=B(s,S.find(l=>l.id==="wave").defaultParams),f=o*.001*i;for(let l=0;l<t;l++){const m=l*8;r==="x"?n[m+1]+=a*Math.sin(n[m]*e+f):r==="y"&&(n[m]+=a*Math.sin(n[m+1]*e+f))}}function X(n,t,s){const{blankingInterval:o}=B(s,S.find(a=>a.id==="blanking").defaultParams);if(!(o<=0))for(let a=0;a<t;a++)a%(o+1)===o&&(n[a*8+6]=1)}function V(n,t,s,o){const{strobeSpeed:a,strobeAmount:e}=B(s,S.find(r=>r.id==="strobe").defaultParams);if(o%a/a<e)for(let r=0;r<t;r++)n[r*8+6]=1}function q(n,t,s){const{mirrorX:o,mirrorY:a}=B(s,S.find(e=>e.id==="mirror").defaultParams);for(let e=0;e<t;e++){const i=e*8;o&&(n[i]=-n[i]),a&&(n[i+1]=-n[i+1])}}class W{constructor(t,s){if(this.canvas=t,this.type=s,this.gl=t.getContext("webgl")||t.getContext("experimental-webgl"),this.animationFrameId=null,this.frameIndexes=Array(10).fill(0),this.pointIndexes=Array(10).fill(0),this.showBeamEffect=!1,this.beamAlpha=.5,this.fadeAlpha=.13,this.beamRenderMode="lines",this.positionBuffer=null,this.colorBuffer=null,this.alphaBuffer=null,this.lastPointDrawTime=0,!this.gl){console.error("WebGL not supported");return}this.setup()}setup(){const t=this.gl,s=`
      attribute vec2 aPosition;
      attribute vec3 aColor;
      attribute float aAlpha;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
        gl_PointSize = 2.0;
        vColor = aColor;
        vAlpha = aAlpha;
      }
    `,o=`
      precision mediump float;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_FragColor = vec4(vColor, vAlpha);
      }
    `,a=this.createShader(t.VERTEX_SHADER,s),e=this.createShader(t.FRAGMENT_SHADER,o),i=this.createProgram(a,e);this.program=i,this.positionAttributeLocation=t.getAttribLocation(i,"aPosition"),this.colorAttributeLocation=t.getAttribLocation(i,"aColor"),this.alphaAttributeLocation=t.getAttribLocation(i,"aAlpha"),this.quadPositionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.quadPositionBuffer);const r=[-1,-1,1,-1,-1,1,-1,1,1,-1,1,1];t.bufferData(t.ARRAY_BUFFER,new Float32Array(r),t.STATIC_DRAW),this.quadColorUniformLocation=t.getUniformLocation(i,"uColor"),this.quadAlphaUniformLocation=t.getUniformLocation(i,"uAlpha");const f=`
      attribute vec2 aPosition;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
      }
    `,l=`
      precision mediump float;
      uniform vec4 uColor;
      void main() {
        gl_FragColor = uColor;
      }
    `,m=this.createShader(t.VERTEX_SHADER,f),p=this.createShader(t.FRAGMENT_SHADER,l);this.fadeProgram=this.createProgram(m,p),this.fadePositionAttributeLocation=t.getAttribLocation(this.fadeProgram,"aPosition"),this.fadeColorUniformLocation=t.getUniformLocation(this.fadeProgram,"uColor"),t.useProgram(i);const g=131072;this.positionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferData(t.ARRAY_BUFFER,g*2*Float32Array.BYTES_PER_ELEMENT,t.DYNAMIC_DRAW),this.colorBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),t.bufferData(t.ARRAY_BUFFER,g*3*Float32Array.BYTES_PER_ELEMENT,t.DYNAMIC_DRAW),this.alphaBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.alphaBuffer),t.bufferData(t.ARRAY_BUFFER,g*1*Float32Array.BYTES_PER_ELEMENT,t.DYNAMIC_DRAW),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA)}reset(){this.frameIndexes.fill(0),this.pointIndexes.fill(0),this.clearCanvas()}createShader(t,s){const o=this.gl,a=o.createShader(t);if(o.shaderSource(a,s),o.compileShader(a),o.getShaderParameter(a,o.COMPILE_STATUS))return a;console.error(o.getShaderInfoLog(a)),o.deleteShader(a)}createProgram(t,s){const o=this.gl,a=o.createProgram();if(o.attachShader(a,t),o.attachShader(a,s),o.linkProgram(a),o.getProgramParameter(a,o.LINK_STATUS))return a;console.error(o.getProgramInfoLog(a)),o.deleteProgram(a)}render(t){t.showBeamEffect!==void 0&&this.setBeamEffect(t.showBeamEffect),t.beamAlpha!==void 0&&this.setBeamAlpha(t.beamAlpha),t.fadeAlpha!==void 0&&this.setFadeAlpha(t.fadeAlpha),t.beamRenderMode!==void 0&&(this.beamRenderMode=t.beamRenderMode),this.type==="world"?this.renderWorld(t.worldData,t.previewScanRate,t.layerIntensities,t.masterIntensity):this.renderSingle(t.ildaFrames,t.previewScanRate,t.intensity,t.effects,t.syncSettings)}renderSingle(t,s,o,a,e={}){const i=this.gl;if(i.viewport(0,0,i.canvas.width,i.canvas.height),this.drawFadeQuad(),!t||t.length===0)return;const r=this.frameIndexes[0]%t.length,f=t[r],l=r/t.length,m=performance.now();this.draw(f,a,this.showBeamEffect,this.beamAlpha,s,this.beamRenderMode,o,0,l,m,e),this.frameIndexes[0]++,this.frameIndexes[0]>=t.length&&(this.frameIndexes[0]=0)}renderWorld(t,s,o,a){const e=this.gl;e.viewport(0,0,e.canvas.width,e.canvas.height),this.drawFadeQuad();const i=performance.now();t.forEach(r=>{if(r&&r.frames&&r.frames.length>0){const f=r.frames[0];if(f){const l=r.layerIndex||0,m=r.syncSettings||{};if(l>=this.frameIndexes.length){const u=l+5;for(;this.frameIndexes.length<u;)this.frameIndexes.push(0),this.pointIndexes.push(0)}const g=(o[l]!==void 0?o[l]:1)*a;if(g>.001){const u=this.frameIndexes[l]%r.frames.length/r.frames.length;this.draw(f,r.effects,this.showBeamEffect,this.beamAlpha,s,this.beamRenderMode,g,l,u,i,m)}}}}),t.forEach(r=>{if(r&&r.frames){const f=r.layerIndex||0;this.frameIndexes[f]++,this.frameIndexes[f]>=r.frames.length&&(this.frameIndexes[f]=0)}})}drawFadeQuad(){const t=this.gl;this.fadeProgram&&(t.useProgram(this.fadeProgram),t.bindBuffer(t.ARRAY_BUFFER,this.quadPositionBuffer),t.enableVertexAttribArray(this.fadePositionAttributeLocation),t.vertexAttribPointer(this.fadePositionAttributeLocation,2,t.FLOAT,!1,0,0),t.uniform4f(this.fadeColorUniformLocation,0,0,0,this.fadeAlpha),t.drawArrays(t.TRIANGLES,0,6))}setBeamEffect(t){this.showBeamEffect=t}setBeamAlpha(t){this.beamAlpha=t}setFadeAlpha(t){this.fadeAlpha=t}draw(t,s,o,a,e,i,r=1,f=0,l=0,m=performance.now(),p={}){if(this.gl,!t||!t.points)return;const g=(s||[]).map(h=>{const A={...h.params},c=S.find(d=>d.id===h.id);return c&&c.paramControls.forEach(d=>{const F=`${h.id}.${d.id}`,x=p[F];if(x&&(d.type==="range"||d.type==="number")){let v=0;x==="fps"?v=m*.001%1:(x==="timeline"||x==="bpm")&&(v=l),A[d.id]=d.min+(d.max-d.min)*v}}),{...h,params:A}}),u=T(t,g,{progress:l,time:m}),b=u.points,P=u.isTypedArray,w=P?b.length/8:b.length;if(w===0)return;const y=Math.max(1,Math.floor(w/e));let R=this.pointIndexes[f]||0;R>=w&&(R=0);const E=h=>{const A=(R+h)%w;if(P){const c=A*8;return{x:b[c],y:b[c+1],r:b[c+3],g:b[c+4],b:b[c+5],blanking:b[c+6]===1}}else{const c=b[A];return{x:c.x,y:c.y,r:c.r,g:c.g,b:c.b,blanking:c.blanking}}},G=()=>{let h=[],A=[];for(let c=0;c<y;c++){const d=E(c);if(d.blanking){h.length>0&&(this._drawSegment(new Float32Array(h),new Float32Array(A),1,h.length/2),h=[],A=[]);continue}h.push(d.x,d.y),A.push(d.r/255*r,d.g/255*r,d.b/255*r)}h.length>0&&this._drawSegment(new Float32Array(h),new Float32Array(A),1,h.length/2)},C=()=>{const h=[],A=[];for(let c=0;c<y;c++){const d=E(c);if(!d.blanking){h.push(0,0,d.x,d.y);const F=[d.r/255*r,d.g/255*r,d.b/255*r];A.push(...F,...F)}}h.length>0&&this._drawLines(new Float32Array(h),new Float32Array(A),a,h.length/2)},Y=()=>{const h=[],A=[];let c=E(0);for(let d=1;d<y;d++){const F=E(d);if(!c.blanking&&!F.blanking){h.push(0,0,c.x,c.y,F.x,F.y);const x=[c.r/255*r,c.g/255*r,c.b/255*r],v=[F.r/255*r,F.g/255*r,F.b/255*r],H=[(x[0]+v[0])/2,(x[1]+v[1])/2,(x[2]+v[2])/2];A.push(...H,...x,...v)}c=F}h.length>0&&this._drawTriangles(new Float32Array(h),new Float32Array(A),a,h.length/2)};G(),o&&(i==="points"?C():i==="lines"?Y():i==="both"&&(Y(),C())),this.pointIndexes[f]=(R+y)%w}_drawSegment(t,s,o,a){const e=this.gl;e.useProgram(this.program),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,t),e.enableVertexAttribArray(this.positionAttributeLocation),e.vertexAttribPointer(this.positionAttributeLocation,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,s),e.enableVertexAttribArray(this.colorAttributeLocation),e.vertexAttribPointer(this.colorAttributeLocation,3,e.FLOAT,!1,0,0);const i=new Float32Array(Array(a).fill(o));e.bindBuffer(e.ARRAY_BUFFER,this.alphaBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,i),e.enableVertexAttribArray(this.alphaAttributeLocation),e.vertexAttribPointer(this.alphaAttributeLocation,1,e.FLOAT,!1,0,0),e.drawArrays(e.LINE_STRIP,0,a)}_drawLines(t,s,o,a){const e=this.gl;e.useProgram(this.program),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,t),e.enableVertexAttribArray(this.positionAttributeLocation),e.vertexAttribPointer(this.positionAttributeLocation,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,s),e.enableVertexAttribArray(this.colorAttributeLocation),e.vertexAttribPointer(this.colorAttributeLocation,3,e.FLOAT,!1,0,0);const i=new Float32Array(Array(a).fill(o));e.bindBuffer(e.ARRAY_BUFFER,this.alphaBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,i),e.enableVertexAttribArray(this.alphaAttributeLocation),e.vertexAttribPointer(this.alphaAttributeLocation,1,e.FLOAT,!1,0,0),e.drawArrays(e.LINES,0,a)}_drawTriangles(t,s,o,a){const e=this.gl;e.useProgram(this.program),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,t),e.enableVertexAttribArray(this.positionAttributeLocation),e.vertexAttribPointer(this.positionAttributeLocation,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,s),e.enableVertexAttribArray(this.colorAttributeLocation),e.vertexAttribPointer(this.colorAttributeLocation,3,e.FLOAT,!1,0,0);const i=new Float32Array(Array(a).fill(o));e.bindBuffer(e.ARRAY_BUFFER,this.alphaBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,i),e.enableVertexAttribArray(this.alphaAttributeLocation),e.vertexAttribPointer(this.alphaAttributeLocation,1,e.FLOAT,!1,0,0),e.drawArrays(e.TRIANGLES,0,a)}clearCanvas(){const t=this.gl;t.viewport(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT)}destroy(){cancelAnimationFrame(this.animationFrameId)}}const L=new Map;function I(n,t=0){const s=L.get(n);if(!s)return;const o=performance.now();s.renderer.render(s.data),t=o,s.animationFrameId=requestAnimationFrame(()=>I(n,t))}self.onmessage=n=>{const{action:t,payload:s}=n.data;if(t==="register"){const{id:o,canvas:a,type:e,data:i}=s,r=new W(a,e),f=requestAnimationFrame(()=>I(o));L.set(o,{renderer:r,type:e,data:i,animationFrameId:f})}else if(t==="deregister"){const{id:o}=s,a=L.get(o);a&&(cancelAnimationFrame(a.animationFrameId),L.delete(o))}else if(t==="update"){const{id:o,data:a}=s,e=L.get(o);e&&(e.data=a)}else if(t==="clear"){const{id:o}=s,a=L.get(o);a&&a.renderer.clearCanvas()}}})();
