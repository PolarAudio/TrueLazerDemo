(function(){"use strict";const I=[{id:"rotate",name:"Rotate",type:"transform",description:"Rotates the shape around its center.",defaultParams:{angle:0,speed:0,direction:"CW"},paramControls:[{id:"angle",label:"Angle",type:"range",min:0,max:360,step:1},{id:"speed",label:"Speed",type:"range",min:0,max:10,step:.1},{id:"direction",label:"Direction",type:"select",options:["CW","CCW"]}]},{id:"scale",name:"Scale",type:"transform",description:"Scales the shape.",defaultParams:{scaleX:1,scaleY:1},paramControls:[{id:"scaleX",label:"Scale X",type:"range",min:.01,max:5,step:.01},{id:"scaleY",label:"Scale Y",type:"range",min:.01,max:5,step:.01}]},{id:"translate",name:"Translate",type:"transform",description:"Moves the shape.",defaultParams:{translateX:0,translateY:0},paramControls:[{id:"translateX",label:"Translate X",type:"range",min:-1,max:1,step:.01},{id:"translateY",label:"Translate Y",type:"range",min:-1,max:1,step:.01}]},{id:"color",name:"Color",type:"color",description:"Changes the color of the shape with solid or rainbow modes.",defaultParams:{mode:"solid",r:255,g:255,b:255,cycleSpeed:0,rainbowSpread:1,rainbowOffset:0,rainbowPalette:"rainbow"},paramControls:[{id:"mode",label:"Mode",type:"select",options:["solid","rainbow"]},{id:"r",label:"Red",type:"range",min:0,max:255,step:1,showIf:{mode:"solid"}},{id:"g",label:"Green",type:"range",min:0,max:255,step:1,showIf:{mode:"solid"}},{id:"b",label:"Blue",type:"range",min:0,max:255,step:1,showIf:{mode:"solid"}},{id:"cycleSpeed",label:"Cycle Speed",type:"range",min:0,max:10,step:.1},{id:"rainbowSpread",label:"Rainbow Spread",type:"range",min:.1,max:10,step:.1,showIf:{mode:"rainbow"}},{id:"rainbowOffset",label:"Rainbow Offset",type:"range",min:0,max:360,step:1,showIf:{mode:"rainbow"}},{id:"rainbowPalette",label:"Palette",type:"select",options:["rainbow","fire","ice","cyber"],showIf:{mode:"rainbow"}}]},{id:"wave",name:"Wave",type:"animation",description:"Applies a wave distortion to the shape.",defaultParams:{amplitude:.1,frequency:10,speed:1,direction:"x"},paramControls:[{id:"amplitude",label:"Amplitude",type:"range",min:.01,max:1,step:.01},{id:"frequency",label:"Frequency",type:"range",min:1,max:50,step:1},{id:"speed",label:"Speed",type:"range",min:.1,max:10,step:.1},{id:"direction",label:"Direction",type:"select",options:["x","y"]}]},{id:"warp",name:"Warp",type:"animation",description:"Symmetrical chaotic wave distortion.",defaultParams:{amount:.1,chaos:.5,speed:1},paramControls:[{id:"amount",label:"Amount",type:"range",min:0,max:1,step:.01},{id:"chaos",label:"Chaos",type:"range",min:0,max:1,step:.01},{id:"speed",label:"Speed",type:"range",min:.1,max:10,step:.1}]},{id:"distortion",name:"Distortion",type:"transform",description:"Distorts the point data.",defaultParams:{amount:.1,scale:10,speed:.5},paramControls:[{id:"amount",label:"Amount",type:"range",min:0,max:1,step:.01},{id:"scale",label:"Scale",type:"range",min:1,max:50,step:1},{id:"speed",label:"Speed",type:"range",min:0,max:5,step:.1}]},{id:"move",name:"Move (Bounce)",type:"transform",description:"Moves points and bounces them off the borders.",defaultParams:{speedX:.1,speedY:.1},paramControls:[{id:"speedX",label:"Speed X",type:"range",min:0,max:2,step:.01},{id:"speedY",label:"Speed Y",type:"range",min:0,max:2,step:.01}]},{id:"delay",name:"Delay",type:"effect",description:"Frame or Channel based delay effect.",defaultParams:{mode:"frame",playstyle:"repeat",useCustomOrder:!1,delayDirection:"left_to_right",delayAmount:5,decay:.8,customOrder:[],enabled:!0},paramControls:[{id:"mode",label:"Mode",type:"select",options:["frame","channel"]},{id:"playstyle",label:"Playstyle",type:"select",options:["once","repeat","bounce"]},{id:"useCustomOrder",label:"Custom Order",type:"checkbox",showIf:{mode:"channel"}},{id:"delayDirection",label:"Direction",type:"select",options:["center_to_out","out_to_center","left_to_right","right_to_left"],showIf:{useCustomOrder:!1}},{id:"delayAmount",label:"Delay Time",type:"range",min:1,max:60,step:1},{id:"decay",label:"Decay",type:"range",min:0,max:1,step:.01}]},{id:"chase",name:"Chase",type:"effect",description:"Frame or Channel based chase effect.",defaultParams:{mode:"frame",playstyle:"repeat",steps:4,decay:.8,speed:1,overlap:1,direction:"left_to_right",useCustomOrder:!1,customOrder:[],enabled:!0},paramControls:[{id:"mode",label:"Mode",type:"select",options:["frame","channel"]},{id:"playstyle",label:"Playstyle",type:"select",options:["once","repeat","bounce"]},{id:"steps",label:"Steps",type:"range",min:2,max:16,step:1,showIf:{mode:"frame"}},{id:"decay",label:"Decay",type:"range",min:0,max:1,step:.01},{id:"speed",label:"Speed",type:"range",min:.1,max:5,step:.1},{id:"overlap",label:"Overlap",type:"range",min:1,max:4,step:1},{id:"useCustomOrder",label:"Custom Order",type:"checkbox",showIf:{mode:"channel"}},{id:"direction",label:"Direction",type:"select",options:["center_to_out","out_to_center","left_to_right","right_to_left"],showIf:{useCustomOrder:!1}}]},{id:"blanking",name:"Blanking",type:"animation",description:"Controls the blanking of the laser output.",defaultParams:{blankingInterval:0,spacing:0},paramControls:[{id:"blankingInterval",label:"Blanking Interval",type:"range",min:0,max:10,step:1},{id:"spacing",label:"Spacing",type:"range",min:0,max:20,step:1}]},{id:"strobe",name:"Strobe",type:"animation",description:"Applies a strobe effect to the laser output.",defaultParams:{strobeSpeed:100,strobeAmount:.5},paramControls:[{id:"strobeSpeed",label:"Strobe Speed (ms)",type:"range",min:10,max:1e3,step:10},{id:"strobeAmount",label:"Strobe Amount (0-1)",type:"range",min:0,max:1,step:.01}]},{id:"mirror",name:"Mirror",type:"transform",description:"Mirrors the shape from the center.",defaultParams:{mode:"none"},paramControls:[{id:"mode",label:"Mirror Mode",type:"select",options:["none","x+","x-","y+","y-"]}]}],L=(n,e)=>({...e,...n});function N(n,e,h,a){if(!h)return e;const o=typeof h=="string"?{syncMode:h}:h;if(!o.syncMode)return e;const{time:t,progress:r=0,bpm:l=120,clipDuration:s=0,fftLevels:f={low:0,mid:0,high:0}}=a;let d=0;const i=o.speedMultiplier||1,c=o.style||"loop";if(o.syncMode==="fps")d=t*.001*i;else if(o.syncMode==="timeline"){const w=Math.max(.01,o.duration||1);s>0?d=r*s/w*i:d=0}else if(o.syncMode==="bpm"){const w=Math.max(.1,o.beats||4),y=l/60,_=w/(y||2);s>0?d=r*s/_*i:d=0}else if(o.syncMode==="fft"){const w=o.fftRange||"low",y=f[w]||0;return X(y,e,o)}c==="bounce"&&(d*=2);const m=o.direction||"forward";if(m==="pause")return e;let u=0;if(c==="once")u=Math.min(d,1),m==="backward"&&(u=1-u);else if(c==="bounce"){let w=d%1;Math.floor(d)%2===1?u=1-w:u=w,m==="backward"&&(u=1-u)}else u=d%1,m==="backward"&&(u=1-u);const b=o.range;let R=0,A=1;if(b&&Array.isArray(b)&&b.length===2)R=b[0],A=b[1];else return e;return R+(A-R)*u}function X(n,e,h){const a=h.range;return a&&Array.isArray(a)&&a.length===2?a[0]+(a[1]-a[0])*n:e}function W(n,e,h={}){const{progress:a=0,time:o=performance.now(),effectStates:t,syncSettings:r={},fftLevels:l}=h;if(!e||e.length===0)return n;let s;if(Array.isArray(n.points)){s=new Float32Array(n.points.length*8);for(let i=0;i<n.points.length;i++){const c=n.points[i],m=i*8;s[m]=c.x,s[m+1]=c.y,s[m+2]=c.z||0,s[m+3]=c.r,s[m+4]=c.g,s[m+5]=c.b,s[m+6]=c.blanking?1:0,s[m+7]=c.lastPoint?1:0}}else s=new Float32Array(n.points);let f=s;const d=()=>f.length/8;for(const i of e){if(i.params.enabled===!1||!I.find(u=>u.id===i.id))continue;const m={...i.params};for(const u of Object.keys(m)){const b=`${i.id}.${u}`;r[b]&&(m[u]=N(u,m[u],r[b],h))}switch(i.id){case"rotate":V(f,d(),m,a,o);break;case"scale":q(f,d(),m);break;case"translate":z(f,d(),m);break;case"color":G(f,d(),m,o);break;case"wave":Q(f,d(),m,o);break;case"blanking":K(f,d(),m);break;case"strobe":$(f,d(),m,o);break;case"mirror":f=j(f,d(),m);break;case"warp":Z(f,d(),m,o);break;case"distortion":J(f,d(),m,o);break;case"move":ee(f,d(),m,o);break;case"delay":t&&i.instanceId&&(f=te(f,d(),m,t,i.instanceId,h));break;case"chase":f=re(f,d(),m,o,h);break}}return{...n,points:f,isTypedArray:!0}}function V(n,e,h,a,o){const{angle:t,speed:r,direction:l}=L(h,I.find(m=>m.id==="rotate").defaultParams),s=l==="CCW"?-1:1,f=o*.001*r*s,d=t*Math.PI/180+f,i=Math.sin(d),c=Math.cos(d);for(let m=0;m<e;m++){const u=m*8,b=n[u],R=n[u+1];n[u]=b*c-R*i,n[u+1]=b*i+R*c}}function q(n,e,h){const{scaleX:a,scaleY:o}=L(h,I.find(t=>t.id==="scale").defaultParams);for(let t=0;t<e;t++){const r=t*8;n[r]*=a,n[r+1]*=o}}function z(n,e,h){const{translateX:a,translateY:o}=L(h,I.find(t=>t.id==="translate").defaultParams);for(let t=0;t<e;t++){const r=t*8;n[r]+=a,n[r+1]+=o}}function G(n,e,h,a){const{mode:o,r:t,g:r,b:l,cycleSpeed:s,rainbowSpread:f,rainbowOffset:d,rainbowPalette:i}=L(h,I.find(m=>m.id==="color").defaultParams),c=a*.001*s;if(o==="rainbow"){const m=i||"rainbow";for(let u=0;u<e;u++){const b=u*8,R=(u/e*f+c*.5+d/360)%1;let A,w,y;m==="rainbow"?[A,w,y]=O(R,1,.5):[A,w,y]=H(m,R),n[b+3]=A,n[b+4]=w,n[b+5]=y}}else if(s>0){const m=c*50%360,[u,b,R]=O(m/360,1,.5);for(let A=0;A<e;A++){const w=A*8;n[w+3]=u,n[w+4]=b,n[w+5]=R}}else for(let m=0;m<e;m++){const u=m*8;n[u+3]=t,n[u+4]=r,n[u+5]=l}}function H(n,e){const h={fire:[{r:255,g:0,b:0},{r:255,g:128,b:0},{r:255,g:255,b:0},{r:255,g:0,b:0}],ice:[{r:0,g:0,b:255},{r:0,g:255,b:255},{r:255,g:255,b:255},{r:0,g:0,b:255}],cyber:[{r:255,g:0,b:255},{r:0,g:255,b:255},{r:0,g:0,b:255},{r:255,g:0,b:255}]},a=h[n]||h.fire,o=e*(a.length-1),t=Math.floor(o),r=o-t,l=a[t],s=a[t+1]||a[t];return[Math.round(l.r+(s.r-l.r)*r),Math.round(l.g+(s.g-l.g)*r),Math.round(l.b+(s.b-l.b)*r)]}function O(n,e,h){let a,o,t;{const r=(f,d,i)=>(i<0&&(i+=1),i>1&&(i-=1),i<.16666666666666666?f+(d-f)*6*i:i<.5?d:i<.6666666666666666?f+(d-f)*(.6666666666666666-i)*6:f),l=h+e-h*e,s=2*h-l;a=r(s,l,n+1/3),o=r(s,l,n),t=r(s,l,n-1/3)}return[Math.round(a*255),Math.round(o*255),Math.round(t*255)]}function Q(n,e,h,a){const{amplitude:o,frequency:t,speed:r,direction:l}=L(h,I.find(f=>f.id==="wave").defaultParams),s=a*.001*r;for(let f=0;f<e;f++){const d=f*8;l==="x"?n[d+1]+=o*Math.sin(n[d]*t+s):l==="y"&&(n[d]+=o*Math.sin(n[d+1]*t+s))}}function K(n,e,h){const{blankingInterval:a,spacing:o=0}=L(h,I.find(r=>r.id==="blanking").defaultParams);if(a<=0)return;const t=a+1+o;for(let r=0;r<e;r++)r%t>=a&&(n[r*8+6]=1)}function $(n,e,h,a){const{strobeSpeed:o,strobeAmount:t}=L(h,I.find(l=>l.id==="strobe").defaultParams);if(a%o/o<t)for(let l=0;l<e;l++)n[l*8+6]=1}function j(n,e,h){const{mode:a}=L(h,I.find(s=>s.id==="mirror").defaultParams);if(a==="none")return n;let o=[];for(let s=0;s<e;s++){const f=s*8,d=n[f],i=n[f+1];let c=!1;a==="x-"&&(d<=0||a==="x+"&&(d>=0||a==="y-"&&(i<=0||a==="y+"&&i>=0)))&&(c=!0),c&&o.push({x:n[f],y:n[f+1],z:n[f+2],r:n[f+3],g:n[f+4],b:n[f+5],blk:n[f+6],last:n[f+7]})}const t=o.length*2,r=new Float32Array(t*8);let l=0;for(const s of o)r[l++]=s.x,r[l++]=s.y,r[l++]=s.z,r[l++]=s.r,r[l++]=s.g,r[l++]=s.b,r[l++]=s.blk,r[l++]=s.last;for(const s of o)a==="x-"||a==="x+"?r[l++]=-s.x:r[l++]=s.x,a==="y-"||a==="y+"?r[l++]=-s.y:r[l++]=s.y,r[l++]=s.z,r[l++]=s.r,r[l++]=s.g,r[l++]=s.b,r[l++]=s.blk,r[l++]=s.last;return r}function Z(n,e,h,a){const{amount:o,chaos:t,speed:r}=L(h,I.find(s=>s.id==="warp").defaultParams),l=a*.001*r;for(let s=0;s<e;s++){const f=s*8,d=n[f],i=n[f+1],c=Math.abs(i);n[f]+=Math.sin(c*10*(1+t)+l)*o*Math.cos(l*t),n[f+1]+=Math.cos(Math.abs(d)*10*(1+t)+l)*o*Math.sin(l*t)}}function J(n,e,h,a){const{amount:o,scale:t,speed:r}=L(h,I.find(s=>s.id==="distortion").defaultParams),l=a*.001*r;for(let s=0;s<e;s++){const f=s*8,d=Math.sin(n[f]*t+l)*Math.cos(n[f+1]*t-l),i=Math.cos(n[f]*t-l)*Math.sin(n[f+1]*t+l);n[f]+=d*o,n[f+1]+=i*o}}function ee(n,e,h,a){const{speedX:o,speedY:t}=L(h,I.find(d=>d.id==="move").defaultParams),r=a*.001,l=r*o,s=r*t,f=4;for(let d=0;d<e;d++){const i=d*8;let c=n[i]+l,m=n[i+1]+s,u=(c+1)%f;u<0&&(u+=f),u>2&&(u=4-u),c=u-1;let b=(m+1)%f;b<0&&(b+=f),b>2&&(b=4-b),m=b-1,n[i]=c,n[i+1]=m}}function te(n,e,h,a,o,t){const{mode:r="frame",delayAmount:l,decay:s,delayDirection:f,useCustomOrder:d,customOrder:i}=L(h,I.find(m=>m.id==="delay").defaultParams);a.has(o)||a.set(o,[]);const c=a.get(o);if(c.unshift(new Float32Array(n)),r==="frame"){const u=l*10+1;c.length>u&&(c.length=u);const b=new Float32Array(n.length);for(let R=0;R<e;R++){let A=0;const w=R/e;f==="left_to_right"?A=Math.floor(w*9):f==="right_to_left"?A=Math.floor((1-w)*9):f==="center_to_out"?A=Math.floor(Math.abs(w-.5)*2*9):f==="out_to_center"&&(A=Math.floor((1-Math.abs(w-.5)*2)*9));const y=A*l,_=y<c.length?c[y]:null,F=Math.pow(s,A),x=R*8;_&&_.length===n.length?(b[x]=_[x],b[x+1]=_[x+1],b[x+2]=_[x+2],b[x+3]=_[x+3]*F,b[x+4]=_[x+4]*F,b[x+5]=_[x+5]*F,b[x+6]=_[x+6],b[x+7]=_[x+7]):(b.set(n.subarray(x,x+8),x),b[x+3]=0,b[x+4]=0,b[x+5]=0,b[x+6]=1)}return b}else{const{assignedDacs:m}=t||{};let u=new Map,b=0;if(d||h.delayMode==="channel")(i&&i.length>0?i.map(P=>P.originalIndex):m?m.map((P,p)=>p):[0]).forEach((P,p)=>{u.set(P,p),b=Math.max(b,p)});else{const P=(m||[]).length||1;for(let p=0;p<P;p++){let S=p;f==="right_to_left"?S=P-1-p:f==="center_to_out"?S=Math.floor(Math.abs(p-(P-1)/2)):f==="out_to_center"&&(S=Math.min(p,P-1-p)),u.set(p,S),b=Math.max(b,S)}}const A=b+1,w=l*A+1;c.length>w&&(c.length=w);const y=[];for(let g=0;g<A;g++){const P=g*l;y.push({points:P<c.length?c[P]:null,factor:Math.pow(s,g),index:g})}const _=y.reduce((g,P)=>g+(P.points?P.points.length/8:n.length/8),0),F=new Float32Array(_*8);let x=0;const E=new Array(y.length);for(let g=0;g<y.length;g++){const P=y[g],p=P.points,S=p?p.length/8:n.length/8;E[g]=x;for(let M=0;M<S;M++){const v=M*8,C=x+M*8;p?(F[C]=p[v],F[C+1]=p[v+1],F[C+2]=p[v+2],F[C+3]=p[v+3]*P.factor,F[C+4]=p[v+4]*P.factor,F[C+5]=p[v+5]*P.factor,F[C+6]=p[v+6],F[C+7]=p[v+7]):F[C+6]=1}x+=S*8}const B=new Map;return u.forEach((g,P)=>{g<y.length&&B.set(P,{start:E[g],length:y[g].points?y[g].points.length:n.length})}),F._channelDistributions=B,F}}function re(n,e,h,a,o={}){const{mode:t="frame",steps:r,decay:l,speed:s,overlap:f,direction:d,useCustomOrder:i,customOrder:c}=L(h,I.find(A=>A.id==="chase").defaultParams),{progress:m=0,clipDuration:u=1}=o,b=m*u,R=m!==void 0&&u>0?b:a*.001;if(t==="frame"){const A=r,w=R*s%A,y=new Float32Array(n.length);for(let _=0;_<e;_++){const F=_/e;let x=0;d==="left_to_right"?x=Math.floor(F*(A-1)):d==="right_to_left"?x=Math.floor((1-F)*(A-1)):d==="center_to_out"?x=Math.floor(Math.abs(F-.5)*2*(A-1)):d==="out_to_center"&&(x=Math.floor((1-Math.abs(F-.5)*2)*(A-1)));let E=Math.abs(w-x);E>A/2&&(E=A-E);let B=E<f?1-E/f:0;l>0&&(B=Math.pow(B,1-l));const g=_*8;y.set(n.subarray(g,g+8),g),y[g+3]*=B,y[g+4]*=B,y[g+5]*=B,B<.05&&(y[g+6]=1)}return y}else{const{assignedDacs:A}=o||{};let w=new Map,y=0;if(i)(c&&c.length>0?c.map(S=>S.originalIndex):A?A.map((S,M)=>M):[0]).forEach((S,M)=>{w.set(S,M),y++});else{y=(A?A.length:1)||1;for(let p=0;p<y;p++){let S=p;d==="right_to_left"?S=y-1-p:d==="center_to_out"?S=Math.floor(Math.abs(p-(y-1)/2)):d==="out_to_center"&&(S=Math.min(p,y-1-p)),w.set(p,S)}}const _=y,F=R*s%_,x=e*y,E=new Float32Array(x*8),B=new Map;let g=0;const P=Array.from(w.keys());P.length===0&&P.push(0);for(const p of P){const S=w.get(p)||0;let M=Math.abs(F-S);M>_/2&&(M=_-M);let v=M<f?1-M/f:0;l>0&&(v=Math.pow(v,1-l));const C=g;for(let Y=0;Y<e;Y++){const T=Y*8,D=g+Y*8;E.set(n.subarray(T,T+8),D),E[D+3]*=v,E[D+4]*=v,E[D+5]*=v,v<.05&&(E[D+6]=1)}B.set(p,{start:C,length:e*8}),g+=e*8}return E._channelDistributions=B,E}}function ae(n,e){if(!e||!n||!n.points)return n;const{safetyZones:h,outputArea:a,transformationEnabled:o,transformationMode:t,flipX:r,flipY:l}=e;let s=n.points;const f=n.isTypedArray||s instanceof Float32Array,d=f?s.length/8:s.length;let i=f?new Float32Array(s):s.map(c=>({...c}));for(let c=0;c<d;c++){let m,u,b,R,A,w;if(f?(m=i[c*8],u=i[c*8+1],b=i[c*8+3],R=i[c*8+4],A=i[c*8+5],w=i[c*8+6]):(m=i[c].x,u=i[c].y,b=i[c].r,R=i[c].g,A=i[c].b,w=i[c].blanking?1:0),r&&(m=-m),l&&(u=-u),o&&a){let y=(m+1)/2,_=(1-u)/2;t==="crop"?(y<a.x||y>a.x+a.w||_<a.y||_>a.y+a.h)&&(b=0,R=0,A=0,w=1):t==="scale"&&(y=a.x+y*a.w,_=a.y+_*a.h,m=y*2-1,u=1-_*2)}if(h&&h.length>0){let y=(m+1)/2,_=(1-u)/2;for(const F of h)if(y>=F.x&&y<=F.x+F.w&&_>=F.y&&_<=F.y+F.h){b=0,R=0,A=0,w=1;break}}f?(i[c*8]=m,i[c*8+1]=u,i[c*8+3]=b,i[c*8+4]=R,i[c*8+5]=A,i[c*8+6]=w):(i[c].x=m,i[c].y=u,i[c].r=b,i[c].g=R,i[c].b=A,i[c].blanking=w>.5)}return{...n,points:i,isTypedArray:f}}class oe{constructor(e,h){if(this.canvas=e,this.type=h,this.gl=e.getContext("webgl")||e.getContext("experimental-webgl"),this.animationFrameId=null,this.frameIndexes=Array(10).fill(0),this.pointIndexes=Array(10).fill(0),this.showBeamEffect=!1,this.beamAlpha=.5,this.fadeAlpha=.13,this.beamRenderMode="both",this.positionBuffer=null,this.colorBuffer=null,this.alphaBuffer=null,this.lastPointDrawTime=0,!this.gl){console.error("WebGL not supported");return}this.setup()}setup(){const e=this.gl,h=`
      attribute vec2 aPosition;
      attribute vec3 aColor;
      attribute float aAlpha;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
        gl_PointSize = 2.0;
        vColor = aColor;
        vAlpha = aAlpha;
      }
    `,a=`
      precision mediump float;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_FragColor = vec4(vColor, vAlpha);
      }
    `,o=this.createShader(e.VERTEX_SHADER,h),t=this.createShader(e.FRAGMENT_SHADER,a),r=this.createProgram(o,t);this.program=r,this.positionAttributeLocation=e.getAttribLocation(r,"aPosition"),this.colorAttributeLocation=e.getAttribLocation(r,"aColor"),this.alphaAttributeLocation=e.getAttribLocation(r,"aAlpha"),this.quadPositionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.quadPositionBuffer);const l=[-1,-1,1,-1,-1,1,-1,1,1,-1,1,1];e.bufferData(e.ARRAY_BUFFER,new Float32Array(l),e.STATIC_DRAW),this.quadColorUniformLocation=e.getUniformLocation(r,"uColor"),this.quadAlphaUniformLocation=e.getUniformLocation(r,"uAlpha");const s=`
      attribute vec2 aPosition;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
      }
    `,f=`
      precision mediump float;
      uniform vec4 uColor;
      void main() {
        gl_FragColor = uColor;
      }
    `,d=this.createShader(e.VERTEX_SHADER,s),i=this.createShader(e.FRAGMENT_SHADER,f);this.fadeProgram=this.createProgram(d,i),this.fadePositionAttributeLocation=e.getAttribLocation(this.fadeProgram,"aPosition"),this.fadeColorUniformLocation=e.getUniformLocation(this.fadeProgram,"uColor"),e.useProgram(r);const c=131072;this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferData(e.ARRAY_BUFFER,c*2*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),this.colorBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),e.bufferData(e.ARRAY_BUFFER,c*3*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),this.alphaBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.alphaBuffer),e.bufferData(e.ARRAY_BUFFER,c*1*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.clearColor(0,0,0,1)}reset(){this.frameIndexes.fill(0),this.pointIndexes.fill(0),this.clearCanvas()}createShader(e,h){const a=this.gl,o=a.createShader(e);if(a.shaderSource(o,h),a.compileShader(o),a.getShaderParameter(o,a.COMPILE_STATUS))return o;console.error(a.getShaderInfoLog(o)),a.deleteShader(o)}createProgram(e,h){const a=this.gl,o=a.createProgram();if(a.attachShader(o,e),a.attachShader(o,h),a.linkProgram(o),a.getProgramParameter(o,a.LINK_STATUS))return o;console.error(a.getProgramInfoLog(o)),a.deleteProgram(o)}render(e){e.showBeamEffect!==void 0&&this.setBeamEffect(e.showBeamEffect),e.beamAlpha!==void 0&&this.setBeamAlpha(e.beamAlpha),e.fadeAlpha!==void 0&&this.setFadeAlpha(e.fadeAlpha),e.beamRenderMode!==void 0&&(this.beamRenderMode=e.beamRenderMode),this.type==="world"?this.renderWorld(e.worldData,e.previewScanRate,e.layerIntensities,e.masterIntensity,e.dacSettings,e.previewTime,e.fftLevels):this.renderSingle(e.ildaFrames,e.previewScanRate,e.intensity,e.effects,e.syncSettings,e.bpm,e.clipDuration,e.progress,e.previewTime,e.fftLevels)}renderSingle(e,h,a,o,t={},r=120,l=1,s=null,f=null,d={low:0,mid:0,high:0}){const i=this.gl;if(i.viewport(0,0,i.canvas.width,i.canvas.height),this.drawFadeQuad(),!e||e.length===0)return;const c=this.frameIndexes[0]%e.length,m=e[c],u=s!==null?s:c/e.length,b=f!==null?f:performance.now();this.draw(m,o,this.showBeamEffect,this.beamAlpha,h,this.beamRenderMode,a,0,u,b,t,r,l,d),this.frameIndexes[0]++,this.frameIndexes[0]>=e.length&&(this.frameIndexes[0]=0)}renderWorld(e,h,a,o,t,r=null,l={low:0,mid:0,high:0}){const s=this.gl;s.viewport(0,0,s.canvas.width,s.canvas.height),this.drawFadeQuad();const f=r!==null?r:performance.now();e.forEach(d=>{if(d&&d.frames&&d.frames.length>0){const i=d.frames[0];if(i){const c=d.layerIndex||0;if(d.syncSettings,d.bpm,c>=this.frameIndexes.length){const b=c+5;for(;this.frameIndexes.length<b;)this.frameIndexes.push(0),this.pointIndexes.push(0)}const u=(a[c]!==void 0?a[c]:1)*o;if(u>.001){const b=d.progress!==void 0?d.progress:this.frameIndexes[c]%d.frames.length/d.frames.length,{syncSettings:R={},bpm:A=120,clipDuration:w=1}=d;let y=i;if(t){let _=i;if(t.dimmer!==void 0&&t.dimmer<1){const F=i.points,x=i.isTypedArray||F instanceof Float32Array,E=x?F.length/8:F.length,B=x?new Float32Array(F):F.map(g=>({...g}));for(let g=0;g<E;g++)x?(B[g*8+3]*=t.dimmer,B[g*8+4]*=t.dimmer,B[g*8+5]*=t.dimmer):(B[g].r*=t.dimmer,B[g].g*=t.dimmer,B[g].b*=t.dimmer);_={...i,points:B,isTypedArray:x}}y=ae(_,t)}this.draw(y,d.effects,this.showBeamEffect,this.beamAlpha,h,this.beamRenderMode,u,c,b,f,R,A,w,l)}}}}),e.forEach(d=>{if(d&&d.frames){const i=d.layerIndex||0;this.frameIndexes[i]++,this.frameIndexes[i]>=d.frames.length&&(this.frameIndexes[i]=0)}})}drawFadeQuad(){const e=this.gl;this.fadeProgram&&(e.useProgram(this.fadeProgram),e.bindBuffer(e.ARRAY_BUFFER,this.quadPositionBuffer),e.enableVertexAttribArray(this.fadePositionAttributeLocation),e.vertexAttribPointer(this.fadePositionAttributeLocation,2,e.FLOAT,!1,0,0),e.uniform4f(this.fadeColorUniformLocation,0,0,0,this.fadeAlpha),e.drawArrays(e.TRIANGLES,0,6))}setBeamEffect(e){this.showBeamEffect=e}setBeamAlpha(e){this.beamAlpha=e}setFadeAlpha(e){this.fadeAlpha=e}draw(e,h,a,o,t,r,l=1,s=0,f=0,d=performance.now(),i={},c=120,m=1,u={low:0,mid:0,high:0}){if(this.gl,!e||!e.points)return;const b=W(e,h,{progress:f,time:d,syncSettings:i,bpm:c,clipDuration:m,fftLevels:u}),R=b.points,A=b.isTypedArray,w=A?R.length/8:R.length;if(w===0)return;const y=Math.max(1,Math.floor(w/t));let _=this.pointIndexes[s]||0;_>=w&&(_=0);const F=g=>{const P=(_+g)%w;if(A){const p=P*8;return{x:R[p],y:R[p+1],r:R[p+3],g:R[p+4],b:R[p+5],blanking:R[p+6]===1}}else{const p=R[P];return{x:p.x,y:p.y,r:p.r,g:p.g,b:p.b,blanking:p.blanking}}},x=()=>{const g=r==="points"||r==="both",P=r==="lines"||r==="both";let p=[],S=[];for(let M=0;M<y;M++){const v=F(M);if(v.blanking){p.length>0&&(P&&this._drawSegment(new Float32Array(p),new Float32Array(S),1,p.length/2,!1),g&&this._drawSegment(new Float32Array(p),new Float32Array(S),1,p.length/2,!0),p=[],S=[]);continue}p.push(v.x,v.y),S.push(v.r/255*l,v.g/255*l,v.b/255*l)}p.length>0&&(P&&this._drawSegment(new Float32Array(p),new Float32Array(S),1,p.length/2,!1),g&&this._drawSegment(new Float32Array(p),new Float32Array(S),1,p.length/2,!0))},E=()=>{const g=[],P=[];for(let p=0;p<y;p++){const S=F(p);if(!S.blanking){g.push(0,0,S.x,S.y);const M=[S.r/255*l,S.g/255*l,S.b/255*l];P.push(...M,...M)}}g.length>0&&this._drawLines(new Float32Array(g),new Float32Array(P),o,g.length/2)},B=()=>{const g=[],P=[];let p=F(0);for(let S=1;S<y;S++){const M=F(S);if(!p.blanking&&!M.blanking){g.push(0,0,p.x,p.y,M.x,M.y);const v=[p.r/255*l,p.g/255*l,p.b/255*l],C=[M.r/255*l,M.g/255*l,M.b/255*l],Y=[(v[0]+C[0])/2,(v[1]+C[1])/2,(v[2]+C[2])/2],T=.3,D=[v[0]*T,v[1]*T,v[2]*T],ne=[C[0]*T,C[1]*T,C[2]*T];P.push(...Y,...D,...ne)}p=M}g.length>0&&this._drawTriangles(new Float32Array(g),new Float32Array(P),o,g.length/2)};x(),a&&(r==="points"?E():r==="lines"?B():r==="both"&&(B(),E())),this.pointIndexes[s]=(_+y)%w}_drawSegment(e,h,a,o,t=!1){const r=this.gl;r.useProgram(this.program),r.bindBuffer(r.ARRAY_BUFFER,this.positionBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,e),r.enableVertexAttribArray(this.positionAttributeLocation),r.vertexAttribPointer(this.positionAttributeLocation,2,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,this.colorBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,h),r.enableVertexAttribArray(this.colorAttributeLocation),r.vertexAttribPointer(this.colorAttributeLocation,3,r.FLOAT,!1,0,0);const l=new Float32Array(Array(o).fill(a));r.bindBuffer(r.ARRAY_BUFFER,this.alphaBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,l),r.enableVertexAttribArray(this.alphaAttributeLocation),r.vertexAttribPointer(this.alphaAttributeLocation,1,r.FLOAT,!1,0,0),r.drawArrays(t?r.POINTS:r.LINE_STRIP,0,o)}_drawLines(e,h,a,o){const t=this.gl;t.useProgram(this.program),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,e),t.enableVertexAttribArray(this.positionAttributeLocation),t.vertexAttribPointer(this.positionAttributeLocation,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,h),t.enableVertexAttribArray(this.colorAttributeLocation),t.vertexAttribPointer(this.colorAttributeLocation,3,t.FLOAT,!1,0,0);const r=new Float32Array(Array(o).fill(a));t.bindBuffer(t.ARRAY_BUFFER,this.alphaBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,r),t.enableVertexAttribArray(this.alphaAttributeLocation),t.vertexAttribPointer(this.alphaAttributeLocation,1,t.FLOAT,!1,0,0),t.drawArrays(t.LINES,0,o)}_drawTriangles(e,h,a,o){const t=this.gl;t.useProgram(this.program),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,e),t.enableVertexAttribArray(this.positionAttributeLocation),t.vertexAttribPointer(this.positionAttributeLocation,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,h),t.enableVertexAttribArray(this.colorAttributeLocation),t.vertexAttribPointer(this.colorAttributeLocation,3,t.FLOAT,!1,0,0);const r=new Float32Array(Array(o).fill(a));t.bindBuffer(t.ARRAY_BUFFER,this.alphaBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,r),t.enableVertexAttribArray(this.alphaAttributeLocation),t.vertexAttribPointer(this.alphaAttributeLocation,1,t.FLOAT,!1,0,0),t.drawArrays(t.TRIANGLES,0,o)}clearCanvas(){const e=this.gl;e.viewport(0,0,e.canvas.width,e.canvas.height),e.clear(e.COLOR_BUFFER_BIT)}destroy(){cancelAnimationFrame(this.animationFrameId)}}const k=new Map;function U(n,e=0){const h=k.get(n);if(!h)return;const a=performance.now();h.renderer.render(h.data),e=a,h.animationFrameId=requestAnimationFrame(()=>U(n,e))}self.onmessage=n=>{const{action:e,payload:h}=n.data;if(e==="register"){const{id:a,canvas:o,type:t,data:r}=h,l=new oe(o,t),s=requestAnimationFrame(()=>U(a));k.set(a,{renderer:l,type:t,data:r,animationFrameId:s})}else if(e==="deregister"){const{id:a}=h,o=k.get(a);o&&(cancelAnimationFrame(o.animationFrameId),k.delete(a))}else if(e==="update"){const{id:a,data:o}=h,t=k.get(a);t&&(t.data=o)}else if(e==="clear"){const{id:a}=h,o=k.get(a);o&&o.renderer.clearCanvas()}}})();
