(function(){"use strict";const C=[{id:"rotate",name:"Rotate",type:"transform",description:"Rotates the shape around its center.",defaultParams:{angle:0,speed:0,direction:"CW"},paramControls:[{id:"angle",label:"Angle",type:"range",min:0,max:360,step:1},{id:"speed",label:"Speed",type:"range",min:0,max:10,step:.1},{id:"direction",label:"Direction",type:"select",options:["CW","CCW"]}]},{id:"scale",name:"Scale",type:"transform",description:"Scales the shape.",defaultParams:{scaleX:1,scaleY:1},paramControls:[{id:"scaleX",label:"Scale X",type:"range",min:.01,max:5,step:.01},{id:"scaleY",label:"Scale Y",type:"range",min:.01,max:5,step:.01}]},{id:"translate",name:"Translate",type:"transform",description:"Moves the shape.",defaultParams:{translateX:0,translateY:0},paramControls:[{id:"translateX",label:"Translate X",type:"range",min:-1,max:1,step:.01},{id:"translateY",label:"Translate Y",type:"range",min:-1,max:1,step:.01}]},{id:"color",name:"Color",type:"color",description:"Changes the color of the shape with solid or rainbow modes.",defaultParams:{mode:"solid",r:255,g:255,b:255,cycleSpeed:0,rainbowSpread:1,rainbowOffset:0,rainbowPalette:"rainbow"},paramControls:[{id:"mode",label:"Mode",type:"select",options:["solid","rainbow"]},{id:"r",label:"Red",type:"range",min:0,max:255,step:1,showIf:{mode:"solid"}},{id:"g",label:"Green",type:"range",min:0,max:255,step:1,showIf:{mode:"solid"}},{id:"b",label:"Blue",type:"range",min:0,max:255,step:1,showIf:{mode:"solid"}},{id:"cycleSpeed",label:"Cycle Speed",type:"range",min:0,max:10,step:.1},{id:"rainbowSpread",label:"Rainbow Spread",type:"range",min:.1,max:10,step:.1,showIf:{mode:"rainbow"}},{id:"rainbowOffset",label:"Rainbow Offset",type:"range",min:0,max:360,step:1,showIf:{mode:"rainbow"}},{id:"rainbowPalette",label:"Palette",type:"select",options:["rainbow","fire","ice","cyber"],showIf:{mode:"rainbow"}}]},{id:"wave",name:"Wave",type:"animation",description:"Applies a wave distortion to the shape.",defaultParams:{amplitude:.1,frequency:10,speed:1,direction:"x"},paramControls:[{id:"amplitude",label:"Amplitude",type:"range",min:.01,max:1,step:.01},{id:"frequency",label:"Frequency",type:"range",min:1,max:50,step:1},{id:"speed",label:"Speed",type:"range",min:.1,max:10,step:.1},{id:"direction",label:"Direction",type:"select",options:["x","y"]}]},{id:"warp",name:"Warp",type:"animation",description:"Symmetrical chaotic wave distortion.",defaultParams:{amount:.1,chaos:.5,speed:1},paramControls:[{id:"amount",label:"Amount",type:"range",min:0,max:1,step:.01},{id:"chaos",label:"Chaos",type:"range",min:0,max:1,step:.01},{id:"speed",label:"Speed",type:"range",min:.1,max:10,step:.1}]},{id:"distortion",name:"Distortion",type:"transform",description:"Distorts the point data.",defaultParams:{amount:.1,scale:10,speed:.5},paramControls:[{id:"amount",label:"Amount",type:"range",min:0,max:1,step:.01},{id:"scale",label:"Scale",type:"range",min:1,max:50,step:1},{id:"speed",label:"Speed",type:"range",min:0,max:5,step:.1}]},{id:"move",name:"Move (Bounce)",type:"transform",description:"Moves points and bounces them off the borders.",defaultParams:{speedX:.1,speedY:.1},paramControls:[{id:"speedX",label:"Speed X",type:"range",min:0,max:2,step:.01},{id:"speedY",label:"Speed Y",type:"range",min:0,max:2,step:.01}]},{id:"delay",name:"Delay",type:"effect",description:"Channel-based delay effect.",defaultParams:{useCustomOrder:!1,delayDirection:"left_to_right",delayAmount:5,decay:.8,customOrder:[]},paramControls:[{id:"useCustomOrder",label:"Custom Order",type:"checkbox"},{id:"delayDirection",label:"Direction",type:"select",options:["center_to_out","out_to_center","left_to_right","right_to_left"],showIf:{useCustomOrder:!1}},{id:"delayAmount",label:"Delay Time",type:"range",min:1,max:60,step:1},{id:"decay",label:"Decay",type:"range",min:0,max:1,step:.01}]},{id:"chase",name:"Chase",type:"effect",description:"Step-based chase effect.",defaultParams:{steps:4,decay:.8,speed:1,overlap:1,direction:"left_to_right",useCustomOrder:!1,customOrder:[]},paramControls:[{id:"steps",label:"Steps",type:"range",min:2,max:16,step:1},{id:"decay",label:"Decay",type:"range",min:0,max:1,step:.01},{id:"speed",label:"Speed",type:"range",min:.1,max:5,step:.1},{id:"overlap",label:"Overlap",type:"range",min:1,max:4,step:1},{id:"useCustomOrder",label:"Custom Order",type:"checkbox"},{id:"direction",label:"Direction",type:"select",options:["center_to_out","out_to_center","left_to_right","right_to_left"],showIf:{useCustomOrder:!1}}]},{id:"blanking",name:"Blanking",type:"animation",description:"Controls the blanking of the laser output.",defaultParams:{blankingInterval:0},paramControls:[{id:"blankingInterval",label:"Blanking Interval",type:"range",min:0,max:10,step:1}]},{id:"strobe",name:"Strobe",type:"animation",description:"Applies a strobe effect to the laser output.",defaultParams:{strobeSpeed:100,strobeAmount:.5},paramControls:[{id:"strobeSpeed",label:"Strobe Speed (ms)",type:"range",min:10,max:1e3,step:10},{id:"strobeAmount",label:"Strobe Amount (0-1)",type:"range",min:0,max:1,step:.01}]},{id:"mirror",name:"Mirror",type:"transform",description:"Mirrors the shape from the center.",defaultParams:{mode:"none"},paramControls:[{id:"mode",label:"Mirror Mode",type:"select",options:["none","x+","x-","y+","y-"]}]}],I=(o,e)=>({...e,...o});function H(o,e,d,n){if(!d)return e;const a=typeof d=="string"?{syncMode:d}:d;if(!a.syncMode)return e;const{time:t,progress:r=0,bpm:l=120,clipDuration:s=0}=n;let i=0;const p=a.speedMultiplier||1;if(a.syncMode==="fps")i=t*.001*p;else if(a.syncMode==="timeline"){const x=Math.max(.01,a.duration||1);s>0?i=r*s/x*p:i=0}else if(a.syncMode==="bpm"){const x=Math.max(.1,a.beats||4),w=l/60,S=x/(w||2);s>0?i=r*s/S*p:i=0}const c=a.direction||"forward";if(c==="pause")return e;const f=a.style||"loop";let h=0;if(f==="once")h=Math.min(i,1),c==="backward"&&(h=1-h);else if(f==="bounce"){let x=i%1;Math.floor(i)%2===1?h=1-x:h=x,c==="backward"&&(h=1-h)}else h=i%1,c==="backward"&&(h=1-h);const u=a.range;let y=0,_=1;if(u&&Array.isArray(u)&&u.length===2)y=u[0],_=u[1];else return e;return y+(_-y)*h}function Q(o,e,d={}){const{progress:n=0,time:a=performance.now(),effectStates:t,syncSettings:r={}}=d;if(!e||e.length===0)return o;let l;if(Array.isArray(o.points)){l=new Float32Array(o.points.length*8);for(let p=0;p<o.points.length;p++){const c=o.points[p],f=p*8;l[f]=c.x,l[f+1]=c.y,l[f+2]=c.z||0,l[f+3]=c.r,l[f+4]=c.g,l[f+5]=c.b,l[f+6]=c.blanking?1:0,l[f+7]=c.lastPoint?1:0}}else l=new Float32Array(o.points);let s=l;const i=()=>s.length/8;for(const p of e){if(!C.find(h=>h.id===p.id))continue;const f={...p.params};for(const h of Object.keys(f)){const u=`${p.id}.${h}`;r[u]&&(f[h]=H(h,f[h],r[u],d))}switch(p.id){case"rotate":K(s,i(),f,n,a);break;case"scale":Z(s,i(),f);break;case"translate":$(s,i(),f);break;case"color":j(s,i(),f,a);break;case"wave":ee(s,i(),f,a);break;case"blanking":te(s,i(),f);break;case"strobe":re(s,i(),f,a);break;case"mirror":s=ae(s,i(),f);break;case"warp":oe(s,i(),f,a);break;case"distortion":ne(s,i(),f,a);break;case"move":se(s,i(),f,a);break;case"delay":t&&p.instanceId&&(s=ie(s,i(),f,t,p.instanceId,d));break;case"chase":s=le(s,i(),f,a,d);break}}return{...o,points:s,isTypedArray:!0}}function K(o,e,d,n,a){const{angle:t,speed:r,direction:l}=I(d,C.find(h=>h.id==="rotate").defaultParams),s=l==="CCW"?-1:1,i=a*.001*r*s,p=t*Math.PI/180+i,c=Math.sin(p),f=Math.cos(p);for(let h=0;h<e;h++){const u=h*8,y=o[u],_=o[u+1];o[u]=y*f-_*c,o[u+1]=y*c+_*f}}function Z(o,e,d){const{scaleX:n,scaleY:a}=I(d,C.find(t=>t.id==="scale").defaultParams);for(let t=0;t<e;t++){const r=t*8;o[r]*=n,o[r+1]*=a}}function $(o,e,d){const{translateX:n,translateY:a}=I(d,C.find(t=>t.id==="translate").defaultParams);for(let t=0;t<e;t++){const r=t*8;o[r]+=n,o[r+1]+=a}}function j(o,e,d,n){const{mode:a,r:t,g:r,b:l,cycleSpeed:s,rainbowSpread:i,rainbowOffset:p,rainbowPalette:c}=I(d,C.find(h=>h.id==="color").defaultParams),f=n*.001*s;if(a==="rainbow"){const h=c||"rainbow";for(let u=0;u<e;u++){const y=u*8,_=(u/e*i+f*.5+p/360)%1;let x,w,S;h==="rainbow"?[x,w,S]=U(_,1,.5):[x,w,S]=J(h,_),o[y+3]=x,o[y+4]=w,o[y+5]=S}}else if(s>0){const h=f*50%360,[u,y,_]=U(h/360,1,.5);for(let x=0;x<e;x++){const w=x*8;o[w+3]=u,o[w+4]=y,o[w+5]=_}}else for(let h=0;h<e;h++){const u=h*8;o[u+3]=t,o[u+4]=r,o[u+5]=l}}function J(o,e){const d={fire:[{r:255,g:0,b:0},{r:255,g:128,b:0},{r:255,g:255,b:0},{r:255,g:0,b:0}],ice:[{r:0,g:0,b:255},{r:0,g:255,b:255},{r:255,g:255,b:255},{r:0,g:0,b:255}],cyber:[{r:255,g:0,b:255},{r:0,g:255,b:255},{r:0,g:0,b:255},{r:255,g:0,b:255}]},n=d[o]||d.fire,a=e*(n.length-1),t=Math.floor(a),r=a-t,l=n[t],s=n[t+1]||n[t];return[Math.round(l.r+(s.r-l.r)*r),Math.round(l.g+(s.g-l.g)*r),Math.round(l.b+(s.b-l.b)*r)]}function U(o,e,d){let n,a,t;{const r=(i,p,c)=>(c<0&&(c+=1),c>1&&(c-=1),c<.16666666666666666?i+(p-i)*6*c:c<.5?p:c<.6666666666666666?i+(p-i)*(.6666666666666666-c)*6:i),l=d+e-d*e,s=2*d-l;n=r(s,l,o+1/3),a=r(s,l,o),t=r(s,l,o-1/3)}return[Math.round(n*255),Math.round(a*255),Math.round(t*255)]}function ee(o,e,d,n){const{amplitude:a,frequency:t,speed:r,direction:l}=I(d,C.find(i=>i.id==="wave").defaultParams),s=n*.001*r;for(let i=0;i<e;i++){const p=i*8;l==="x"?o[p+1]+=a*Math.sin(o[p]*t+s):l==="y"&&(o[p]+=a*Math.sin(o[p+1]*t+s))}}function te(o,e,d){const{blankingInterval:n}=I(d,C.find(a=>a.id==="blanking").defaultParams);if(!(n<=0))for(let a=0;a<e;a++)a%(n+1)===n&&(o[a*8+6]=1)}function re(o,e,d,n){const{strobeSpeed:a,strobeAmount:t}=I(d,C.find(l=>l.id==="strobe").defaultParams);if(n%a/a<t)for(let l=0;l<e;l++)o[l*8+6]=1}function ae(o,e,d){const{mode:n}=I(d,C.find(s=>s.id==="mirror").defaultParams);if(n==="none")return o;let a=[];for(let s=0;s<e;s++){const i=s*8,p=o[i],c=o[i+1];let f=!1;n==="x-"?p<=0&&(f=!0):n==="x+"?p>=0&&(f=!0):n==="y-"?c<=0&&(f=!0):n==="y+"&&c>=0&&(f=!0),f&&a.push({x:o[i],y:o[i+1],z:o[i+2],r:o[i+3],g:o[i+4],b:o[i+5],blk:o[i+6],last:o[i+7]})}const t=a.length*2,r=new Float32Array(t*8);let l=0;for(const s of a)r[l++]=s.x,r[l++]=s.y,r[l++]=s.z,r[l++]=s.r,r[l++]=s.g,r[l++]=s.b,r[l++]=s.blk,r[l++]=s.last;for(const s of a)n==="x-"||n==="x+"?r[l++]=-s.x:r[l++]=s.x,n==="y-"||n==="y+"?r[l++]=-s.y:r[l++]=s.y,r[l++]=s.z,r[l++]=s.r,r[l++]=s.g,r[l++]=s.b,r[l++]=s.blk,r[l++]=s.last;return r}function oe(o,e,d,n){const{amount:a,chaos:t,speed:r}=I(d,C.find(s=>s.id==="warp").defaultParams),l=n*.001*r;for(let s=0;s<e;s++){const i=s*8,p=o[i],c=o[i+1],f=Math.abs(c);o[i]+=Math.sin(f*10*(1+t)+l)*a*Math.cos(l*t),o[i+1]+=Math.cos(Math.abs(p)*10*(1+t)+l)*a*Math.sin(l*t)}}function ne(o,e,d,n){const{amount:a,scale:t,speed:r}=I(d,C.find(s=>s.id==="distortion").defaultParams),l=n*.001*r;for(let s=0;s<e;s++){const i=s*8,p=Math.sin(o[i]*t+l)*Math.cos(o[i+1]*t-l),c=Math.cos(o[i]*t-l)*Math.sin(o[i+1]*t+l);o[i]+=p*a,o[i+1]+=c*a}}function se(o,e,d,n){const{speedX:a,speedY:t}=I(d,C.find(p=>p.id==="move").defaultParams),r=n*.001,l=r*a,s=r*t,i=4;for(let p=0;p<e;p++){const c=p*8;let f=o[c]+l,h=o[c+1]+s,u=(f+1)%i;u<0&&(u+=i),u>2&&(u=4-u),f=u-1;let y=(h+1)%i;y<0&&(y+=i),y>2&&(y=4-y),h=y-1,o[c]=f,o[c+1]=h}}function ie(o,e,d,n,a,t){const r=C.find(m=>m.id==="delay").defaultParams,{delayAmount:l,decay:s,useCustomOrder:i,delayDirection:p,customOrder:c}=I(d,r),f=i||d.delayMode==="channel"||d.delayMode===!0;n.has(a)||n.set(a,[]);const h=n.get(a),u=new Float32Array(o);h.unshift(u);const{assignedDacs:y}=t||{};let _=new Map,x=0;if(f){let m=[];c&&Array.isArray(c)&&c.length>0?m=c.map(g=>g.originalIndex!==void 0?g.originalIndex:0):y?m=y.map((g,b)=>b):m=[0],m.forEach((g,b)=>{_.set(g,b),x=Math.max(x,b)})}else{const g=(y||[]).length||1;for(let b=0;b<g;b++){let R=0;p==="right_to_left"?R=g-1-b:p==="center_to_out"?R=Math.floor(Math.abs(b-(g-1)/2)):p==="out_to_center"?R=Math.min(b,g-1-b):R=b,_.set(b,R),x=Math.max(x,R)}g===0&&_.set(0,0)}const w=x+1,S=l*w+1;h.length>S&&(h.length=S);const F=[];for(let m=0;m<w;m++){const g=m*l;let b=null;g===0?b=o:g<h.length&&(b=h[g]);const R=Math.pow(s,m);F.push({points:b,factor:R,index:m})}if(F.length===0)return o;const E=e+F.reduce((m,g)=>m+(g.points?g.points.length/8:o.length/8),0),B=new Float32Array(E*8);let P=0;const A=new Array(F.length);for(let m=0;m<F.length;m++){const g=F[m],b=g.points,R=b?b.length/8:o.length/8,L=g.factor;A[m]=P;for(let k=0;k<R;k++){const M=k*8,T=P+k*8;let Y=0,X=0,W=0,V=0,q=0,G=0,O=1,z=0;b?(Y=b[M],X=b[M+1],W=b[M+2],V=b[M+3],q=b[M+4],G=b[M+5],O=b[M+6],z=b[M+7]):O=1,B[T]=Y,B[T+1]=X,B[T+2]=W,B[T+3]=V*L,B[T+4]=q*L,B[T+5]=G*L,B[T+6]=O,B[T+7]=z}P+=R*8}const v=new Map;return _.forEach((m,g)=>{if(m<F.length){const b=A[m],R=F[m].points?F[m].points.length:o.length;v.set(g,{start:b,length:R})}}),B._channelDistributions=v,B}function le(o,e,d,n,a={}){e=Math.floor(e);const{decay:t,speed:r,overlap:l,direction:s,useCustomOrder:i,customOrder:p}=I(d,C.find(B=>B.id==="chase").defaultParams),{assignedDacs:c}=a||{};let f=new Map,h=0;if(i){let B=[];p&&Array.isArray(p)&&p.length>0?B=p.map(P=>P.originalIndex!==void 0?P.originalIndex:0):c?B=c.map((P,A)=>A):B=[0],B.forEach((P,A)=>{f.set(P,A),h++})}else{h=(c||[]).length||1;for(let P=0;P<h;P++){let A=P;s==="right_to_left"?A=h-1-P:s==="center_to_out"?A=Math.floor(Math.abs(P-(h-1)/2)):s==="out_to_center"&&(A=Math.min(P,h-1-P)),f.set(P,A)}}h===0&&(h=1);const u=h,y=n*.001*r%u,x=e*h,w=new Float32Array(x*8),S=new Map;let F=0;const E=Array.from(f.keys());E.length===0&&E.push(0);for(const B of E){const P=f.get(B)||0;let A=Math.abs(y-P);A>u/2&&(A=u-A);let v=0;A<l&&(v=1-A/l,v=Math.max(0,v),t>0&&(v=Math.pow(v,1-t)));const m=F;for(let g=0;g<e;g++){const b=g*8,R=F+g*8;w[R]=o[b],w[R+1]=o[b+1],w[R+2]=o[b+2]||0,w[R+3]=o[b+3]*v,w[R+4]=o[b+4]*v,w[R+5]=o[b+5]*v,w[R+6]=v<.05?1:o[b+6],w[R+7]=o[b+7]}S.set(B,{start:m,length:e}),F+=e*8}return w._channelDistributions=S,w}function ce(o,e){if(!e||!o||!o.points)return o;const{safetyZones:d,outputArea:n,transformationEnabled:a,transformationMode:t,flipX:r,flipY:l}=e;let s=o.points;const i=o.isTypedArray||s instanceof Float32Array,p=i?s.length/8:s.length;let c;i?c=new Float32Array(s):c=s.map(f=>({...f}));for(let f=0;f<p;f++){let h,u,y,_,x,w;if(i?(h=c[f*8],u=c[f*8+1],y=c[f*8+3],_=c[f*8+4],x=c[f*8+5],w=c[f*8+6]):(h=c[f].x,u=c[f].y,y=c[f].r,_=c[f].g,x=c[f].b,w=c[f].blanking?1:0),r&&(h=-h),l&&(u=-u),a&&n){let S=(h+1)/2,F=(1-u)/2;t==="crop"?(S<n.x||S>n.x+n.w||F<n.y||F>n.y+n.h)&&(y=0,_=0,x=0,w=1):t==="scale"&&(S=n.x+S*n.w,F=n.y+F*n.h,h=S*2-1,u=1-F*2)}if(d&&d.length>0){let S=(h+1)/2,F=(1-u)/2;for(const E of d)if(S>=E.x&&S<=E.x+E.w&&F>=E.y&&F<=E.y+E.h){y=0,_=0,x=0,w=1;break}}i?(c[f*8]=h,c[f*8+1]=u,c[f*8+3]=y,c[f*8+4]=_,c[f*8+5]=x,c[f*8+6]=w):(c[f].x=h,c[f].y=u,c[f].r=y,c[f].g=_,c[f].b=x,c[f].blanking=w>.5)}return{...o,points:c,isTypedArray:i}}class fe{constructor(e,d){if(this.canvas=e,this.type=d,this.gl=e.getContext("webgl")||e.getContext("experimental-webgl"),this.animationFrameId=null,this.frameIndexes=Array(10).fill(0),this.pointIndexes=Array(10).fill(0),this.showBeamEffect=!1,this.beamAlpha=.5,this.fadeAlpha=.13,this.beamRenderMode="both",this.positionBuffer=null,this.colorBuffer=null,this.alphaBuffer=null,this.lastPointDrawTime=0,!this.gl){console.error("WebGL not supported");return}this.setup()}setup(){const e=this.gl,d=`
      attribute vec2 aPosition;
      attribute vec3 aColor;
      attribute float aAlpha;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
        gl_PointSize = 2.0;
        vColor = aColor;
        vAlpha = aAlpha;
      }
    `,n=`
      precision mediump float;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_FragColor = vec4(vColor, vAlpha);
      }
    `,a=this.createShader(e.VERTEX_SHADER,d),t=this.createShader(e.FRAGMENT_SHADER,n),r=this.createProgram(a,t);this.program=r,this.positionAttributeLocation=e.getAttribLocation(r,"aPosition"),this.colorAttributeLocation=e.getAttribLocation(r,"aColor"),this.alphaAttributeLocation=e.getAttribLocation(r,"aAlpha"),this.quadPositionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.quadPositionBuffer);const l=[-1,-1,1,-1,-1,1,-1,1,1,-1,1,1];e.bufferData(e.ARRAY_BUFFER,new Float32Array(l),e.STATIC_DRAW),this.quadColorUniformLocation=e.getUniformLocation(r,"uColor"),this.quadAlphaUniformLocation=e.getUniformLocation(r,"uAlpha");const s=`
      attribute vec2 aPosition;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
      }
    `,i=`
      precision mediump float;
      uniform vec4 uColor;
      void main() {
        gl_FragColor = uColor;
      }
    `,p=this.createShader(e.VERTEX_SHADER,s),c=this.createShader(e.FRAGMENT_SHADER,i);this.fadeProgram=this.createProgram(p,c),this.fadePositionAttributeLocation=e.getAttribLocation(this.fadeProgram,"aPosition"),this.fadeColorUniformLocation=e.getUniformLocation(this.fadeProgram,"uColor"),e.useProgram(r);const f=131072;this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferData(e.ARRAY_BUFFER,f*2*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),this.colorBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),e.bufferData(e.ARRAY_BUFFER,f*3*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),this.alphaBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.alphaBuffer),e.bufferData(e.ARRAY_BUFFER,f*1*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.clearColor(0,0,0,1)}reset(){this.frameIndexes.fill(0),this.pointIndexes.fill(0),this.clearCanvas()}createShader(e,d){const n=this.gl,a=n.createShader(e);if(n.shaderSource(a,d),n.compileShader(a),n.getShaderParameter(a,n.COMPILE_STATUS))return a;console.error(n.getShaderInfoLog(a)),n.deleteShader(a)}createProgram(e,d){const n=this.gl,a=n.createProgram();if(n.attachShader(a,e),n.attachShader(a,d),n.linkProgram(a),n.getProgramParameter(a,n.LINK_STATUS))return a;console.error(n.getProgramInfoLog(a)),n.deleteProgram(a)}render(e){e.showBeamEffect!==void 0&&this.setBeamEffect(e.showBeamEffect),e.beamAlpha!==void 0&&this.setBeamAlpha(e.beamAlpha),e.fadeAlpha!==void 0&&this.setFadeAlpha(e.fadeAlpha),e.beamRenderMode!==void 0&&(this.beamRenderMode=e.beamRenderMode),this.type==="world"?this.renderWorld(e.worldData,e.previewScanRate,e.layerIntensities,e.masterIntensity,e.dacSettings,e.previewTime):this.renderSingle(e.ildaFrames,e.previewScanRate,e.intensity,e.effects,e.syncSettings,e.bpm,e.clipDuration,e.progress,e.previewTime)}renderSingle(e,d,n,a,t={},r=120,l=1,s=null,i=null){const p=this.gl;if(p.viewport(0,0,p.canvas.width,p.canvas.height),this.drawFadeQuad(),!e||e.length===0)return;const c=this.frameIndexes[0]%e.length,f=e[c],h=s!==null?s:c/e.length,u=i!==null?i:performance.now();this.draw(f,a,this.showBeamEffect,this.beamAlpha,d,this.beamRenderMode,n,0,h,u,t,r,l),this.frameIndexes[0]++,this.frameIndexes[0]>=e.length&&(this.frameIndexes[0]=0)}renderWorld(e,d,n,a,t,r=null){const l=this.gl;l.viewport(0,0,l.canvas.width,l.canvas.height),this.drawFadeQuad();const s=r!==null?r:performance.now();e.forEach(i=>{if(i&&i.frames&&i.frames.length>0){const p=i.frames[0];if(p){const c=i.layerIndex||0;if(i.syncSettings,i.bpm,c>=this.frameIndexes.length){const u=c+5;for(;this.frameIndexes.length<u;)this.frameIndexes.push(0),this.pointIndexes.push(0)}const h=(n[c]!==void 0?n[c]:1)*a;if(h>.001){const u=i.progress!==void 0?i.progress:this.frameIndexes[c]%i.frames.length/i.frames.length,{syncSettings:y={},bpm:_=120,clipDuration:x=1}=i;let w=p;if(t){let S=p;if(t.dimmer!==void 0&&t.dimmer<1){const F=p.points,E=p.isTypedArray||F instanceof Float32Array,B=E?F.length/8:F.length,P=E?new Float32Array(F):F.map(A=>({...A}));for(let A=0;A<B;A++)E?(P[A*8+3]*=t.dimmer,P[A*8+4]*=t.dimmer,P[A*8+5]*=t.dimmer):(P[A].r*=t.dimmer,P[A].g*=t.dimmer,P[A].b*=t.dimmer);S={...p,points:P,isTypedArray:E}}w=ce(S,t)}this.draw(w,i.effects,this.showBeamEffect,this.beamAlpha,d,this.beamRenderMode,h,c,u,s,y,_,x)}}}}),e.forEach(i=>{if(i&&i.frames){const p=i.layerIndex||0;this.frameIndexes[p]++,this.frameIndexes[p]>=i.frames.length&&(this.frameIndexes[p]=0)}})}drawFadeQuad(){const e=this.gl;this.fadeProgram&&(e.useProgram(this.fadeProgram),e.bindBuffer(e.ARRAY_BUFFER,this.quadPositionBuffer),e.enableVertexAttribArray(this.fadePositionAttributeLocation),e.vertexAttribPointer(this.fadePositionAttributeLocation,2,e.FLOAT,!1,0,0),e.uniform4f(this.fadeColorUniformLocation,0,0,0,this.fadeAlpha),e.drawArrays(e.TRIANGLES,0,6))}setBeamEffect(e){this.showBeamEffect=e}setBeamAlpha(e){this.beamAlpha=e}setFadeAlpha(e){this.fadeAlpha=e}draw(e,d,n,a,t,r,l=1,s=0,i=0,p=performance.now(),c={},f=120,h=1){if(this.gl,!e||!e.points)return;const u=Q(e,d,{progress:i,time:p,syncSettings:c,bpm:f,clipDuration:h}),y=u.points,_=u.isTypedArray,x=_?y.length/8:y.length;if(x===0)return;const w=Math.max(1,Math.floor(x/t));let S=this.pointIndexes[s]||0;S>=x&&(S=0);const F=A=>{const v=(S+A)%x;if(_){const m=v*8;return{x:y[m],y:y[m+1],r:y[m+3],g:y[m+4],b:y[m+5],blanking:y[m+6]===1}}else{const m=y[v];return{x:m.x,y:m.y,r:m.r,g:m.g,b:m.b,blanking:m.blanking}}},E=()=>{const A=r==="points"||r==="both",v=r==="lines"||r==="both";let m=[],g=[];for(let b=0;b<w;b++){const R=F(b);if(R.blanking){m.length>0&&(v&&this._drawSegment(new Float32Array(m),new Float32Array(g),1,m.length/2,!1),A&&this._drawSegment(new Float32Array(m),new Float32Array(g),1,m.length/2,!0),m=[],g=[]);continue}m.push(R.x,R.y),g.push(R.r/255*l,R.g/255*l,R.b/255*l)}m.length>0&&(v&&this._drawSegment(new Float32Array(m),new Float32Array(g),1,m.length/2,!1),A&&this._drawSegment(new Float32Array(m),new Float32Array(g),1,m.length/2,!0))},B=()=>{const A=[],v=[];for(let m=0;m<w;m++){const g=F(m);if(!g.blanking){A.push(0,0,g.x,g.y);const b=[g.r/255*l,g.g/255*l,g.b/255*l];v.push(...b,...b)}}A.length>0&&this._drawLines(new Float32Array(A),new Float32Array(v),a,A.length/2)},P=()=>{const A=[],v=[];let m=F(0);for(let g=1;g<w;g++){const b=F(g);if(!m.blanking&&!b.blanking){A.push(0,0,m.x,m.y,b.x,b.y);const R=[m.r/255*l,m.g/255*l,m.b/255*l],L=[b.r/255*l,b.g/255*l,b.b/255*l],k=[(R[0]+L[0])/2,(R[1]+L[1])/2,(R[2]+L[2])/2],M=.3,T=[R[0]*M,R[1]*M,R[2]*M],Y=[L[0]*M,L[1]*M,L[2]*M];v.push(...k,...T,...Y)}m=b}A.length>0&&this._drawTriangles(new Float32Array(A),new Float32Array(v),a,A.length/2)};E(),n&&(r==="points"?B():r==="lines"?P():r==="both"&&(P(),B())),this.pointIndexes[s]=(S+w)%x}_drawSegment(e,d,n,a,t=!1){const r=this.gl;r.useProgram(this.program),r.bindBuffer(r.ARRAY_BUFFER,this.positionBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,e),r.enableVertexAttribArray(this.positionAttributeLocation),r.vertexAttribPointer(this.positionAttributeLocation,2,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,this.colorBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,d),r.enableVertexAttribArray(this.colorAttributeLocation),r.vertexAttribPointer(this.colorAttributeLocation,3,r.FLOAT,!1,0,0);const l=new Float32Array(Array(a).fill(n));r.bindBuffer(r.ARRAY_BUFFER,this.alphaBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,l),r.enableVertexAttribArray(this.alphaAttributeLocation),r.vertexAttribPointer(this.alphaAttributeLocation,1,r.FLOAT,!1,0,0),r.drawArrays(t?r.POINTS:r.LINE_STRIP,0,a)}_drawLines(e,d,n,a){const t=this.gl;t.useProgram(this.program),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,e),t.enableVertexAttribArray(this.positionAttributeLocation),t.vertexAttribPointer(this.positionAttributeLocation,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,d),t.enableVertexAttribArray(this.colorAttributeLocation),t.vertexAttribPointer(this.colorAttributeLocation,3,t.FLOAT,!1,0,0);const r=new Float32Array(Array(a).fill(n));t.bindBuffer(t.ARRAY_BUFFER,this.alphaBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,r),t.enableVertexAttribArray(this.alphaAttributeLocation),t.vertexAttribPointer(this.alphaAttributeLocation,1,t.FLOAT,!1,0,0),t.drawArrays(t.LINES,0,a)}_drawTriangles(e,d,n,a){const t=this.gl;t.useProgram(this.program),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,e),t.enableVertexAttribArray(this.positionAttributeLocation),t.vertexAttribPointer(this.positionAttributeLocation,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,d),t.enableVertexAttribArray(this.colorAttributeLocation),t.vertexAttribPointer(this.colorAttributeLocation,3,t.FLOAT,!1,0,0);const r=new Float32Array(Array(a).fill(n));t.bindBuffer(t.ARRAY_BUFFER,this.alphaBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,r),t.enableVertexAttribArray(this.alphaAttributeLocation),t.vertexAttribPointer(this.alphaAttributeLocation,1,t.FLOAT,!1,0,0),t.drawArrays(t.TRIANGLES,0,a)}clearCanvas(){const e=this.gl;e.viewport(0,0,e.canvas.width,e.canvas.height),e.clear(e.COLOR_BUFFER_BIT)}destroy(){cancelAnimationFrame(this.animationFrameId)}}const D=new Map;function N(o,e=0){const d=D.get(o);if(!d)return;const n=performance.now();d.renderer.render(d.data),e=n,d.animationFrameId=requestAnimationFrame(()=>N(o,e))}self.onmessage=o=>{const{action:e,payload:d}=o.data;if(e==="register"){const{id:n,canvas:a,type:t,data:r}=d,l=new fe(a,t),s=requestAnimationFrame(()=>N(n));D.set(n,{renderer:l,type:t,data:r,animationFrameId:s})}else if(e==="deregister"){const{id:n}=d,a=D.get(n);a&&(cancelAnimationFrame(a.animationFrameId),D.delete(n))}else if(e==="update"){const{id:n,data:a}=d,t=D.get(n);t&&(t.data=a)}else if(e==="clear"){const{id:n}=d,a=D.get(n);a&&a.renderer.clearCanvas()}}})();
