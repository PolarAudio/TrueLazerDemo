(function(){"use strict";const S=[{r:255,g:0,b:0},{r:255,g:17,b:0},{r:255,g:34,b:0},{r:255,g:51,b:0},{r:255,g:68,b:0},{r:255,g:85,b:0},{r:255,g:102,b:0},{r:255,g:119,b:0},{r:255,g:136,b:0},{r:255,g:153,b:0},{r:255,g:170,b:0},{r:255,g:187,b:0},{r:255,g:204,b:0},{r:255,g:221,b:0},{r:255,g:238,b:0},{r:255,g:255,b:0},{r:255,g:255,b:0},{r:238,g:255,b:0},{r:204,g:255,b:0},{r:170,g:255,b:0},{r:136,g:255,b:0},{r:102,g:255,b:0},{r:68,g:255,b:0},{r:34,g:255,b:0},{r:0,g:255,b:0},{r:0,g:255,b:34},{r:0,g:255,b:68},{r:0,g:255,b:102},{r:0,g:255,b:136},{r:0,g:255,b:170},{r:0,g:255,b:204},{r:0,g:255,b:238},{r:0,g:136,b:255},{r:0,g:119,b:255},{r:0,g:102,b:255},{r:0,g:102,b:255},{r:0,g:85,b:255},{r:0,g:68,b:255},{r:0,g:68,b:255},{r:0,g:34,b:255},{r:0,g:0,b:255},{r:34,g:0,b:255},{r:68,g:0,b:255},{r:102,g:0,b:255},{r:136,g:0,b:255},{r:170,g:0,b:255},{r:204,g:0,b:255},{r:238,g:0,b:255},{r:255,g:0,b:255},{r:255,g:34,b:255},{r:255,g:68,b:255},{r:255,g:102,b:255},{r:255,g:136,b:255},{r:255,g:170,b:255},{r:255,g:204,b:255},{r:255,g:238,b:255},{r:255,g:255,b:255},{r:255,g:238,b:238},{r:255,g:204,b:204},{r:255,g:170,b:170},{r:255,g:136,b:136},{r:255,g:102,b:102},{r:255,g:68,b:68},{r:0,g:34,b:34}],U=new Map;function P(l,i,a,I,f=S){const g=[],t=new DataView(l);let o=0;try{for(let r=0;r<I;r++){if(i===2){o+=a;continue}let h,c,F=0,e,s,u,b;i===0||i===4?(h=t.getInt16(o,!1)/32768,c=t.getInt16(o+2,!1)/32768,F=t.getInt16(o+4,!1)/32768,b=t.getUint8(o+6)):(h=t.getInt16(o,!1)/32768,c=t.getInt16(o+2,!1)/32768,b=t.getUint8(o+4));const m=(b&64)!==0,n=(b&128)!==0;if(i===0||i===1){const d=t.getUint8(o+(i===0?7:5)),p=f||S,M=p[d%p.length]||S[0];e=M.r,s=M.g,u=M.b}else(i===4||i===5)&&(u=t.getUint8(o+(i===4?7:5)),s=t.getUint8(o+(i===4?8:6)),e=t.getUint8(o+(i===4?9:7)));if(g.push({x:h,y:c,z:F,r:e===void 0?255:e,g:s===void 0?255:s,b:u===void 0?255:u,blanking:m,lastPoint:n}),o+=a,n)break}}catch(r){console.warn("Parser: Error reading points:",r)}return g}function v(l,i=!1){console.log(`[ilda-parser.worker.js] parseIldaFile - Starting parsing. stopAtFirstFrame=${i}`);const a=new DataView(l);if(l.byteLength<32)return{frames:[],error:"File too small to be a valid ILDA file"};const I=String.fromCharCode(a.getUint8(0),a.getUint8(1),a.getUint8(2),a.getUint8(3));if(I!=="ILDA")return console.warn(`[ilda-parser.worker.js] Parser: Invalid ILDA header signature: ${I}`),{frames:[],error:"Invalid ILDA file header"};const f=[];let g=null,t=0,o=null;for(;t+32<=l.byteLength;){const r=t,h=String.fromCharCode(a.getUint8(r),a.getUint8(r+1),a.getUint8(r+2),a.getUint8(r+3));if(h!=="ILDA"){console.warn(`[ilda-parser.worker.js] Parser: Invalid ILDA signature at offset ${r}, got: ${h}. Skipping 32 bytes.`),t+=32;continue}const c=a.getUint8(r+7);if(g===null&&(g=c),c>5){console.warn(`[ilda-parser.worker.js] Parser: Unknown format code: ${c} at offset ${r}. Skipping 32 bytes.`),t+=32;continue}const F=String.fromCharCode(...new Uint8Array(l,r+8,8)).trim(),e=String.fromCharCode(...new Uint8Array(l,r+16,8)).trim();let s=a.getUint16(r+24,!1);const u=a.getUint16(r+26,!1),b=a.getUint16(r+28,!1),m=a.getUint8(r+30);let n;switch(c){case 0:n=8;break;case 1:n=6;break;case 2:n=3;break;case 4:n=10;break;case 5:n=8;break;default:console.warn(`Parser: Unsupported format ${c}, skipping 32 bytes.`),t+=32;continue}if(c===2){o=[];const y=t+32;for(let w=0;w<s;w++){const x=a.getUint8(y+w*3),D=a.getUint8(y+w*3+1),k=a.getUint8(y+w*3+2);o.push({r:x,g:D,b:k})}}let d=s*n,p=32+d;const M=l.byteLength-t;if(p<M){const y=M-p;y>0&&y<=32&&(console.warn(`Parser: Malformed frame, ${y} leftover bytes. Adjusting size.`),p+=y,d+=y,s=Math.floor(d/n))}if(r+p>l.byteLength){console.warn(`Parser: Incomplete frame data for ${s} points at offset ${r}. Expected ${p} bytes, but only ${l.byteLength-r} bytes remaining. Breaking.`);break}if(s===0){console.log("[ilda-parser.worker.js] Parser: Empty frame, skipping"),t+=p;continue}if(f.push({frameName:F,companyName:e,frameNumber:u,totalFrames:b,scannerHead:m,formatCode:c,recordSize:n,pointCount:s,pointDataOffset:r+32,pointDataSize:d,frameEndOffset:r+p,palette:o,bounds:{minX:0,maxX:0,minY:0,maxY:0}}),t+=p,i&&f.length>0){console.log("[ilda-parser.worker.js] parseIldaFile - stopAtFirstFrame requested, breaking early.");break}}return console.log(`[ilda-parser.worker.js] parseIldaFile - Finished parsing. Found ${f.length} frames.`),{frames:f,error:f.length===0?"No valid frames found":null,firstFormatCode:g,ildaFileBuffer:l}}async function A(l,i=128,a=128){if(!l||l.length===0)return null;const I=new OffscreenCanvas(i,a),f=I.getContext("2d");f.fillStyle="#000000",f.fillRect(0,0,i,a),f.lineWidth=1.5,f.lineCap="round";let g=null,t=null;for(let o=0;o<l.length;o++){const r=l[o],h=(r.x+1)*.5*i,c=(1-(r.y+1)*.5)*a;!r.blanking&&g!==null&&(f.beginPath(),f.moveTo(g,t),f.lineTo(h,c),f.strokeStyle=`rgb(${r.r},${r.g},${r.b})`,f.stroke()),g=h,t=c}return I.transferToImageBitmap()}const $=new Map;self.onmessage=async function(l){const{arrayBuffer:i,type:a,fileName:I,filePath:f,layerIndex:g,colIndex:t,workerId:o,frameIndex:r,isStillFrame:h,requestId:c,stopAtFirstFrame:F}=l.data;if(a==="parse-ilda"){if(!i){self.postMessage({success:!1,error:"ArrayBuffer missing for parse-ilda command",type:"parse-ilda"});return}try{console.log("[ilda-parser.worker.js] Calling parseIldaFile for:",I);const e=v(i,F);if(e.error){self.postMessage({success:!1,error:e.error,type:"parse-ilda",fileName:I,filePath:f,layerIndex:g,colIndex:t}),self.postMessage({type:"parsing-status",status:!1,layerIndex:g,colIndex:t});return}const s=`ilda-${Date.now()}-${Math.random().toString(36).substring(2,9)}`;U.set(s,{ildaFileBuffer:e.ildaFileBuffer,framesMetadata:e.frames}),console.log("[ilda-parser.worker.js] Posting success message for parse-ilda."),self.postMessage({success:!0,workerId:s,totalFrames:e.frames.length,ildaFormat:e.firstFormatCode,fileName:I,filePath:f,layerIndex:g,colIndex:t,type:"parse-ilda"}),self.postMessage({type:"parsing-status",status:!1,layerIndex:g,colIndex:t})}catch(e){console.error("[ilda-parser.worker.js] Error parsing file in onmessage handler:",e),self.postMessage({success:!1,error:e.message,type:"parse-ilda"}),self.postMessage({type:"parsing-status",status:!1,layerIndex:g,colIndex:t})}}else if(a==="load-and-parse-ilda"){const e=Math.random().toString(36).substring(2,15);$.set(e,{fileName:I,filePath:f,layerIndex:g,colIndex:t,browserFile:l.data.browserFile,stopAtFirstFrame:F}),g!==void 0&&t!==void 0&&self.postMessage({type:"parsing-status",status:!0,layerIndex:g,colIndex:t});const s=F?65536:null;self.postMessage({type:"request-file-content",filePath:f,requestId:e,maxBytes:s})}else if(a==="file-content-response"){const e=$.get(c);if(!e){console.error(`Worker: No context found for requestId: ${c}`);return}if($.delete(c),l.data.error){console.error(`Worker: Error receiving file content: ${l.data.error}`),self.postMessage({success:!1,error:l.data.error,type:"parse-ilda",...e}),e.layerIndex!==void 0&&e.colIndex!==void 0&&self.postMessage({type:"parsing-status",status:!1,layerIndex:e.layerIndex,colIndex:e.colIndex});return}try{console.log(`[ilda-parser.worker.js] Calling parseIldaFile for: ${e.fileName} (from file-content-response)`);const s=v(i,e.stopAtFirstFrame);if(s.error){self.postMessage({success:!1,error:s.error,type:"parse-ilda",...e}),e.layerIndex!==void 0&&e.colIndex!==void 0&&self.postMessage({type:"parsing-status",status:!1,layerIndex:e.layerIndex,colIndex:e.colIndex});return}const u=`ilda-${Date.now()}-${Math.random().toString(36).substring(2,9)}`;U.set(u,{ildaFileBuffer:s.ildaFileBuffer,framesMetadata:s.frames}),self.postMessage({success:!0,workerId:u,totalFrames:s.frames.length,ildaFormat:s.firstFormatCode,type:"parse-ilda",...e}),e.layerIndex!==void 0&&e.colIndex!==void 0&&self.postMessage({type:"parsing-status",status:!1,layerIndex:e.layerIndex,colIndex:e.colIndex})}catch(s){console.error("[ilda-parser.worker.js] Error parsing file from content response:",s),self.postMessage({success:!1,error:s.message,type:"parse-ilda",...e}),e.layerIndex!==void 0&&e.colIndex!==void 0&&self.postMessage({type:"parsing-status",status:!1,layerIndex:e.layerIndex,colIndex:e.colIndex})}}else if(a==="get-frame"){const{workerId:e,frameIndex:s,isStillFrame:u,layerIndex:b,colIndex:m,browserFile:n,filePath:d}=l.data,p=U.get(e);if(!p){self.postMessage({success:!1,error:"ILDA data not found",type:"get-frame",workerId:e,browserFile:n,filePath:d,layerIndex:b,colIndex:m});return}const{ildaFileBuffer:M,framesMetadata:y}=p,w=Math.floor(s);if(!Number.isFinite(w)||w>=y.length||w<0){self.postMessage({success:!1,error:`Frame index ${s} out of bounds or invalid`,type:"get-frame",workerId:e,browserFile:n,filePath:d,layerIndex:b,colIndex:m});return}const x=y[w];if(!x){self.postMessage({success:!1,error:`Frame metadata not found for index ${w}`,type:"get-frame",workerId:e,browserFile:n,filePath:d,layerIndex:b,colIndex:m});return}let D=x.cachedPoints;if(!D){const k=M.slice(x.pointDataOffset,x.pointDataOffset+x.pointDataSize);D=P(k,x.formatCode,x.recordSize,x.pointCount,x.palette),x.cachedPoints=D}if(n){const k=await A(D);self.postMessage({success:!0,bitmap:k,type:"get-frame",workerId:e,frameIndex:s,isStillFrame:u,layerIndex:b,colIndex:m,browserFile:n,filePath:d},[k])}else{const k={points:D};self.postMessage({success:!0,frame:k,type:"get-frame",workerId:e,frameIndex:s,isStillFrame:u,layerIndex:b,colIndex:m,browserFile:n,filePath:d})}}else if(a==="get-all-frames"){const e=U.get(o);if(!e){self.postMessage({success:!1,error:"ILDA data not found",type:"get-all-frames",workerId:o});return}const{ildaFileBuffer:s,framesMetadata:u}=e,b=[];try{for(let m=0;m<u.length;m++){const n=u[m];let d=n.cachedPoints;if(!d){const p=s.slice(n.pointDataOffset,n.pointDataOffset+n.pointDataSize);d=P(p,n.formatCode,n.recordSize,n.pointCount,n.palette),n.cachedPoints=d}b.push({...n,points:d})}self.postMessage({success:!0,frames:b,type:"get-all-frames",workerId:o,layerIndex:g,colIndex:t})}catch(m){self.postMessage({success:!1,error:m.message,type:"get-all-frames",workerId:o})}}}})();
