(function(){"use strict";const N=[{id:"rotate",name:"Rotate",type:"transform",description:"Rotates the shape around its center.",defaultParams:{angle:0,speed:0,direction:"CW"},paramControls:[{id:"angle",label:"Angle",type:"range",min:0,max:360,step:1},{id:"speed",label:"Speed",type:"range",min:0,max:10,step:.1},{id:"direction",label:"Direction",type:"select",options:["CW","CCW"]}]},{id:"scale",name:"Scale",type:"transform",description:"Scales the shape.",defaultParams:{scaleX:1,scaleY:1},paramControls:[{id:"scaleX",label:"Scale X",type:"range",min:.01,max:5,step:.01},{id:"scaleY",label:"Scale Y",type:"range",min:.01,max:5,step:.01}]},{id:"translate",name:"Translate",type:"transform",description:"Moves the shape.",defaultParams:{translateX:0,translateY:0},paramControls:[{id:"translateX",label:"Translate X",type:"range",min:-1,max:1,step:.01},{id:"translateY",label:"Translate Y",type:"range",min:-1,max:1,step:.01}]},{id:"color",name:"Color",type:"color",description:"Changes the color of the shape with solid or rainbow modes.",defaultParams:{mode:"solid",r:255,g:255,b:255,cycleSpeed:0,rainbowSpread:1,rainbowOffset:0,rainbowPalette:"rainbow"},paramControls:[{id:"mode",label:"Mode",type:"select",options:["solid","rainbow"]},{id:"r",label:"Red",type:"range",min:0,max:255,step:1,showIf:{mode:"solid"}},{id:"g",label:"Green",type:"range",min:0,max:255,step:1,showIf:{mode:"solid"}},{id:"b",label:"Blue",type:"range",min:0,max:255,step:1,showIf:{mode:"solid"}},{id:"cycleSpeed",label:"Cycle Speed",type:"range",min:0,max:10,step:.1},{id:"rainbowSpread",label:"Rainbow Spread",type:"range",min:.1,max:10,step:.1,showIf:{mode:"rainbow"}},{id:"rainbowOffset",label:"Rainbow Offset",type:"range",min:0,max:360,step:1,showIf:{mode:"rainbow"}},{id:"rainbowPalette",label:"Palette",type:"select",options:["rainbow","fire","ice","cyber"],showIf:{mode:"rainbow"}}]},{id:"wave",name:"Wave",type:"animation",description:"Applies a wave distortion to the shape.",defaultParams:{amplitude:.1,frequency:10,speed:1,direction:"x"},paramControls:[{id:"amplitude",label:"Amplitude",type:"range",min:.01,max:1,step:.01},{id:"frequency",label:"Frequency",type:"range",min:1,max:50,step:1},{id:"speed",label:"Speed",type:"range",min:.1,max:10,step:.1},{id:"direction",label:"Direction",type:"select",options:["x","y"]}]},{id:"warp",name:"Warp",type:"animation",description:"Symmetrical chaotic wave distortion.",defaultParams:{amount:.1,chaos:.5,speed:1},paramControls:[{id:"amount",label:"Amount",type:"range",min:0,max:1,step:.01},{id:"chaos",label:"Chaos",type:"range",min:0,max:1,step:.01},{id:"speed",label:"Speed",type:"range",min:.1,max:10,step:.1}]},{id:"distortion",name:"Distortion",type:"transform",description:"Distorts the point data.",defaultParams:{amount:.1,scale:10,speed:.5},paramControls:[{id:"amount",label:"Amount",type:"range",min:0,max:1,step:.01},{id:"scale",label:"Scale",type:"range",min:1,max:50,step:1},{id:"speed",label:"Speed",type:"range",min:0,max:5,step:.1}]},{id:"move",name:"Move (Bounce)",type:"transform",description:"Moves points and bounces them off the borders.",defaultParams:{speedX:.1,speedY:.1},paramControls:[{id:"speedX",label:"Speed X",type:"range",min:0,max:2,step:.01},{id:"speedY",label:"Speed Y",type:"range",min:0,max:2,step:.01}]},{id:"delay",name:"Delay",type:"effect",description:"Frame or Channel based delay effect.",defaultParams:{mode:"frame",playstyle:"repeat",useCustomOrder:!1,delayDirection:"left_to_right",delayAmount:5,decay:.8,customOrder:[],enabled:!0},paramControls:[{id:"mode",label:"Mode",type:"select",options:["frame","channel"]},{id:"playstyle",label:"Playstyle",type:"select",options:["once","repeat"]},{id:"useCustomOrder",label:"Custom Order",type:"checkbox",showIf:{mode:"channel"}},{id:"delayDirection",label:"Direction",type:"select",options:["center_to_out","out_to_center","left_to_right","right_to_left"],showIf:{useCustomOrder:!1}},{id:"delayAmount",label:"Delay Time",type:"range",min:1,max:60,step:1},{id:"decay",label:"Decay",type:"range",min:0,max:1,step:.01}]},{id:"chase",name:"Chase",type:"effect",description:"Frame or Channel based chase effect.",defaultParams:{mode:"frame",playstyle:"repeat",steps:4,decay:.8,speed:1,overlap:1,direction:"left_to_right",useCustomOrder:!1,customOrder:[],enabled:!0},paramControls:[{id:"mode",label:"Mode",type:"select",options:["frame","channel"]},{id:"playstyle",label:"Playstyle",type:"select",options:["once","repeat","bounce"]},{id:"steps",label:"Steps",type:"range",min:2,max:16,step:1,showIf:{mode:"frame"}},{id:"decay",label:"Decay",type:"range",min:0,max:1,step:.01},{id:"speed",label:"Speed",type:"range",min:.1,max:5,step:.1},{id:"overlap",label:"Overlap",type:"range",min:1,max:4,step:1},{id:"useCustomOrder",label:"Custom Order",type:"checkbox",showIf:{mode:"channel"}},{id:"direction",label:"Direction",type:"select",options:["center_to_out","out_to_center","left_to_right","right_to_left"],showIf:{useCustomOrder:!1}}]},{id:"blanking",name:"Blanking",type:"animation",description:"Controls the blanking of the laser output.",defaultParams:{blankingInterval:0,spacing:0},paramControls:[{id:"blankingInterval",label:"Blanking Interval",type:"range",min:0,max:10,step:1},{id:"spacing",label:"Spacing",type:"range",min:0,max:20,step:1}]},{id:"strobe",name:"Strobe",type:"animation",description:"Applies a strobe effect to the laser output.",defaultParams:{strobeSpeed:100,strobeAmount:.5},paramControls:[{id:"strobeSpeed",label:"Strobe Speed (ms)",type:"range",min:10,max:1e3,step:10},{id:"strobeAmount",label:"Strobe Amount (0-1)",type:"range",min:0,max:1,step:.01}]},{id:"mirror",name:"Mirror",type:"transform",description:"Mirrors the shape from the center.",defaultParams:{mode:"none"},paramControls:[{id:"mode",label:"Mirror Mode",type:"select",options:["none","x+","x-","y+","y-"]}]}].reduce((n,e)=>(n[e.id]=e,n),{});function X(n,e,d,o){if(!d)return e;const t=typeof d=="string"?{syncMode:d}:d;if(!t.syncMode)return e;const{time:a,progress:r=0,bpm:i=120,clipDuration:g=0,fftLevels:u={low:0,mid:0,high:0},activationTime:h=0}=o;let l=0;const c=t.speedMultiplier||1,s=t.style||"loop";if(s==="once"&&h>0){const w=(a-h)*.001;let A=1;if(t.syncMode==="timeline")A=Math.max(.01,t.duration||1);else if(t.syncMode==="bpm"){const x=Math.max(.1,t.beats||4),B=i/60;A=x/(B||2)}else if(t.syncMode==="fps")return l=w*c,calculateAnimPhase(l,t,e);l=w/A*c}else if(t.syncMode==="fps")l=a*.001*c;else if(t.syncMode==="timeline"){const w=Math.max(.01,t.duration||1);g>0?l=r*g/w*c:l=0}else if(t.syncMode==="bpm"){const w=Math.max(.1,t.beats||4),A=i/60,x=w/(A||2);g>0?l=r*g/x*c:l=0}else if(t.syncMode==="fft"){const w=t.fftRange||"low",A=u[w]||0;return W(A,e,t)}s==="bounce"&&(l*=2);const b=t.direction||"forward";if(b==="pause")return e;let m=0;if(s==="once")m=Math.min(l,1),b==="backward"&&(m=1-m);else if(s==="bounce"){let w=l%1;Math.floor(l)%2===1?m=1-w:m=w,b==="backward"&&(m=1-m)}else m=l%1,b==="backward"&&(m=1-m);const y=t.range;let p=0,R=1;if(y&&Array.isArray(y)&&y.length===2)p=y[0],R=y[1];else return e;return p+(R-p)*m}function W(n,e,d){const o=d.range;return o&&Array.isArray(o)&&o.length===2?o[0]+(o[1]-o[0])*n:e}let Y=new Float32Array(1024*8);function k(n){Y.length<n*8&&(Y=new Float32Array(n*8*2))}function q(n,e,d={}){const{progress:o=0,time:t=performance.now(),effectStates:a,syncSettings:r={},fftLevels:i}=d;if(!e||e.length===0)return n;const g=n.points,u=n.isTypedArray||g instanceof Float32Array,h=u?g.length/8:g.length;k(h);const l=Y.subarray(0,h*8);if(u)l.set(g);else for(let b=0;b<h;b++){const m=g[b],y=b*8;l[y]=m.x,l[y+1]=m.y,l[y+2]=m.z||0,l[y+3]=m.r,l[y+4]=m.g,l[y+5]=m.b,l[y+6]=m.blanking?1:0,l[y+7]=m.lastPoint?1:0}const c=()=>l.length/8;let s=l;for(const b of e){const m=b.params;if(m.enabled===!1||!N[b.id])continue;let p=m;const R=b.instanceId?`${b.instanceId}.`:`${b.id}.`;let w=!1;for(const A in m)if(r[R+A]){w=!0;break}if(w){p={...m};for(const A in p){const x=R+A;r[x]&&(p[A]=X(A,p[A],r[x],d))}}switch(b.id){case"rotate":V(s,c(),p,o,t);break;case"scale":G(s,c(),p);break;case"translate":H(s,c(),p);break;case"color":z(s,c(),p,t);break;case"wave":K(s,c(),p,t);break;case"blanking":$(s,c(),p);break;case"strobe":Z(s,c(),p,t);break;case"mirror":s=j(s,c(),p);break;case"warp":J(s,c(),p,t);break;case"distortion":ee(s,c(),p,t);break;case"move":te(s,c(),p,t);break;case"delay":a&&b.instanceId&&(s=ae(s,c(),p,a,b.instanceId,d));break;case"chase":s=re(s,c(),p,t,d);break}}return{...n,points:new Float32Array(s),isTypedArray:!0}}function V(n,e,d,o,t){const{angle:a,speed:r,direction:i}=d,g=i==="CCW"?-1:1,u=t*.001*r*g,h=a*Math.PI/180+u,l=Math.sin(h),c=Math.cos(h);for(let s=0;s<e;s++){const b=s*8,m=n[b],y=n[b+1];n[b]=m*c-y*l,n[b+1]=m*l+y*c}}function G(n,e,d){const{scaleX:o,scaleY:t}=d;for(let a=0;a<e;a++){const r=a*8;n[r]*=o,n[r+1]*=t}}function H(n,e,d){const{translateX:o,translateY:t}=d;for(let a=0;a<e;a++){const r=a*8;n[r]+=o,n[r+1]+=t}}function z(n,e,d,o){const{mode:t,r:a,g:r,b:i,cycleSpeed:g,rainbowSpread:u,rainbowOffset:h,rainbowPalette:l}=d,c=o*.001*g;if(t==="rainbow"){const s=l||"rainbow";for(let b=0;b<e;b++){const m=b*8,y=(b/e*u+c*.5+h/360)%1;let p,R,w;s==="rainbow"?[p,R,w]=O(y,1,.5):[p,R,w]=Q(s,y),n[m+3]=p,n[m+4]=R,n[m+5]=w}}else if(g>0){const s=c*50%360,[b,m,y]=O(s/360,1,.5);for(let p=0;p<e;p++){const R=p*8;n[R+3]=b,n[R+4]=m,n[R+5]=y}}else for(let s=0;s<e;s++){const b=s*8;n[b+3]=a,n[b+4]=r,n[b+5]=i}}function Q(n,e){const d={fire:[{r:255,g:0,b:0},{r:255,g:128,b:0},{r:255,g:255,b:0},{r:255,g:0,b:0}],ice:[{r:0,g:0,b:255},{r:0,g:255,b:255},{r:255,g:255,b:255},{r:0,g:0,b:255}],cyber:[{r:255,g:0,b:255},{r:0,g:255,b:255},{r:0,g:0,b:255},{r:255,g:0,b:255}]},o=d[n]||d.fire,t=e*(o.length-1),a=Math.floor(t),r=t-a,i=o[a],g=o[a+1]||o[a];return[Math.round(i.r+(g.r-i.r)*r),Math.round(i.g+(g.g-i.g)*r),Math.round(i.b+(g.b-i.b)*r)]}function O(n,e,d){let o,t,a;{const r=(u,h,l)=>(l<0&&(l+=1),l>1&&(l-=1),l<.16666666666666666?u+(h-u)*6*l:l<.5?h:l<.6666666666666666?u+(h-u)*(.6666666666666666-l)*6:u),i=d+e-d*e,g=2*d-i;o=r(g,i,n+1/3),t=r(g,i,n),a=r(g,i,n-1/3)}return[Math.round(o*255),Math.round(t*255),Math.round(a*255)]}function K(n,e,d,o){const{amplitude:t,frequency:a,speed:r,direction:i}=d,g=o*.001*r;for(let u=0;u<e;u++){const h=u*8;i==="x"?n[h+1]+=t*Math.sin(n[h]*a+g):i==="y"&&(n[h]+=t*Math.sin(n[h+1]*a+g))}}function $(n,e,d){const{blankingInterval:o,spacing:t=0}=d;if(o<=0)return;const a=o+1+t;for(let r=0;r<e;r++)r%a>=o&&(n[r*8+6]=1)}function Z(n,e,d,o){const{strobeSpeed:t,strobeAmount:a}=d;if(o%t/t<a)for(let i=0;i<e;i++)n[i*8+6]=1}function j(n,e,d){const{mode:o}=d;if(o==="none")return n;let t=0;k(e*2);const a=[];for(let i=0;i<e;i++){const g=i*8,u=n[g],h=n[g+1];let l=!1;o==="x-"?u<=0&&(l=!0):o==="x+"?u>=0&&(l=!0):o==="y-"?h<=0&&(l=!0):o==="y+"&&h>=0&&(l=!0),l&&(a.push(g),t++)}const r=new Float32Array(t*2*8);for(let i=0;i<t;i++){const g=a[i],u=i*8;r.set(n.subarray(g,g+8),u);const h=(t+i)*8;r.set(n.subarray(g,g+8),h),(o==="x-"||o==="x+")&&(r[h]=-r[h]),(o==="y-"||o==="y+")&&(r[h+1]=-r[h+1])}return r}function J(n,e,d,o){const{amount:t,chaos:a,speed:r}=d,i=o*.001*r;for(let g=0;g<e;g++){const u=g*8,h=n[u],l=n[u+1],c=Math.abs(l);n[u]+=Math.sin(c*10*(1+a)+i)*t*Math.cos(i*a),n[u+1]+=Math.cos(Math.abs(h)*10*(1+a)+i)*t*Math.sin(i*a)}}function ee(n,e,d,o){const{amount:t,scale:a,speed:r}=d,i=o*.001*r;for(let g=0;g<e;g++){const u=g*8,h=Math.sin(n[u]*a+i)*Math.cos(n[u+1]*a-i),l=Math.cos(n[u]*a-i)*Math.sin(n[u+1]*a+i);n[u]+=h*t,n[u+1]+=l*t}}function te(n,e,d,o){const{speedX:t,speedY:a}=d,r=o*.001,i=r*t,g=r*a,u=4;for(let h=0;h<e;h++){const l=h*8;let c=n[l]+i,s=n[l+1]+g,b=(c+1)%u;b<0&&(b+=u),b>2&&(b=4-b),c=b-1;let m=(s+1)%u;m<0&&(m+=u),m>2&&(m=4-m),s=m-1,n[l]=c,n[l+1]=s}}function ae(n,e,d,o,t,a){const{mode:r="frame",delayAmount:i,decay:g,delayDirection:u,useCustomOrder:h,customOrder:l,playstyle:c="repeat"}=d;o.has(t)||o.set(t,[]);const s=o.get(t);if(s.unshift(new Float32Array(n)),r==="frame"){const m=i*10+1;s.length>m&&(s.length=m);const y=new Float32Array(n.length);for(let p=0;p<e;p++){let R=0;const w=p/e;u==="left_to_right"?R=Math.floor(w*9):u==="right_to_left"?R=Math.floor((1-w)*9):u==="center_to_out"?R=Math.floor(Math.abs(w-.5)*2*9):u==="out_to_center"&&(R=Math.floor((1-Math.abs(w-.5)*2)*9));const A=R*i,x=A<s.length?s[A]:null,B=Math.pow(g,R),M=p*8;x&&x.length===n.length?(y[M]=x[M],y[M+1]=x[M+1],y[M+2]=x[M+2],y[M+3]=x[M+3]*B,y[M+4]=x[M+4]*B,y[M+5]=x[M+5]*B,y[M+6]=x[M+6],y[M+7]=x[M+7]):(y.set(n.subarray(M,M+8),M),y[M+3]=0,y[M+4]=0,y[M+5]=0,y[M+6]=1)}return y}else{const{assignedDacs:b}=a||{};let m=new Map,y=0;if(h||d.delayMode==="channel")(l&&l.length>0?l.map(F=>F.originalIndex):b?b.map((F,f)=>f):[0]).forEach((F,f)=>{m.set(F,f),y=Math.max(y,f)});else{const F=(b||[]).length||1;for(let f=0;f<F;f++){let S=f;u==="right_to_left"?S=F-1-f:u==="center_to_out"?S=Math.floor(Math.abs(f-(F-1)/2)):u==="out_to_center"&&(S=Math.min(f,F-1-f)),m.set(f,S),y=Math.max(y,S)}}const R=y+1,w=i*R+1;s.length>w&&(s.length=w);const A=[];for(let _=0;_<R;_++){const F=_*i;A.push({points:F<s.length?s[F]:null,factor:Math.pow(g,_),index:_})}const x=A.reduce((_,F)=>_+(F.points?F.points.length/8:n.length/8),0),B=new Float32Array(x*8);let M=0;const I=new Array(A.length);for(let _=0;_<A.length;_++){const F=A[_],f=F.points,S=f?f.length/8:n.length/8;I[_]=M;for(let v=0;v<S;v++){const E=v*8,C=M+v*8;f?(B[C]=f[E],B[C+1]=f[E+1],B[C+2]=f[E+2],B[C+3]=f[E+3]*F.factor,B[C+4]=f[E+4]*F.factor,B[C+5]=f[E+5]*F.factor,B[C+6]=f[E+6],B[C+7]=f[E+7]):B[C+6]=1}M+=S*8}const P=new Map;return m.forEach((_,F)=>{_<A.length&&P.set(F,{start:I[_],length:A[_].points?A[_].points.length:n.length})}),B._channelDistributions=P,B}}function re(n,e,d,o,t={}){const{mode:a="frame",steps:r,decay:i,speed:g,overlap:u,direction:h,useCustomOrder:l,customOrder:c,playstyle:s="loop"}=d,{progress:b=0,clipDuration:m=1}=t,y=b!==void 0&&m>0;if(a==="frame"){const p=r;let R=(y?b*p:o*.001)*g;if(s==="bounce"){const A=p,x=R%(A*2);R=x>A?A*2-x:x}else s==="once"?R=Math.min(R,p):R=R%p;const w=new Float32Array(n.length);for(let A=0;A<e;A++){const x=A/e;let B=0;h==="left_to_right"?B=Math.min(p-1,Math.floor(x*p)):h==="right_to_left"?B=Math.min(p-1,Math.floor((1-x)*p)):h==="center_to_out"?B=Math.min(p-1,Math.floor(Math.abs(x-.5)*2*p)):h==="out_to_center"&&(B=Math.min(p-1,Math.floor((1-Math.abs(x-.5)*2)*p)));let M=Math.abs(R-B);M>p/2&&(M=p-M);let I=M<u?1-M/u:0;i>0&&(I=Math.pow(I,1-i));const P=A*8;w.set(n.subarray(P,P+8),P),w[P+3]*=I,w[P+4]*=I,w[P+5]*=I,I<.05&&(w[P+6]=1)}return w}else{const{assignedDacs:p}=t||{};let R=new Map,w=0;if(l)(c&&c.length>0?c.map(f=>f.originalIndex):p?p.map((f,S)=>S):[0]).forEach((f,S)=>{R.set(f,S),w++});else{w=(p?p.length:1)||1;for(let F=0;F<w;F++){let f=F;h==="right_to_left"?f=w-1-F:h==="center_to_out"?f=Math.floor(Math.abs(F-(w-1)/2)):h==="out_to_center"&&(f=Math.min(F,w-1-F)),R.set(F,f)}}const A=w;let x=(y?b*A:o*.001)*g;if(s==="bounce"){const F=A,f=x%(F*2);x=f>F?F*2-f:f}else s==="once"?x=Math.min(x,A):x=x%A;const B=e*w,M=new Float32Array(B*8),I=new Map;let P=0;const _=Array.from(R.keys());_.length===0&&_.push(0);for(const F of _){const f=R.get(F)||0;let S=Math.abs(x-f);S>A/2&&(S=A-S);let v=S<u?1-S/u:0;i>0&&(v=Math.pow(v,1-i));const E=P;for(let C=0;C<e;C++){const T=C*8,L=P+C*8;M.set(n.subarray(T,T+8),L),M[L+3]*=v,M[L+4]*=v,M[L+5]*=v,v<.05&&(M[L+6]=1)}I.set(F,{start:E,length:e*8}),P+=e*8}return M._channelDistributions=I,M}}function oe(n,e,d=!1){if(!e||!n||!n.points)return n;const{safetyZones:o,outputArea:t,transformationEnabled:a,transformationMode:r,flipX:i,flipY:g}=e;let u=n.points;const h=n.isTypedArray||u instanceof Float32Array,l=h?u.length/8:u.length;let c=d?u:h?new Float32Array(u):u.map(s=>({...s}));for(let s=0;s<l;s++){let b,m,y,p,R,w;if(h?(b=c[s*8],m=c[s*8+1],y=c[s*8+3],p=c[s*8+4],R=c[s*8+5],w=c[s*8+6]):(b=c[s].x,m=c[s].y,y=c[s].r,p=c[s].g,R=c[s].b,w=c[s].blanking?1:0),a&&t){let A=(b+1)/2,x=(1-m)/2;r==="crop"?(A<t.x||A>t.x+t.w||x<t.y||x>t.y+t.h)&&(y=0,p=0,R=0,w=1):r==="scale"&&(A=t.x+A*t.w,x=t.y+x*t.h,b=A*2-1,m=1-x*2)}if(o&&o.length>0){let A=(b+1)/2,x=(1-m)/2;for(const B of o)if(A>=B.x&&A<=B.x+B.w&&x>=B.y&&x<=B.y+B.h){y=0,p=0,R=0,w=1;break}}i&&(b=-b),g&&(m=-m),b=Math.max(-1,Math.min(1,b)),m=Math.max(-1,Math.min(1,m)),h?(c[s*8]=b,c[s*8+1]=m,c[s*8+3]=y,c[s*8+4]=p,c[s*8+5]=R,c[s*8+6]=w):(c[s].x=b,c[s].y=m,c[s].r=y,c[s].g=p,c[s].b=R,c[s].blanking=w>.5)}return{...n,points:c,isTypedArray:h}}class ne{constructor(e,d){if(this.canvas=e,this.type=d,this.gl=e.getContext("webgl")||e.getContext("experimental-webgl"),this.animationFrameId=null,this.frameIndexes=Array(10).fill(0),this.pointIndexes=Array(10).fill(0),this.showBeamEffect=!1,this.beamAlpha=.5,this.fadeAlpha=.13,this.beamRenderMode="both",this.positionBuffer=null,this.colorBuffer=null,this.alphaBuffer=null,this.alphaBufferData=new Float32Array(131072),this.lastPointDrawTime=0,!this.gl){console.error("WebGL not supported");return}this.setup()}setup(){const e=this.gl,d=`
      attribute vec2 aPosition;
      attribute vec3 aColor;
      attribute float aAlpha;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
        gl_PointSize = 2.0;
        vColor = aColor;
        vAlpha = aAlpha;
      }
    `,o=`
      precision mediump float;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_FragColor = vec4(vColor, vAlpha);
      }
    `,t=this.createShader(e.VERTEX_SHADER,d),a=this.createShader(e.FRAGMENT_SHADER,o),r=this.createProgram(t,a);this.program=r,this.positionAttributeLocation=e.getAttribLocation(r,"aPosition"),this.colorAttributeLocation=e.getAttribLocation(r,"aColor"),this.alphaAttributeLocation=e.getAttribLocation(r,"aAlpha"),this.quadPositionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.quadPositionBuffer);const i=[-1,-1,1,-1,-1,1,-1,1,1,-1,1,1];e.bufferData(e.ARRAY_BUFFER,new Float32Array(i),e.STATIC_DRAW),this.quadColorUniformLocation=e.getUniformLocation(r,"uColor"),this.quadAlphaUniformLocation=e.getUniformLocation(r,"uAlpha");const g=`
      attribute vec2 aPosition;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
      }
    `,u=`
      precision mediump float;
      uniform vec4 uColor;
      void main() {
        gl_FragColor = uColor;
      }
    `,h=this.createShader(e.VERTEX_SHADER,g),l=this.createShader(e.FRAGMENT_SHADER,u);this.fadeProgram=this.createProgram(h,l),this.fadePositionAttributeLocation=e.getAttribLocation(this.fadeProgram,"aPosition"),this.fadeColorUniformLocation=e.getUniformLocation(this.fadeProgram,"uColor"),e.useProgram(r);const c=131072;this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferData(e.ARRAY_BUFFER,c*2*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),this.colorBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),e.bufferData(e.ARRAY_BUFFER,c*3*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),this.alphaBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.alphaBuffer),e.bufferData(e.ARRAY_BUFFER,c*1*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.clearColor(0,0,0,1)}reset(){this.frameIndexes.fill(0),this.pointIndexes.fill(0),this.clearCanvas()}createShader(e,d){const o=this.gl,t=o.createShader(e);if(o.shaderSource(t,d),o.compileShader(t),o.getShaderParameter(t,o.COMPILE_STATUS))return t;console.error(o.getShaderInfoLog(t)),o.deleteShader(t)}createProgram(e,d){const o=this.gl,t=o.createProgram();if(o.attachShader(t,e),o.attachShader(t,d),o.linkProgram(t),o.getProgramParameter(t,o.LINK_STATUS))return t;console.error(o.getProgramInfoLog(t)),o.deleteProgram(t)}render(e){e.showBeamEffect!==void 0&&this.setBeamEffect(e.showBeamEffect),e.beamAlpha!==void 0&&this.setBeamAlpha(e.beamAlpha),e.fadeAlpha!==void 0&&this.setFadeAlpha(e.fadeAlpha),e.beamRenderMode!==void 0&&(this.beamRenderMode=e.beamRenderMode),this.type==="world"?this.renderWorld(e.worldData,e.previewScanRate,e.layerIntensities,e.masterIntensity,e.dacSettings,e.previewTime,e.fftLevels):this.renderSingle(e.ildaFrames,e.previewScanRate,e.intensity,e.effects,e.syncSettings,e.bpm,e.clipDuration,e.progress,e.previewTime,e.fftLevels,e.effectStates)}renderSingle(e,d,o,t,a={},r=120,i=1,g=null,u=null,h={low:0,mid:0,high:0},l=null){const c=this.gl;if(c.viewport(0,0,c.canvas.width,c.canvas.height),this.drawFadeQuad(),!e||e.length===0)return;const s=this.frameIndexes[0]%e.length,b=e[s],m=g!==null?g:s/e.length,y=u!==null?u:performance.now();this.draw(b,t,this.showBeamEffect,this.beamAlpha,d,this.beamRenderMode,o,0,m,y,a,r,i,h,l),this.frameIndexes[0]++,this.frameIndexes[0]>=e.length&&(this.frameIndexes[0]=0)}renderWorld(e,d,o,t,a,r=null,i={low:0,mid:0,high:0}){const g=this.gl;g.viewport(0,0,g.canvas.width,g.canvas.height),this.drawFadeQuad();const u=r!==null?r:performance.now();e.forEach(h=>{if(h&&h.frames&&h.frames.length>0){const l=h.frames[0];if(l){const c=h.layerIndex||0;if(h.syncSettings,h.bpm,c>=this.frameIndexes.length){const m=c+5;for(;this.frameIndexes.length<m;)this.frameIndexes.push(0),this.pointIndexes.push(0)}const b=(o[c]!==void 0?o[c]:1)*t;if(b>.001){const m=h.progress!==void 0?h.progress:this.frameIndexes[c]%h.frames.length/h.frames.length,{syncSettings:y={},bpm:p=120,clipDuration:R=1,effectStates:w=null}=h;let A=l;if(a){let x=l;if(a.dimmer!==void 0&&a.dimmer<1){const B=l.points,M=l.isTypedArray||B instanceof Float32Array,I=M?B.length/8:B.length,P=M?new Float32Array(B):B.map(_=>({..._}));for(let _=0;_<I;_++)M?(P[_*8+3]*=a.dimmer,P[_*8+4]*=a.dimmer,P[_*8+5]*=a.dimmer):(P[_].r*=a.dimmer,P[_].g*=a.dimmer,P[_].b*=a.dimmer);x={...l,points:P,isTypedArray:M}}A=oe(x,a)}this.draw(A,h.effects,this.showBeamEffect,this.beamAlpha,d,this.beamRenderMode,b,c,m,u,y,p,R,i,w)}}}}),e.forEach(h=>{if(h&&h.frames){const l=h.layerIndex||0;this.frameIndexes[l]++,this.frameIndexes[l]>=h.frames.length&&(this.frameIndexes[l]=0)}})}drawFadeQuad(){const e=this.gl;this.fadeProgram&&(e.useProgram(this.fadeProgram),e.bindBuffer(e.ARRAY_BUFFER,this.quadPositionBuffer),e.enableVertexAttribArray(this.fadePositionAttributeLocation),e.vertexAttribPointer(this.fadePositionAttributeLocation,2,e.FLOAT,!1,0,0),e.uniform4f(this.fadeColorUniformLocation,0,0,0,this.fadeAlpha),e.drawArrays(e.TRIANGLES,0,6))}setBeamEffect(e){this.showBeamEffect=e}setBeamAlpha(e){this.beamAlpha=e}setFadeAlpha(e){this.fadeAlpha=e}draw(e,d,o,t,a,r,i=1,g=0,u=0,h=performance.now(),l={},c=120,s=1,b={low:0,mid:0,high:0},m=null){if(this.gl,!e||!e.points)return;const y=q(e,d,{progress:u,time:h,syncSettings:l,bpm:c,clipDuration:s,fftLevels:b,effectStates:m}),p=y.points,R=y.isTypedArray,w=R?p.length/8:p.length;if(w===0)return;const A=Math.max(1,Math.floor(w/a));let x=this.pointIndexes[g]||0;x>=w&&(x=0);const B=_=>{const F=(x+_)%w;if(R){const f=F*8;return{x:p[f],y:p[f+1],r:p[f+3],g:p[f+4],b:p[f+5],blanking:p[f+6]===1}}else{const f=p[F];return{x:f.x,y:f.y,r:f.r,g:f.g,b:f.b,blanking:f.blanking}}},M=()=>{const _=r==="points"||r==="both",F=r==="lines"||r==="both";let f=[],S=[];for(let v=0;v<A;v++){const E=B(v);if(E.blanking){f.length>0&&(F&&this._drawSegment(new Float32Array(f),new Float32Array(S),1,f.length/2,!1),_&&this._drawSegment(new Float32Array(f),new Float32Array(S),1,f.length/2,!0),f=[],S=[]);continue}f.push(E.x,E.y),S.push(E.r/255*i,E.g/255*i,E.b/255*i)}f.length>0&&(F&&this._drawSegment(new Float32Array(f),new Float32Array(S),1,f.length/2,!1),_&&this._drawSegment(new Float32Array(f),new Float32Array(S),1,f.length/2,!0))},I=()=>{const _=[],F=[];for(let f=0;f<A;f++){const S=B(f);if(!S.blanking){_.push(0,0,S.x,S.y);const v=[S.r/255*i,S.g/255*i,S.b/255*i];F.push(...v,...v)}}_.length>0&&this._drawLines(new Float32Array(_),new Float32Array(F),t,_.length/2)},P=()=>{const _=[],F=[];let f=B(0);for(let S=1;S<A;S++){const v=B(S);if(!f.blanking&&!v.blanking){_.push(0,0,f.x,f.y,v.x,v.y);const E=[f.r/255*i,f.g/255*i,f.b/255*i],C=[v.r/255*i,v.g/255*i,v.b/255*i],T=[(E[0]+C[0])/2,(E[1]+C[1])/2,(E[2]+C[2])/2],L=.3,se=[E[0]*L,E[1]*L,E[2]*L],ie=[C[0]*L,C[1]*L,C[2]*L];F.push(...T,...se,...ie)}f=v}_.length>0&&this._drawTriangles(new Float32Array(_),new Float32Array(F),t,_.length/2)};M(),o&&(r==="points"?I():r==="lines"?P():r==="both"&&(P(),I())),this.pointIndexes[g]=(x+A)%w}_drawSegment(e,d,o,t,a=!1){const r=this.gl;r.useProgram(this.program),r.bindBuffer(r.ARRAY_BUFFER,this.positionBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,e),r.enableVertexAttribArray(this.positionAttributeLocation),r.vertexAttribPointer(this.positionAttributeLocation,2,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,this.colorBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,d),r.enableVertexAttribArray(this.colorAttributeLocation),r.vertexAttribPointer(this.colorAttributeLocation,3,r.FLOAT,!1,0,0),this.alphaBufferData.length<t&&(this.alphaBufferData=new Float32Array(t*2)),this.alphaBufferData.fill(o,0,t);const i=this.alphaBufferData.subarray(0,t);r.bindBuffer(r.ARRAY_BUFFER,this.alphaBuffer),r.bufferSubData(r.ARRAY_BUFFER,0,i),r.enableVertexAttribArray(this.alphaAttributeLocation),r.vertexAttribPointer(this.alphaAttributeLocation,1,r.FLOAT,!1,0,0),r.drawArrays(a?r.POINTS:r.LINE_STRIP,0,t)}_drawLines(e,d,o,t){const a=this.gl;a.useProgram(this.program),a.bindBuffer(a.ARRAY_BUFFER,this.positionBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,e),a.enableVertexAttribArray(this.positionAttributeLocation),a.vertexAttribPointer(this.positionAttributeLocation,2,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.colorBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,d),a.enableVertexAttribArray(this.colorAttributeLocation),a.vertexAttribPointer(this.colorAttributeLocation,3,a.FLOAT,!1,0,0),this.alphaBufferData.length<t&&(this.alphaBufferData=new Float32Array(t*2)),this.alphaBufferData.fill(o,0,t);const r=this.alphaBufferData.subarray(0,t);a.bindBuffer(a.ARRAY_BUFFER,this.alphaBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,r),a.enableVertexAttribArray(this.alphaAttributeLocation),a.vertexAttribPointer(this.alphaAttributeLocation,1,a.FLOAT,!1,0,0),a.drawArrays(a.LINES,0,t)}_drawTriangles(e,d,o,t){const a=this.gl;a.useProgram(this.program),a.bindBuffer(a.ARRAY_BUFFER,this.positionBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,e),a.enableVertexAttribArray(this.positionAttributeLocation),a.vertexAttribPointer(this.positionAttributeLocation,2,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.colorBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,d),a.enableVertexAttribArray(this.colorAttributeLocation),a.vertexAttribPointer(this.colorAttributeLocation,3,a.FLOAT,!1,0,0),this.alphaBufferData.length<t&&(this.alphaBufferData=new Float32Array(t*2)),this.alphaBufferData.fill(o,0,t);const r=this.alphaBufferData.subarray(0,t);a.bindBuffer(a.ARRAY_BUFFER,this.alphaBuffer),a.bufferSubData(a.ARRAY_BUFFER,0,r),a.enableVertexAttribArray(this.alphaAttributeLocation),a.vertexAttribPointer(this.alphaAttributeLocation,1,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,t)}clearCanvas(){const e=this.gl;e.viewport(0,0,e.canvas.width,e.canvas.height),e.clear(e.COLOR_BUFFER_BIT)}destroy(){if(cancelAnimationFrame(this.animationFrameId),this.gl){const e=this.gl.getExtension("WEBGL_losing_context");e&&e.loseContext()}}}const D=new Map;function U(n,e=0){const d=D.get(n);if(!d)return;const o=performance.now();d.renderer.render(d.data),e=o,d.animationFrameId=requestAnimationFrame(()=>U(n,e))}self.onmessage=n=>{const{action:e,payload:d}=n.data;if(e==="register"){const{id:o,canvas:t,type:a,data:r}=d,i=new ne(t,a),g=requestAnimationFrame(()=>U(o));D.set(o,{renderer:i,type:a,data:r,animationFrameId:g})}else if(e==="deregister"){const{id:o}=d,t=D.get(o);t&&(cancelAnimationFrame(t.animationFrameId),D.delete(o))}else if(e==="update"){const{id:o,data:t}=d,a=D.get(o);a&&(a.data=t)}else if(e==="clear"){const{id:o}=d,t=D.get(o);t&&t.renderer.clearCanvas()}}})();
