(function(){"use strict";const S=[{id:"rotate",name:"Rotate",type:"transform",description:"Rotates the shape around its center.",defaultParams:{angle:0,speed:0,direction:"CW"},paramControls:[{id:"angle",label:"Angle",type:"range",min:0,max:360,step:1},{id:"speed",label:"Speed",type:"range",min:0,max:10,step:.1},{id:"direction",label:"Direction",type:"select",options:["CW","CCW"]}]},{id:"scale",name:"Scale",type:"transform",description:"Scales the shape.",defaultParams:{scaleX:1,scaleY:1},paramControls:[{id:"scaleX",label:"Scale X",type:"range",min:.01,max:5,step:.01},{id:"scaleY",label:"Scale Y",type:"range",min:.01,max:5,step:.01}]},{id:"translate",name:"Translate",type:"transform",description:"Moves the shape.",defaultParams:{translateX:0,translateY:0},paramControls:[{id:"translateX",label:"Translate X",type:"range",min:-1,max:1,step:.01},{id:"translateY",label:"Translate Y",type:"range",min:-1,max:1,step:.01}]},{id:"color",name:"Color",type:"color",description:"Changes the color of the shape with solid or rainbow modes.",defaultParams:{mode:"solid",r:255,g:255,b:255,cycleSpeed:0,rainbowSpread:1,rainbowOffset:0},paramControls:[{id:"mode",label:"Mode",type:"select",options:["solid","rainbow"]},{id:"r",label:"Red",type:"range",min:0,max:255,step:1,showIf:{mode:"solid"}},{id:"g",label:"Green",type:"range",min:0,max:255,step:1,showIf:{mode:"solid"}},{id:"b",label:"Blue",type:"range",min:0,max:255,step:1,showIf:{mode:"solid"}},{id:"cycleSpeed",label:"Cycle Speed",type:"range",min:0,max:10,step:.1},{id:"rainbowSpread",label:"Rainbow Spread",type:"range",min:.1,max:10,step:.1,showIf:{mode:"rainbow"}},{id:"rainbowOffset",label:"Rainbow Offset",type:"range",min:0,max:360,step:1,showIf:{mode:"rainbow"}},{id:"rainbowPalette",label:"Palette",type:"select",options:["rainbow","fire","ice","cyber"],showIf:{mode:"rainbow"}}]},{id:"wave",name:"Wave",type:"animation",description:"Applies a wave distortion to the shape.",defaultParams:{amplitude:.1,frequency:10,speed:1,direction:"x"},paramControls:[{id:"amplitude",label:"Amplitude",type:"range",min:.01,max:1,step:.01},{id:"frequency",label:"Frequency",type:"range",min:1,max:50,step:1},{id:"speed",label:"Speed",type:"range",min:.1,max:10,step:.1},{id:"direction",label:"Direction",type:"select",options:["x","y"]}]},{id:"warp",name:"Warp",type:"animation",description:"Symmetrical chaotic wave distortion.",defaultParams:{amount:.1,chaos:.5,speed:1},paramControls:[{id:"amount",label:"Amount",type:"range",min:0,max:1,step:.01},{id:"chaos",label:"Chaos",type:"range",min:0,max:1,step:.01},{id:"speed",label:"Speed",type:"range",min:.1,max:10,step:.1}]},{id:"distortion",name:"Distortion",type:"transform",description:"Distorts the point data.",defaultParams:{amount:.1,scale:10,speed:.5},paramControls:[{id:"amount",label:"Amount",type:"range",min:0,max:1,step:.01},{id:"scale",label:"Scale",type:"range",min:1,max:50,step:1},{id:"speed",label:"Speed",type:"range",min:0,max:5,step:.1}]},{id:"move",name:"Move (Bounce)",type:"transform",description:"Moves points and bounces them off the borders.",defaultParams:{speedX:.1,speedY:.1},paramControls:[{id:"speedX",label:"Speed X",type:"range",min:0,max:2,step:.01},{id:"speedY",label:"Speed Y",type:"range",min:0,max:2,step:.01}]},{id:"delay",name:"Delay / Chase",type:"effect",description:"Creates a trailing chaser effect.",defaultParams:{delayAmount:5,decay:.8,mode:"linear",target:"intensity",direction:"out"},paramControls:[{id:"delayAmount",label:"Delay",type:"range",min:1,max:60,step:1},{id:"decay",label:"Decay",type:"range",min:0,max:1,step:.01},{id:"mode",label:"Mode",type:"select",options:["linear","symmetric"]},{id:"target",label:"Target",type:"select",options:["intensity","color","effect"]},{id:"direction",label:"Direction",type:"select",options:["out","in"]}]},{id:"blanking",name:"Blanking",type:"animation",description:"Controls the blanking of the laser output.",defaultParams:{blankingInterval:0},paramControls:[{id:"blankingInterval",label:"Blanking Interval",type:"range",min:0,max:10,step:1}]},{id:"strobe",name:"Strobe",type:"animation",description:"Applies a strobe effect to the laser output.",defaultParams:{strobeSpeed:100,strobeAmount:.5},paramControls:[{id:"strobeSpeed",label:"Strobe Speed (ms)",type:"range",min:10,max:1e3,step:10},{id:"strobeAmount",label:"Strobe Amount (0-1)",type:"range",min:0,max:1,step:.01}]},{id:"mirror",name:"Mirror",type:"transform",description:"Mirrors the shape from the center.",defaultParams:{mode:"none"},paramControls:[{id:"mode",label:"Mirror Mode",type:"select",options:["none","x+","x-","y+","y-"]}]}],P=(n,e)=>({...e,...n});function T(n,e,l={}){const{progress:o=0,time:r=performance.now(),effectStates:t}=l;if(!e||e.length===0)return n;let s;if(Array.isArray(n.points)){s=new Float32Array(n.points.length*8);for(let i=0;i<n.points.length;i++){const f=n.points[i],h=i*8;s[h]=f.x,s[h+1]=f.y,s[h+2]=f.z||0,s[h+3]=f.r,s[h+4]=f.g,s[h+5]=f.b,s[h+6]=f.blanking?1:0,s[h+7]=f.lastPoint?1:0}}else s=new Float32Array(n.points);let a=s;const c=()=>a.length/8;for(const i of e)if(S.find(h=>h.id===i.id))switch(i.id){case"rotate":D(a,c(),i.params,o,r);break;case"scale":U(a,c(),i.params);break;case"translate":k(a,c(),i.params);break;case"color":O(a,c(),i.params,r);break;case"wave":X(a,c(),i.params,r);break;case"blanking":W(a,c(),i.params);break;case"strobe":V(a,c(),i.params,r);break;case"mirror":q(a,c(),i.params);break;case"warp":G(a,c(),i.params,r);break;case"distortion":H(a,c(),i.params,r);break;case"move":z(a,c(),i.params,r);break;case"delay":t&&i.instanceId&&(a=Q(a,c(),i.params,t,i.instanceId));break}return{...n,points:a,isTypedArray:!0}}function D(n,e,l,o,r){const{angle:t,speed:s,direction:a}=P(l,S.find(b=>b.id==="rotate").defaultParams),c=a==="CCW"?-1:1,i=r*.001*s*c,f=t*Math.PI/180+i,h=Math.sin(f),u=Math.cos(f);for(let b=0;b<e;b++){const d=b*8,m=n[d],y=n[d+1];n[d]=m*u-y*h,n[d+1]=m*h+y*u}}function U(n,e,l){const{scaleX:o,scaleY:r}=P(l,S.find(t=>t.id==="scale").defaultParams);for(let t=0;t<e;t++){const s=t*8;n[s]*=o,n[s+1]*=r}}function k(n,e,l){const{translateX:o,translateY:r}=P(l,S.find(t=>t.id==="translate").defaultParams);for(let t=0;t<e;t++){const s=t*8;n[s]+=o,n[s+1]+=r}}function O(n,e,l,o){const{mode:r,r:t,g:s,b:a,cycleSpeed:c,rainbowSpread:i,rainbowOffset:f,rainbowPalette:h}=P(l,S.find(b=>b.id==="color").defaultParams),u=o*.001*c;if(r==="rainbow"){const b=h||"rainbow";for(let d=0;d<e;d++){const m=d*8,y=(d/e*i+u*.5+f/360)%1;let w,R,F;b==="rainbow"?[w,R,F]=C(y,1,.5):[w,R,F]=N(b,y),n[m+3]=w,n[m+4]=R,n[m+5]=F}}else if(c>0){const b=u*50%360,[d,m,y]=C(b/360,1,.5);for(let w=0;w<e;w++){const R=w*8;n[R+3]=d,n[R+4]=m,n[R+5]=y}}else for(let b=0;b<e;b++){const d=b*8;n[d+3]=t,n[d+4]=s,n[d+5]=a}}function N(n,e){const l={fire:[{r:255,g:0,b:0},{r:255,g:128,b:0},{r:255,g:255,b:0},{r:255,g:0,b:0}],ice:[{r:0,g:0,b:255},{r:0,g:255,b:255},{r:255,g:255,b:255},{r:0,g:0,b:255}],cyber:[{r:255,g:0,b:255},{r:0,g:255,b:255},{r:0,g:0,b:255},{r:255,g:0,b:255}]},o=l[n]||l.fire,r=e*(o.length-1),t=Math.floor(r),s=r-t,a=o[t],c=o[t+1]||o[t];return[Math.round(a.r+(c.r-a.r)*s),Math.round(a.g+(c.g-a.g)*s),Math.round(a.b+(c.b-a.b)*s)]}function C(n,e,l){let o,r,t;{const s=(i,f,h)=>(h<0&&(h+=1),h>1&&(h-=1),h<.16666666666666666?i+(f-i)*6*h:h<.5?f:h<.6666666666666666?i+(f-i)*(.6666666666666666-h)*6:i),a=l+e-l*e,c=2*l-a;o=s(c,a,n+1/3),r=s(c,a,n),t=s(c,a,n-1/3)}return[Math.round(o*255),Math.round(r*255),Math.round(t*255)]}function X(n,e,l,o){const{amplitude:r,frequency:t,speed:s,direction:a}=P(l,S.find(i=>i.id==="wave").defaultParams),c=o*.001*s;for(let i=0;i<e;i++){const f=i*8;a==="x"?n[f+1]+=r*Math.sin(n[f]*t+c):a==="y"&&(n[f]+=r*Math.sin(n[f+1]*t+c))}}function W(n,e,l){const{blankingInterval:o}=P(l,S.find(r=>r.id==="blanking").defaultParams);if(!(o<=0))for(let r=0;r<e;r++)r%(o+1)===o&&(n[r*8+6]=1)}function V(n,e,l,o){const{strobeSpeed:r,strobeAmount:t}=P(l,S.find(a=>a.id==="strobe").defaultParams);if(o%r/r<t)for(let a=0;a<e;a++)n[a*8+6]=1}function q(n,e,l){const{mode:o}=P(l,S.find(r=>r.id==="mirror").defaultParams);if(o!=="none")for(let r=0;r<e;r++){const t=r*8,s=n[t],a=n[t+1];o==="x+"?n[t]=Math.abs(s):o==="x-"?n[t]=-Math.abs(s):o==="y+"?n[t+1]=Math.abs(a):o==="y-"&&(n[t+1]=-Math.abs(a))}}function G(n,e,l,o){const{amount:r,chaos:t,speed:s}=P(l,S.find(c=>c.id==="warp").defaultParams),a=o*.001*s;for(let c=0;c<e;c++){const i=c*8,f=n[i],h=n[i+1],u=Math.abs(h);n[i]+=Math.sin(u*10*(1+t)+a)*r*Math.cos(a*t),n[i+1]+=Math.cos(Math.abs(f)*10*(1+t)+a)*r*Math.sin(a*t)}}function H(n,e,l,o){const{amount:r,scale:t,speed:s}=P(l,S.find(c=>c.id==="distortion").defaultParams),a=o*.001*s;for(let c=0;c<e;c++){const i=c*8,f=Math.sin(n[i]*t+a)*Math.cos(n[i+1]*t-a),h=Math.cos(n[i]*t-a)*Math.sin(n[i+1]*t+a);n[i]+=f*r,n[i+1]+=h*r}}function z(n,e,l,o){const{speedX:r,speedY:t}=P(l,S.find(f=>f.id==="move").defaultParams),s=o*.001,a=s*r,c=s*t,i=4;for(let f=0;f<e;f++){const h=f*8;let u=n[h]+a,b=n[h+1]+c,d=(u+1)%i;d<0&&(d+=i),d>2&&(d=4-d),u=d-1;let m=(b+1)%i;m<0&&(m+=i),m>2&&(m=4-m),b=m-1,n[h]=u,n[h+1]=b}}function Q(n,e,l,o,r){const{delayAmount:t,decay:s}=P(l,S.find(d=>d.id==="delay").defaultParams);o.has(r)||o.set(r,[]);const a=o.get(r),c=new Float32Array(n);a.unshift(c);const i=t*4+1;a.length>i&&(a.length=i);const f=[];for(let d=1;d<=4;d++){const m=d*t;if(m<a.length){const y=a[m];y.length===n.length&&f.push({points:y,factor:Math.pow(s,d)})}}if(f.length===0)return n;const h=e+f.reduce((d,m)=>d+m.points.length/8,0),u=new Float32Array(h*8);u.set(n,0);let b=n.length;for(const d of f){const m=d.points,y=m.length/8,w=d.factor;for(let R=0;R<y;R++){const F=R*8,E=b+R*8;u[E]=m[F],u[E+1]=m[F+1],u[E+2]=m[F+2],u[E+3]=m[F+3]*w,u[E+4]=m[F+4]*w,u[E+5]=m[F+5]*w,u[E+6]=m[F+6],u[E+7]=m[F+7]}b+=m.length}return u}class K{constructor(e,l){if(this.canvas=e,this.type=l,this.gl=e.getContext("webgl")||e.getContext("experimental-webgl"),this.animationFrameId=null,this.frameIndexes=Array(10).fill(0),this.pointIndexes=Array(10).fill(0),this.showBeamEffect=!1,this.beamAlpha=.5,this.fadeAlpha=.13,this.beamRenderMode="lines",this.positionBuffer=null,this.colorBuffer=null,this.alphaBuffer=null,this.lastPointDrawTime=0,!this.gl){console.error("WebGL not supported");return}this.setup()}setup(){const e=this.gl,l=`
      attribute vec2 aPosition;
      attribute vec3 aColor;
      attribute float aAlpha;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
        gl_PointSize = 2.0;
        vColor = aColor;
        vAlpha = aAlpha;
      }
    `,o=`
      precision mediump float;
      varying vec3 vColor;
      varying float vAlpha;
      void main() {
        gl_FragColor = vec4(vColor, vAlpha);
      }
    `,r=this.createShader(e.VERTEX_SHADER,l),t=this.createShader(e.FRAGMENT_SHADER,o),s=this.createProgram(r,t);this.program=s,this.positionAttributeLocation=e.getAttribLocation(s,"aPosition"),this.colorAttributeLocation=e.getAttribLocation(s,"aColor"),this.alphaAttributeLocation=e.getAttribLocation(s,"aAlpha"),this.quadPositionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.quadPositionBuffer);const a=[-1,-1,1,-1,-1,1,-1,1,1,-1,1,1];e.bufferData(e.ARRAY_BUFFER,new Float32Array(a),e.STATIC_DRAW),this.quadColorUniformLocation=e.getUniformLocation(s,"uColor"),this.quadAlphaUniformLocation=e.getUniformLocation(s,"uAlpha");const c=`
      attribute vec2 aPosition;
      void main() {
        gl_Position = vec4(aPosition, 0.0, 1.0);
      }
    `,i=`
      precision mediump float;
      uniform vec4 uColor;
      void main() {
        gl_FragColor = uColor;
      }
    `,f=this.createShader(e.VERTEX_SHADER,c),h=this.createShader(e.FRAGMENT_SHADER,i);this.fadeProgram=this.createProgram(f,h),this.fadePositionAttributeLocation=e.getAttribLocation(this.fadeProgram,"aPosition"),this.fadeColorUniformLocation=e.getUniformLocation(this.fadeProgram,"uColor"),e.useProgram(s);const u=131072;this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferData(e.ARRAY_BUFFER,u*2*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),this.colorBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer),e.bufferData(e.ARRAY_BUFFER,u*3*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),this.alphaBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.alphaBuffer),e.bufferData(e.ARRAY_BUFFER,u*1*Float32Array.BYTES_PER_ELEMENT,e.DYNAMIC_DRAW),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)}reset(){this.frameIndexes.fill(0),this.pointIndexes.fill(0),this.clearCanvas()}createShader(e,l){const o=this.gl,r=o.createShader(e);if(o.shaderSource(r,l),o.compileShader(r),o.getShaderParameter(r,o.COMPILE_STATUS))return r;console.error(o.getShaderInfoLog(r)),o.deleteShader(r)}createProgram(e,l){const o=this.gl,r=o.createProgram();if(o.attachShader(r,e),o.attachShader(r,l),o.linkProgram(r),o.getProgramParameter(r,o.LINK_STATUS))return r;console.error(o.getProgramInfoLog(r)),o.deleteProgram(r)}render(e){e.showBeamEffect!==void 0&&this.setBeamEffect(e.showBeamEffect),e.beamAlpha!==void 0&&this.setBeamAlpha(e.beamAlpha),e.fadeAlpha!==void 0&&this.setFadeAlpha(e.fadeAlpha),e.beamRenderMode!==void 0&&(this.beamRenderMode=e.beamRenderMode),this.type==="world"?this.renderWorld(e.worldData,e.previewScanRate,e.layerIntensities,e.masterIntensity):this.renderSingle(e.ildaFrames,e.previewScanRate,e.intensity,e.effects,e.syncSettings)}renderSingle(e,l,o,r,t={}){const s=this.gl;if(s.viewport(0,0,s.canvas.width,s.canvas.height),this.drawFadeQuad(),!e||e.length===0)return;const a=this.frameIndexes[0]%e.length,c=e[a],i=a/e.length,f=performance.now();this.draw(c,r,this.showBeamEffect,this.beamAlpha,l,this.beamRenderMode,o,0,i,f,t),this.frameIndexes[0]++,this.frameIndexes[0]>=e.length&&(this.frameIndexes[0]=0)}renderWorld(e,l,o,r){const t=this.gl;t.viewport(0,0,t.canvas.width,t.canvas.height),this.drawFadeQuad();const s=performance.now();e.forEach(a=>{if(a&&a.frames&&a.frames.length>0){const c=a.frames[0];if(c){const i=a.layerIndex||0,f=a.syncSettings||{};if(i>=this.frameIndexes.length){const b=i+5;for(;this.frameIndexes.length<b;)this.frameIndexes.push(0),this.pointIndexes.push(0)}const u=(o[i]!==void 0?o[i]:1)*r;if(u>.001){const b=this.frameIndexes[i]%a.frames.length/a.frames.length;this.draw(c,a.effects,this.showBeamEffect,this.beamAlpha,l,this.beamRenderMode,u,i,b,s,f)}}}}),e.forEach(a=>{if(a&&a.frames){const c=a.layerIndex||0;this.frameIndexes[c]++,this.frameIndexes[c]>=a.frames.length&&(this.frameIndexes[c]=0)}})}drawFadeQuad(){const e=this.gl;this.fadeProgram&&(e.useProgram(this.fadeProgram),e.bindBuffer(e.ARRAY_BUFFER,this.quadPositionBuffer),e.enableVertexAttribArray(this.fadePositionAttributeLocation),e.vertexAttribPointer(this.fadePositionAttributeLocation,2,e.FLOAT,!1,0,0),e.uniform4f(this.fadeColorUniformLocation,0,0,0,this.fadeAlpha),e.drawArrays(e.TRIANGLES,0,6))}setBeamEffect(e){this.showBeamEffect=e}setBeamAlpha(e){this.beamAlpha=e}setFadeAlpha(e){this.fadeAlpha=e}draw(e,l,o,r,t,s,a=1,c=0,i=0,f=performance.now(),h={}){if(this.gl,!e||!e.points)return;const u=(l||[]).map(A=>{const x={...A.params},p=S.find(g=>g.id===A.id);return p&&p.paramControls.forEach(g=>{const B=`${A.id}.${g.id}`,v=h[B];if(v&&(g.type==="range"||g.type==="number")){let L=0;v==="fps"?L=f*.001%1:(v==="timeline"||v==="bpm")&&(L=i),x[g.id]=g.min+(g.max-g.min)*L}}),{...A,params:x}}),b=T(e,u,{progress:i,time:f}),d=b.points,m=b.isTypedArray,y=m?d.length/8:d.length;if(y===0)return;const w=Math.max(1,Math.floor(y/t));let R=this.pointIndexes[c]||0;R>=y&&(R=0);const F=A=>{const x=(R+A)%y;if(m){const p=x*8;return{x:d[p],y:d[p+1],r:d[p+3],g:d[p+4],b:d[p+5],blanking:d[p+6]===1}}else{const p=d[x];return{x:p.x,y:p.y,r:p.r,g:p.g,b:p.b,blanking:p.blanking}}},E=()=>{let A=[],x=[];for(let p=0;p<w;p++){const g=F(p);if(g.blanking){A.length>0&&(this._drawSegment(new Float32Array(A),new Float32Array(x),1,A.length/2),A=[],x=[]);continue}A.push(g.x,g.y),x.push(g.r/255*a,g.g/255*a,g.b/255*a)}A.length>0&&this._drawSegment(new Float32Array(A),new Float32Array(x),1,A.length/2)},M=()=>{const A=[],x=[];for(let p=0;p<w;p++){const g=F(p);if(!g.blanking){A.push(0,0,g.x,g.y);const B=[g.r/255*a,g.g/255*a,g.b/255*a];x.push(...B,...B)}}A.length>0&&this._drawLines(new Float32Array(A),new Float32Array(x),r,A.length/2)},Y=()=>{const A=[],x=[];let p=F(0);for(let g=1;g<w;g++){const B=F(g);if(!p.blanking&&!B.blanking){A.push(0,0,p.x,p.y,B.x,B.y);const v=[p.r/255*a,p.g/255*a,p.b/255*a],L=[B.r/255*a,B.g/255*a,B.b/255*a],$=[(v[0]+L[0])/2,(v[1]+L[1])/2,(v[2]+L[2])/2];x.push(...$,...v,...L)}p=B}A.length>0&&this._drawTriangles(new Float32Array(A),new Float32Array(x),r,A.length/2)};E(),o&&(s==="points"?M():s==="lines"?Y():s==="both"&&(Y(),M())),this.pointIndexes[c]=(R+w)%y}_drawSegment(e,l,o,r){const t=this.gl;t.useProgram(this.program),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,e),t.enableVertexAttribArray(this.positionAttributeLocation),t.vertexAttribPointer(this.positionAttributeLocation,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,l),t.enableVertexAttribArray(this.colorAttributeLocation),t.vertexAttribPointer(this.colorAttributeLocation,3,t.FLOAT,!1,0,0);const s=new Float32Array(Array(r).fill(o));t.bindBuffer(t.ARRAY_BUFFER,this.alphaBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,s),t.enableVertexAttribArray(this.alphaAttributeLocation),t.vertexAttribPointer(this.alphaAttributeLocation,1,t.FLOAT,!1,0,0),t.drawArrays(t.LINE_STRIP,0,r)}_drawLines(e,l,o,r){const t=this.gl;t.useProgram(this.program),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,e),t.enableVertexAttribArray(this.positionAttributeLocation),t.vertexAttribPointer(this.positionAttributeLocation,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,l),t.enableVertexAttribArray(this.colorAttributeLocation),t.vertexAttribPointer(this.colorAttributeLocation,3,t.FLOAT,!1,0,0);const s=new Float32Array(Array(r).fill(o));t.bindBuffer(t.ARRAY_BUFFER,this.alphaBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,s),t.enableVertexAttribArray(this.alphaAttributeLocation),t.vertexAttribPointer(this.alphaAttributeLocation,1,t.FLOAT,!1,0,0),t.drawArrays(t.LINES,0,r)}_drawTriangles(e,l,o,r){const t=this.gl;t.useProgram(this.program),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,e),t.enableVertexAttribArray(this.positionAttributeLocation),t.vertexAttribPointer(this.positionAttributeLocation,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,l),t.enableVertexAttribArray(this.colorAttributeLocation),t.vertexAttribPointer(this.colorAttributeLocation,3,t.FLOAT,!1,0,0);const s=new Float32Array(Array(r).fill(o));t.bindBuffer(t.ARRAY_BUFFER,this.alphaBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,s),t.enableVertexAttribArray(this.alphaAttributeLocation),t.vertexAttribPointer(this.alphaAttributeLocation,1,t.FLOAT,!1,0,0),t.drawArrays(t.TRIANGLES,0,r)}clearCanvas(){const e=this.gl;e.viewport(0,0,e.canvas.width,e.canvas.height),e.clear(e.COLOR_BUFFER_BIT)}destroy(){cancelAnimationFrame(this.animationFrameId)}}const _=new Map;function I(n,e=0){const l=_.get(n);if(!l)return;const o=performance.now();l.renderer.render(l.data),e=o,l.animationFrameId=requestAnimationFrame(()=>I(n,e))}self.onmessage=n=>{const{action:e,payload:l}=n.data;if(e==="register"){const{id:o,canvas:r,type:t,data:s}=l,a=new K(r,t),c=requestAnimationFrame(()=>I(o));_.set(o,{renderer:a,type:t,data:s,animationFrameId:c})}else if(e==="deregister"){const{id:o}=l,r=_.get(o);r&&(cancelAnimationFrame(r.animationFrameId),_.delete(o))}else if(e==="update"){const{id:o,data:r}=l,t=_.get(o);t&&(t.data=r)}else if(e==="clear"){const{id:o}=l,r=_.get(o);r&&r.renderer.clearCanvas()}}})();
